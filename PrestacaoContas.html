<div class="p-4">
  <h2 class="text-xl font-bold mb-4">ðŸ“‘ PrestaÃ§Ã£o de Contas</h2>

  <!-- FORMULÃRIO DE DESPESA -->
  <form id="formDespesa" class="bg-white rounded-lg shadow p-4 mb-6 space-y-3">
    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <label>PoÃ§o</label>
        <select id="pocoId" class="border p-2 w-full rounded" required></select>
      </div>
      <div>
        <label>Data</label>
        <input type="date" id="data" class="border p-2 w-full rounded" required>
      </div>
    </div>
    <div>
      <label>DescriÃ§Ã£o</label>
      <input type="text" id="descricao" class="border p-2 w-full rounded" required>
    </div>
    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <label>Valor (R$)</label>
        <input type="number" step="0.01" id="valor" class="border p-2 w-full rounded" required>
      </div>
      <div>
        <label>Comprovante</label>
        <input type="file" id="comprovante" class="border p-2 w-full rounded">
      </div>
    </div>

    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      ðŸ’¾ Registrar Despesa
    </button>
  </form>

  <!-- TABELA -->
  <h3 class="font-semibold mb-2">LanÃ§amentos Realizados</h3>
  <table id="tabelaPrestacoes" class="w-full bg-white rounded shadow overflow-hidden">
    <thead class="bg-blue-100">
      <tr>
        <th class="p-2 text-left">PoÃ§o</th>
        <th class="p-2 text-left">Data</th>
        <th class="p-2 text-left">DescriÃ§Ã£o</th>
        <th class="p-2 text-left">Valor</th>
        <th class="p-2 text-left">Comprovante</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="totalizador" class="mt-4 text-blue-700 font-semibold"></div>
</div>

<script>
// =============================
// CARREGAR POÃ‡OS NO SELECT
// =============================
function carregarSelectPocos() {
  google.script.run.withSuccessHandler(pocos => {
    const select = document.getElementById('pocoId');
    select.innerHTML = pocos.map(p => `<option value="${p.ID}">${p.Nome} - ${p.Base}</option>`).join('');
  }).listarPocos();
}

// =============================
// SUBMIT FORMULÃRIO
// =============================
document.getElementById('formDespesa').addEventListener('submit', async e => {
  e.preventDefault();

  const pocoId = document.getElementById('pocoId').value;
  const data = document.getElementById('data').value;
  const descricao = document.getElementById('descricao').value;
  const valor = parseFloat(document.getElementById('valor').value);
  const fileInput = document.getElementById('comprovante');

  let comprovanteURL = '';
  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    const reader = new FileReader();
    const base64 = await new Promise(resolve => {
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });

    await new Promise(resolve => {
      google.script.run.withSuccessHandler(url => {
        comprovanteURL = url;
        resolve();
      }).uploadFile(base64, file.name, file.type);
    });
  }

  const despesa = { pocoId, data, descricao, valor, comprovanteURL };
  google.script.run.withSuccessHandler(() => {
    e.target.reset();
    carregarPrestacoes();
  }).salvarPrestacao(despesa);
});

// =============================
// CARREGAR LISTA
// =============================
function carregarPrestacoes() {
  google.script.run.withSuccessHandler(registros => {
    const tbody = document.querySelector('#tabelaPrestacoes tbody');
    let total = 0;
    tbody.innerHTML = registros.map(r => {
      total += Number(r.Valor);
      return `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-2">${r.PoÃ§oID}</td>
          <td class="p-2">${new Date(r.Data).toLocaleDateString('pt-BR')}</td>
          <td class="p-2">${r.DescriÃ§Ã£o}</td>
          <td class="p-2">R$ ${Number(r.Valor).toFixed(2)}</td>
          <td class="p-2">${r.ComprovanteURL ? `<a href="${r.ComprovanteURL}" target="_blank">ðŸ“Ž Ver</a>` : '-'}</td>
        </tr>`;
    }).join('');
    document.getElementById('totalizador').textContent = `ðŸ’° Total lanÃ§ado: R$ ${total.toFixed(2)}`;
  }).listarPrestacoes();
}

carregarSelectPocos();
carregarPrestacoes();
</script>
