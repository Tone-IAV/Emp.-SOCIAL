<div class="p-4">
  <h2 class="text-xl font-bold mb-4">üìë Presta√ß√£o de Contas</h2>

  <!-- FORMUL√ÅRIO DE DESPESA -->
  <form id="formDespesa" class="bg-white rounded-lg shadow p-4 mb-6 space-y-3">
    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <label>Po√ßo</label>
        <select id="pocoId" class="border p-2 w-full rounded" required></select>
      </div>
      <div>
        <label>Data</label>
        <input type="date" id="data" class="border p-2 w-full rounded" required>
      </div>
    </div>
    <div>
      <label>Descri√ß√£o</label>
      <input type="text" id="descricao" class="border p-2 w-full rounded" required>
    </div>
    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <label>Valor (R$)</label>
        <input type="number" step="0.01" id="valor" class="border p-2 w-full rounded" required>
      </div>
      <div>
        <label>Comprovante</label>
        <input type="file" id="comprovante" class="border p-2 w-full rounded">
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <label>Categoria da despesa</label>
        <select id="categoria" class="border p-2 w-full rounded">
          <option>Perfura√ß√£o</option>
          <option>Instala√ß√£o</option>
          <option>Manuten√ß√£o</option>
          <option>Capacita√ß√£o</option>
          <option>Log√≠stica</option>
          <option>Outros investimentos</option>
        </select>
      </div>
      <div>
        <label>Registrado por</label>
        <input type="text" id="registradoPor" class="border p-2 w-full rounded" placeholder="Equipe respons√°vel">
      </div>
    </div>

    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      üíæ Registrar Despesa
    </button>
  </form>

  <!-- TABELA -->
  <h3 class="font-semibold mb-2">Lan√ßamentos Realizados</h3>
  <table id="tabelaPrestacoes" class="w-full bg-white rounded shadow overflow-hidden">
    <thead class="bg-blue-100">
      <tr>
        <th class="p-2 text-left">Po√ßo</th>
        <th class="p-2 text-left">Status</th>
        <th class="p-2 text-left">Data</th>
        <th class="p-2 text-left">Descri√ß√£o</th>
        <th class="p-2 text-left">Valor</th>
        <th class="p-2 text-left">Categoria</th>
        <th class="p-2 text-left">Registrado por</th>
        <th class="p-2 text-left">Comprovante</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="totalizador" class="mt-4 text-blue-700 font-semibold"></div>
</div>

<script>
  (() => {
    const mapaPocos = {};
    const { escapeHtml, formatarMoeda } = window;

    function carregarSelectPocos() {
      google.script.run.withSuccessHandler(pocos => {
        const select = document.getElementById('pocoId');
        const options = pocos.map(p => {
          const nome = p['Comunidade'] || p['Munic√≠pio'] || p['Estado'] || 'Po√ßo sem nome';
          const local = [p['Munic√≠pio'], p['Estado']].filter(Boolean).join(' - ');
          mapaPocos[p.ID] = {
            nome,
            local,
            status: p.Status || 'Sem status',
            previsto: Number(p.OrcamentoPrevisto || p['Valor Previsto Perfura√ß√£o'] || 0),
            executado: Number(p.OrcamentoExecutado || p['Valor Realizado'] || 0)
          };
          const status = mapaPocos[p.ID].status;
          return `<option value="${p.ID}">${escapeHtml(nome)} (${escapeHtml(status)})</option>`;
        });
        select.innerHTML = options.join('');
        carregarPrestacoes();
      }).listarPocos();
    }

    document.getElementById('formDespesa').addEventListener('submit', async e => {
      e.preventDefault();

      const pocoId = document.getElementById('pocoId').value;
      const data = document.getElementById('data').value;
      const descricao = document.getElementById('descricao').value;
      const valor = parseFloat(document.getElementById('valor').value);
      const categoria = document.getElementById('categoria').value;
      const registradoPor = document.getElementById('registradoPor').value;
      const fileInput = document.getElementById('comprovante');

      let comprovanteURL = '';
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        const base64 = await new Promise(resolve => {
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });

        await new Promise(resolve => {
          google.script.run.withSuccessHandler(url => {
            comprovanteURL = url;
            resolve();
          }).uploadFile(base64, file.name, file.type);
        });
      }

      const despesa = { pocoId, data, descricao, valor, categoria, registradoPor, comprovanteURL };
      google.script.run.withSuccessHandler(() => {
        e.target.reset();
        carregarPrestacoes();
      }).salvarPrestacao(despesa);
    });

    function carregarPrestacoes() {
      google.script.run.withSuccessHandler(registros => {
        const tbody = document.querySelector('#tabelaPrestacoes tbody');
        let total = 0;
        if (!registros.length) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 py-4">Nenhum lan√ßamento registrado.</td></tr>';
          document.getElementById('totalizador').textContent = 'üí∞ Total lan√ßado: R$ 0,00';
          return;
        }
        tbody.innerHTML = registros.map(r => {
          const valor = Number(r.Valor || 0);
          total += valor;
          const data = r.Data ? new Date(r.Data) : null;
          const dataTexto = data && !isNaN(data.getTime()) ? data.toLocaleDateString('pt-BR') : '-';
          const infoPoco = mapaPocos[r.Po√ßoID] || { nome: r.Po√ßoID, local: '', status: '-' };
          const categoria = r.Categoria || '-';
          const autor = r.RegistradoPor || '-';
          return `
            <tr class="border-b hover:bg-gray-50">
              <td class="p-2">
                <div class="font-semibold text-gray-900">${escapeHtml(infoPoco.nome)}</div>
                <small class="text-gray-500">${escapeHtml(infoPoco.local)}</small>
              </td>
              <td class="p-2"><span class="inline-flex px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-700">${escapeHtml(infoPoco.status)}</span></td>
              <td class="p-2">${dataTexto}</td>
              <td class="p-2">${escapeHtml(r.Descri√ß√£o)}</td>
              <td class="p-2">${formatarMoeda(valor)}</td>
              <td class="p-2">${escapeHtml(categoria)}</td>
              <td class="p-2">${escapeHtml(autor)}</td>
              <td class="p-2">${r.ComprovanteURL ? `<a href="${escapeHtml(r.ComprovanteURL)}" target="_blank">üìé Ver</a>` : '-'}</td>
            </tr>`;
        }).join('');
        const selecionado = document.getElementById('pocoId').value;
        const info = mapaPocos[selecionado];
        if (info) {
          const saldo = info.previsto - info.executado;
          document.getElementById('totalizador').textContent = `üí∞ Executado neste po√ßo: ${formatarMoeda(info.executado)} | Previsto: ${formatarMoeda(info.previsto)} | Saldo: ${formatarMoeda(saldo)}`;
        } else {
          document.getElementById('totalizador').textContent = `üí∞ Total lan√ßado: ${formatarMoeda(total)}`;
        }
      }).listarPrestacoes();
    }

    carregarSelectPocos();
  })();
</script>
