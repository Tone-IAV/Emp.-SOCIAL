<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa vivo das miss√µes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/maps/highmaps.js"></script>
  <script src="https://code.highcharts.com/maps/modules/map.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; margin: 0; background: linear-gradient(180deg,#e0f2fe 0%,#f8fafc 40%,#ffffff 100%); color: #0f172a; }
    nav { background: linear-gradient(90deg,#38bdf8 0%,#2563eb 100%); color: #f8fafc; display:flex; justify-content:space-between; align-items:center; padding:14px 24px; box-shadow:0 10px 30px rgba(37,99,235,0.35); }
    nav a { color:#0f172a; background:rgba(255,255,255,0.85); padding:8px 16px; border-radius:999px; font-weight:600; text-decoration:none; box-shadow:0 6px 18px rgba(15,23,42,0.15); transition:all .2s ease; }
    nav a:hover { transform:translateY(-1px); background:#ffffff; }
    .page-wrapper { max-width:1200px; margin:0 auto; padding:36px 20px 64px; display:flex; flex-direction:column; gap:28px; }
    .hero { background: linear-gradient(160deg, rgba(37,99,235,0.18) 0%, rgba(6,182,212,0.14) 55%, rgba(14,116,144,0.12) 100%); border-radius:32px; padding:32px; box-shadow:0 30px 60px rgba(14,165,233,0.25); position:relative; overflow:hidden; }
    .hero::after { content:""; position:absolute; inset:auto -120px -120px auto; width:360px; height:360px; background:radial-gradient(circle at center, rgba(59,130,246,0.22), transparent 70%); }
    .hero > * { position:relative; z-index:1; }
    .hero h1 { font-size:2rem; font-weight:700; margin:0 0 12px; color:#0f172a; }
    .hero p { max-width:720px; font-size:1rem; color:#1e293b; }
    .resumo-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:18px; }
    .resumo-card { background:#ffffff; border-radius:20px; padding:20px; box-shadow:0 16px 36px rgba(37,99,235,0.18); display:flex; flex-direction:column; gap:8px; border:1px solid rgba(148,163,184,0.25); }
    .resumo-card span { font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:#2563eb; }
    .resumo-card strong { font-size:1.9rem; font-weight:700; color:#0f172a; }
    .resumo-card small { font-size:0.85rem; color:#475569; }
    .mapa-painel { background:rgba(255,255,255,0.94); border-radius:28px; padding:26px; box-shadow:0 30px 70px rgba(14,116,144,0.14); display:grid; gap:22px; }
    .mapa-header { display:flex; flex-direction:column; gap:10px; }
    .mapa-header h2 { font-size:1.35rem; font-weight:700; margin:0; color:#0f172a; }
    .mapa-header p { font-size:0.92rem; color:#475569; margin:0; }
    #mapaEstados { width:100%; height:520px; border-radius:20px; box-shadow:inset 0 0 0 1px rgba(14,116,144,0.12); }
    .mapa-legenda { background:rgba(191,219,254,0.9); border-radius:18px; padding:16px; font-size:0.88rem; color:#0f172a; box-shadow:0 16px 32px rgba(37,99,235,0.18); }
    .mapa-status { font-size:0.9rem; color:#0f172a; text-align:center; padding:12px; border-radius:16px; background:rgba(226,232,240,0.7); }
    .lista-estados { background:#ffffff; border-radius:26px; padding:24px; box-shadow:0 24px 54px rgba(15,23,42,0.12); }
    .lista-estados table { width:100%; border-collapse:collapse; font-size:0.92rem; }
    .lista-estados th, .lista-estados td { padding:12px 14px; text-align:left; border-bottom:1px solid rgba(226,232,240,0.9); }
    .lista-estados thead { background:rgba(191,219,254,0.35); color:#0f172a; }
    .lista-estados tbody tr:hover { background:rgba(224,242,254,0.45); }
    .badge { display:inline-flex; align-items:center; gap:6px; background:rgba(14,165,233,0.18); border-radius:999px; padding:4px 12px; font-size:0.75rem; font-weight:600; color:#0369a1; }
    @media (max-width: 768px) {
      nav { flex-direction:column; gap:12px; text-align:center; }
      .hero { padding:26px; }
      .hero h1 { font-size:1.65rem; }
    }
  </style>
</head>
<body>
  <nav>
    <strong class="text-lg tracking-tight">üí† Mapa vivo das miss√µes</strong>
    <a href="index.html">Voltar para o painel principal</a>
  </nav>
  <main class="page-wrapper">
    <section class="hero">
      <h1>Onde a miss√£o acontece em tempo real</h1>
      <p>Visualize os estados com miss√µes ativas, o volume de benefici√°rios alcan√ßados e identifique rapidamente as regi√µes que precisam de refor√ßo. Este painel geogr√°fico foi destacado para que voc√™ possa compartilh√°-lo em reuni√µes e apresenta√ß√µes sem distra√ß√µes adicionais.</p>
    </section>

    <section>
      <div id="mapaResumo" class="resumo-grid"></div>
    </section>

    <section class="mapa-painel">
      <div class="mapa-header">
        <h2>Distribui√ß√£o dos po√ßos e benefici√°rios</h2>
        <p>Selecione um estado no mapa interativo para detalhar po√ßos monitorados e pessoas alcan√ßadas. Utilize a tabela abaixo para priorizar decis√µes.</p>
      </div>
      <div id="mapaStatus" class="mapa-status">Carregando mapa em tempo real...</div>
      <div id="mapaWrapper" class="hidden">
        <div id="mapaEstados"></div>
        <div class="mapa-legenda">
          <strong class="block text-sky-800">Como interpretar:</strong>
          <span>Quanto mais intenso o tom de azul, maior o n√∫mero de benefici√°rios acompanhados. Clique em um estado para ver os totais e alinhe recursos onde a atua√ß√£o ainda √© t√≠mida.</span>
        </div>
      </div>
    </section>

    <section class="lista-estados">
      <header class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <h3 class="text-xl font-semibold text-slate-800">Prioridades por estado</h3>
        <span id="mapaAtualizacao" class="badge">Atualiza√ß√£o ao vivo</span>
      </header>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Estado</th>
              <th>Po√ßos monitorados</th>
              <th>Benefici√°rios</th>
              <th>Participa√ß√£o</th>
            </tr>
          </thead>
          <tbody id="mapaListaEstados">
            <tr>
              <td colspan="4" class="text-center text-slate-500 py-6">Carregando distribui√ß√£o por estado...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    (function() {
      const resumoContainer = document.getElementById('mapaResumo');
      const statusEl = document.getElementById('mapaStatus');
      const wrapper = document.getElementById('mapaWrapper');
      const tabelaBody = document.getElementById('mapaListaEstados');
      const badgeAtualizacao = document.getElementById('mapaAtualizacao');
      const mapaEstadosKeys = {
        AC: 'br-ac', AL: 'br-al', AM: 'br-am', AP: 'br-ap', BA: 'br-ba', CE: 'br-ce', DF: 'br-df', ES: 'br-es', GO: 'br-go',
        MA: 'br-ma', MT: 'br-mt', MS: 'br-ms', MG: 'br-mg', PA: 'br-pa', PB: 'br-pb', PR: 'br-pr', PE: 'br-pe', PI: 'br-pi',
        RJ: 'br-rj', RN: 'br-rn', RO: 'br-ro', RR: 'br-rr', RS: 'br-rs', SC: 'br-sc', SE: 'br-se', SP: 'br-sp', TO: 'br-to'
      };

      const formatarNumero = valor => {
        const numero = Number(valor) || 0;
        return numero.toLocaleString('pt-BR');
      };

      const formatarPercentual = valor => {
        const numero = Number(valor) || 0;
        if (!isFinite(numero)) return '0%';
        return `${numero.toFixed(1).replace('.', ',')}%`;
      };

      const formatarMoeda = valor => {
        const numero = Number(valor) || 0;
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(numero);
      };

      const criarCardResumo = (titulo, valor, subtitulo) => `
        <article class="resumo-card" role="group" aria-label="${titulo}">
          <span>${titulo}</span>
          <strong>${valor}</strong>
          <small>${subtitulo}</small>
        </article>
      `;

      const atualizarResumo = totais => {
        if (!resumoContainer) return;
        const totalPocos = formatarNumero(totais.totalPocos || 0);
        const concluidos = formatarNumero(totais.concluidos || 0);
        const beneficiarios = formatarNumero(totais.beneficiariosTotal || 0);
        const taxaConclusao = formatarPercentual(totais.taxaConclusao || 0);

        resumoContainer.innerHTML = [
          criarCardResumo('Po√ßos monitorados', totalPocos, `${concluidos} conclu√≠dos`),
          criarCardResumo('Benefici√°rios alcan√ßados', beneficiarios, `Taxa de conclus√£o ${taxaConclusao}`),
          criarCardResumo('Doadores ativos', formatarNumero(totais.doadoresAtivos || 0), `${formatarNumero(totais.mediaBeneficiarios || 0)} benefici√°rios por po√ßo`),
          criarCardResumo('Investimento realizado', formatarMoeda(totais.investimentoRealizado || 0), `Gap ${formatarMoeda(totais.gapFinanceiro || 0)}`)
        ].join('');
      };

      const atualizarTabela = (porEstado = []) => {
        if (!Array.isArray(porEstado) || !porEstado.length) {
          tabelaBody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 py-6">Nenhum estado com miss√µes ativas foi encontrado.</td></tr>';
          return;
        }
        const totalBeneficiarios = porEstado.reduce((acc, item) => acc + (Number(item.beneficiarios) || 0), 0);
        tabelaBody.innerHTML = porEstado.map(item => {
          const beneficiarios = Number(item.beneficiarios) || 0;
          const participacao = totalBeneficiarios ? (beneficiarios / totalBeneficiarios) * 100 : 0;
          return `
            <tr>
              <td class="font-semibold text-slate-700">${item.estado}</td>
              <td>${formatarNumero(item.pocos || 0)}</td>
              <td>${formatarNumero(beneficiarios)}</td>
              <td>${formatarPercentual(participacao)}</td>
            </tr>
          `;
        }).join('');
      };

      const renderMapa = dados => {
        if (!window.Highcharts) return;
        const container = document.getElementById('mapaEstados');
        if (!container) return;
        const serie = (dados.porEstado || [])
          .map(item => {
            const key = mapaEstadosKeys[item.estado];
            if (!key) return null;
            return {
              'hc-key': key,
              value: Number(item.beneficiarios || 0),
              pocos: Number(item.pocos || 0),
              beneficiarios: Number(item.beneficiarios || 0)
            };
          })
          .filter(Boolean);

        if (!serie.length) {
          serie.push({ 'hc-key': 'br-sp', value: 0, pocos: 0, beneficiarios: 0 });
        }

        const desenhar = geojson => {
          const createMapChart = typeof Highcharts.mapChart === 'function'
            ? Highcharts.mapChart.bind(Highcharts)
            : ((id, options) => {
                if (Highcharts && typeof Highcharts.chart === 'function') {
                  const fallbackOptions = Highcharts.merge({ chart: { type: 'map' } }, options);
                  return Highcharts.chart(id, fallbackOptions);
                }
                console.warn('Highcharts map module n√£o est√° dispon√≠vel. O mapa n√£o ser√° renderizado.');
                return null;
              });

          if (window.__mapChart) {
            window.__mapChart.update({ chart: { map: geojson } }, false);
            window.__mapChart.series[0].setData(serie, true);
            window.__mapChart.reflow();
            return;
          }

          const novoMapa = createMapChart('mapaEstados', {
            chart: { map: geojson, backgroundColor: '#f8fafc' },
            title: { text: null },
            credits: { enabled: false },
            mapNavigation: { enabled: true, enableMouseWheelZoom: false },
            colorAxis: {
              min: 0,
              stops: [
                [0, '#dbeafe'],
                [0.5, '#60a5fa'],
                [1, '#1d4ed8']
              ]
            },
            legend: {
              layout: 'horizontal',
              align: 'center',
              verticalAlign: 'bottom',
              backgroundColor: 'rgba(255,255,255,0.85)'
            },
            tooltip: {
              useHTML: true,
              pointFormatter() {
                const pocos = Highcharts.numberFormat(this.pocos || 0, 0, ',', '.');
                const beneficiarios = Highcharts.numberFormat(this.beneficiarios || 0, 0, ',', '.');
                return `<strong>${this.name}</strong><br/>Po√ßos monitorados: ${pocos}<br/>Benefici√°rios: ${beneficiarios}`;
              }
            },
            series: [{
              type: 'map',
              data: serie,
              joinBy: 'hc-key',
              name: 'Benefici√°rios atendidos',
              states: { hover: { color: '#1d4ed8' } },
              dataLabels: {
                enabled: true,
                format: '{point.properties.postal-code}',
                style: { fontWeight: '600', color: '#0f172a' }
              }
            }]
          });

          if (novoMapa) {
            window.__mapChart = novoMapa;
            window.__mapChart.reflow();
          }
        };

        if (window.__mapaBrasilGeojson) {
          desenhar(window.__mapaBrasilGeojson);
        } else {
          Highcharts.getJSON('https://code.highcharts.com/mapdata/countries/br/br-all.topo.json', geojson => {
            window.__mapaBrasilGeojson = geojson;
            desenhar(geojson);
          });
        }
      };

      const aplicarDados = dados => {
        if (!dados) {
          statusEl.textContent = 'N√£o foi poss√≠vel carregar os dados geogr√°ficos neste momento.';
          statusEl.classList.remove('hidden');
          wrapper.classList.add('hidden');
          return;
        }
        atualizarResumo(dados.totais || {});
        atualizarTabela(dados.porEstado || []);
        renderMapa(dados);
        statusEl.textContent = '';
        statusEl.classList.add('hidden');
        wrapper.classList.remove('hidden');
        if (badgeAtualizacao) {
          const agora = new Date();
          badgeAtualizacao.textContent = `Atualizado em ${agora.toLocaleString('pt-BR')}`;
        }
      };

      const carregarDados = () => {
        statusEl.classList.remove('hidden');
        statusEl.textContent = 'Carregando mapa em tempo real...';
        if (window.google && google.script && google.script.run && google.script.run.withSuccessHandler) {
          google.script.run.withSuccessHandler(aplicarDados).obterDashboardAnalitico();
          return;
        }

        statusEl.textContent = 'Carregamento autom√°tico indispon√≠vel fora do ambiente Google Apps Script.';
        statusEl.classList.remove('hidden');
        wrapper.classList.add('hidden');
      };

      carregarDados();

      window.addEventListener('resize', () => {
        if (window.__mapChart && typeof window.__mapChart.reflow === 'function') {
          window.__mapChart.reflow();
        }
      });
    })();
  </script>
</body>
</html>
