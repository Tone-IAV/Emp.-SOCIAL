<section class="mapa-module" aria-labelledby="mapaTitulo">
  <style>
    .mapa-module {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      padding: clamp(1.5rem, 3vw, 2.5rem);
      background: rgba(255, 255, 255, 0.94);
      border-radius: 28px;
      box-shadow: 0 30px 70px rgba(14, 116, 144, 0.14);
      border: 1px solid rgba(148, 163, 184, 0.22);
    }

    .mapa-module .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .mapa-module .mapa-hero {
      position: relative;
      overflow: hidden;
      border-radius: 24px;
      padding: clamp(1.8rem, 4vw, 2.6rem);
      background: linear-gradient(160deg, rgba(37,99,235,0.18) 0%, rgba(6,182,212,0.14) 55%, rgba(14,116,144,0.12) 100%);
      box-shadow: inset 0 0 0 1px rgba(148,163,184,0.12);
      display: grid;
      gap: 0.85rem;
    }

    .mapa-module .mapa-hero::after {
      content: "";
      position: absolute;
      inset: auto -120px -120px auto;
      width: 320px;
      height: 320px;
      background: radial-gradient(circle at center, rgba(59,130,246,0.22), transparent 70%);
    }

    .mapa-module .mapa-hero > * {
      position: relative;
      z-index: 1;
    }

    .mapa-module .mapa-hero h1 {
      margin: 0;
      font-size: clamp(1.8rem, 3vw, 2.1rem);
      font-weight: 700;
      color: #0f172a;
    }

    .mapa-module .mapa-hero p {
      margin: 0;
      max-width: 60ch;
      font-size: 1rem;
      line-height: 1.6;
      color: #1e293b;
    }

    .mapa-module .resumo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 1.2rem;
    }

    .mapa-module .resumo-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 1.4rem 1.6rem;
      box-shadow: 0 16px 36px rgba(37, 99, 235, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .mapa-module .resumo-card span {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #2563eb;
    }

    .mapa-module .resumo-card strong {
      font-size: 1.9rem;
      font-weight: 700;
      color: #0f172a;
    }

    .mapa-module .resumo-card small {
      font-size: 0.85rem;
      color: #475569;
    }

    .mapa-module .mapa-panel {
      display: grid;
      gap: 1.5rem;
      background: rgba(255,255,255,0.94);
      border-radius: 24px;
      padding: clamp(1.6rem, 3vw, 2.4rem);
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.18);
    }

    .mapa-module .mapa-header {
      display: grid;
      gap: 0.5rem;
    }

    .mapa-module .mapa-header h2 {
      margin: 0;
      font-size: 1.35rem;
      font-weight: 700;
      color: #0f172a;
    }

    .mapa-module .mapa-header p {
      margin: 0;
      font-size: 0.94rem;
      color: #475569;
    }

    .mapa-module .mapa-status {
      background: rgba(226, 232, 240, 0.7);
      border-radius: 16px;
      padding: 0.9rem 1.2rem;
      text-align: center;
      color: #0f172a;
      font-weight: 500;
    }

    .mapa-module .mapa-wrapper {
      display: grid;
      gap: 1rem;
    }

    .mapa-module .mapa-estados {
      width: 100%;
      height: clamp(360px, 45vw, 520px);
      border-radius: 20px;
      box-shadow: inset 0 0 0 1px rgba(14, 116, 144, 0.12);
      overflow: hidden;
    }

    .mapa-module .mapa-legenda {
      background: rgba(191, 219, 254, 0.9);
      border-radius: 18px;
      padding: 1rem 1.25rem;
      font-size: 0.88rem;
      color: #0f172a;
      box-shadow: 0 16px 32px rgba(37, 99, 235, 0.18);
      display: grid;
      gap: 0.35rem;
    }

    .mapa-module .lista-estados {
      background: #ffffff;
      border-radius: 26px;
      padding: clamp(1.4rem, 3vw, 2rem);
      box-shadow: 0 24px 54px rgba(15, 23, 42, 0.12);
      border: 1px solid rgba(226, 232, 240, 0.8);
      display: grid;
      gap: 1rem;
    }

    .mapa-module .lista-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .mapa-module .lista-header h2 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: #1e293b;
    }

    .mapa-module .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: rgba(14, 165, 233, 0.18);
      border-radius: 999px;
      padding: 0.35rem 0.85rem;
      font-size: 0.78rem;
      font-weight: 600;
      color: #0369a1;
    }

    .mapa-module .tabela-wrapper {
      overflow-x: auto;
    }

    .mapa-module table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.92rem;
    }

    .mapa-module thead {
      background: rgba(191, 219, 254, 0.35);
      color: #0f172a;
    }

    .mapa-module th,
    .mapa-module td {
      padding: 0.75rem 0.9rem;
      text-align: left;
      border-bottom: 1px solid rgba(226, 232, 240, 0.9);
    }

    .mapa-module tbody tr:hover {
      background: rgba(224, 242, 254, 0.45);
    }

    .mapa-module .text-center {
      text-align: center;
    }

    .mapa-module .text-slate-500 {
      color: #64748b;
    }

    .mapa-module .text-slate-700 {
      color: #334155;
    }

    .mapa-module .font-semibold {
      font-weight: 600;
    }

    .mapa-module .py-6 {
      padding-block: 1.5rem;
    }

    .mapa-module .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .mapa-module {
        padding: 1.2rem;
      }

      .mapa-module .mapa-hero {
        padding: 1.6rem;
      }

      .mapa-module .mapa-estados {
        height: clamp(280px, 75vw, 420px);
      }
    }
  </style>

  <header class="mapa-hero" role="group" aria-describedby="mapaIntro">
    <h1 id="mapaTitulo">Onde a missão acontece em tempo real</h1>
    <p id="mapaIntro">Visualize os estados com missões ativas, o volume de beneficiários alcançados e identifique rapidamente as regiões que precisam de reforço. Este painel geográfico foi destacado para que você possa compartilhá-lo em reuniões e apresentações sem distrações adicionais.</p>
  </header>

  <section aria-labelledby="mapaResumoTitulo">
    <h2 class="sr-only" id="mapaResumoTitulo">Resumo geral das operações</h2>
    <div id="mapaResumo" class="resumo-grid"></div>
  </section>

  <section class="mapa-panel" aria-labelledby="mapaPainelTitulo">
    <div class="mapa-header">
      <h2 id="mapaPainelTitulo">Distribuição dos poços e beneficiários</h2>
      <p>Selecione um estado no mapa interativo para detalhar poços monitorados e pessoas alcançadas. Utilize a tabela abaixo para priorizar decisões.</p>
    </div>
    <div id="mapaStatus" class="mapa-status">Carregando mapa em tempo real...</div>
    <div id="mapaWrapper" class="mapa-wrapper hidden">
      <div id="mapaEstados" class="mapa-estados"></div>
      <div class="mapa-legenda">
        <strong>Como interpretar:</strong>
        <span>Quanto mais intenso o tom de azul, maior o número de beneficiários acompanhados. Clique em um estado para ver os totais e alinhe recursos onde a atuação ainda é tímida.</span>
      </div>
    </div>
  </section>

  <section class="lista-estados" aria-labelledby="mapaTabelaTitulo">
    <div class="lista-header">
      <h2 id="mapaTabelaTitulo">Prioridades por estado</h2>
      <span id="mapaAtualizacao" class="badge">Atualização ao vivo</span>
    </div>
    <div class="tabela-wrapper">
      <table aria-describedby="mapaAtualizacao">
        <thead>
          <tr>
            <th scope="col">Estado</th>
            <th scope="col">Poços monitorados</th>
            <th scope="col">Beneficiários</th>
            <th scope="col">Participação</th>
          </tr>
        </thead>
        <tbody id="mapaListaEstados">
          <tr>
            <td colspan="4" class="text-center text-slate-500 py-6">Carregando distribuição por estado...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</section>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="https://code.highcharts.com/maps/modules/map.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script>
  (function() {
    const resumoContainer = document.getElementById('mapaResumo');
    const statusEl = document.getElementById('mapaStatus');
    const wrapper = document.getElementById('mapaWrapper');
    const tabelaBody = document.getElementById('mapaListaEstados');
    const badgeAtualizacao = document.getElementById('mapaAtualizacao');
    const mapaEstadosKeys = {
      AC: 'br-ac', AL: 'br-al', AM: 'br-am', AP: 'br-ap', BA: 'br-ba', CE: 'br-ce', DF: 'br-df', ES: 'br-es', GO: 'br-go',
      MA: 'br-ma', MT: 'br-mt', MS: 'br-ms', MG: 'br-mg', PA: 'br-pa', PB: 'br-pb', PR: 'br-pr', PE: 'br-pe', PI: 'br-pi',
      RJ: 'br-rj', RN: 'br-rn', RO: 'br-ro', RR: 'br-rr', RS: 'br-rs', SC: 'br-sc', SE: 'br-se', SP: 'br-sp', TO: 'br-to'
    };

    const formatarNumero = valor => {
      const numero = Number(valor) || 0;
      return numero.toLocaleString('pt-BR');
    };

    const formatarPercentual = valor => {
      const numero = Number(valor) || 0;
      if (!isFinite(numero)) return '0%';
      return `${numero.toFixed(1).replace('.', ',')}%`;
    };

    const formatarMoeda = valor => {
      const numero = Number(valor) || 0;
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(numero);
    };

    const criarCardResumo = (titulo, valor, subtitulo) => `
      <article class="resumo-card" role="group" aria-label="${titulo}">
        <span>${titulo}</span>
        <strong>${valor}</strong>
        <small>${subtitulo}</small>
      </article>
    `;

    const atualizarResumo = totais => {
      if (!resumoContainer) return;
      const totalPocos = formatarNumero(totais.totalPocos || 0);
      const concluidos = formatarNumero(totais.concluidos || 0);
      const beneficiarios = formatarNumero(totais.beneficiariosTotal || 0);
      const taxaConclusao = formatarPercentual(totais.taxaConclusao || 0);

      resumoContainer.innerHTML = [
        criarCardResumo('Poços monitorados', totalPocos, `${concluidos} concluídos`),
        criarCardResumo('Beneficiários alcançados', beneficiarios, `Taxa de conclusão ${taxaConclusao}`),
        criarCardResumo('Doadores ativos', formatarNumero(totais.doadoresAtivos || 0), `${formatarNumero(totais.mediaBeneficiarios || 0)} beneficiários por poço`),
        criarCardResumo('Investimento realizado', formatarMoeda(totais.investimentoRealizado || 0), `Gap ${formatarMoeda(totais.gapFinanceiro || 0)}`)
      ].join('');
    };

    const atualizarTabela = (porEstado = []) => {
      if (!Array.isArray(porEstado) || !porEstado.length) {
        tabelaBody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 py-6">Nenhum estado com missões ativas foi encontrado.</td></tr>';
        return;
      }
      const totalBeneficiarios = porEstado.reduce((acc, item) => acc + (Number(item.beneficiarios) || 0), 0);
      tabelaBody.innerHTML = porEstado.map(item => {
        const beneficiarios = Number(item.beneficiarios) || 0;
        const participacao = totalBeneficiarios ? (beneficiarios / totalBeneficiarios) * 100 : 0;
        return `
          <tr>
            <td class="font-semibold text-slate-700">${item.estado}</td>
            <td>${formatarNumero(item.pocos || 0)}</td>
            <td>${formatarNumero(beneficiarios)}</td>
            <td>${formatarPercentual(participacao)}</td>
          </tr>
        `;
      }).join('');
    };

    const renderMapa = dados => {
      if (!window.Highcharts) return;
      const container = document.getElementById('mapaEstados');
      if (!container) return;
      const serie = (dados.porEstado || [])
        .map(item => {
          const key = mapaEstadosKeys[item.estado];
          if (!key) return null;
          return {
            'hc-key': key,
            value: Number(item.beneficiarios || 0),
            pocos: Number(item.pocos || 0),
            beneficiarios: Number(item.beneficiarios || 0)
          };
        })
        .filter(Boolean);

      if (!serie.length) {
        serie.push({ 'hc-key': 'br-sp', value: 0, pocos: 0, beneficiarios: 0 });
      }

      const desenhar = geojson => {
        const createMapChart = typeof Highcharts.mapChart === 'function'
          ? Highcharts.mapChart.bind(Highcharts)
          : ((id, options) => {
              if (Highcharts && typeof Highcharts.chart === 'function') {
                const fallbackOptions = Highcharts.merge({ chart: { type: 'map' } }, options);
                return Highcharts.chart(id, fallbackOptions);
              }
              console.warn('Highcharts map module não está disponível. O mapa não será renderizado.');
              return null;
            });

        if (window.__mapChart) {
          window.__mapChart.update({ chart: { map: geojson } }, false);
          window.__mapChart.series[0].setData(serie, true);
          window.__mapChart.reflow();
          return;
        }

        const novoMapa = createMapChart('mapaEstados', {
          chart: { map: geojson, backgroundColor: '#f8fafc' },
          title: { text: null },
          credits: { enabled: false },
          mapNavigation: { enabled: true, enableMouseWheelZoom: false },
          colorAxis: {
            min: 0,
            stops: [
              [0, '#dbeafe'],
              [0.5, '#60a5fa'],
              [1, '#1d4ed8']
            ]
          },
          legend: {
            layout: 'horizontal',
            align: 'center',
            verticalAlign: 'bottom',
            backgroundColor: 'rgba(255,255,255,0.85)'
          },
          tooltip: {
            useHTML: true,
            pointFormatter() {
              const pocos = Highcharts.numberFormat(this.pocos || 0, 0, ',', '.');
              const beneficiarios = Highcharts.numberFormat(this.beneficiarios || 0, 0, ',', '.');
              return `<strong>${this.name}</strong><br/>Poços monitorados: ${pocos}<br/>Beneficiários: ${beneficiarios}`;
            }
          },
          series: [{
            type: 'map',
            data: serie,
            joinBy: 'hc-key',
            name: 'Beneficiários atendidos',
            states: { hover: { color: '#1d4ed8' } },
            dataLabels: {
              enabled: true,
              format: '{point.properties.postal-code}',
              style: { fontWeight: '600', color: '#0f172a' }
            }
          }]
        });

        if (novoMapa) {
          window.__mapChart = novoMapa;
          window.__mapChart.reflow();
        }
      };

      if (window.__mapaBrasilGeojson) {
        desenhar(window.__mapaBrasilGeojson);
      } else {
        Highcharts.getJSON('https://code.highcharts.com/mapdata/countries/br/br-all.topo.json', geojson => {
          window.__mapaBrasilGeojson = geojson;
          desenhar(geojson);
        });
      }
    };

    const construirFallbackDados = () => {
      if (window.__dadosMapaDemo && typeof window.__dadosMapaDemo === 'object') {
        return window.__dadosMapaDemo;
      }
      const totais = {
        totalPocos: 12,
        concluidos: 7,
        taxaConclusao: 0,
        beneficiariosTotal: 1840,
        mediaBeneficiarios: 0,
        doadoresAtivos: 5,
        investimentoRealizado: 520000,
        gapFinanceiro: 125000
      };
      const porEstado = [
        { estado: 'CE', pocos: 4, beneficiarios: 680 },
        { estado: 'PI', pocos: 3, beneficiarios: 420 },
        { estado: 'RN', pocos: 2, beneficiarios: 260 },
        { estado: 'PB', pocos: 2, beneficiarios: 310 },
        { estado: 'BA', pocos: 1, beneficiarios: 170 }
      ];
      const totalPocosCalculado = porEstado.reduce((acc, item) => acc + (Number(item.pocos) || 0), 0) || totais.totalPocos;
      const totalBeneficiarios = porEstado.reduce((acc, item) => acc + (Number(item.beneficiarios) || 0), 0) || totais.beneficiariosTotal;
      totais.totalPocos = totalPocosCalculado;
      totais.beneficiariosTotal = totalBeneficiarios;
      totais.mediaBeneficiarios = totalPocosCalculado ? Math.round(totalBeneficiarios / totalPocosCalculado) : 0;
      const concluidos = totais.concluidos || Math.round(totalPocosCalculado * 0.55);
      totais.concluidos = concluidos;
      totais.taxaConclusao = totalPocosCalculado ? Number(((concluidos / totalPocosCalculado) * 100).toFixed(1)) : 0;
      return { totais, porEstado };
    };

    const aplicarDados = (dados, opcoes = {}) => {
      const { manterStatus = false, statusMensagem = '' } = opcoes;
      if (!dados) {
        statusEl.textContent = 'Não foi possível carregar os dados geográficos neste momento.';
        statusEl.classList.remove('hidden');
        wrapper.classList.add('hidden');
        return;
      }
      atualizarResumo(dados.totais || {});
      atualizarTabela(dados.porEstado || []);
      renderMapa(dados);
      if (manterStatus) {
        statusEl.textContent = statusMensagem || '';
        statusEl.classList.toggle('hidden', !statusMensagem);
      } else {
        statusEl.textContent = '';
        statusEl.classList.add('hidden');
      }
      wrapper.classList.remove('hidden');
      if (badgeAtualizacao) {
        const agora = new Date();
        badgeAtualizacao.textContent = `Atualizado em ${agora.toLocaleString('pt-BR')}`;
      }
    };

    const carregarDados = () => {
      statusEl.classList.remove('hidden');
      statusEl.textContent = 'Carregando mapa em tempo real...';
      if (window.google && google.script && google.script.run && google.script.run.withSuccessHandler) {
        google.script.run.withSuccessHandler(aplicarDados).obterDashboardAnalitico();
        return;
      }

      const fallback = construirFallbackDados();
      if (fallback) {
        aplicarDados(fallback, { manterStatus: true, statusMensagem: 'Exibindo dados demonstrativos.' });
        return;
      }

      statusEl.textContent = 'Carregamento automático indisponível fora do ambiente Google Apps Script.';
      statusEl.classList.remove('hidden');
      wrapper.classList.add('hidden');
    };

    carregarDados();

    window.addEventListener('resize', () => {
      if (window.__mapChart && typeof window.__mapChart.reflow === 'function') {
        window.__mapChart.reflow();
      }
    });
  })();
</script>
