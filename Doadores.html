<div class="p-4 space-y-6">
  <div>
    <h2 class="text-xl font-bold">üí∞ Cadastro e Gerenciamento de Doadores</h2>
    <p class="text-gray-600 text-sm">Organize os dados de contato e acompanhe os dep√≥sitos realizados por cada parceiro.</p>
  </div>

  <div class="flex flex-wrap gap-2">
    <button id="btnNovoDoador" type="button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
      ‚ûï Novo doador
    </button>
    <button id="btnNovoDeposito" type="button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
      üí∏ Novo dep√≥sito
    </button>
  </div>

  <form id="formDoador" class="bg-white rounded-lg shadow p-4 space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h3 class="font-semibold">Cadastrar novo doador</h3>
      <button type="button" data-close="doador" class="text-sm text-gray-500 hover:text-gray-700">Fechar</button>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Nome do doador</label>
      <input type="text" id="nome" class="border p-2 w-full rounded" required>
    </div>
    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">Email</label>
        <input type="email" id="email" class="border p-2 w-full rounded" placeholder="contato@exemplo.org">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Telefone</label>
        <input type="text" id="telefone" class="border p-2 w-full rounded" placeholder="(00) 90000-0000">
      </div>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Observa√ß√µes</label>
      <textarea id="observacoes" rows="3" class="border p-2 w-full rounded" placeholder="Refer√™ncias, foco de atua√ß√£o, contatos adicionais..."></textarea>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Po√ßos para vincular</label>
      <select id="pocosSelect" multiple class="border p-2 w-full rounded h-32"></select>
      <small class="text-gray-500">Segure CTRL (ou ‚åò no Mac) para selecionar m√∫ltiplos.</small>
    </div>

    <div class="flex gap-2">
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üíæ Salvar doador</button>
      <button type="reset" class="px-4 py-2 rounded border" data-reset="doador">Limpar</button>
    </div>
  </form>

  <form id="formDeposito" class="bg-white rounded-lg shadow p-4 space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h3 class="font-semibold">Registrar novo dep√≥sito</h3>
      <button type="button" data-close="deposito" class="text-sm text-gray-500 hover:text-gray-700">Fechar</button>
    </div>
    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">Doador</label>
        <select id="depositoDoador" class="border p-2 w-full rounded" required></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Valor (R$)</label>
        <input type="number" id="valorDeposito" step="0.01" min="0" class="border p-2 w-full rounded" required>
      </div>
    </div>
    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">Data do dep√≥sito</label>
        <input type="date" id="dataDeposito" class="border p-2 w-full rounded">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">M√©todo</label>
        <input type="text" id="metodoDeposito" class="border p-2 w-full rounded" placeholder="PIX, TED, Boleto...">
      </div>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Observa√ß√µes</label>
      <textarea id="observacoesDeposito" rows="3" class="border p-2 w-full rounded" placeholder="Informe detalhes relevantes do dep√≥sito"></textarea>
    </div>
    <div class="flex gap-2">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">üí∏ Registrar dep√≥sito</button>
      <button type="reset" class="px-4 py-2 rounded border" data-reset="deposito">Limpar</button>
    </div>
  </form>

  <div>
    <h3 class="font-semibold mb-2">Lista de doadores e dep√≥sitos</h3>
    <div class="overflow-x-auto">
      <table id="tabelaDoadores" class="w-full bg-white rounded shadow overflow-hidden">
        <thead class="bg-green-100 text-sm">
          <tr>
            <th class="p-3 text-left">Doador</th>
            <th class="p-3 text-left">Contato</th>
            <th class="p-3 text-left">Total doado</th>
            <th class="p-3 text-left">√öltimo dep√≥sito</th>
            <th class="p-3 text-left">Dep√≥sitos registrados</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="msgDoador" class="mt-2 font-semibold hidden"></div>
</div>

<script>
  (() => {
    const { escapeHtml, formatarMoeda } = window;
    const formDoador = document.getElementById('formDoador');
    const formDeposito = document.getElementById('formDeposito');
    const btnNovoDoador = document.getElementById('btnNovoDoador');
    const btnNovoDeposito = document.getElementById('btnNovoDeposito');
    const mensagem = document.getElementById('msgDoador');

    function limparMensagem() {
      if (!mensagem) return;
      mensagem.textContent = '';
      mensagem.classList.add('hidden');
      mensagem.classList.remove('text-green-700', 'text-red-600');
    }

    function mostrarMensagem(texto, erro = false) {
      if (!mensagem) return;
      mensagem.textContent = texto;
      mensagem.classList.remove('hidden');
      mensagem.classList.toggle('text-red-600', erro);
      mensagem.classList.toggle('text-green-700', !erro);
    }

    function alternarSecao(secao) {
      limparMensagem();
      if (secao === 'doador') {
        formDoador.classList.toggle('hidden');
        if (!formDoador.classList.contains('hidden')) {
          formDeposito.classList.add('hidden');
        }
      } else if (secao === 'deposito') {
        formDeposito.classList.toggle('hidden');
        if (!formDeposito.classList.contains('hidden')) {
          formDoador.classList.add('hidden');
        }
      }
    }

    btnNovoDoador.addEventListener('click', () => alternarSecao('doador'));
    btnNovoDeposito.addEventListener('click', () => alternarSecao('deposito'));

    document.querySelectorAll('button[data-close]').forEach(btn => {
      btn.addEventListener('click', () => {
        const alvo = btn.getAttribute('data-close');
        if (alvo === 'doador') formDoador.classList.add('hidden');
        if (alvo === 'deposito') formDeposito.classList.add('hidden');
      });
    });

    document.querySelectorAll('button[data-reset]').forEach(btn => {
      btn.addEventListener('click', () => limparMensagem());
    });

    function carregarSelectPocos() {
      google.script.run.withSuccessHandler(pocos => {
        const select = document.getElementById('pocosSelect');
        if (!select) return;
        if (!pocos.length) {
          select.innerHTML = '<option value="" disabled>Nenhum po√ßo cadastrado</option>';
          return;
        }
        const options = pocos.map(p => {
          const nome = p['Comunidade'] || p['Munic√≠pio'] || p['Estado'] || 'Po√ßo sem nome';
          const local = [p['Munic√≠pio'], p['Estado']].filter(Boolean).join(' - ');
          return `<option value="${p.ID}">${escapeHtml(nome)} (${escapeHtml(local || 'Local n√£o informado')})</option>`;
        });
        select.innerHTML = options.join('');
      }).listarPocos();
    }

    function preencherSelectDoadores(doadores) {
      const select = document.getElementById('depositoDoador');
      if (!select) return;
      if (!doadores.length) {
        select.innerHTML = '<option value="" disabled>Cadastre um doador antes de registrar dep√≥sitos</option>';
        select.disabled = true;
        return;
      }
      const options = ['<option value="" disabled selected>Selecione um doador</option>']
        .concat(doadores.map(d => `<option value="${d.ID}">${escapeHtml(d.Nome)}</option>`));
      select.innerHTML = options.join('');
      select.disabled = false;
    }

    formDoador.addEventListener('submit', e => {
      e.preventDefault();
      limparMensagem();
      const nome = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const observacoes = document.getElementById('observacoes').value.trim();
      const pocosSelecionados = Array.from(document.getElementById('pocosSelect').selectedOptions).map(o => o.value);

      const doador = { nome, email, telefone, observacoes };

      google.script.run
        .withSuccessHandler(res => {
          if (!res || !res.success) {
            mostrarMensagem(res && res.mensagem ? res.mensagem : 'Erro ao salvar doador.', true);
            return;
          }
          if (pocosSelecionados.length > 0) {
            google.script.run.vincularDoadorAPocos(res.id, pocosSelecionados);
          }
          mostrarMensagem('‚úÖ Doador salvo com sucesso!');
          e.target.reset();
          formDoador.classList.add('hidden');
          carregarDoadores();
        })
        .withFailureHandler(erro => mostrarMensagem(erro && erro.message ? erro.message : 'Erro ao salvar doador.', true))
        .salvarDoador(doador);
    });

    formDeposito.addEventListener('submit', e => {
      e.preventDefault();
      limparMensagem();
      const doadorId = document.getElementById('depositoDoador').value;
      const valor = document.getElementById('valorDeposito').value;
      const data = document.getElementById('dataDeposito').value;
      const metodo = document.getElementById('metodoDeposito').value.trim();
      const observacoes = document.getElementById('observacoesDeposito').value.trim();

      if (!doadorId) {
        mostrarMensagem('Selecione um doador para registrar o dep√≥sito.', true);
        return;
      }

      const valorNumerico = Number(valor);
      if (!Number.isFinite(valorNumerico) || valorNumerico <= 0) {
        mostrarMensagem('Informe um valor de dep√≥sito v√°lido.', true);
        return;
      }

      const registro = { doadorId, valor, data, metodo, observacoes };

      google.script.run
        .withSuccessHandler(res => {
          if (!res || !res.success) {
            mostrarMensagem(res && res.mensagem ? res.mensagem : 'Erro ao registrar dep√≥sito.', true);
            return;
          }
          mostrarMensagem('üí∏ Dep√≥sito registrado com sucesso!');
          e.target.reset();
          formDeposito.classList.add('hidden');
          carregarDoadores();
        })
        .withFailureHandler(erro => mostrarMensagem(erro && erro.message ? erro.message : 'Erro ao registrar dep√≥sito.', true))
        .registrarDeposito(registro);
    });

    function formatarData(valor) {
      if (!valor) return '-';
      const data = new Date(valor);
      return Number.isNaN(data.getTime()) ? '-' : data.toLocaleDateString('pt-BR');
    }

    function carregarDoadores() {
      google.script.run.withSuccessHandler(doadores => {
        preencherSelectDoadores(doadores);
        const tbody = document.querySelector('#tabelaDoadores tbody');
        if (!tbody) return;
        if (!doadores.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-6">Nenhum doador cadastrado at√© o momento.</td></tr>';
          return;
        }
        tbody.innerHTML = doadores.map(d => {
          const total = formatarMoeda(d.ValorDoado || 0);
          const ultimoDeposito = formatarData(d.DataDoacao);
          const quantidadeDepositos = Number(d.QuantidadeDepositos || (Array.isArray(d.Depositos) ? d.Depositos.length : 0));
          const contato = [
            d.Email ? `<div class="text-sm">üìß ${escapeHtml(d.Email)}</div>` : '',
            d.Telefone ? `<div class="text-sm">üìû ${escapeHtml(d.Telefone)}</div>` : ''
          ].filter(Boolean).join('') || '<span class="text-gray-500 text-sm">Sem contato informado</span>';

          const depositos = Array.isArray(d.Depositos) ? d.Depositos : [];
          const depositosHtml = depositos.length
            ? depositos.map(dep => {
                const dataTexto = formatarData(dep.DataDeposito);
                const valorDeposito = formatarMoeda(dep.Valor || 0);
                const metodo = dep.Metodo ? ` ¬∑ ${escapeHtml(dep.Metodo)}` : '';
                return `<div class="flex items-center justify-between gap-2 text-xs bg-gray-50 border rounded px-2 py-1">`
                  + `<span>${escapeHtml(dataTexto)}${metodo}</span>`
                  + `<span class="font-semibold">${valorDeposito}</span>`
                  + `</div>`;
              }).join('')
            : '<span class="text-gray-500 text-sm">Sem dep√≥sitos registrados</span>';

          return `
            <tr class="border-b last:border-b-0 hover:bg-gray-50">
              <td class="p-3 align-top">
                <div class="font-semibold">${escapeHtml(d.Nome)}</div>
                ${d.Observacoes ? `<div class="text-xs text-gray-500 mt-1">${escapeHtml(d.Observacoes)}</div>` : ''}
              </td>
              <td class="p-3 align-top">${contato}</td>
              <td class="p-3 align-top">
                <div class="font-semibold">${total}</div>
                <div class="text-xs text-gray-500">${quantidadeDepositos} dep√≥sito(s)</div>
              </td>
              <td class="p-3 align-top">${escapeHtml(ultimoDeposito)}</td>
              <td class="p-3 space-y-1 align-top">${depositosHtml}</td>
            </tr>
          `;
        }).join('');
      }).listarDoadores();
    }

    carregarSelectPocos();
    carregarDoadores();
  })();
</script>
