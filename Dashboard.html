<div class="space-y-6">
  <style>
    .dash-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.08);
      position: relative;
      overflow: hidden;
    }
    .dash-card .dash-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1d4ed8;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .dash-card .dash-value {
      font-size: 2rem;
      font-weight: 700;
      margin: 0.75rem 0 0.5rem;
    }
    .dash-card .dash-detail {
      font-size: 0.9rem;
      color: #64748b;
    }
    .dash-card::after {
      content: "";
      position: absolute;
      inset: auto -40% -40% auto;
      width: 160px;
      height: 160px;
      background: radial-gradient(circle at center, rgba(37, 99, 235, 0.18), transparent 70%);
      z-index: 0;
    }
    .dash-card > * { position: relative; z-index: 1; }

    .dashboard-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1rem;
    }

    .mini-card {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(14, 165, 233, 0.12));
      border-radius: 12px;
      padding: 0.9rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      min-height: 92px;
    }
    .mini-card .mini-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #2563eb;
      font-weight: 600;
    }
    .mini-card .mini-value {
      font-size: 1.35rem;
      font-weight: 700;
      color: #0f172a;
    }
    .mini-card .mini-detail {
      font-size: 0.8rem;
      color: #475569;
    }

    .table-dashboard {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .table-dashboard thead {
      background: #eff6ff;
      color: #1d4ed8;
    }
    .table-dashboard th,
    .table-dashboard td {
      padding: 0.75rem 0.85rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.78rem;
      font-weight: 600;
      padding: 0.2rem 0.75rem;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }
    .empty-state {
      text-align: center;
      padding: 1rem;
      color: #6b7280;
      font-size: 0.9rem;
    }
  </style>

  <div class="grid gap-4 lg:grid-cols-2">
    <div class="dash-card">
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <h3 class="dashboard-section-title">Poços instalados em <span id="anoReferenciaTitulo"></span></h3>
          <p class="dash-detail">Indicadores espelhados do painel legado anual</p>
        </div>
        <div class="text-right">
          <p class="dash-value" id="totalInstalacoesAno"></p>
          <span class="dash-detail">Conclusões registradas no ano</span>
        </div>
      </div>
      <div class="grid gap-3 sm:grid-cols-2 mt-4" id="indicadoresAno"></div>
    </div>
    <div class="dash-card">
      <h3 class="dashboard-section-title">Panorama hídrico e tipologia</h3>
      <div class="grid gap-3 sm:grid-cols-2" id="indicadoresHidricos"></div>
    </div>
  </div>

  <div class="dash-card">
    <h3 class="dashboard-section-title">Histórico de instalações por ano</h3>
    <div class="overflow-x-auto">
      <table class="table-dashboard" id="tabelaHistoricoInstalacoes">
        <thead>
          <tr>
            <th>Ano</th>
            <th>Poços concluídos</th>
            <th>Investimento realizado</th>
            <th>Beneficiários</th>
            <th>Metros perfurados</th>
            <th>Vazão estimada/dia</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="dash-card">
    <h3 class="dashboard-section-title">Ações pós-instalação e usos comunitários da água</h3>
    <div class="overflow-x-auto">
      <table class="table-dashboard" id="tabelaAcoesPosInstalacao">
        <thead>
          <tr>
            <th>Poço / Comunidade</th>
            <th>Estado</th>
            <th>Situação hídrica</th>
            <th>Ações pós-instalação</th>
            <th>Usos da água</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="dash-card">
    <h3 class="dashboard-section-title">Resumo geral dos projetos</h3>
    <div class="grid gap-4 md:grid-cols-4" id="indicadoresPrincipais"></div>
  </div>

  <div class="dash-card">
    <h3 class="dashboard-section-title">Situação financeira consolidada</h3>
    <div class="grid gap-4 md:grid-cols-3" id="indicadoresFinanceiros"></div>
  </div>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="dash-card">
      <h3 class="dashboard-section-title">Distribuição dos poços por status</h3>
      <canvas id="graficoStatus" height="220"></canvas>
    </div>
    <div class="dash-card">
      <h3 class="dashboard-section-title">Pipeline de contatos de instalação</h3>
      <canvas id="graficoPipeline" height="220"></canvas>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="dash-card">
      <h3 class="dashboard-section-title">Investimentos previstos x realizados</h3>
      <canvas id="graficoFinanceiro" height="220"></canvas>
    </div>
    <div class="dash-card">
      <h3 class="dashboard-section-title">Beneficiários por estado</h3>
      <canvas id="graficoBeneficiarios" height="220"></canvas>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="dash-card">
      <h3 class="dashboard-section-title">Doadores em destaque</h3>
      <div class="overflow-x-auto">
        <table class="table-dashboard" id="tabelaDoadoresDestaque">
          <thead>
            <tr>
              <th>Doador</th>
              <th>Valor doado</th>
              <th>Beneficiários apoiados</th>
              <th>Poços financiados</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="dash-card">
      <h3 class="dashboard-section-title">Alertas operacionais</h3>
      <div class="overflow-x-auto">
        <table class="table-dashboard" id="tabelaAlertas">
          <thead>
            <tr>
              <th>Poço</th>
              <th>Motivo</th>
              <th>Responsável</th>
              <th>Próxima ação</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="dash-card">
      <h3 class="dashboard-section-title">Próximas ações críticas</h3>
      <div class="overflow-x-auto">
        <table class="table-dashboard" id="tabelaProximasAcoes">
          <thead>
            <tr>
              <th>Poço / Localidade</th>
              <th>Responsável</th>
              <th>Próxima ação</th>
              <th>Contato</th>
              <th>Último contato</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="dash-card">
      <h3 class="dashboard-section-title">Últimos contatos registrados</h3>
      <div class="overflow-x-auto">
        <table class="table-dashboard" id="tabelaUltimosContatos">
          <thead>
            <tr>
              <th>Data</th>
              <th>Poço</th>
              <th>Contato</th>
              <th>Responsável</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="dash-card">
    <h3 class="dashboard-section-title">Gastos por categoria de prestação de contas</h3>
    <canvas id="graficoGastos" height="240"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (() => {
    const chartsDashboard = {};
    const { escapeHtml, formatarNumero, formatarMoeda } = window;

    const formatarPercentual = valor => `${Number(valor || 0).toFixed(1)}%`;

    function criarCard(titulo, valor, detalhe) {
      return `
        <div class="dash-card">
          <span class="dash-title">${titulo}</span>
          <p class="dash-value">${valor}</p>
          <span class="dash-detail">${detalhe || ''}</span>
        </div>
      `;
    }

    function criarMiniCard(titulo, valor, detalhe) {
      return `
        <div class="mini-card">
          <span class="mini-title">${titulo}</span>
          <span class="mini-value">${valor}</span>
          <span class="mini-detail">${detalhe || ''}</span>
        </div>
      `;
    }

    function formatarLitrosDia(valor) {
      const numeroValor = Number(valor || 0);
      if (numeroValor >= 1e9) return `${(numeroValor / 1e9).toFixed(2)} bi L/dia`;
      if (numeroValor >= 1e6) return `${(numeroValor / 1e6).toFixed(2)} mi L/dia`;
      if (numeroValor >= 1e3) return `${(numeroValor / 1e3).toFixed(1)} mil L/dia`;
      return `${formatarNumero(numeroValor, 0)} L/dia`;
    }

    function renderTabela(elementId, linhas, template, colunas = 5) {
      const corpo = document.querySelector(`#${elementId} tbody`);
      if (!linhas || !linhas.length) {
        corpo.innerHTML = `<tr><td colspan="${colunas}" class="empty-state">Sem registros até o momento.</td></tr>`;
        return;
      }
      corpo.innerHTML = linhas.map(template).join('');
    }

    function renderChart(id, config) {
      if (chartsDashboard[id]) chartsDashboard[id].destroy();
      const ctx = document.getElementById(id);
      if (!ctx) return;
      chartsDashboard[id] = new Chart(ctx, config);
    }

    function renderDashboard(dados) {
      const totais = dados.totais || {};
      const indicadoresLegado = dados.indicadoresLegado || {};
      const hidricos = dados.hidricos || {};
      const historico = indicadoresLegado.historico || [];
      const acoesPos = dados.acoesPosInstalacao || [];

      const anoAtual = indicadoresLegado.anoReferencia || new Date().getFullYear();
      const totalAno = indicadoresLegado.totalInstaladoAno || 0;

      const elAnoReferencia = document.getElementById('anoReferenciaTitulo');
      const elTotalAno = document.getElementById('totalInstalacoesAno');
      if (elAnoReferencia) elAnoReferencia.textContent = anoAtual;
      if (elTotalAno) elTotalAno.textContent = formatarNumero(totalAno || 0);

      const containerIndicadoresAno = document.getElementById('indicadoresAno');
      if (containerIndicadoresAno) {
        if (totalAno) {
          containerIndicadoresAno.innerHTML = [
            criarMiniCard('Investimento realizado', formatarMoeda(indicadoresLegado.investimentoAno || 0), 'Somatório dos poços entregues'),
            criarMiniCard('Beneficiários alcançados', formatarNumero(indicadoresLegado.beneficiariosAno || 0), 'Pessoas beneficiadas em campo'),
            criarMiniCard('Metros perfurados', formatarNumero(indicadoresLegado.metrosPerfuradosAno || 0), 'Extensão perfurada no ano'),
            criarMiniCard('Vazão estimada por dia', formatarLitrosDia(indicadoresLegado.vazaoDiaAno || 0), 'Capacidade combinada dos poços concluídos')
          ].join('');
        } else {
          containerIndicadoresAno.innerHTML = '<div class="empty-state" style="grid-column:1/-1;">Nenhum poço foi concluído neste ano até o momento.</div>';
        }
      }

      const containerHidricos = document.getElementById('indicadoresHidricos');
      if (containerHidricos) {
        containerHidricos.innerHTML = [
          criarMiniCard('Poços secos identificados', formatarNumero(hidricos.pocosSecos || 0), 'Prioridade para revisão técnica'),
          criarMiniCard('Poços artesianos', formatarNumero(hidricos.pocosArtesianos || 0), `Do total monitorado (${formatarNumero(hidricos.totalMonitorados || 0)})`),
          criarMiniCard('Metros perfurados (total)', formatarNumero(hidricos.totalMetrosPerfurados || 0), 'Somatório do portfólio'),
          criarMiniCard('Vazão estimada/dia', formatarLitrosDia(hidricos.totalVazaoDia || 0), `Média ${formatarLitrosDia(hidricos.mediaVazaoDia || 0)} por poço`)
        ].join('');
      }

      document.getElementById('indicadoresPrincipais').innerHTML = [
        criarCard('Poços monitorados', formatarNumero(totais.totalPocos || 0), `${formatarNumero(totais.concluidos || 0)} concluídos`),
        criarCard('Taxa de conclusão', formatarPercentual(totais.taxaConclusao || 0), 'Percentual de poços entregues'),
        criarCard('Beneficiários alcançados', formatarNumero(totais.beneficiariosTotal || 0), `Média de ${formatarNumero(totais.mediaBeneficiarios || 0, 1)} por poço`),
        criarCard('Doadores ativos', formatarNumero(totais.doadoresAtivos || 0), `Total doado ${formatarMoeda(totais.doacoesTotais || 0)}`)
      ].join('');

      document.getElementById('indicadoresFinanceiros').innerHTML = [
        criarCard('Investimento previsto', formatarMoeda(totais.investimentoPrevisto || 0), 'Perfuração + instalação'),
        criarCard('Investimento planejado', formatarMoeda(totais.investimentoPlanejado || 0), 'Valor declarado pelos projetos'),
        criarCard('Valor realizado', formatarMoeda(totais.investimentoRealizado || 0), `Gap atual ${formatarMoeda(totais.gapFinanceiro || 0)}`)
      ].join('');

      const coresBase = ['#1d4ed8', '#38bdf8', '#2563eb', '#0ea5e9', '#3b82f6', '#0284c7'];

      const distStatus = dados.distribuicaoStatus || [];
      renderChart('graficoStatus', {
        type: 'doughnut',
        data: {
          labels: distStatus.map(s => s.status),
          datasets: [{
            data: distStatus.map(s => s.total),
            backgroundColor: coresBase,
            borderWidth: 0
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      const pipeline = dados.pipelineContatos || [];
      renderChart('graficoPipeline', {
        type: 'bar',
        data: {
          labels: pipeline.map(p => p.status),
          datasets: [{
            label: 'Poços',
            data: pipeline.map(p => p.total),
            backgroundColor: '#1d4ed8',
            borderRadius: 8
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });

      renderChart('graficoFinanceiro', {
        type: 'bar',
        data: {
          labels: ['Previsto', 'Planejado', 'Realizado'],
          datasets: [{
            label: 'R$ (milhares)',
            data: [totais.investimentoPrevisto || 0, totais.investimentoPlanejado || 0, totais.investimentoRealizado || 0],
            backgroundColor: ['#2563eb', '#3b82f6', '#1d4ed8'],
            borderRadius: 10
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: valor => `R$ ${(valor / 1000).toLocaleString('pt-BR')}k`
              }
            }
          }
        }
      });

      const estados = dados.porEstado || [];
      renderChart('graficoBeneficiarios', {
        type: 'horizontalBar' in Chart.controllers ? 'horizontalBar' : 'bar',
        data: {
          labels: estados.map(e => e.estado),
          datasets: [{
            label: 'Beneficiários',
            data: estados.map(e => e.beneficiarios),
            backgroundColor: '#38bdf8',
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          plugins: { legend: { display: false } },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });

      const gastos = dados.gastosPorCategoria || [];
      renderChart('graficoGastos', {
        type: 'bar',
        data: {
          labels: gastos.map(g => g.categoria),
          datasets: [{
            label: 'Valor gasto',
            data: gastos.map(g => g.valor),
            backgroundColor: '#0ea5e9',
            borderRadius: 8
          }]
        },
        options: {
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${formatarMoeda(ctx.parsed.y)}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: valor => formatarMoeda(valor)
              }
            }
          }
        }
      });

      renderTabela('tabelaDoadoresDestaque', dados.doadoresDestaque, item => {
        return `
          <tr>
            <td>${escapeHtml(item.nome)}</td>
            <td>${formatarMoeda(item.valor)}</td>
            <td>${formatarNumero(item.beneficiariosApoiados)}</td>
            <td>${formatarNumero(item.quantidadePocos)}</td>
          </tr>
        `;
      }, 4);

      renderTabela('tabelaAlertas', dados.alertas, item => {
        return `
          <tr>
            <td>${escapeHtml(item.poco)}</td>
            <td>${escapeHtml(item.motivo)}</td>
            <td>${escapeHtml(item.responsavel)}</td>
            <td>${escapeHtml(item.proximaAcao)}</td>
            <td><span class="status-pill">${escapeHtml(item.status)}</span></td>
          </tr>
        `;
      });

      renderTabela('tabelaProximasAcoes', dados.proximasAcoes, item => {
        const ultimoContatoData = item.ultimoContato ? new Date(item.ultimoContato) : null;
        const ultimoContato = ultimoContatoData && !isNaN(ultimoContatoData)
          ? ultimoContatoData.toLocaleDateString('pt-BR')
          : '-';
        const dias = item.diasSemContato != null ? `${item.diasSemContato} dias` : 'Sem registro';
        return `
          <tr>
            <td>${escapeHtml(item.poco)}</td>
            <td>${escapeHtml(item.responsavel || '-')}</td>
            <td>
              <div>${escapeHtml(item.proximaAcao || '-')}</div>
              ${item.impacto ? `<small style="color:#64748b;">Impacto: ${escapeHtml(item.impacto)}</small>` : ''}
              ${item.situacaoHidrica ? `<small style="color:#0f172a;">Situação hídrica: ${escapeHtml(item.situacaoHidrica)}</small>` : ''}
            </td>
            <td>
              <div>${escapeHtml(item.contato || '-')}</div>
              <span class="status-pill">${escapeHtml(item.statusContato)}</span>
            </td>
            <td>
              <div>${ultimoContato}</div>
              <small style="color:#64748b;">${dias}</small>
            </td>
          </tr>
        `;
      });

      renderTabela('tabelaUltimosContatos', dados.ultimosContatos, item => {
        const dataContato = item.data ? new Date(item.data) : null;
        const dataTexto = dataContato && !isNaN(dataContato)
          ? dataContato.toLocaleDateString('pt-BR')
          : '-';
        return `
          <tr>
            <td>${dataTexto}</td>
            <td>${escapeHtml(item.poco)}</td>
            <td>${escapeHtml(item.contato)}</td>
            <td>${escapeHtml(item.responsavel)}</td>
            <td><span class="status-pill">${escapeHtml(item.status)}</span></td>
          </tr>
        `;
      });

      renderTabela('tabelaHistoricoInstalacoes', historico, item => {
        return `
          <tr>
            <td>${escapeHtml(String(item.ano || '-'))}</td>
            <td>${formatarNumero(item.total || 0)}</td>
            <td>${formatarMoeda(item.investimento || 0)}</td>
            <td>${formatarNumero(item.beneficiarios || 0)}</td>
            <td>${formatarNumero(item.metros || 0)}</td>
            <td>${formatarLitrosDia(item.vazaoDia || 0)}</td>
          </tr>
        `;
      }, 6);

      renderTabela('tabelaAcoesPosInstalacao', acoesPos, item => {
        const acoes = item.acoes ? escapeHtml(item.acoes).replace(/\n/g, '<br>') : '-';
        const usos = item.usos ? escapeHtml(item.usos).replace(/\n/g, '<br>') : '-';
        return `
          <tr>
            <td>${escapeHtml(item.poco)}</td>
            <td>${escapeHtml(item.estado || '-')}</td>
            <td>${escapeHtml(item.situacaoHidrica || '-')}</td>
            <td>${acoes}</td>
            <td>${usos}</td>
          </tr>
        `;
      }, 5);
    }

    google.script.run.withSuccessHandler(renderDashboard).obterDashboardAnalitico();
  })();
</script>
