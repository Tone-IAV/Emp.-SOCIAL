<div class="space-y-6">
  <style>
    .dash-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.08);
      position: relative;
      overflow: hidden;
    }
    .dash-card .dash-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1d4ed8;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .dash-card .dash-value {
      font-size: 2rem;
      font-weight: 700;
      margin: 0.75rem 0 0.5rem;
    }
    .dash-card .dash-detail {
      font-size: 0.9rem;
      color: #64748b;
    }
    .dash-card::after {
      content: "";
      position: absolute;
      inset: auto -40% -40% auto;
      width: 160px;
      height: 160px;
      background: radial-gradient(circle at center, rgba(37, 99, 235, 0.18), transparent 70%);
      z-index: 0;
    }
    .dash-card > * { position: relative; z-index: 1; }

    .dashboard-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1rem;
    }

    .mini-card {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(14, 165, 233, 0.12));
      border-radius: 12px;
      padding: 0.9rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      min-height: 92px;
    }
    .mini-card .mini-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #2563eb;
      font-weight: 600;
    }
    .mini-card .mini-value {
      font-size: 1.35rem;
      font-weight: 700;
      color: #0f172a;
    }
    .mini-card .mini-detail {
      font-size: 0.8rem;
      color: #475569;
    }

    .table-dashboard {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .table-dashboard thead {
      background: #eff6ff;
      color: #1d4ed8;
    }
    .table-dashboard th,
    .table-dashboard td {
      padding: 0.75rem 0.85rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }
    .chart-box { min-height: 240px; }
    .card-header { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; }
    .toggle-card {
      background: #eff6ff;
      color: #1d4ed8;
      border: none;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.35rem 0.85rem;
      cursor: pointer;
      transition: all .2s ease;
    }
    .toggle-card:hover { background: #dbeafe; transform: translateY(-1px); }
    .collapsible {
      overflow: hidden;
      transition: max-height .3s ease, opacity .3s ease;
      max-height: 1600px;
      opacity: 1;
    }
    .collapsible.collapsed {
      max-height: 0;
      opacity: 0;
      pointer-events: none;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.78rem;
      font-weight: 600;
      padding: 0.2rem 0.75rem;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }
    .empty-state {
      text-align: center;
      padding: 1rem;
      color: #6b7280;
      font-size: 0.9rem;
    }
  </style>

  <div class="grid gap-4 lg:grid-cols-2">
    <div class="dash-card">
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <h3 class="dashboard-section-title">Poços instalados em <span id="anoReferenciaTitulo"></span></h3>
          <p class="dash-detail">Indicadores espelhados do painel legado anual</p>
        </div>
        <div class="text-right">
          <p class="dash-value" id="totalInstalacoesAno"></p>
          <span class="dash-detail">Conclusões registradas no ano</span>
        </div>
      </div>
      <div class="grid gap-3 sm:grid-cols-2 mt-4" id="indicadoresAno"></div>
    </div>
    <div class="dash-card">
      <h3 class="dashboard-section-title">Panorama hídrico e tipologia</h3>
      <div class="grid gap-3 sm:grid-cols-2" id="indicadoresHidricos"></div>
    </div>
  </div>

  <div class="dash-card">
    <h3 class="dashboard-section-title">Histórico de instalações por ano</h3>
    <div class="overflow-x-auto">
      <table class="table-dashboard" id="tabelaHistoricoInstalacoes">
        <thead>
          <tr>
            <th>Ano</th>
            <th>Poços concluídos</th>
            <th>Investimento realizado</th>
            <th>Beneficiários</th>
            <th>Metros perfurados</th>
            <th>Vazão estimada/dia</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="dash-card">
    <h3 class="dashboard-section-title">Ações pós-instalação e usos comunitários da água</h3>
    <div class="overflow-x-auto">
      <table class="table-dashboard" id="tabelaAcoesPosInstalacao">
        <thead>
          <tr>
            <th>Poço / Comunidade</th>
            <th>Estado</th>
            <th>Situação hídrica</th>
            <th>Ações pós-instalação</th>
            <th>Usos da água</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="dash-card">
    <h3 class="dashboard-section-title">Resumo geral dos projetos</h3>
    <div class="grid gap-4 md:grid-cols-4" id="indicadoresPrincipais"></div>
  </div>

  <div class="dash-card">
    <h3 class="dashboard-section-title">Situação financeira consolidada</h3>
    <div class="grid gap-4 md:grid-cols-3" id="indicadoresFinanceiros"></div>
  </div>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="dash-card">
      <h3 class="dashboard-section-title">Distribuição dos poços por status</h3>
      <div id="graficoStatus" class="chart-box"></div>
    </div>
    <div class="dash-card">
      <h3 class="dashboard-section-title">Pipeline de contatos de instalação</h3>
      <div id="graficoPipeline" class="chart-box"></div>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="dash-card">
      <h3 class="dashboard-section-title">Investimentos previstos x realizados</h3>
      <div id="graficoFinanceiro" class="chart-box"></div>
    </div>
    <div class="dash-card">
      <h3 class="dashboard-section-title">Beneficiários por estado</h3>
      <div id="graficoBeneficiarios" class="chart-box"></div>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-2">
  <div class="dash-card">
    <div class="card-header">
      <h3 class="dashboard-section-title">Doadores em destaque</h3>
      <button class="toggle-card" data-target="blocoDoadores" data-start="collapsed">Mostrar detalhes</button>
    </div>
    <div id="blocoDoadores" class="collapsible collapsed">
      <div class="overflow-x-auto">
        <table class="table-dashboard" id="tabelaDoadoresDestaque">
          <thead>
            <tr>
              <th>Doador</th>
              <th>Valor doado</th>
              <th>Beneficiários apoiados</th>
              <th>Poços financiados</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
    <div class="dash-card">
      <div class="card-header">
        <h3 class="dashboard-section-title">Alertas operacionais</h3>
        <button class="toggle-card" data-target="blocoAlertas" data-start="expanded">Ocultar detalhes</button>
      </div>
      <div id="blocoAlertas" class="collapsible">
        <div class="overflow-x-auto">
          <table class="table-dashboard" id="tabelaAlertas">
            <thead>
              <tr>
                <th>Poço</th>
                <th>Motivo</th>
                <th>Responsável</th>
                <th>Próxima ação</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="dash-card">
      <div class="card-header">
        <h3 class="dashboard-section-title">Próximas ações críticas</h3>
        <button class="toggle-card" data-target="blocoAcoes" data-start="collapsed">Mostrar detalhes</button>
      </div>
      <div id="blocoAcoes" class="collapsible collapsed">
        <div class="overflow-x-auto">
          <table class="table-dashboard" id="tabelaProximasAcoes">
            <thead>
              <tr>
                <th>Poço / Localidade</th>
                <th>Responsável</th>
                <th>Próxima ação</th>
                <th>Contato</th>
                <th>Último contato</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="dash-card">
      <div class="card-header">
        <h3 class="dashboard-section-title">Últimos contatos registrados</h3>
        <button class="toggle-card" data-target="blocoContatos" data-start="collapsed">Mostrar detalhes</button>
      </div>
      <div id="blocoContatos" class="collapsible collapsed">
        <div class="overflow-x-auto">
          <table class="table-dashboard" id="tabelaUltimosContatos">
            <thead>
              <tr>
                <th>Data</th>
                <th>Poço</th>
                <th>Contato</th>
                <th>Responsável</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="dash-card">
    <div class="card-header">
      <h3 class="dashboard-section-title">Gastos por categoria de prestação de contas</h3>
      <button class="toggle-card" data-target="blocoGastos" data-start="expanded">Ocultar detalhes</button>
    </div>
    <div id="blocoGastos" class="collapsible">
      <div id="graficoGastos" class="chart-box"></div>
    </div>
  </div>
</div>

<script>
  (() => {
    const chartsDashboard = {};
    const { escapeHtml, formatarNumero, formatarMoeda, criarAtributoDetalhes } = window;

    const STATUS_CORES = {
      'Solicitado': '#f97316',
      'Orçamento previsto': '#facc15',
      'Instalação': '#2563eb',
      'Concluído': '#16a34a',
      'Pago': '#047857'
    };

    const formatarPercentual = valor => `${Number(valor || 0).toFixed(1)}%`;

    function criarCard(titulo, valor, detalhe) {
      return `
        <div class="dash-card">
          <span class="dash-title">${titulo}</span>
          <p class="dash-value">${valor}</p>
          <span class="dash-detail">${detalhe || ''}</span>
        </div>
      `;
    }

    function criarMiniCard(titulo, valor, detalhe) {
      return `
        <div class="mini-card">
          <span class="mini-title">${titulo}</span>
          <span class="mini-value">${valor}</span>
          <span class="mini-detail">${detalhe || ''}</span>
        </div>
      `;
    }

    function formatarLitrosDia(valor) {
      const numeroValor = Number(valor || 0);
      if (numeroValor >= 1e9) return `${(numeroValor / 1e9).toFixed(2)} bi L/dia`;
      if (numeroValor >= 1e6) return `${(numeroValor / 1e6).toFixed(2)} mi L/dia`;
      if (numeroValor >= 1e3) return `${(numeroValor / 1e3).toFixed(1)} mil L/dia`;
      return `${formatarNumero(numeroValor, 0)} L/dia`;
    }

    function renderTabela(elementId, linhas, template, colunas = 5) {
      const corpo = document.querySelector(`#${elementId} tbody`);
      if (!corpo) return;
      if (!linhas || !linhas.length) {
        corpo.innerHTML = `<tr><td colspan="${colunas}" class="empty-state">Sem registros até o momento.</td></tr>`;
        return;
      }
      corpo.innerHTML = linhas.map(template).join('');
    }

    function atualizarTextoBotao(botao, collapsed) {
      botao.textContent = collapsed ? 'Mostrar detalhes' : 'Ocultar detalhes';
    }

    function inicializarToggles() {
      document.querySelectorAll('.toggle-card').forEach(botao => {
        const target = document.getElementById(botao.dataset.target);
        if (!target) return;
        const startCollapsed = botao.dataset.start === 'collapsed';
        target.classList.toggle('collapsed', startCollapsed);
        atualizarTextoBotao(botao, target.classList.contains('collapsed'));
        botao.addEventListener('click', () => {
          const collapsed = target.classList.toggle('collapsed');
          atualizarTextoBotao(botao, collapsed);
        });
      });
    }

    inicializarToggles();

    function renderChart(id, customOptions) {
      if (!window.Highcharts) return;
      const container = document.getElementById(id);
      if (!container) return;
      if (chartsDashboard[id]) {
        chartsDashboard[id].destroy();
      }
      chartsDashboard[id] = Highcharts.chart(id, Highcharts.merge({
        title: { text: null },
        credits: { enabled: false },
        legend: { align: 'center', verticalAlign: 'bottom' }
      }, customOptions));
    }

    const mapaEstadosKeys = {
      AC: 'br-ac', AL: 'br-al', AM: 'br-am', AP: 'br-ap', BA: 'br-ba', CE: 'br-ce', DF: 'br-df', ES: 'br-es', GO: 'br-go',
      MA: 'br-ma', MT: 'br-mt', MS: 'br-ms', MG: 'br-mg', PA: 'br-pa', PB: 'br-pb', PR: 'br-pr', PE: 'br-pe', PI: 'br-pi',
      RJ: 'br-rj', RN: 'br-rn', RO: 'br-ro', RR: 'br-rr', RS: 'br-rs', SC: 'br-sc', SE: 'br-se', SP: 'br-sp', TO: 'br-to'
    };

    function prepararMapa(dados) {
      window.__dadosDashboard = dados;
      window.renderMapaDistribuicao = containerId => {
        if (!window.Highcharts) return;
        const container = document.getElementById(containerId);
        if (!container) return;

        const serie = (dados.porEstado || [])
          .map(item => {
            const key = mapaEstadosKeys[item.estado];
            if (!key) return null;
            return {
              'hc-key': key,
              value: Number(item.beneficiarios || 0),
              pocos: Number(item.pocos || 0),
              beneficiarios: Number(item.beneficiarios || 0)
            };
          })
          .filter(Boolean);

        if (!serie.length) {
          serie.push({ 'hc-key': 'br-sp', value: 0, pocos: 0, beneficiarios: 0 });
        }

        const desenhar = geojson => {
          const createMapChart = typeof Highcharts.mapChart === 'function'
            ? Highcharts.mapChart.bind(Highcharts)
            : ((id, options) => {
                if (Highcharts && typeof Highcharts.chart === 'function') {
                  const fallbackOptions = Highcharts.merge({ chart: { type: 'map' } }, options);
                  return Highcharts.chart(id, fallbackOptions);
                }
                console.warn('Highcharts map module não está disponível. O mapa não será renderizado.');
                return null;
              });

          if (window.__mapChart) {
            window.__mapChart.update({ chart: { map: geojson } }, false);
            window.__mapChart.series[0].setData(serie, true);
            window.__mapChart.reflow();
            return;
          }
          const novoMapa = createMapChart(containerId, {
            chart: { map: geojson, backgroundColor: '#f8fafc' },
            title: { text: null },
            credits: { enabled: false },
            mapNavigation: { enabled: true, enableMouseWheelZoom: false },
            colorAxis: {
              min: 0,
              stops: [
                [0, '#dbeafe'],
                [0.5, '#60a5fa'],
                [1, '#1d4ed8']
              ]
            },
            legend: {
              layout: 'horizontal',
              align: 'center',
              verticalAlign: 'bottom',
              backgroundColor: 'rgba(255,255,255,0.85)'
            },
            tooltip: {
              useHTML: true,
              pointFormatter() {
                const pocos = Highcharts.numberFormat(this.pocos || 0, 0, ',', '.');
                const beneficiarios = Highcharts.numberFormat(this.beneficiarios || 0, 0, ',', '.');
                return `<strong>${this.name}</strong><br/>Poços monitorados: ${pocos}<br/>Beneficiários: ${beneficiarios}`;
              }
            },
            series: [{
              type: 'map',
              data: serie,
              joinBy: 'hc-key',
              name: 'Beneficiários atendidos',
              states: { hover: { color: '#1d4ed8' } },
              dataLabels: {
                enabled: true,
                format: '{point.properties.postal-code}',
                style: { fontWeight: '600', color: '#0f172a' }
              }
            }]
          });
          if (novoMapa) {
            window.__mapChart = novoMapa;
            window.__mapChart.reflow();
          }
        };

        if (window.__mapaBrasilGeojson) {
          desenhar(window.__mapaBrasilGeojson);
        } else {
          Highcharts.getJSON('https://code.highcharts.com/mapdata/countries/br/br-all.topo.json', geojson => {
            window.__mapaBrasilGeojson = geojson;
            desenhar(geojson);
          });
        }
      };
    }

    function renderDashboard(dados) {
      const totais = dados.totais || {};
      const indicadoresLegado = dados.indicadoresLegado || {};
      const hidricos = dados.hidricos || {};
      const historico = indicadoresLegado.historico || [];
      const acoesPos = dados.acoesPosInstalacao || [];

      const anoAtual = indicadoresLegado.anoReferencia || new Date().getFullYear();
      const totalAno = indicadoresLegado.totalInstaladoAno || 0;

      const elAnoReferencia = document.getElementById('anoReferenciaTitulo');
      const elTotalAno = document.getElementById('totalInstalacoesAno');
      if (elAnoReferencia) elAnoReferencia.textContent = anoAtual;
      if (elTotalAno) elTotalAno.textContent = formatarNumero(totalAno || 0);

      const containerIndicadoresAno = document.getElementById('indicadoresAno');
      if (containerIndicadoresAno) {
        if (totalAno) {
          containerIndicadoresAno.innerHTML = [
            criarMiniCard('Investimento realizado', formatarMoeda(indicadoresLegado.investimentoAno || 0), 'Somatório dos poços entregues'),
            criarMiniCard('Beneficiários alcançados', formatarNumero(indicadoresLegado.beneficiariosAno || 0), 'Pessoas beneficiadas em campo'),
            criarMiniCard('Metros perfurados', formatarNumero(indicadoresLegado.metrosPerfuradosAno || 0), 'Extensão perfurada no ano'),
            criarMiniCard('Vazão estimada por dia', formatarLitrosDia(indicadoresLegado.vazaoDiaAno || 0), 'Capacidade combinada dos poços concluídos')
          ].join('');
        } else {
          containerIndicadoresAno.innerHTML = '<div class="empty-state" style="grid-column:1/-1;">Nenhum poço foi concluído neste ano até o momento.</div>';
        }
      }

      const containerHidricos = document.getElementById('indicadoresHidricos');
      if (containerHidricos) {
        containerHidricos.innerHTML = [
          criarMiniCard('Poços secos identificados', formatarNumero(hidricos.pocosSecos || 0), 'Prioridade para revisão técnica'),
          criarMiniCard('Poços artesianos', formatarNumero(hidricos.pocosArtesianos || 0), `Do total monitorado (${formatarNumero(hidricos.totalMonitorados || 0)})`),
          criarMiniCard('Metros perfurados (total)', formatarNumero(hidricos.totalMetrosPerfurados || 0), 'Somatório do portfólio'),
          criarMiniCard('Vazão estimada/dia', formatarLitrosDia(hidricos.totalVazaoDia || 0), `Média ${formatarLitrosDia(hidricos.mediaVazaoDia || 0)} por poço`)
        ].join('');
      }

      document.getElementById('indicadoresPrincipais').innerHTML = [
        criarCard('Poços monitorados', formatarNumero(totais.totalPocos || 0), `${formatarNumero(totais.concluidos || 0)} concluídos`),
        criarCard('Taxa de conclusão', formatarPercentual(totais.taxaConclusao || 0), 'Percentual de poços entregues'),
        criarCard('Beneficiários alcançados', formatarNumero(totais.beneficiariosTotal || 0), `Média de ${formatarNumero(totais.mediaBeneficiarios || 0, 1)} por poço`),
        criarCard('Doadores ativos', formatarNumero(totais.doadoresAtivos || 0), `Total doado ${formatarMoeda(totais.doacoesTotais || 0)}`)
      ].join('');

      document.getElementById('indicadoresFinanceiros').innerHTML = [
        criarCard('Investimento previsto', formatarMoeda(totais.investimentoPrevisto || 0), 'Perfuração + instalação'),
        criarCard('Investimento planejado', formatarMoeda(totais.investimentoPlanejado || 0), 'Valor declarado pelos projetos'),
        criarCard('Valor realizado', formatarMoeda(totais.investimentoRealizado || 0), `Gap atual ${formatarMoeda(totais.gapFinanceiro || 0)}`)
      ].join('');

      const distStatus = dados.distribuicaoStatus || [];
      renderChart('graficoStatus', {
        chart: { type: 'pie' },
        plotOptions: {
          pie: {
            innerSize: '60%',
            dataLabels: { format: '{point.name}: <b>{point.y}</b>' }
          }
        },
        tooltip: { pointFormat: '<b>{point.y}</b> poços ({point.percentage:.1f}%)' },
        series: [{
          name: 'Poços',
          data: distStatus.map(s => ({
            name: s.status,
            y: Number(s.total || 0),
            color: STATUS_CORES[s.status] || undefined
          }))
        }]
      });

      const pipeline = dados.pipelineContatos || [];
      renderChart('graficoPipeline', {
        chart: { type: 'column' },
        xAxis: { categories: pipeline.map(p => p.status), crosshair: true },
        yAxis: { min: 0, title: { text: 'Poços' } },
        tooltip: { pointFormat: '<b>{point.y}</b> poços' },
        plotOptions: { column: { borderRadius: 6, pointPadding: 0.12, groupPadding: 0.1 } },
        legend: { enabled: false },
        series: [{ name: 'Poços', data: pipeline.map(p => Number(p.total || 0)) }]
      });

      renderChart('graficoFinanceiro', {
        chart: { type: 'column' },
        xAxis: { categories: ['Previsto', 'Planejado', 'Realizado'] },
        yAxis: {
          min: 0,
          title: { text: 'Investimento (R$)' },
          labels: {
            formatter() {
              return `R$ ${(this.value / 1000).toLocaleString('pt-BR')}k`;
            }
          }
        },
        legend: { enabled: false },
        tooltip: {
          pointFormatter() {
            return `<span style="color:${this.color}">●</span> ${this.category}: <b>${formatarMoeda(this.y)}</b>`;
          }
        },
        plotOptions: { column: { borderRadius: 8, pointPadding: 0.15 } },
        series: [{
          name: 'Investimentos',
          data: [
            Number(totais.investimentoPrevisto || 0),
            Number(totais.investimentoPlanejado || 0),
            Number(totais.investimentoRealizado || 0)
          ]
        }]
      });

      const estados = dados.porEstado || [];
      renderChart('graficoBeneficiarios', {
        chart: { type: 'bar' },
        xAxis: { categories: estados.map(e => e.estado), title: { text: null } },
        yAxis: { min: 0, title: { text: 'Beneficiários' } },
        legend: { enabled: false },
        tooltip: { pointFormat: '<b>{point.y}</b> beneficiários' },
        plotOptions: { bar: { borderRadius: 6 } },
        series: [{ name: 'Beneficiários', data: estados.map(e => Number(e.beneficiarios || 0)) }]
      });

      const gastos = dados.gastosPorCategoria || [];
      renderChart('graficoGastos', {
        chart: { type: 'column' },
        xAxis: { categories: gastos.map(g => g.categoria), title: { text: null } },
        yAxis: {
          min: 0,
          title: { text: 'Valor gasto (R$)' },
          labels: {
            formatter() {
              return formatarMoeda(this.value);
            }
          }
        },
        legend: { enabled: false },
        tooltip: {
          pointFormatter() {
            return `<span style="color:${this.color}">●</span> ${this.category}: <b>${formatarMoeda(this.y)}</b>`;
          }
        },
        plotOptions: { column: { borderRadius: 8, pointPadding: 0.1 } },
        series: [{ name: 'Prestação', data: gastos.map(g => Number(g.valor || 0)) }]
      });

      renderTabela('tabelaDoadoresDestaque', dados.doadoresDestaque, item => {
        const detalheAttr = criarAtributoDetalhes({
          titulo: item.nome || 'Doador em destaque',
          subtitulo: `Contribuição ${formatarMoeda(item.valor || 0)}`,
          campos: [
            { label: 'Beneficiários apoiados', valor: formatarNumero(item.beneficiariosApoiados || 0) },
            { label: 'Poços financiados', valor: formatarNumero(item.quantidadePocos || 0) },
            { label: 'Contato principal', valor: item.contato || 'Não informado' },
            { label: 'Observações', valor: item.observacoes || 'Sem observações registradas.' }
          ],
          acao: { label: 'Abrir guia Impacto', destino: 'impacto' }
        });
        return `
          <tr ${detalheAttr} class="linha-detalhe" role="button" tabindex="0">
            <td>${escapeHtml(item.nome)}</td>
            <td>${formatarMoeda(item.valor)}</td>
            <td>${formatarNumero(item.beneficiariosApoiados)}</td>
            <td>${formatarNumero(item.quantidadePocos)}</td>
          </tr>
        `;
      }, 4);

      renderTabela('tabelaAlertas', dados.alertas, item => {
        const detalheAttr = criarAtributoDetalhes({
          titulo: item.poco || 'Poço em alerta',
          subtitulo: item.motivo ? `Motivo: ${item.motivo}` : 'Alerta operacional',
          campos: [
            { label: 'Responsável', valor: item.responsavel || 'Não informado' },
            { label: 'Próxima ação', valor: item.proximaAcao || 'Não definida' },
            { label: 'Status', valor: item.status || 'Sem status' },
            { label: 'Contato', valor: item.contato || 'Sem contato associado' }
          ],
          acao: { label: 'Abrir gestão', destino: 'gestao' }
        });
        return `
          <tr ${detalheAttr} class="linha-detalhe" role="button" tabindex="0">
            <td>${escapeHtml(item.poco)}</td>
            <td>${escapeHtml(item.motivo)}</td>
            <td>${escapeHtml(item.responsavel)}</td>
            <td>${escapeHtml(item.proximaAcao)}</td>
            <td><span class="status-pill">${escapeHtml(item.status)}</span></td>
          </tr>
        `;
      });

      renderTabela('tabelaProximasAcoes', dados.proximasAcoes, item => {
        const ultimoContatoData = item.ultimoContato ? new Date(item.ultimoContato) : null;
        const ultimoContato = ultimoContatoData && !isNaN(ultimoContatoData)
          ? ultimoContatoData.toLocaleDateString('pt-BR')
          : '-';
        const dias = item.diasSemContato != null ? `${item.diasSemContato} dias` : 'Sem registro';
        const detalheAttr = criarAtributoDetalhes({
          titulo: item.poco || 'Próxima ação',
          subtitulo: item.proximaAcao ? `Próximo passo: ${item.proximaAcao}` : 'Ação pendente',
          campos: [
            { label: 'Responsável', valor: item.responsavel || 'Não informado' },
            { label: 'Contato', valor: item.contato || 'Sem contato associado' },
            { label: 'Status do contato', valor: item.statusContato || 'Sem status' },
            { label: 'Impacto esperado', valor: item.impacto || 'Sem impacto registrado' },
            { label: 'Situação hídrica', valor: item.situacaoHidrica || 'Sem dados' },
            { label: 'Último contato', valor: ultimoContato },
            { label: 'Tempo sem contato', valor: dias }
          ],
          acao: { label: 'Abrir gestão', destino: 'gestao' }
        });
        return `
          <tr ${detalheAttr} class="linha-detalhe" role="button" tabindex="0">
            <td>${escapeHtml(item.poco)}</td>
            <td>${escapeHtml(item.responsavel || '-')}</td>
            <td>
              <div>${escapeHtml(item.proximaAcao || '-')}</div>
              ${item.impacto ? `<small style="color:#64748b;">Impacto: ${escapeHtml(item.impacto)}</small>` : ''}
              ${item.situacaoHidrica ? `<small style="color:#0f172a;">Situação hídrica: ${escapeHtml(item.situacaoHidrica)}</small>` : ''}
            </td>
            <td>
              <div>${escapeHtml(item.contato || '-')}</div>
              <span class="status-pill">${escapeHtml(item.statusContato)}</span>
            </td>
            <td>
              <div>${ultimoContato}</div>
              <small style="color:#64748b;">${dias}</small>
            </td>
          </tr>
        `;
      });

      renderTabela('tabelaUltimosContatos', dados.ultimosContatos, item => {
        const dataContato = item.data ? new Date(item.data) : null;
        const dataTexto = dataContato && !isNaN(dataContato)
          ? dataContato.toLocaleDateString('pt-BR')
          : '-';
        const detalheAttr = criarAtributoDetalhes({
          titulo: item.poco || 'Contato registrado',
          subtitulo: `Contato realizado em ${dataTexto}`,
          campos: [
            { label: 'Responsável', valor: item.responsavel || 'Não informado' },
            { label: 'Pessoa contatada', valor: item.contato || 'Sem identificação' },
            { label: 'Status', valor: item.status || 'Sem status' },
            { label: 'Resumo', valor: item.resumo || 'Sem resumo registrado.' }
          ],
          acao: { label: 'Abrir gestão', destino: 'gestao' }
        });
        return `
          <tr ${detalheAttr} class="linha-detalhe" role="button" tabindex="0">
            <td>${dataTexto}</td>
            <td>${escapeHtml(item.poco)}</td>
            <td>${escapeHtml(item.contato)}</td>
            <td>${escapeHtml(item.responsavel)}</td>
            <td><span class="status-pill">${escapeHtml(item.status)}</span></td>
          </tr>
        `;
      });

      renderTabela('tabelaHistoricoInstalacoes', historico, item => {
        const detalheAttr = criarAtributoDetalhes({
          titulo: `Ano ${item.ano || '-'}`,
          subtitulo: `${formatarNumero(item.total || 0)} poços concluídos`,
          campos: [
            { label: 'Investimento realizado', valor: formatarMoeda(item.investimento || 0) },
            { label: 'Beneficiários atendidos', valor: formatarNumero(item.beneficiarios || 0) },
            { label: 'Metros perfurados', valor: formatarNumero(item.metros || 0) },
            { label: 'Vazão estimada / dia', valor: formatarLitrosDia(item.vazaoDia || 0) }
          ],
          acao: { label: 'Manter na visão geral', destino: 'dashboard' }
        });
        return `
          <tr ${detalheAttr} class="linha-detalhe" role="button" tabindex="0">
            <td>${escapeHtml(String(item.ano || '-'))}</td>
            <td>${formatarNumero(item.total || 0)}</td>
            <td>${formatarMoeda(item.investimento || 0)}</td>
            <td>${formatarNumero(item.beneficiarios || 0)}</td>
            <td>${formatarNumero(item.metros || 0)}</td>
            <td>${formatarLitrosDia(item.vazaoDia || 0)}</td>
          </tr>
        `;
      }, 6);

      renderTabela('tabelaAcoesPosInstalacao', acoesPos, item => {
        const acoes = item.acoes ? escapeHtml(item.acoes).replace(/\n/g, '<br>') : '-';
        const usos = item.usos ? escapeHtml(item.usos).replace(/\n/g, '<br>') : '-';
        const detalheAttr = criarAtributoDetalhes({
          titulo: item.poco || 'Ações pós-instalação',
          subtitulo: item.situacaoHidrica ? `Situação hídrica: ${item.situacaoHidrica}` : 'Situação hídrica não informada',
          campos: [
            { label: 'Estado', valor: item.estado || '-' },
            { label: 'Ações pós-instalação', valor: item.acoes || 'Sem ações registradas.' },
            { label: 'Usos comunitários', valor: item.usos || 'Sem usos registrados.' }
          ],
          acao: { label: 'Abrir guia Impacto', destino: 'impacto' }
        });
        return `
          <tr ${detalheAttr} class="linha-detalhe" role="button" tabindex="0">
            <td>${escapeHtml(item.poco)}</td>
            <td>${escapeHtml(item.estado || '-')}</td>
            <td>${escapeHtml(item.situacaoHidrica || '-')}</td>
            <td>${acoes}</td>
            <td>${usos}</td>
          </tr>
        `;
      }, 5);
      prepararMapa(dados);
    }

    google.script.run.withSuccessHandler(renderDashboard).obterDashboardAnalitico();
  })();
</script>
