<div class="space-y-6">
  <section class="grid gap-6 xl:grid-cols-12">
    <header class="bg-white rounded-lg shadow p-6 space-y-4 xl:col-span-7">
      <div class="space-y-2">
        <p class="etapa-legenda text-blue-600">Fluxo completo</p>
        <h2 class="text-2xl font-semibold text-blue-700">üíß Jornada enxuta dos po√ßos artesianos</h2>
        <p class="text-sm text-gray-600">Simplificamos o caminho desde o pedido do l√≠der de base at√© a opera√ß√£o do po√ßo. Cadastre, analise e acompanhe cada etapa sem perder os indicadores essenciais.</p>
      </div>
      <ol id="etapasFluxo" class="etapas-fluxo"></ol>
    </header>
    <aside class="painel-indicadores xl:col-span-5">
      <h3 class="painel-indicadores__titulo">Indicadores do pipeline</h3>
      <dl id="indicadoresFluxo" class="indicadores-fluxo"></dl>
    </aside>
  </section>

  <form id="formPoco" class="bg-white rounded-lg shadow p-6 space-y-6">
    <input type="hidden" id="pocoId">
    <input type="hidden" id="dadosEvidencias">
    <input type="hidden" id="dadosTimeline">
    <input type="hidden" id="dadosTermo">
    <input type="hidden" id="dadosNota">

    <div class="flex items-center justify-between flex-wrap gap-3">
      <div>
        <p class="etapa-legenda text-blue-600">Formul√°rio unificado</p>
        <h3 class="font-semibold text-lg text-gray-800">Cadastro e atualiza√ß√£o do po√ßo</h3>
      </div>
      <div class="flex gap-3">
        <button type="button" id="btnLimparFormulario" class="px-4 py-2 rounded border border-gray-300 text-gray-600 hover:bg-gray-100">Limpar</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700">Salvar informa√ß√µes</button>
      </div>
    </div>

    <datalist id="listaEstados"></datalist>
    <datalist id="listaMunicipios"></datalist>

    <section class="etapa-card">
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <p class="etapa-legenda">Passo 1</p>
          <h4 class="etapa-titulo">Solicita√ß√£o do l√≠der de base</h4>
          <p class="etapa-descricao">Pe√ßa que a pessoa em campo informe apenas o essencial. O sistema completa o restante automaticamente.</p>
        </div>
        <button type="button" id="btnCapturarLocalizacao" class="botao-localizacao">Capturar localiza√ß√£o agora</button>
      </div>

      <p id="feedbackLocalizacaoSimplificada" class="feedback-simplificado">Use o bot√£o acima quando estiver no local do po√ßo para preencher a posi√ß√£o automaticamente.</p>

      <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2">
          <label class="text-sm font-medium text-gray-700">Comunidade / ponto do po√ßo</label>
          <input id="comunidade" class="campo" placeholder="Ex.: Comunidade Vida" autocomplete="organization">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">L√≠der local</label>
          <input id="solicitante" class="campo" placeholder="Nome de quem fez o pedido">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Contato do l√≠der</label>
          <input id="contatoSolicitante" class="campo" placeholder="Telefone ou WhatsApp">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Dist√¢ncia at√© energia (m)</label>
          <input id="distanciaEnergia" class="campo" inputmode="decimal" autocomplete="off" placeholder="0">
        </div>
        <div class="md:col-span-3">
          <label class="text-sm font-medium text-gray-700">Resumo r√°pido da necessidade</label>
          <textarea id="resumoStatus" rows="2" class="campo" placeholder="Em poucas palavras, descreva o cen√°rio da comunidade."></textarea>
        </div>
        <div class="md:col-span-3">
          <label class="text-sm font-medium text-gray-700">Evid√™ncias iniciais (foto, v√≠deo ou documento)</label>
          <input type="file" id="arquivoEvidencias" class="campo" multiple>
          <p class="texto-apoio">Voc√™ pode anexar imagens tiradas pelo celular ou outros arquivos que ajudem na an√°lise.</p>
        </div>
      </div>

      <div class="localizacao-resumo" id="resumoLocalizacao">
        <div>
          <p class="localizacao-label">Endere√ßo estimado</p>
          <p id="resumoLocalizacaoEndereco" class="localizacao-valor">Aguardando localiza√ß√£o</p>
        </div>
        <div class="localizacao-coords">
          <span>Lat: <strong id="resumoLocalizacaoLatitude">-</strong></span>
          <span>Lon: <strong id="resumoLocalizacaoLongitude">-</strong></span>
        </div>
      </div>
    </section>

    <section class="etapa-card etapa-card--localizacao">
      <div class="space-y-4">
        <div class="grid md:grid-cols-4 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-700">Estado</label>
            <input id="estado" class="campo" required list="listaEstados" autocomplete="address-level1" placeholder="Selecione ou deixe o sistema preencher">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Munic√≠pio</label>
            <input id="municipio" class="campo" required list="listaMunicipios" autocomplete="address-level2" placeholder="Selecione o munic√≠pio">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Regi√£o</label>
            <input id="regiao" class="campo" placeholder="Ex.: Sert√£o dos Inhamuns">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Doadores vinculados</label>
            <input id="doadores" class="campo" placeholder="IDs ou nomes separados por v√≠rgula">
          </div>
        </div>

        <div class="md:col-span-4 text-xs text-gray-500" id="feedbackMunicipio"></div>

        <div class="grid md:grid-cols-4 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-700">Latitude</label>
            <input id="latitude" class="campo" placeholder="-5.167000" inputmode="decimal" autocomplete="off">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Longitude</label>
            <input id="longitude" class="campo" placeholder="-40.656000" inputmode="decimal" autocomplete="off">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Benefici√°rios estimados</label>
            <input id="beneficiarios" type="text" inputmode="numeric" class="campo" placeholder="0" autocomplete="off">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Empresa respons√°vel</label>
            <input id="empresa" class="campo" placeholder="Fornecedor respons√°vel">
          </div>
        </div>

        <div class="md:col-span-4 text-xs text-gray-500" id="feedbackCoordenadas"></div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-gray-700">Localiza√ß√£o no mapa</label>
          <div id="mapaCoordenadas" class="mapa-coordenadas"></div>
          <p class="text-xs text-gray-500">Clique ou arraste o marcador para ajustar a posi√ß√£o manualmente, se necess√°rio.</p>
        </div>
      </div>
    </section>

    <details class="etapa-card etapa-card--detalhes" open>
      <summary class="etapa-detalhes__summary">
        <span>
          <p class="etapa-legenda">Passo 3</p>
          <h4 class="etapa-titulo">Completar dados operacionais e financeiros</h4>
        </span>
        <span class="etapa-detalhes__icone" aria-hidden="true"></span>
      </summary>
      <div class="space-y-4 mt-4">
        <fieldset class="border border-blue-100 rounded-lg p-4">
          <legend class="px-2 text-blue-700 font-semibold">Datas do processo</legend>
          <div class="grid md:grid-cols-5 gap-4">
            <div>
              <label class="texto-legenda">Solicita√ß√£o</label>
              <input type="date" id="dataSolicitacao" class="campo">
            </div>
            <div>
              <label class="texto-legenda">Or√ßamento previsto</label>
              <input type="date" id="dataOrcamentoPrevisto" class="campo">
            </div>
            <div>
              <label class="texto-legenda">Instala√ß√£o</label>
              <input type="date" id="dataInstalacao" class="campo">
            </div>
            <div>
              <label class="texto-legenda">Conclus√£o</label>
              <input type="date" id="dataConclusao" class="campo">
            </div>
            <div>
              <label class="texto-legenda">Pagamento</label>
              <input type="date" id="dataPagamento" class="campo">
            </div>
          </div>
        </fieldset>

        <fieldset class="border border-blue-100 rounded-lg p-4">
          <legend class="px-2 text-blue-700 font-semibold">Or√ßamento</legend>
          <div class="grid md:grid-cols-4 gap-4">
            <div>
              <label class="texto-legenda">Previsto (R$)</label>
              <input type="text" id="orcamentoPrevisto" class="campo" inputmode="decimal" autocomplete="off">
            </div>
            <div>
              <label class="texto-legenda">Aprovado (R$)</label>
              <input type="text" id="orcamentoAprovado" class="campo" inputmode="decimal" autocomplete="off">
            </div>
            <div>
              <label class="texto-legenda">Executado (R$)</label>
              <input type="text" id="orcamentoExecutado" class="campo" inputmode="decimal" autocomplete="off">
            </div>
            <div>
              <label class="texto-legenda">Investimento previsto em planilha (R$)</label>
              <input type="text" id="investimento" class="campo" inputmode="decimal" autocomplete="off">
            </div>
          </div>
        </fieldset>

        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-700">Contato principal</label>
            <input id="contatoNome" class="campo" placeholder="Nome do respons√°vel">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Telefone / WhatsApp</label>
            <input id="contatoTelefone" class="campo" placeholder="(00) 90000-0000" inputmode="tel" autocomplete="off">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">E-mail</label>
            <input id="contatoEmail" class="campo" placeholder="contato@email.com">
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-700">Termo de autoriza√ß√£o (PDF ou imagem)</label>
            <input type="file" id="arquivoTermo" accept=".pdf,image/*" class="campo">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Nota fiscal (PDF ou imagem)</label>
            <input type="file" id="arquivoNota" accept=".pdf,image/*" class="campo">
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-700">Situa√ß√£o h√≠drica</label>
            <input id="situacaoHidrica" class="campo" placeholder="Produzindo normalmente, em an√°lise t√©cnica...">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Uso priorit√°rio da √°gua</label>
            <input id="usoAgua" class="campo" placeholder="Consumo humano, irriga√ß√£o, apoio √† escola...">
          </div>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700">A√ß√µes p√≥s-instala√ß√£o</label>
          <textarea id="acoesPosInstalacao" rows="2" class="campo" placeholder="Capacita√ß√µes, hortas comunit√°rias, monitoramento..."></textarea>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700">Observa√ß√µes gerais</label>
          <textarea id="observacoes" rows="3" class="campo" placeholder="Registre aprendizados, pend√™ncias ou alertas."></textarea>
        </div>
      </div>
    </details>

    <p id="mensagemFormulario" class="text-sm font-medium"></p>
  </form>

  <section class="bg-white rounded-lg shadow p-6 space-y-4">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h3 class="text-lg font-semibold text-gray-800">Planilhas e etapas operacionais</h3>
        <p class="text-sm text-gray-600">Clique em uma etapa para ver os registros correspondentes e os dados consolidados.</p>
      </div>
    </div>
    <div id="listaPlanilhasOperacionais" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"></div>
  </section>

  <div id="painelPlanilhaDetalhes" class="planilha-detalhes hidden" role="dialog" aria-modal="true" aria-labelledby="planilhaTitulo" aria-hidden="true">
    <div class="planilha-detalhes__content">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h4 id="planilhaTitulo" class="text-lg font-semibold text-gray-900" tabindex="-1"></h4>
          <p id="planilhaResumo" class="text-sm text-gray-600"></p>
        </div>
        <button type="button" id="btnFecharPlanilha" class="btn-fechar-planilha" aria-label="Fechar detalhes">Fechar</button>
      </div>
      <div id="planilhaLista" class="planilha-detalhes__lista space-y-3 mt-4"></div>
    </div>
  </div>

  <section class="bg-white rounded-lg shadow p-5 flex flex-col gap-2">
    <h3 class="text-lg font-semibold text-gray-800">Painel de solicita√ß√µes</h3>
    <p class="text-sm text-gray-600">Acompanhe o andamento das solicita√ß√µes, or√ßamentos, viabilidades e execu√ß√µes em tempo real.</p>
  </section>

  <section class="grid lg:grid-cols-12 gap-6">
    <aside class="lg:col-span-5 space-y-3">
      <div class="bg-white rounded-lg shadow p-4 flex flex-col gap-3">
        <div class="flex items-center justify-between gap-3">
          <h3 class="font-semibold text-gray-800">Po√ßos cadastrados</h3>
          <span id="contadorPocos" class="text-sm text-gray-500"></span>
        </div>
        <input id="buscaPocos" class="campo" placeholder="Buscar por estado, munic√≠pio ou status">
      </div>
      <ul id="listaPocos" class="space-y-3"></ul>
      <div id="mapaPocos" class="mapa-pocos bg-white rounded-lg shadow"></div>
    </aside>

    <div class="lg:col-span-7">
      <div id="painelDetalhes" class="bg-white rounded-lg shadow p-6 hidden flex-col gap-5">
        <div class="flex flex-col gap-2">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 id="detalheTitulo" class="text-xl font-semibold text-gray-900"></h3>
              <p id="detalheLocal" class="text-sm text-gray-500"></p>
            </div>
            <span id="detalheStatus" class="px-3 py-1 rounded-full text-sm font-medium"></span>
          </div>
          <p id="detalheResumo" class="text-sm text-gray-600"></p>
        </div>

        <div class="grid md:grid-cols-4 gap-3">
          <article class="resumo-card">
            <p class="titulo">Benefici√°rios</p>
            <strong id="detalheBeneficiarios" class="valor">-</strong>
          </article>
          <article class="resumo-card">
            <p class="titulo">Previsto</p>
            <strong id="detalhePrevisto" class="valor">-</strong>
          </article>
          <article class="resumo-card">
            <p class="titulo">Executado</p>
            <strong id="detalheExecutado" class="valor">-</strong>
          </article>
          <article class="resumo-card">
            <p class="titulo">Energia</p>
            <strong id="detalheDistanciaEnergia" class="valor">-</strong>
            <p class="texto-apoio mt-1">Dist√¢ncia at√© o ponto de energia (m)</p>
          </article>
        </div>

        <section>
          <h4 class="subtitulo">Linha do tempo do po√ßo</h4>
          <ol id="timelineEtapas" class="timeline"></ol>
        </section>

        <section class="space-y-3">
          <div class="flex items-center justify-between">
            <h4 class="subtitulo">Evid√™ncias</h4>
            <div class="flex gap-3 text-sm">
              <a id="linkTermo" class="link-doc" target="_blank" rel="noopener">Termo de autoriza√ß√£o</a>
              <a id="linkNota" class="link-doc" target="_blank" rel="noopener">Nota fiscal</a>
            </div>
          </div>
          <div id="galeriaEvidencias" class="grid sm:grid-cols-2 gap-3"></div>
        </section>

        <section class="space-y-2">
          <h4 class="subtitulo">Contatos e respons√°veis</h4>
          <ul id="listaContatos" class="space-y-2"></ul>
        </section>

        <div class="flex justify-end">
          <button id="btnEditarPoco" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700">Editar informa√ß√µes</button>
        </div>
      </div>
      <div id="mensagemDetalhes" class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
        Selecione um po√ßo para visualizar a linha do tempo e as evid√™ncias.
      </div>
    </div>
  </section>
</div>

<style>
  .etapa-legenda {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #2563eb;
  }
  .etapa-titulo {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
  }
  .etapa-descricao {
    font-size: 0.9rem;
    color: #475569;
  }
  .etapa-card {
    border: 1px solid #e0f2fe;
    border-radius: 1rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, rgba(219, 234, 254, 0.35), rgba(191, 219, 254, 0.15));
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .etapa-card--localizacao {
    background: linear-gradient(135deg, rgba(191, 219, 254, 0.3), rgba(125, 211, 252, 0.18));
  }
  .etapa-card--detalhes {
    background: #f8fafc;
    border-style: dashed;
  }
  .botao-localizacao {
    background: #1d4ed8;
    color: #fff;
    font-weight: 600;
    border: none;
    border-radius: 999px;
    padding: 0.55rem 1.4rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: transform .2s ease, box-shadow .2s ease;
  }
  .botao-localizacao:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 20px rgba(29, 78, 216, 0.2);
  }
  .feedback-simplificado {
    font-size: 0.85rem;
    color: #475569;
    background: rgba(219, 234, 254, 0.45);
    border-radius: 0.75rem;
    padding: 0.6rem 0.85rem;
    border: 1px solid transparent;
  }
  .feedback-simplificado--sucesso {
    color: #166534;
    background: rgba(187, 247, 208, 0.65);
    border-color: rgba(22, 101, 52, 0.35);
  }
  .feedback-simplificado--erro {
    color: #b91c1c;
    background: rgba(254, 226, 226, 0.65);
    border-color: rgba(185, 28, 28, 0.35);
  }
  .feedback-simplificado--info {
    color: #1d4ed8;
    background: rgba(219, 234, 254, 0.65);
    border-color: rgba(37, 99, 235, 0.3);
  }
  .feedback-simplificado--neutro {
    color: #475569;
  }
  .texto-apoio {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
  }
  .localizacao-resumo {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    border-radius: 0.75rem;
    border: 1px solid rgba(37, 99, 235, 0.2);
    padding: 0.85rem 1rem;
    background: rgba(219, 234, 254, 0.25);
  }
  .localizacao-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #1d4ed8;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .localizacao-valor {
    font-size: 0.95rem;
    color: #0f172a;
    font-weight: 600;
  }
  .localizacao-coords {
    display: flex;
    gap: 1rem;
    font-family: 'JetBrains Mono', 'Fira Mono', 'SFMono-Regular', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-size: 0.8rem;
    color: #0f172a;
  }
  .painel-indicadores {
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(13, 148, 136, 0.15));
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 12px 30px rgba(15, 118, 110, 0.18);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .painel-indicadores__titulo {
    font-size: 1rem;
    font-weight: 600;
    color: #0f172a;
  }
  .indicadores-fluxo {
    display: grid;
    gap: 0.85rem;
  }
  .indicadores-fluxo dt {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #0f172a;
    opacity: 0.7;
  }
  .indicadores-fluxo dd {
    font-size: 1.6rem;
    font-weight: 700;
    color: #0f172a;
  }
  .etapas-fluxo {
    display: grid;
    gap: 0.75rem;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }
  .etapas-fluxo li {
    list-style: none;
    border: 1px solid rgba(37, 99, 235, 0.2);
    border-radius: 0.85rem;
    padding: 1rem;
    background: rgba(219, 234, 254, 0.35);
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  .etapas-fluxo .etapa-label {
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #0ea5e9;
  }
  .etapas-fluxo .contador {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1d4ed8;
  }
  .etapa-detalhes__summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    cursor: pointer;
  }
  .etapa-detalhes__summary::-webkit-details-marker {
    display: none;
  }
  .etapa-detalhes__icone {
    width: 1.2rem;
    height: 1.2rem;
    border: 2px solid #1d4ed8;
    border-radius: 999px;
    position: relative;
  }
  .etapa-detalhes__icone::before,
  .etapa-detalhes__icone::after {
    content: '';
    position: absolute;
    background: #1d4ed8;
    transition: transform .2s ease;
  }
  .etapa-detalhes__icone::before {
    inset: 0.45rem 0.25rem;
  }
  .etapa-detalhes__icone::after {
    inset: 0.25rem 0.45rem;
    transform: rotate(90deg);
  }
  details[open] > .etapa-detalhes__summary .etapa-detalhes__icone::after {
    transform: rotate(0deg);
  }
  .planilha-detalhes {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 4rem 1.5rem;
    z-index: 60;
  }
  .planilha-detalhes.hidden {
    display: none;
  }
  .planilha-detalhes__content {
    background: #fff;
    border-radius: 1.25rem;
    width: min(720px, 100%);
    padding: 1.75rem;
    box-shadow: 0 25px 60px rgba(15, 23, 42, 0.25);
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
  }
  .btn-fechar-planilha {
    background: #eff6ff;
    color: #1d4ed8;
    border: none;
    border-radius: 999px;
    padding: 0.45rem 1rem;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-fechar-planilha:hover {
    background: #dbeafe;
  }
  .planilha-detalhes__lista article {
    border: 1px solid #e2e8f0;
    border-radius: 0.9rem;
    padding: 1rem;
    background: #f8fafc;
  }
  .planilha-card {
    border: 1px solid rgba(37, 99, 235, 0.35);
    border-radius: 1rem;
    padding: 1.1rem;
    background: #fff;
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    transition: transform .2s ease, box-shadow .2s ease;
    cursor: pointer;
  }
  .planilha-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 32px rgba(37, 99, 235, 0.15);
  }
  .planilha-card:focus {
    outline: 2px solid #2563eb;
    outline-offset: 2px;
  }
  .planilha-card__etapa {
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #0ea5e9;
  }
  .planilha-card__titulo {
    font-size: 1rem;
    font-weight: 600;
    color: #1d4ed8;
  }
  .planilha-card__contador {
    font-size: 2rem;
    font-weight: 700;
    color: #0f172a;
  }
  .planilha-card__descricao {
    font-size: 0.85rem;
    color: #475569;
  }
  body.overflow-hidden-planilha {
    overflow: hidden;
  }
  .campo {
    width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.55rem 0.75rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }
  .campo:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
  }
  .texto-legenda {
    font-size: 0.85rem;
    font-weight: 600;
    color: #1f2937;
    display: block;
    margin-bottom: 0.35rem;
  }
  .resumo-card {
    border: 1px solid #e0e7ff;
    border-radius: 0.75rem;
    padding: 1rem;
    background: linear-gradient(135deg, rgba(219, 234, 254, 0.6), rgba(191, 219, 254, 0.3));
  }
  .resumo-card .titulo {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #1d4ed8;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  .resumo-card .valor {
    font-size: 1.2rem;
    color: #1e3a8a;
  }
  .subtitulo {
    font-size: 0.95rem;
    font-weight: 600;
    color: #1f2937;
  }
  .timeline {
    position: relative;
    padding-left: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 0.6rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #bfdbfe;
  }
  .timeline-item {
    position: relative;
    padding-left: 0.75rem;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -1.05rem;
    top: 0.4rem;
    width: 10px;
    height: 10px;
    border-radius: 9999px;
    background: #93c5fd;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px rgba(147, 197, 253, 0.4);
  }
  .timeline-item[data-status="concluido"]::before {
    background: #22c55e;
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.35);
  }
  .timeline-item[data-status="andamento"]::before {
    background: #facc15;
    box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.35);
  }
  .timeline-item[data-status="pendente"]::before {
    background: #9ca3af;
    box-shadow: 0 0 0 2px rgba(156, 163, 175, 0.35);
  }
  .timeline-titulo {
    font-weight: 600;
    font-size: 0.95rem;
    color: #1f2937;
  }
  .timeline-data {
    font-size: 0.75rem;
    color: #6b7280;
  }
  .timeline-descricao {
    font-size: 0.75rem;
    color: #4b5563;
    margin-top: 0.25rem;
  }
  .link-doc {
    color: #2563eb;
    text-decoration: none;
  }
  .link-doc:hover {
    text-decoration: underline;
  }
  .mapa-pocos {
    height: 400px;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    overflow: hidden;
  }
  .mapa-pocos.leaflet-container {
    height: 400px;
  }
  .mapa-coordenadas {
    height: 280px;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    overflow: hidden;
  }
  .mapa-coordenadas.leaflet-container {
    height: 280px;
  }
  .popup-localizacao {
    font-size: 0.85rem;
    line-height: 1.35;
    color: #1f2937;
  }
  .popup-localizacao .titulo {
    display: block;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 0.15rem;
  }
  .popup-localizacao .subtitulo {
    display: block;
    font-size: 0.75rem;
    color: #475569;
    margin-bottom: 0.4rem;
  }
  .popup-localizacao .coords {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    font-family: 'JetBrains Mono', 'Fira Mono', 'SFMono-Regular', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-size: 0.75rem;
    color: #0f172a;
    margin-bottom: 0.35rem;
  }
  .popup-localizacao .detalhe {
    font-size: 0.75rem;
    color: #334155;
  }
  .popup-localizacao .status {
    margin-top: 0.4rem;
    font-size: 0.7rem;
    color: #0369a1;
  }
  .popup-localizacao-container .leaflet-popup-content {
    margin: 0;
  }
  .popup-localizacao-container .leaflet-popup-content-wrapper {
    padding: 0.75rem 0.9rem;
    border-radius: 0.75rem;
  }
</style>

<script>
(() => {
  const listaPocosEl = document.getElementById('listaPocos');
  const contadorPocosEl = document.getElementById('contadorPocos');
  const buscaEl = document.getElementById('buscaPocos');
  const painelDetalhes = document.getElementById('painelDetalhes');
  const mensagemDetalhes = document.getElementById('mensagemDetalhes');
  const timelineEl = document.getElementById('timelineEtapas');
  const evidenciasEl = document.getElementById('galeriaEvidencias');
  const contatosEl = document.getElementById('listaContatos');
  const detalheTitulo = document.getElementById('detalheTitulo');
  const detalheLocal = document.getElementById('detalheLocal');
  const detalheResumo = document.getElementById('detalheResumo');
  const detalheStatus = document.getElementById('detalheStatus');
  const detalheBeneficiarios = document.getElementById('detalheBeneficiarios');
  const detalhePrevisto = document.getElementById('detalhePrevisto');
  const detalheExecutado = document.getElementById('detalheExecutado');
  const detalheDistanciaEnergia = document.getElementById('detalheDistanciaEnergia');
  const linkTermo = document.getElementById('linkTermo');
  const linkNota = document.getElementById('linkNota');
  const btnEditar = document.getElementById('btnEditarPoco');
  const btnLimpar = document.getElementById('btnLimparFormulario');
  const mensagemFormulario = document.getElementById('mensagemFormulario');
  const feedbackCoordenadas = document.getElementById('feedbackCoordenadas');
  const feedbackMunicipio = document.getElementById('feedbackMunicipio');
  const datalistEstados = document.getElementById('listaEstados');
  const datalistMunicipios = document.getElementById('listaMunicipios');
  const form = document.getElementById('formPoco');
  const btnCapturarLocalizacao = document.getElementById('btnCapturarLocalizacao');
  const feedbackLocalizacaoSimplificada = document.getElementById('feedbackLocalizacaoSimplificada');
  const resumoLocalizacaoEndereco = document.getElementById('resumoLocalizacaoEndereco');
  const resumoLocalizacaoLatitude = document.getElementById('resumoLocalizacaoLatitude');
  const resumoLocalizacaoLongitude = document.getElementById('resumoLocalizacaoLongitude');
  const indicadoresFluxoEl = document.getElementById('indicadoresFluxo');
  const etapasFluxoEl = document.getElementById('etapasFluxo');
  const listaPlanilhasOperacionais = document.getElementById('listaPlanilhasOperacionais');
  const painelPlanilhaDetalhes = document.getElementById('painelPlanilhaDetalhes');
  const planilhaTitulo = document.getElementById('planilhaTitulo');
  const planilhaResumo = document.getElementById('planilhaResumo');
  const planilhaLista = document.getElementById('planilhaLista');
  const btnFecharPlanilha = document.getElementById('btnFecharPlanilha');

  let elementoFocoAnterior = null;

  const hiddenId = document.getElementById('pocoId');
  const hiddenEvidencias = document.getElementById('dadosEvidencias');
  const hiddenTimeline = document.getElementById('dadosTimeline');
  const hiddenTermo = document.getElementById('dadosTermo');
  const hiddenNota = document.getElementById('dadosNota');

  const campos = {
    estado: document.getElementById('estado'),
    municipio: document.getElementById('municipio'),
    comunidade: document.getElementById('comunidade'),
    regiao: document.getElementById('regiao'),
    latitude: document.getElementById('latitude'),
    longitude: document.getElementById('longitude'),
    beneficiarios: document.getElementById('beneficiarios'),
    investimento: document.getElementById('investimento'),
    distanciaEnergia: document.getElementById('distanciaEnergia'),
    solicitante: document.getElementById('solicitante'),
    contatoSolicitante: document.getElementById('contatoSolicitante'),
    doadores: document.getElementById('doadores'),
    resumoStatus: document.getElementById('resumoStatus'),
    dataSolicitacao: document.getElementById('dataSolicitacao'),
    dataOrcamentoPrevisto: document.getElementById('dataOrcamentoPrevisto'),
    dataInstalacao: document.getElementById('dataInstalacao'),
    dataConclusao: document.getElementById('dataConclusao'),
    dataPagamento: document.getElementById('dataPagamento'),
    orcamentoPrevisto: document.getElementById('orcamentoPrevisto'),
    orcamentoAprovado: document.getElementById('orcamentoAprovado'),
    orcamentoExecutado: document.getElementById('orcamentoExecutado'),
    empresa: document.getElementById('empresa'),
    contatoNome: document.getElementById('contatoNome'),
    contatoTelefone: document.getElementById('contatoTelefone'),
    contatoEmail: document.getElementById('contatoEmail'),
    situacaoHidrica: document.getElementById('situacaoHidrica'),
    usoAgua: document.getElementById('usoAgua'),
    acoesPosInstalacao: document.getElementById('acoesPosInstalacao'),
    observacoes: document.getElementById('observacoes')
  };

  const arquivos = {
    termo: document.getElementById('arquivoTermo'),
    nota: document.getElementById('arquivoNota'),
    evidencias: document.getElementById('arquivoEvidencias')
  };

  const obterTextoCampo = (campo) => {
    if (!campo || campo.value == null) return '';
    return String(campo.value).trim();
  };

  const atualizarResumoLocalizacao = () => {
    if (!resumoLocalizacaoEndereco) return;
    const comunidade = obterTextoCampo(campos.comunidade);
    const municipio = obterTextoCampo(campos.municipio);
    const estado = obterTextoCampo(campos.estado);
    const partes = [comunidade, municipio, estado].filter(Boolean);
    resumoLocalizacaoEndereco.textContent = partes.length ? partes.join(' ‚Ä¢ ') : 'Aguardando localiza√ß√£o';
    resumoLocalizacaoLatitude.textContent = obterTextoCampo(campos.latitude) || '-';
    resumoLocalizacaoLongitude.textContent = obterTextoCampo(campos.longitude) || '-';
  };

  const ESTADOS_BRASIL = [
    { sigla: 'AC', nome: 'Acre' },
    { sigla: 'AL', nome: 'Alagoas' },
    { sigla: 'AP', nome: 'Amap√°' },
    { sigla: 'AM', nome: 'Amazonas' },
    { sigla: 'BA', nome: 'Bahia' },
    { sigla: 'CE', nome: 'Cear√°' },
    { sigla: 'DF', nome: 'Distrito Federal' },
    { sigla: 'ES', nome: 'Esp√≠rito Santo' },
    { sigla: 'GO', nome: 'Goi√°s' },
    { sigla: 'MA', nome: 'Maranh√£o' },
    { sigla: 'MT', nome: 'Mato Grosso' },
    { sigla: 'MS', nome: 'Mato Grosso do Sul' },
    { sigla: 'MG', nome: 'Minas Gerais' },
    { sigla: 'PA', nome: 'Par√°' },
    { sigla: 'PB', nome: 'Para√≠ba' },
    { sigla: 'PR', nome: 'Paran√°' },
    { sigla: 'PE', nome: 'Pernambuco' },
    { sigla: 'PI', nome: 'Piau√≠' },
    { sigla: 'RJ', nome: 'Rio de Janeiro' },
    { sigla: 'RN', nome: 'Rio Grande do Norte' },
    { sigla: 'RS', nome: 'Rio Grande do Sul' },
    { sigla: 'RO', nome: 'Rond√¥nia' },
    { sigla: 'RR', nome: 'Roraima' },
    { sigla: 'SC', nome: 'Santa Catarina' },
    { sigla: 'SP', nome: 'S√£o Paulo' },
    { sigla: 'SE', nome: 'Sergipe' },
    { sigla: 'TO', nome: 'Tocantins' }
  ];

  const MUNICIPIOS_CACHE = new Map();
  let carregamentoMunicipiosAtual = 0;
  let ultimoEstadoReconhecido = '';

  const normalizarTextoAcentos = (valor) => {
    return (valor || '')
      .toString()
      .trim()
      .toUpperCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '');
  };

  const obterEstadoPorValor = (valor) => {
    const texto = normalizarTextoAcentos(valor);
    if (!texto) return null;
    return ESTADOS_BRASIL.find(estado => {
      const nomeNormalizado = normalizarTextoAcentos(estado.nome);
      return estado.sigla === texto || nomeNormalizado === texto;
    }) || null;
  };

  const atualizarFeedbackMunicipios = (mensagem, tipo = 'neutro') => {
    if (!feedbackMunicipio) return;
    const cores = {
      sucesso: 'text-green-600',
      erro: 'text-red-600',
      info: 'text-blue-600',
      neutro: 'text-gray-500'
    };
    feedbackMunicipio.textContent = mensagem;
    feedbackMunicipio.className = `md:col-span-4 text-xs mt-1 ${cores[tipo] || cores.neutro}`;
  };

  const escaparParaDatalist = (valor) => {
    return String(valor || '').replace(/"/g, '&quot;');
  };

  const limparMunicipios = (mensagem = 'Selecione um estado para listar munic√≠pios automaticamente.', tipo = 'info') => {
    if (datalistMunicipios) datalistMunicipios.innerHTML = '';
    if (campos.municipio) {
      campos.municipio.dataset.estado = '';
    }
    if (campos.estado) {
      campos.estado.dataset.sigla = '';
    }
    ultimoEstadoReconhecido = '';
    atualizarFeedbackMunicipios(mensagem, mensagem ? tipo : 'neutro');
  };

  const aplicarMunicipiosNaLista = (estadoInfo, municipios, municipioAtual = '') => {
    if (!datalistMunicipios) return;
    datalistMunicipios.innerHTML = municipios
      .map(nome => `<option value="${escaparParaDatalist(nome)}"></option>`)
      .join('');
    if (campos.municipio) {
      campos.municipio.dataset.estado = estadoInfo.sigla;
    }
    const municipioNormalizado = municipioAtual ? municipioAtual.toLowerCase() : '';
    const existe = municipioNormalizado
      ? municipios.some(nome => nome.toLowerCase() === municipioNormalizado)
      : false;
    if (municipioAtual && !existe) {
      atualizarFeedbackMunicipios(`Munic√≠pios de ${estadoInfo.nome} carregados. O valor informado n√£o foi encontrado, escolha um da lista.`, 'info');
    } else {
      atualizarFeedbackMunicipios(`Munic√≠pios de ${estadoInfo.nome} carregados (${municipios.length}).`, 'sucesso');
    }
  };

  const carregarMunicipiosPorEstado = (estadoInfo, municipioAtual = '') => {
    if (!estadoInfo) {
      limparMunicipios('Estado n√£o reconhecido. Preencha manualmente.', 'erro');
      return;
    }
    ultimoEstadoReconhecido = estadoInfo.sigla;
    if (campos.estado) {
      campos.estado.dataset.sigla = estadoInfo.sigla;
    }
    const idSolicitacao = ++carregamentoMunicipiosAtual;
    atualizarFeedbackMunicipios(`Carregando munic√≠pios de ${estadoInfo.nome}...`, 'info');

    const preencher = (municipios) => {
      if (idSolicitacao !== carregamentoMunicipiosAtual) return;
      aplicarMunicipiosNaLista(estadoInfo, municipios, municipioAtual);
    };

    if (MUNICIPIOS_CACHE.has(estadoInfo.sigla)) {
      preencher(MUNICIPIOS_CACHE.get(estadoInfo.sigla));
      return;
    }

    fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${estadoInfo.sigla}/municipios`)
      .then(res => {
        if (!res.ok) throw new Error('Resposta inv√°lida do IBGE.');
        return res.json();
      })
      .then(lista => {
        const municipios = Array.isArray(lista)
          ? lista.map(item => item && item.nome ? item.nome : '')
              .filter(Boolean)
              .sort((a, b) => a.localeCompare(b, 'pt-BR'))
          : [];
        MUNICIPIOS_CACHE.set(estadoInfo.sigla, municipios);
        preencher(municipios);
      })
      .catch(erro => {
        if (idSolicitacao !== carregamentoMunicipiosAtual) return;
        console.error('Erro ao carregar munic√≠pios do IBGE.', erro);
        limparMunicipios('N√£o foi poss√≠vel carregar os munic√≠pios automaticamente. Preencha manualmente.', 'erro');
      });
  };

  const popularEstados = () => {
    if (!datalistEstados) return;
    const opcoes = ESTADOS_BRASIL
      .map(estado => {
        const descricao = `${estado.nome} (${estado.sigla})`;
        return [
          `<option value="${escaparParaDatalist(estado.sigla)}">${descricao}</option>`,
          `<option value="${escaparParaDatalist(estado.nome)}"></option>`
        ];
      })
      .reduce((acumulador, atual) => acumulador.concat(atual), [])
      .join('');
    datalistEstados.innerHTML = opcoes;
  };

  const sincronizarMunicipiosComEstado = (valorEstado, municipioAtual = '') => {
    const estadoInfo = obterEstadoPorValor(valorEstado);
    if (!valorEstado) {
      limparMunicipios('Selecione um estado para listar munic√≠pios automaticamente.', 'info');
      return null;
    }
    if (!estadoInfo) {
      limparMunicipios('Estado n√£o reconhecido. Preencha manualmente.', 'erro');
      return null;
    }
    carregarMunicipiosPorEstado(estadoInfo, municipioAtual);
    return estadoInfo;
  };

  const numericMaskHelpers = new Map();

  const parseValorNumerico = (valor) => {
    if (valor === undefined || valor === null) return null;
    if (typeof valor === 'number') {
      return Number.isNaN(valor) ? null : valor;
    }
    const texto = String(valor).trim();
    if (!texto) return null;
    let normalizado = texto.replace(/\s+/g, '');
    if (normalizado.includes(',')) {
      normalizado = normalizado.replace(/\./g, '').replace(',', '.');
    } else {
      normalizado = normalizado.replace(/[^0-9.-]/g, '');
    }
    const numero = Number(normalizado);
    return Number.isNaN(numero) ? null : numero;
  };

  const configurarMascaraNumerica = (campo, decimais = 0) => {
    if (!campo) return;
    const formatador = new Intl.NumberFormat('pt-BR', {
      minimumFractionDigits: decimais,
      maximumFractionDigits: decimais
    });

    const helper = {
      decimais,
      definirValor: (valor) => {
        const numero = parseValorNumerico(valor);
        if (numero === null) {
          campo.dataset.raw = '';
          campo.value = '';
          return;
        }
        const raw = decimais > 0 ? numero.toFixed(decimais) : numero.toString();
        campo.dataset.raw = raw;
        campo.value = formatador.format(Number(raw));
      }
    };

    numericMaskHelpers.set(campo.id, helper);

    campo.addEventListener('focus', () => {
      campo.value = campo.dataset.raw || '';
    });

    campo.addEventListener('input', () => {
      const texto = campo.value.replace(/[^0-9,.-]/g, '');
      campo.value = texto;
      const numero = parseValorNumerico(texto);
      campo.dataset.raw = numero === null ? '' : (helper.decimais > 0 ? numero.toFixed(helper.decimais) : numero.toString());
    });

    campo.addEventListener('blur', () => {
      const numero = obterNumeroNormalizado(campo);
      if (numero === '' && numero !== 0) {
        campo.dataset.raw = '';
        campo.value = '';
        return;
      }
      helper.definirValor(numero);
    });

    helper.definirValor(campo.value);
  };

  const definirValorNumerico = (campo, valor) => {
    const helper = campo ? numericMaskHelpers.get(campo.id) : null;
    if (helper) {
      helper.definirValor(valor);
    } else if (campo) {
      campo.value = valor || '';
    }
  };

  const obterNumeroNormalizado = (campo) => {
    if (!campo) return '';
    const helper = numericMaskHelpers.get(campo.id);
    if (helper) {
      const raw = campo.dataset.raw;
      if (raw === undefined || raw === null || raw === '') return '';
      const numero = parseValorNumerico(raw);
      if (numero === null) return '';
      return helper.decimais === 0 ? Math.round(numero) : Number(numero.toFixed(helper.decimais));
    }
    const texto = (campo.value || '').trim();
    if (!texto) return '';
    const numero = parseValorNumerico(texto);
    return numero === null ? '' : numero;
  };

  const formatarTelefoneParaExibicao = (valor) => {
    const digitos = (valor || '').replace(/\D/g, '').slice(0, 11);
    if (!digitos) return '';
    if (digitos.length <= 10) {
      return digitos.replace(/(\d{0,2})(\d{0,4})(\d{0,4})/, (match, ddd, parte1, parte2) => {
        if (!parte1) return ddd;
        if (!parte2) return `(${ddd}) ${parte1}`;
        return `(${ddd}) ${parte1}-${parte2}`;
      });
    }
    return digitos.replace(/(\d{0,2})(\d{0,5})(\d{0,4})/, (match, ddd, parte1, parte2) => {
      if (!parte1) return ddd;
      if (!parte2) return `(${ddd}) ${parte1}`;
      return `(${ddd}) ${parte1}-${parte2}`;
    });
  };

  const configurarMascaraTelefone = (campo) => {
    if (!campo) return;
    campo.addEventListener('input', () => {
      const digitos = campo.value.replace(/\D/g, '').slice(0, 11);
      campo.dataset.raw = digitos;
      campo.value = formatarTelefoneParaExibicao(digitos);
    });
    campo.addEventListener('blur', () => {
      campo.value = formatarTelefoneParaExibicao(obterTelefoneNormalizado(campo));
    });
    campo.dataset.raw = (campo.value || '').replace(/\D/g, '').slice(0, 11);
    campo.value = formatarTelefoneParaExibicao(campo.dataset.raw);
  };

  const obterTelefoneNormalizado = (campo) => {
    if (!campo) return '';
    const raw = campo.dataset ? campo.dataset.raw : null;
    if (raw !== undefined && raw !== null) return raw;
    return (campo.value || '').replace(/\D/g, '').slice(0, 11);
  };

  const definirTelefone = (campo, valor) => {
    if (!campo) return;
    const digitos = (valor || '').replace(/\D/g, '').slice(0, 11);
    campo.dataset.raw = digitos;
    campo.value = formatarTelefoneParaExibicao(digitos);
  };

  [
    { campo: campos.beneficiarios, decimais: 0 },
    { campo: campos.investimento, decimais: 2 },
    { campo: campos.orcamentoPrevisto, decimais: 2 },
    { campo: campos.orcamentoAprovado, decimais: 2 },
    { campo: campos.orcamentoExecutado, decimais: 2 },
    { campo: campos.distanciaEnergia, decimais: 0 }
  ].forEach(({ campo, decimais }) => configurarMascaraNumerica(campo, decimais));

  configurarMascaraTelefone(campos.contatoTelefone);

  popularEstados();
  if (campos.estado && campos.estado.value) {
    sincronizarMunicipiosComEstado(campos.estado.value, campos.municipio ? campos.municipio.value : '');
  } else {
    limparMunicipios('Selecione um estado para listar munic√≠pios automaticamente.', 'info');
  }

  if (campos.estado) {
    const reagirEstado = () => {
      const municipioAtual = campos.municipio ? campos.municipio.value : '';
      sincronizarMunicipiosComEstado(campos.estado.value, municipioAtual);
    };
    ['change', 'blur'].forEach(evento => campos.estado.addEventListener(evento, reagirEstado));
    campos.estado.addEventListener('input', () => {
      if (!campos.estado.value.trim()) {
        if (campos.municipio) campos.municipio.value = '';
        limparMunicipios('Selecione um estado para listar munic√≠pios automaticamente.', 'info');
      }
    });
  }

  if (campos.municipio) {
    campos.municipio.addEventListener('focus', () => {
      if (!campos.estado.value.trim()) {
        atualizarFeedbackMunicipios('Selecione um estado para habilitar a lista de munic√≠pios.', 'info');
      }
    });
  }

  [campos.estado, campos.municipio, campos.comunidade, campos.regiao, campos.resumoStatus]
    .filter(Boolean)
    .forEach(campo => {
      ['input', 'change', 'blur'].forEach(evento => {
        campo.addEventListener(evento, () => {
          atualizarPopupMarcador();
          atualizarResumoLocalizacao();
        });
      });
    });

  const atualizarFeedbackCoordenadas = (mensagem, tipo = 'neutro') => {
    if (feedbackCoordenadas) {
      const cores = {
        sucesso: 'text-green-600',
        erro: 'text-red-600',
        info: 'text-blue-600',
        neutro: 'text-gray-500'
      };
      feedbackCoordenadas.textContent = mensagem;
      feedbackCoordenadas.className = `md:col-span-4 text-xs mt-1 ${cores[tipo] || cores.neutro}`;
    }
    if (feedbackLocalizacaoSimplificada) {
      const classes = {
        sucesso: 'feedback-simplificado feedback-simplificado--sucesso',
        erro: 'feedback-simplificado feedback-simplificado--erro',
        info: 'feedback-simplificado feedback-simplificado--info',
        neutro: 'feedback-simplificado feedback-simplificado--neutro'
      };
      feedbackLocalizacaoSimplificada.textContent = mensagem;
      feedbackLocalizacaoSimplificada.className = classes[tipo] || classes.neutro;
    }
    atualizarResumoLocalizacao();
    atualizarPopupMarcador();
  };

  const analisarCoordenada = (valor, limite) => {
    const texto = valor == null ? '' : String(valor).trim();
    if (!texto) return { valor: null, vazio: true, mensagem: '' };
    const numero = Number(texto.replace(/\s+/g, '').replace(',', '.'));
    if (!Number.isFinite(numero)) {
      return { valor: null, vazio: false, mensagem: 'Use apenas n√∫meros e separador decimal.' };
    }
    if (numero < -limite || numero > limite) {
      return { valor: null, vazio: false, mensagem: `Valor deve estar entre ${-limite} e ${limite}.` };
    }
    return { valor: Number(numero.toFixed(6)), vazio: false, mensagem: '' };
  };

  const atualizarValidacaoCoordenadas = () => {
    const lat = analisarCoordenada(campos.latitude.value, 90);
    const lon = analisarCoordenada(campos.longitude.value, 180);

    if (lat.mensagem) {
      atualizarFeedbackCoordenadas(`Latitude inv√°lida: ${lat.mensagem}`, 'erro');
      return { valido: false, latitude: null, longitude: null };
    }
    if (lon.mensagem) {
      atualizarFeedbackCoordenadas(`Longitude inv√°lida: ${lon.mensagem}`, 'erro');
      return { valido: false, latitude: null, longitude: null };
    }

    if (lat.valor !== null && lon.valor !== null) {
      const geocodeOk = geocodificacaoAtual && geocodificacaoAtual.sucesso && geocodificacaoAtual.latitude === lat.valor && geocodificacaoAtual.longitude === lon.valor;
      atualizarFeedbackCoordenadas(geocodeOk ? 'Coordenadas validadas com sucesso.' : 'Coordenadas v√°lidas. Validando endere√ßo automaticamente...', geocodeOk ? 'sucesso' : 'info');
      return { valido: true, latitude: lat.valor, longitude: lon.valor };
    }

    if (!lat.vazio || !lon.vazio) {
      atualizarFeedbackCoordenadas('Informe os dois valores de coordenadas para validar.', 'info');
      return { valido: false, latitude: lat.valor, longitude: lon.valor };
    }

    atualizarFeedbackCoordenadas('Informe latitude e longitude para validar as coordenadas.', 'neutro');
    return { valido: true, latitude: null, longitude: null };
  };

  const solicitarGeocodificacao = (latitude, longitude) => {
    if (geocodeTimeout) {
      clearTimeout(geocodeTimeout);
      geocodeTimeout = null;
    }
    geocodificacaoAtual = { sucesso: false, latitude, longitude, status: 'AGUARDANDO' };
    atualizarFeedbackCoordenadas('Validando coordenadas com servi√ßo de geocodifica√ß√£o...', 'info');

    google.script.run
      .withSuccessHandler(res => {
        const latAtual = analisarCoordenada(campos.latitude.value, 90);
        const lonAtual = analisarCoordenada(campos.longitude.value, 180);
        const coordenadasMantidas = latAtual.valor === latitude && lonAtual.valor === longitude;
        if (!coordenadasMantidas) return;

        if (!res || !res.sucesso) {
          geocodificacaoAtual = null;
          atualizarFeedbackCoordenadas((res && res.mensagem) ? res.mensagem : 'N√£o foi poss√≠vel validar as coordenadas.', 'erro');
          return;
        }

        geocodificacaoAtual = {
          sucesso: true,
          estado: res.estado || '',
          municipio: res.municipio || res.cidade || '',
          fonte: res.fonte || '',
          precisao: res.precisao || '',
          status: res.status || 'OK',
          timestamp: res.timestamp || new Date().toISOString(),
          displayName: res.displayName || '',
          latitude,
          longitude
        };

        const estadoGeocode = geocodificacaoAtual.estado || '';
        const municipioGeocode = geocodificacaoAtual.municipio || '';
        if (estadoGeocode) {
          if (!campos.estado.value) campos.estado.value = estadoGeocode;
          const municipioAtual = campos.municipio.value || municipioGeocode;
          sincronizarMunicipiosComEstado(campos.estado.value || estadoGeocode, municipioAtual);
        }
        if (!campos.municipio.value && municipioGeocode) campos.municipio.value = municipioGeocode;
        atualizarFeedbackCoordenadas('Coordenadas validadas e endere√ßo identificado automaticamente.', 'sucesso');
        carregarLeafletSeNecessario().then(() => atualizarMarcadorCoordenadas(latitude, longitude, true)).catch(() => {});
        atualizarPopupMarcador(true);
        atualizarResumoLocalizacao();
      })
      .withFailureHandler(err => {
        const latAtual = analisarCoordenada(campos.latitude.value, 90);
        const lonAtual = analisarCoordenada(campos.longitude.value, 180);
        const coordenadasMantidas = latAtual.valor === latitude && lonAtual.valor === longitude;
        if (!coordenadasMantidas) return;

        geocodificacaoAtual = null;
        const mensagem = err && err.message ? err.message : 'Erro inesperado na geocodifica√ß√£o.';
        atualizarFeedbackCoordenadas(`N√£o foi poss√≠vel validar as coordenadas: ${mensagem}`, 'erro');
      })
      .geocodificarCoordenadas(latitude, longitude);
  };

  const agendarGeocodificacao = (latitude, longitude) => {
    if (geocodeTimeout) clearTimeout(geocodeTimeout);
    geocodeTimeout = window.setTimeout(() => solicitarGeocodificacao(latitude, longitude), 600);
  };

  const monitorarCoordenadas = (event) => {
    const resultado = atualizarValidacaoCoordenadas();
    atualizarResumoLocalizacao();
    const centralizarNoMapa = event && event.type === 'blur';

    if (!resultado.valido) {
      geocodificacaoAtual = null;
      if (geocodeTimeout) {
        clearTimeout(geocodeTimeout);
        geocodeTimeout = null;
      }
      carregarLeafletSeNecessario().then(() => limparMarcadorCoordenadas(false)).catch(() => {});
      return;
    }

    const { latitude, longitude } = resultado;
    if (latitude !== null && longitude !== null) {
      carregarLeafletSeNecessario().then(() => atualizarMarcadorCoordenadas(latitude, longitude, centralizarNoMapa)).catch(() => {});
      if (geocodificacaoAtual && geocodificacaoAtual.sucesso && geocodificacaoAtual.latitude === latitude && geocodificacaoAtual.longitude === longitude) {
        return;
      }
      geocodificacaoAtual = null;
      agendarGeocodificacao(latitude, longitude);
    } else {
      geocodificacaoAtual = null;
      if (geocodeTimeout) {
        clearTimeout(geocodeTimeout);
        geocodeTimeout = null;
      }
      carregarLeafletSeNecessario().then(() => limparMarcadorCoordenadas(false)).catch(() => {});
    }
  };

  campos.latitude.addEventListener('input', monitorarCoordenadas);
  campos.longitude.addEventListener('input', monitorarCoordenadas);
  campos.latitude.addEventListener('blur', atualizarValidacaoCoordenadas);
  campos.longitude.addEventListener('blur', atualizarValidacaoCoordenadas);

  const capturarLocalizacaoSimplificada = () => {
    if (!navigator.geolocation) {
      atualizarFeedbackCoordenadas('Seu dispositivo n√£o permite capturar a localiza√ß√£o automaticamente.', 'erro');
      return;
    }
    atualizarFeedbackCoordenadas('Capturando localiza√ß√£o do dispositivo...', 'info');
    navigator.geolocation.getCurrentPosition(
      (posicao) => {
        if (!posicao || !posicao.coords) {
          atualizarFeedbackCoordenadas('N√£o foi poss√≠vel obter coordenadas v√°lidas.', 'erro');
          return;
        }
        const { latitude, longitude } = posicao.coords;
        if (!Number.isFinite(latitude) || !Number.isFinite(longitude)) {
          atualizarFeedbackCoordenadas('As coordenadas retornadas n√£o s√£o v√°lidas.', 'erro');
          return;
        }
        campos.latitude.value = Number(latitude).toFixed(6);
        campos.longitude.value = Number(longitude).toFixed(6);
        atualizarResumoLocalizacao();
        monitorarCoordenadas();
        atualizarFeedbackCoordenadas('Localiza√ß√£o capturada com sucesso! Validando endere√ßo...', 'sucesso');
      },
      (erro) => {
        let mensagem = 'N√£o foi poss√≠vel capturar a localiza√ß√£o autom√°tica.';
        if (erro && erro.code === erro.PERMISSION_DENIED) {
          mensagem = 'Permita o acesso √† localiza√ß√£o para preencher automaticamente.';
        }
        atualizarFeedbackCoordenadas(mensagem, 'erro');
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  };

  if (btnCapturarLocalizacao) {
    btnCapturarLocalizacao.addEventListener('click', capturarLocalizacaoSimplificada);
  }

  atualizarFeedbackCoordenadas('Informe latitude e longitude para validar as coordenadas.', 'neutro');

  const limparFormulario = () => {
    form.reset();
    hiddenId.value = '';
    hiddenEvidencias.value = '[]';
    hiddenTimeline.value = '[]';
    hiddenTermo.value = '';
    hiddenNota.value = '';
    mensagemFormulario.textContent = '';
    mensagemFormulario.className = 'text-sm font-medium';
    definirValorNumerico(campos.beneficiarios, '');
    definirValorNumerico(campos.investimento, '');
    definirValorNumerico(campos.orcamentoPrevisto, '');
    definirValorNumerico(campos.orcamentoAprovado, '');
    definirValorNumerico(campos.orcamentoExecutado, '');
    definirValorNumerico(campos.distanciaEnergia, '');
    definirTelefone(campos.contatoTelefone, '');
    carregarLeafletSeNecessario().then(() => limparMarcadorCoordenadas(true)).catch(() => {});
    limparMunicipios('Selecione um estado para listar munic√≠pios automaticamente.', 'info');
    geocodificacaoAtual = null;
    if (geocodeTimeout) {
      clearTimeout(geocodeTimeout);
      geocodeTimeout = null;
    }
    atualizarFeedbackCoordenadas('Informe latitude e longitude para validar as coordenadas.', 'neutro');
    atualizarResumoLocalizacao();
  };

  const STATUS_CORES = {
    'solicitado': 'bg-orange-100 text-orange-700',
    'or√ßamento previsto': 'bg-yellow-100 text-yellow-700',
    'instala√ß√£o': 'bg-blue-100 text-blue-700',
    'conclu√≠do': 'bg-green-100 text-green-700',
    'pago': 'bg-emerald-100 text-emerald-700'
  };

  const ETAPAS_PIPELINE = [
    {
      id: 'solicitacao',
      titulo: 'Solicita√ß√£o do l√≠der de base',
      descricao: 'Registro inicial feito diretamente por quem est√° na comunidade.'
    },
    {
      id: 'painel',
      titulo: 'Painel de solicita√ß√µes',
      descricao: 'Triagem r√°pida para confirmar dados essenciais e encaminhar o pedido.'
    },
    {
      id: 'orcamentos',
      titulo: 'Or√ßamentos com fornecedores',
      descricao: 'Cota√ß√µes enviadas para quem perfura, instala e fornece equipamentos.'
    },
    {
      id: 'viabilidade',
      titulo: 'Viabilidade t√©cnica em campo',
      descricao: 'Profissional vai ao local validar terreno, energia e disponibilidade de √°gua.'
    },
    {
      id: 'analise',
      titulo: 'An√°lise e prioriza√ß√£o',
      descricao: 'Defini√ß√£o dos po√ßos que seguir√£o para a fase de instala√ß√£o.'
    },
    {
      id: 'financiamento',
      titulo: 'Recursos do doador garantidos',
      descricao: 'Valores reservados e prontos para transfer√™ncia ao projeto do po√ßo.'
    },
    {
      id: 'execucao',
      titulo: 'Execu√ß√£o e opera√ß√£o do po√ßo',
      descricao: 'Perfura√ß√£o, instala√ß√£o e monitoramento do funcionamento com a comunidade.'
    }
  ];

  const classificarEtapaPrincipal = (poco = {}) => {
    const baseStatus = [poco.StatusProcessual, poco.Status, poco.ResumoStatus]
      .filter(Boolean)
      .join(' ')
      .toLowerCase();
    if (!baseStatus) return 'solicitacao';
    if (baseStatus.includes('conclu') || baseStatus.includes('oper') || baseStatus.includes('instal') || baseStatus.includes('execut')) return 'execucao';
    if (baseStatus.includes('pag') || baseStatus.includes('recurso') || baseStatus.includes('doa') || baseStatus.includes('financ')) return 'financiamento';
    if (baseStatus.includes('anal') || baseStatus.includes('priori') || baseStatus.includes('decis')) return 'analise';
    if (baseStatus.includes('viab') || baseStatus.includes('vistoria') || baseStatus.includes('tecnic') || baseStatus.includes('exped')) return 'viabilidade';
    if (baseStatus.includes('orc') || baseStatus.includes('cot') || baseStatus.includes('planej') || baseStatus.includes('fornecedor')) return 'orcamentos';
    if (
      baseStatus.includes('painel') ||
      baseStatus.includes('triag') ||
      baseStatus.includes('penden') ||
      baseStatus.includes('aguard') ||
      baseStatus.includes('valid') ||
      baseStatus.includes('acompan')
    ) return 'painel';
    return 'solicitacao';
  };

  const fecharDetalhesPlanilha = () => {
    if (!painelPlanilhaDetalhes) return;
    painelPlanilhaDetalhes.classList.add('hidden');
    painelPlanilhaDetalhes.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('overflow-hidden-planilha');
    if (elementoFocoAnterior && typeof elementoFocoAnterior.focus === 'function') {
      elementoFocoAnterior.focus();
    }
    elementoFocoAnterior = null;
  };

  const abrirDetalhesPlanilha = (etapaId) => {
    if (!painelPlanilhaDetalhes || !planilhaTitulo || !planilhaResumo || !planilhaLista) return;
    const etapa = ETAPAS_PIPELINE.find(item => item.id === etapaId);
    if (!etapa) return;
    const registros = listaPocos.filter(poco => classificarEtapaPrincipal(poco) === etapaId);
    planilhaTitulo.textContent = etapa.titulo;
    const contagemTexto = registros.length
      ? `${registros.length} registro${registros.length === 1 ? '' : 's'} vinculado${registros.length === 1 ? '' : 's'} a esta etapa.`
      : 'Nenhum registro encontrado nesta etapa.';
    const resumoPartes = [];
    if (etapa.descricao) resumoPartes.push(etapa.descricao);
    resumoPartes.push(contagemTexto);
    planilhaResumo.textContent = resumoPartes.join(' ‚Ä¢ ');
    planilhaLista.innerHTML = registros.length
      ? registros.map(poco => {
          const nome = poco['Comunidade'] || poco['Munic√≠pio'] || poco['Estado'] || 'Po√ßo sem identifica√ß√£o';
          const local = [poco['Munic√≠pio'], poco['Estado']].filter(Boolean).join(' ‚Ä¢ ') || 'Local n√£o informado';
          const status = poco.Status || 'Sem status';
          const distanciaBruta = poco.DistanciaEnergia !== undefined ? poco.DistanciaEnergia : poco.distanciaEnergia;
          const distanciaNumero = Number(distanciaBruta);
          const distanciaTexto = distanciaBruta !== '' && distanciaBruta !== null && Number.isFinite(distanciaNumero)
            ? `${distanciaNumero} m at√© a energia`
            : '';
          return `<article>
            <p class="font-semibold text-gray-900">${escapeHtml(nome)}</p>
            <p class="text-xs text-gray-500">${escapeHtml(local)}</p>
            <p class="text-xs text-blue-700 font-semibold mt-1">${escapeHtml(status)}</p>
            ${distanciaTexto ? `<p class="text-xs text-gray-600 mt-1">${escapeHtml(distanciaTexto)}</p>` : ''}
          </article>`;
        }).join('')
      : '<p class="text-sm text-gray-500">Registre novos dados no formul√°rio para acompanhar esta etapa.</p>';
    painelPlanilhaDetalhes.classList.remove('hidden');
    painelPlanilhaDetalhes.setAttribute('aria-hidden', 'false');
    document.body.classList.add('overflow-hidden-planilha');
    elementoFocoAnterior = document.activeElement instanceof HTMLElement ? document.activeElement : null;
    if (planilhaTitulo && typeof planilhaTitulo.focus === 'function') {
      planilhaTitulo.focus();
    }
  };

  const renderizarPlanilhas = () => {
    if (!listaPlanilhasOperacionais) return;
    listaPlanilhasOperacionais.innerHTML = ETAPAS_PIPELINE.map((etapa, indice) => {
      const total = resumoEtapasAtual[etapa.id] || 0;
      const ariaLabel = `Ver detalhes da etapa ${indice + 1}: ${etapa.titulo}`;
      return `<button type="button" class="planilha-card" data-planilha="${etapa.id}" aria-label="${escapeHtml(ariaLabel)}">
        <span class="planilha-card__etapa">Etapa ${indice + 1}</span>
        <span class="planilha-card__titulo">${escapeHtml(etapa.titulo)}</span>
        <span class="planilha-card__contador">${total}</span>
        <span class="planilha-card__descricao">${escapeHtml(etapa.descricao)}</span>
      </button>`;
    }).join('');
    listaPlanilhasOperacionais.querySelectorAll('.planilha-card').forEach(botao => {
      botao.addEventListener('click', () => abrirDetalhesPlanilha(botao.dataset.planilha));
    });
  };

  const atualizarResumoFluxo = () => {
    resumoEtapasAtual = ETAPAS_PIPELINE.reduce((acc, etapa) => {
      acc[etapa.id] = 0;
      return acc;
    }, {});
    listaPocos.forEach(poco => {
      const etapa = classificarEtapaPrincipal(poco);
      if (!resumoEtapasAtual[etapa]) resumoEtapasAtual[etapa] = 0;
      resumoEtapasAtual[etapa] += 1;
    });
    if (etapasFluxoEl) {
      etapasFluxoEl.innerHTML = ETAPAS_PIPELINE.map((etapa, indice) => {
        const total = resumoEtapasAtual[etapa.id] || 0;
        return `
          <li>
            <span class="etapa-label">Etapa ${indice + 1}</span>
            <span class="contador">${total}</span>
            <p class="font-semibold text-slate-800">${escapeHtml(etapa.titulo)}</p>
            <p class="text-xs text-slate-600">${escapeHtml(etapa.descricao)}</p>
          </li>
        `.trim();
      }).join('');
    }
    if (indicadoresFluxoEl) {
      const total = listaPocos.length;
      const execucao = resumoEtapasAtual.execucao || 0;
      const emAndamento = Math.max(total - execucao, 0);
      const aguardandoRecursos = resumoEtapasAtual.financiamento || 0;
      indicadoresFluxoEl.innerHTML = `
        <div><dt>Total de po√ßos</dt><dd>${total}</dd></div>
        <div><dt>Em andamento</dt><dd>${emAndamento}</dd></div>
        <div><dt>Prontos para instalar</dt><dd>${aguardandoRecursos}</dd></div>
      `;
    }
    renderizarPlanilhas();
  };

  if (btnFecharPlanilha) {
    btnFecharPlanilha.addEventListener('click', fecharDetalhesPlanilha);
  }
  if (painelPlanilhaDetalhes) {
    painelPlanilhaDetalhes.addEventListener('click', (evento) => {
      if (evento.target === painelPlanilhaDetalhes) fecharDetalhesPlanilha();
    });
  }
  document.addEventListener('keydown', (evento) => {
    if (evento.key === 'Escape' && painelPlanilhaDetalhes && !painelPlanilhaDetalhes.classList.contains('hidden')) {
      fecharDetalhesPlanilha();
    }
  });

  const MAPA_CENTRO_BRASIL = [-14.235004, -51.92528];
  const MAPA_ZOOM_BRASIL = 4;
  const TILE_URL_PADRAO = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  const TILE_ATTRIBUTION_PADRAO = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> colaboradores';

  let listaPocos = [];
  let resumoEtapasAtual = {};
  let detalheAtual = null;
  let mapaPocos = null;
  let camadaMarcadores = null;
  let leafletPromise = null;
  let mapaCoordenadas = null;
  let marcadorCoordenadas = null;
  let geocodificacaoAtual = null;
  let geocodeTimeout = null;

  const obterValorCampoTrim = (campo) => {
    if (!campo || campo.value == null) return '';
    return String(campo.value).trim();
  };

  const formatarCoordenadaPopup = (valor, etiqueta) => {
    if (!Number.isFinite(valor)) return '';
    return `${etiqueta}: ${Number(valor).toFixed(6)}`;
  };

  const construirPopupLocalizacao = () => {
    if (!marcadorCoordenadas || typeof escapeHtml !== 'function') return '';
    const latLng = typeof marcadorCoordenadas.getLatLng === 'function' ? marcadorCoordenadas.getLatLng() : null;
    const coordenadasPartes = [];
    if (latLng) {
      const latTexto = formatarCoordenadaPopup(latLng.lat, 'Lat');
      const lonTexto = formatarCoordenadaPopup(latLng.lng, 'Lng');
      if (latTexto) coordenadasPartes.push(`<span>${escapeHtml(latTexto)}</span>`);
      if (lonTexto) coordenadasPartes.push(`<span>${escapeHtml(lonTexto)}</span>`);
    }

    const comunidade = obterValorCampoTrim(campos.comunidade);
    const municipioInformado = obterValorCampoTrim(campos.municipio);
    const estadoInformado = obterValorCampoTrim(campos.estado);
    const regiao = obterValorCampoTrim(campos.regiao);
    const resumo = obterValorCampoTrim(campos.resumoStatus);

    const municipioPopup = municipioInformado || (geocodificacaoAtual && geocodificacaoAtual.municipio) || '';
    const estadoPopup = estadoInformado || (geocodificacaoAtual && geocodificacaoAtual.estado) || '';

    const titulo = comunidade || (municipioPopup ? `Po√ßo em ${municipioPopup}` : 'Localiza√ß√£o selecionada');
    const subtituloPartes = [municipioPopup, estadoPopup].filter(Boolean);
    const subtitulo = subtituloPartes.length ? subtituloPartes.join(' ‚Ä¢ ') : 'Atualize os dados ao lado para completar o cadastro.';

    const detalhes = [];
    if (regiao) detalhes.push(`Regi√£o: <strong>${escapeHtml(regiao)}</strong>`);
    if (resumo) detalhes.push(`Situa√ß√£o: ${escapeHtml(resumo)}`);
    if (geocodificacaoAtual && geocodificacaoAtual.sucesso && geocodificacaoAtual.displayName) {
      detalhes.push(escapeHtml(geocodificacaoAtual.displayName));
    }

    let statusLinha = '';
    if (geocodificacaoAtual && geocodificacaoAtual.sucesso) {
      const partesStatus = [];
      if (geocodificacaoAtual.fonte) partesStatus.push(`Fonte: ${geocodificacaoAtual.fonte}`);
      if (geocodificacaoAtual.precisao) partesStatus.push(`Precis√£o: ${geocodificacaoAtual.precisao}`);
      if (geocodificacaoAtual.status && !partesStatus.length) partesStatus.push(geocodificacaoAtual.status);
      statusLinha = partesStatus.join(' ‚Ä¢ ');
    } else if (feedbackCoordenadas && feedbackCoordenadas.textContent) {
      statusLinha = feedbackCoordenadas.textContent;
    }

    const coordsHtml = coordenadasPartes.length ? `<div class="coords">${coordenadasPartes.join('<span>‚Ä¢</span>')}</div>` : '';
    const detalhesHtml = detalhes.length ? detalhes.map(texto => `<div class="detalhe">${texto}</div>`).join('') : '';
    const statusHtml = statusLinha ? `<div class="status">${escapeHtml(statusLinha)}</div>` : '';

    return `
      <div class="popup-localizacao">
        <span class="titulo">${escapeHtml(titulo)}</span>
        <span class="subtitulo">${escapeHtml(subtitulo)}</span>
        ${coordsHtml}
        ${detalhesHtml}
        ${statusHtml}
      </div>
    `;
  };

  const atualizarPopupMarcador = (abrir = false) => {
    if (!marcadorCoordenadas) return;
    const conteudo = construirPopupLocalizacao();
    if (!conteudo) return;
    const popupExistente = typeof marcadorCoordenadas.getPopup === 'function' ? marcadorCoordenadas.getPopup() : null;
    if (popupExistente) {
      popupExistente.setContent(conteudo);
    } else if (typeof marcadorCoordenadas.bindPopup === 'function') {
      marcadorCoordenadas.bindPopup(conteudo, {
        closeButton: false,
        autoClose: false,
        className: 'popup-localizacao-container'
      });
    }
    if (abrir && typeof marcadorCoordenadas.openPopup === 'function') {
      marcadorCoordenadas.openPopup();
    }
  };

  const carregarLeafletSeNecessario = () => {
    if (window.L) return Promise.resolve();
    if (leafletPromise) return leafletPromise;

    leafletPromise = new Promise((resolve, reject) => {
      const head = document.head || document.getElementsByTagName('head')[0];
      if (!head) {
        resolve();
        return;
      }

      if (!document.querySelector('link[data-leaflet="css"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
        link.crossOrigin = '';
        link.dataset.leaflet = 'css';
        head.appendChild(link);
      }

      if (window.L) {
        resolve();
        return;
      }

      const scriptExistente = document.querySelector('script[data-leaflet="js"]');
      if (scriptExistente && scriptExistente.dataset.carregado === 'true') {
        resolve();
        return;
      }

      const script = scriptExistente || document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
      script.crossOrigin = '';
      script.defer = true;
      script.dataset.leaflet = 'js';
      script.onload = () => {
        script.dataset.carregado = 'true';
        resolve();
      };
      script.onerror = (erro) => {
        console.error('Falha ao carregar Leaflet', erro);
        reject(erro);
      };

      if (!scriptExistente) {
        head.appendChild(script);
      }
    });

    return leafletPromise;
  };

  const inicializarMapa = () => {
    if (mapaPocos) return mapaPocos;
    const container = document.getElementById('mapaPocos');
    if (!container || !window.L) return null;

    mapaPocos = L.map(container, {
      zoomControl: true,
      attributionControl: true
    }).setView(MAPA_CENTRO_BRASIL, MAPA_ZOOM_BRASIL);

    L.tileLayer(TILE_URL_PADRAO, {
      maxZoom: 18,
      attribution: TILE_ATTRIBUTION_PADRAO
    }).addTo(mapaPocos);

    camadaMarcadores = L.layerGroup().addTo(mapaPocos);
    setTimeout(() => mapaPocos.invalidateSize(), 100);
    return mapaPocos;
  };

  const inicializarMapaCoordenadas = () => {
    if (mapaCoordenadas) return mapaCoordenadas;
    const container = document.getElementById('mapaCoordenadas');
    if (!container || !window.L) return null;

    mapaCoordenadas = L.map(container, {
      zoomControl: true,
      attributionControl: true
    }).setView(MAPA_CENTRO_BRASIL, MAPA_ZOOM_BRASIL);

    L.tileLayer(TILE_URL_PADRAO, {
      maxZoom: 18,
      attribution: TILE_ATTRIBUTION_PADRAO
    }).addTo(mapaCoordenadas);

    mapaCoordenadas.on('click', (evento) => {
      if (!evento || !evento.latlng) return;
      definirCoordenadasAPartirDoMapa(evento.latlng.lat, evento.latlng.lng, { centralizar: false });
    });

    setTimeout(() => mapaCoordenadas.invalidateSize(), 100);
    return mapaCoordenadas;
  };

  const limparMarcadorCoordenadas = (recentralizar = false) => {
    if (marcadorCoordenadas) {
      marcadorCoordenadas.remove();
      marcadorCoordenadas = null;
    }
    if (recentralizar && mapaCoordenadas) {
      mapaCoordenadas.setView(MAPA_CENTRO_BRASIL, MAPA_ZOOM_BRASIL);
    }
  };

  const atualizarMarcadorCoordenadas = (latitude, longitude, centralizar = false) => {
    if (!window.L) return;
    const mapa = inicializarMapaCoordenadas();
    if (!mapa) return;

    if (!Number.isFinite(latitude) || !Number.isFinite(longitude)) {
      limparMarcadorCoordenadas(centralizar);
      return;
    }

    const existiaMarcador = Boolean(marcadorCoordenadas);
    if (!marcadorCoordenadas) {
      marcadorCoordenadas = L.marker([latitude, longitude], {
        draggable: true,
        autoPan: true
      }).addTo(mapa);

      marcadorCoordenadas.on('dragend', (evento) => {
        const marcador = evento && evento.target;
        if (!marcador) return;
        const posicao = marcador.getLatLng();
        definirCoordenadasAPartirDoMapa(posicao.lat, posicao.lng, { centralizar: false });
      });
    } else {
      marcadorCoordenadas.setLatLng([latitude, longitude]);
    }

    if (centralizar) {
      const zoom = Math.max(mapa.getZoom(), 12);
      mapa.flyTo([latitude, longitude], zoom, { duration: 0.35 });
    }

    atualizarPopupMarcador(!existiaMarcador || centralizar);
  };

  const definirCoordenadasAPartirDoMapa = (latitude, longitude, { centralizar = true } = {}) => {
    if (!Number.isFinite(latitude) || !Number.isFinite(longitude)) return;
    campos.latitude.value = Number(latitude).toFixed(6);
    campos.longitude.value = Number(longitude).toFixed(6);
    atualizarMarcadorCoordenadas(latitude, longitude, centralizar);
    monitorarCoordenadas();
    window.setTimeout(() => atualizarPopupMarcador(true), 0);
  };

  carregarLeafletSeNecessario().then(() => inicializarMapaCoordenadas()).catch(() => {});

  const obterCorMarcador = (poco) => {
    const situacao = (poco.SituacaoHidrica || '').toLowerCase();
    if (situacao.includes('cr√≠t') || situacao.includes('crit') || situacao.includes('colapso')) return '#dc2626';
    if (situacao.includes('alerta') || situacao.includes('aten√ß√£o') || situacao.includes('risco')) return '#f97316';
    if (situacao.includes('manuten√ß√£o') || situacao.includes('monitoramento')) return '#eab308';

    const status = (poco.Status || '').toLowerCase();
    if (status.includes('paralis') || status.includes('aguardando') || status.includes('pendente')) return '#f59e0b';
    if (status.includes('conclu') || status.includes('ativo') || status.includes('produzindo')) return '#16a34a';
    return '#2563eb';
  };

  const atualizarMapa = (pocos = []) => {
    if (!window.L) return;
    const mapa = inicializarMapa();
    if (!mapa || !camadaMarcadores) return;

    camadaMarcadores.clearLayers();
    const bounds = [];

    pocos.forEach(poco => {
      const lat = Number(poco.Latitude ?? poco.latitude ?? poco.lat);
      const lon = Number(poco.Longitude ?? poco.longitude ?? poco.lng ?? poco.lon);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;

      const cor = obterCorMarcador(poco);
      const marker = L.circleMarker([lat, lon], {
        radius: 8,
        color: cor,
        weight: 2,
        fillColor: cor,
        fillOpacity: 0.85
      });

      const municipio = poco['Munic√≠pio'] || poco.Municipio || poco.Cidade || 'Munic√≠pio n√£o informado';
      const situacao = poco.SituacaoHidrica || poco.StatusHidrico || '';
      const statusContato = poco.StatusContato || poco.statusContato || '';
      const linhasTooltip = [
        `<strong>${escapeHtml(municipio)}</strong>`,
        situacao ? `Situa√ß√£o h√≠drica: ${escapeHtml(situacao)}` : '',
        statusContato ? `Contato: ${escapeHtml(statusContato)}` : ''
      ].filter(Boolean).join('<br>');

      marker.bindTooltip(linhasTooltip, { direction: 'top' });
      marker.addTo(camadaMarcadores);
      bounds.push([lat, lon]);
    });

    if (bounds.length) {
      mapa.fitBounds(bounds, { padding: [32, 32] });
    } else {
      mapa.setView(MAPA_CENTRO_BRASIL, MAPA_ZOOM_BRASIL);
    }
  };

  const formataData = (valor) => {
    if (!valor) return '';
    const data = new Date(valor);
    if (Number.isNaN(data.getTime())) return '';
    return data.toLocaleDateString('pt-BR');
  };

  const dataParaInput = (valor) => {
    if (!valor) return '';
    const data = new Date(valor);
    if (Number.isNaN(data.getTime())) return '';
    return data.toISOString().split('T')[0];
  };

  const formataMoeda = (valor) => {
    const numero = Number(valor || 0);
    return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  };

  const statusClasses = (status) => {
    if (!status) return 'bg-gray-100 text-gray-600';
    const chave = status.toLowerCase();
    return STATUS_CORES[chave] || 'bg-gray-100 text-gray-600';
  };

  const renderizarLista = (pocos) => {
    contadorPocosEl.textContent = `${pocos.length} registro${pocos.length === 1 ? '' : 's'}`;
    if (!pocos.length) {
      listaPocosEl.innerHTML = '<li class="bg-white rounded-lg shadow p-4 text-center text-gray-500">Nenhum po√ßo cadastrado.</li>';
      return;
    }
    const html = pocos.map(p => {
      const status = (p.Status || '').toLowerCase();
      const local = [p['Comunidade'], p['Munic√≠pio'], p['Estado']].filter(Boolean).join(' ‚Ä¢ ');
      const previsto = Number(p.OrcamentoPrevisto || p['Valor Previsto Perfura√ß√£o'] || 0);
      const executado = Number(p.OrcamentoExecutado || p['Valor Realizado'] || 0);
      return `
        <li class="bg-white rounded-lg shadow hover:shadow-md transition cursor-pointer border border-transparent hover:border-blue-200" data-id="${p.ID}">
          <div class="p-4 space-y-2">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h4 class="font-semibold text-gray-900">${escapeHtml(p['Comunidade'] || p['Munic√≠pio'] || 'Po√ßo sem identifica√ß√£o')}</h4>
                <p class="text-xs text-gray-500">${escapeHtml(local)}</p>
              </div>
              <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClasses(status)}">${escapeHtml(p.Status || 'Sem status')}</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
              <div>Benefici√°rios: <strong>${Number(p['Benefici√°rios'] || 0)}</strong></div>
              <div>Executado: <strong>${formataMoeda(executado)}</strong></div>
            </div>
          </div>
        </li>`;
    }).join('');
    listaPocosEl.innerHTML = html;
    listaPocosEl.querySelectorAll('li').forEach(item => {
      item.addEventListener('click', () => selecionarPoco(item.dataset.id));
    });
  };

  const selecionarPoco = (id) => {
    const encontrado = listaPocos.find(p => p.ID === id);
    if (!encontrado) {
      console.warn('Po√ßo n√£o encontrado para detalhamento:', id);
      return;
    }

    detalheAtual = {
      poco: encontrado,
      timeline: encontrado.LinhaDoTempo || [],
      evidencias: encontrado.Evidencias || [],
      contatos: []
    };
    preencherDetalhes();

    google.script.run.withSuccessHandler(contatos => {
      if (!detalheAtual || !detalheAtual.poco || detalheAtual.poco.ID !== id) {
        return;
      }

      detalheAtual = Object.assign({}, detalheAtual, { contatos });
      preencherDetalhes();
    }).listarContatosPorPoco(id);
  };

  const preencherDetalhes = () => {
    if (!detalheAtual || !detalheAtual.poco) {
      painelDetalhes.classList.add('hidden');
      mensagemDetalhes.classList.remove('hidden');
      return;
    }
    const { poco, timeline, evidencias, contatos } = detalheAtual;
    painelDetalhes.classList.remove('hidden');
    mensagemDetalhes.classList.add('hidden');

    const nome = poco['Comunidade'] || poco['Munic√≠pio'] || poco['Estado'] || 'Po√ßo sem identifica√ß√£o';
    const local = [poco['Munic√≠pio'], poco['Estado']].filter(Boolean).join(' ‚Ä¢ ');
    detalheTitulo.textContent = nome;
    detalheLocal.textContent = local || 'Local n√£o informado';
    detalheResumo.textContent = poco.ResumoStatus || 'Sem descri√ß√£o';
    detalheStatus.textContent = poco.Status || 'Sem status';
    detalheStatus.className = `px-3 py-1 rounded-full text-sm font-medium ${statusClasses((poco.Status || '').toLowerCase())}`;

    detalheBeneficiarios.textContent = Number(poco['Benefici√°rios'] || 0);
    detalhePrevisto.textContent = formataMoeda(poco.OrcamentoPrevisto || poco['Valor Previsto Perfura√ß√£o']);
    detalheExecutado.textContent = formataMoeda(poco.OrcamentoExecutado || poco['Valor Realizado']);
    if (detalheDistanciaEnergia) {
      const distanciaValor = poco.DistanciaEnergia !== undefined ? poco.DistanciaEnergia : poco.distanciaEnergia;
      const distanciaNumero = Number(distanciaValor);
      detalheDistanciaEnergia.textContent = distanciaValor === '' || distanciaValor === null || Number.isNaN(distanciaNumero)
        ? '-'
        : `${distanciaNumero} m`;
    }

    const idsBase = new Set(['solicitado','orcamento','instalacao','conclusao','pagamento']);
    const timelineExtras = (timeline || []).filter(item => item && !idsBase.has(String(item.id || '').toLowerCase()));
    hiddenTimeline.value = JSON.stringify(timelineExtras);

    timelineEl.innerHTML = (timeline || []).map(item => {
      const status = item.status || 'pendente';
      const data = formataData(item.data);
      return `
        <li class="timeline-item" data-status="${status}">
          <div class="timeline-titulo">${escapeHtml(item.titulo || 'Etapa')}</div>
          <div class="timeline-data">${data || 'Sem data registrada'}</div>
          ${item.descricao ? `<p class="timeline-descricao">${escapeHtml(item.descricao)}</p>` : ''}
        </li>`;
    }).join('');

    if (!timelineEl.innerHTML) {
      timelineEl.innerHTML = '<li class="text-sm text-gray-500">Nenhuma etapa registrada.</li>';
    }

    const evidenciasAtuais = Array.isArray(evidencias) ? evidencias : [];
    hiddenEvidencias.value = JSON.stringify(evidenciasAtuais);
    evidenciasEl.innerHTML = evidenciasAtuais.length
      ? evidenciasAtuais.map(ev => {
          const tipo = (ev.tipo || '').toLowerCase();
          const isImagem = tipo.includes('imagem');
          if (isImagem) {
            return `
              <figure class="rounded-lg overflow-hidden border">
                <img src="${escapeHtml(ev.url)}" alt="${escapeHtml(ev.titulo || 'Evid√™ncia do po√ßo')}" class="w-full h-40 object-cover">
                <figcaption class="p-2 text-xs text-gray-600">${escapeHtml(ev.titulo || 'Imagem')}</figcaption>
              </figure>`;
          }
          return `
            <a href="${escapeHtml(ev.url)}" target="_blank" rel="noopener" class="flex items-center gap-2 border rounded-lg p-3 hover:bg-gray-50">
              <span class="material-icons text-blue-600">description</span>
              <div>
                <p class="text-sm font-semibold text-gray-800">${escapeHtml(ev.titulo || 'Documento')}</p>
                <p class="text-xs text-gray-500">${tipo || 'arquivo'}</p>
              </div>
            </a>`;
        }).join('')
      : '<p class="text-sm text-gray-500">Nenhuma evid√™ncia enviada.</p>';

    linkTermo.href = poco.TermoAutorizacaoURL || '#';
    linkTermo.classList.toggle('opacity-60', !poco.TermoAutorizacaoURL);
    linkNota.href = poco.NotaFiscalURL || '#';
    linkNota.classList.toggle('opacity-60', !poco.NotaFiscalURL);
    hiddenTermo.value = poco.TermoAutorizacaoURL || '';
    hiddenNota.value = poco.NotaFiscalURL || '';

    contatosEl.innerHTML = (contatos && contatos.length)
      ? contatos.map(contato => `
          <li class="border border-gray-200 rounded-lg p-3">
            <p class="text-sm font-semibold text-gray-800">${escapeHtml(contato.nome || contato.ResponsavelContato || 'Contato')}</p>
            <p class="text-xs text-gray-500">${escapeHtml(contato.papel || contato.OrganizacaoContato || '')}</p>
            <p class="text-xs text-gray-500">${escapeHtml(formatarTelefoneParaExibicao(contato.telefoneNormalizado || contato.telefone || contato.ContatoExterno || ''))}</p>
            <p class="text-xs text-gray-500">${escapeHtml(contato.email || '')}</p>
          </li>`).join('')
      : '<li class="text-sm text-gray-500">Nenhum contato estruturado.</li>';
  };

  const carregarPocos = () => {
    carregarLeafletSeNecessario().catch(() => {});
    google.script.run.withSuccessHandler(pocos => {
      listaPocos = pocos;
      atualizarResumoFluxo();
      const filtro = (buscaEl.value || '').toLowerCase();
      const filtrados = filtro
        ? pocos.filter(p => {
            const texto = [p['Comunidade'], p['Munic√≠pio'], p['Estado'], p.Status, p['Regi√£o']]
              .filter(Boolean)
              .join(' ')
              .toLowerCase();
            return texto.includes(filtro);
          })
        : pocos;
      renderizarLista(filtrados);
      carregarLeafletSeNecessario()
        .then(() => atualizarMapa(filtrados))
        .catch(erro => console.error('N√£o foi poss√≠vel atualizar o mapa de po√ßos.', erro));
      if (detalheAtual && detalheAtual.poco) {
        const existe = pocos.find(p => p.ID === detalheAtual.poco.ID);
        if (!existe) {
          detalheAtual = null;
          preencherDetalhes();
        }
      }
    }).listarPocos();
  };

  buscaEl.addEventListener('input', () => {
    const filtro = buscaEl.value.toLowerCase();
    const filtrados = listaPocos.filter(p => {
      const texto = [p['Comunidade'], p['Munic√≠pio'], p['Estado'], p.Status, p['Regi√£o']]
        .filter(Boolean)
        .join(' ')
        .toLowerCase();
      return texto.includes(filtro);
    });
    renderizarLista(filtrados);
    carregarLeafletSeNecessario()
      .then(() => atualizarMapa(filtrados))
      .catch(() => {});
  });

  btnLimpar.addEventListener('click', limparFormulario);

  btnEditar.addEventListener('click', () => {
    if (!detalheAtual || !detalheAtual.poco) return;
    const { poco, contatos } = detalheAtual;
    hiddenId.value = poco.ID;
    campos.estado.value = poco.Estado || '';
    campos.municipio.value = poco['Munic√≠pio'] || '';
    campos.comunidade.value = poco.Comunidade || '';
    campos.regiao.value = poco['Regi√£o'] || '';
    sincronizarMunicipiosComEstado(campos.estado.value, campos.municipio.value);
    const latitudeExistente = poco.Latitude !== undefined && poco.Latitude !== null ? poco.Latitude : '';
    const longitudeExistente = poco.Longitude !== undefined && poco.Longitude !== null ? poco.Longitude : '';
    campos.latitude.value = latitudeExistente;
    campos.longitude.value = longitudeExistente;
    definirValorNumerico(campos.beneficiarios, poco['Benefici√°rios'] || '');
    definirValorNumerico(campos.investimento, poco.Investimento || '');
    campos.solicitante.value = poco.Solicitante || '';
    campos.contatoSolicitante.value = poco.ContatoSolicitante || '';
    campos.doadores.value = poco.Doadores || '';
    campos.resumoStatus.value = poco.ResumoStatus || '';
    campos.dataSolicitacao.value = dataParaInput(poco.DataSolicitacao);
    campos.dataOrcamentoPrevisto.value = dataParaInput(poco.DataOrcamentoPrevisto);
    campos.dataInstalacao.value = dataParaInput(poco.DataInstalacao);
    campos.dataConclusao.value = dataParaInput(poco.DataConclusao);
    campos.dataPagamento.value = dataParaInput(poco.DataPagamento);
    definirValorNumerico(campos.orcamentoPrevisto, poco.OrcamentoPrevisto || poco['Valor Previsto Perfura√ß√£o'] || '');
    definirValorNumerico(campos.orcamentoAprovado, poco.OrcamentoAprovado || '');
    definirValorNumerico(campos.orcamentoExecutado, poco.OrcamentoExecutado || poco['Valor Realizado'] || '');
    definirValorNumerico(campos.distanciaEnergia, poco.DistanciaEnergia || poco.distanciaEnergia || '');
    campos.empresa.value = poco['Empresa Respons√°vel'] || '';
    campos.situacaoHidrica.value = poco.SituacaoHidrica || '';
    campos.usoAgua.value = poco.UsoAguaComunitario || '';
    campos.acoesPosInstalacao.value = poco.AcoesPosInstalacao || '';
    campos.observacoes.value = poco.Observa√ß√µes || '';

    const contatoPrincipal = Array.isArray(contatos) && contatos.length ? contatos[0] : {};
    campos.contatoNome.value = contatoPrincipal.nome || contatoPrincipal.ResponsavelContato || '';
    definirTelefone(campos.contatoTelefone, contatoPrincipal.telefoneNormalizado || contatoPrincipal.telefone || contatoPrincipal.ContatoExterno || '');
    campos.contatoEmail.value = contatoPrincipal.email || '';

    const latAnalise = analisarCoordenada(latitudeExistente, 90);
    const lonAnalise = analisarCoordenada(longitudeExistente, 180);
    const statusGeocode = (poco.GeocodificacaoStatus || '').toString().toUpperCase();
    geocodificacaoAtual = null;
    if (statusGeocode === 'OK' && latAnalise.valor !== null && lonAnalise.valor !== null) {
      let timestampISO = '';
      if (poco.GeocodificacaoTimestamp) {
        const ts = new Date(poco.GeocodificacaoTimestamp);
        if (!Number.isNaN(ts.getTime())) {
          timestampISO = ts.toISOString();
        }
      }
      geocodificacaoAtual = {
        sucesso: true,
        estado: poco.Estado || '',
        municipio: poco['Munic√≠pio'] || '',
        fonte: poco.GeocodificacaoFonte || '',
        precisao: poco.GeocodificacaoPrecisao || '',
        status: poco.GeocodificacaoStatus || 'OK',
        timestamp: timestampISO,
        latitude: latAnalise.valor,
        longitude: lonAnalise.valor
      };
    }
    atualizarValidacaoCoordenadas();
    carregarLeafletSeNecessario()
      .then(() => {
        if (latAnalise.valor !== null && lonAnalise.valor !== null) {
          atualizarMarcadorCoordenadas(latAnalise.valor, lonAnalise.valor, true);
        } else {
          limparMarcadorCoordenadas(true);
        }
      })
      .catch(() => {});

    hiddenEvidencias.value = JSON.stringify(detalheAtual.evidencias || []);
    hiddenTimeline.value = hiddenTimeline.value || '[]';
    hiddenTermo.value = poco.TermoAutorizacaoURL || '';
    hiddenNota.value = poco.NotaFiscalURL || '';
    atualizarResumoLocalizacao();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  const enviarArquivo = async (file) => {
    const reader = new FileReader();
    const base64 = await new Promise((resolve, reject) => {
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
    return new Promise(resolve => {
      google.script.run.withSuccessHandler(url => resolve(url)).uploadFile(base64, file.name, file.type);
    });
  };

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    mensagemFormulario.textContent = 'Salvando informa√ß√µes...';
    mensagemFormulario.className = 'text-sm font-medium text-blue-600';

    try {
      const evidenciasExistentes = JSON.parse(hiddenEvidencias.value || '[]');
      const timelineExtras = JSON.parse(hiddenTimeline.value || '[]');
      const novasEvidencias = [];

      for (const file of arquivos.evidencias.files) {
        const url = await enviarArquivo(file);
        novasEvidencias.push({
          id: `novo-${Date.now()}-${Math.random().toString(36).slice(2)}`,
          tipo: file.type,
          titulo: file.name,
          url,
          data: new Date().toISOString()
        });
      }

      let termoURL = hiddenTermo.value;
      if (arquivos.termo.files.length) {
        termoURL = await enviarArquivo(arquivos.termo.files[0]);
      }
      let notaURL = hiddenNota.value;
      if (arquivos.nota.files.length) {
        notaURL = await enviarArquivo(arquivos.nota.files[0]);
      }

      const validacaoCoordenadas = atualizarValidacaoCoordenadas();
      if (!validacaoCoordenadas.valido) {
        throw new Error('Corrija os valores de latitude e longitude antes de salvar.');
      }
      const latitudeValor = validacaoCoordenadas.latitude;
      const longitudeValor = validacaoCoordenadas.longitude;
      const coordenadasInformadas = latitudeValor !== null && longitudeValor !== null;
      if (coordenadasInformadas) {
        if (!geocodificacaoAtual || !geocodificacaoAtual.sucesso || geocodificacaoAtual.latitude !== latitudeValor || geocodificacaoAtual.longitude !== longitudeValor) {
          throw new Error('Valide as coordenadas antes de salvar o formul√°rio.');
        }
      }

      const beneficiariosNormalizado = obterNumeroNormalizado(campos.beneficiarios);
      const investimentoNormalizado = obterNumeroNormalizado(campos.investimento);
      const orcPrevistoNormalizado = obterNumeroNormalizado(campos.orcamentoPrevisto);
      const orcAprovadoNormalizado = obterNumeroNormalizado(campos.orcamentoAprovado);
      const orcExecutadoNormalizado = obterNumeroNormalizado(campos.orcamentoExecutado);
      const distanciaEnergiaNormalizada = obterNumeroNormalizado(campos.distanciaEnergia);
      const telefoneNormalizado = obterTelefoneNormalizado(campos.contatoTelefone);
      const telefoneFormatado = formatarTelefoneParaExibicao(telefoneNormalizado);
      const geocodificacaoPayload = coordenadasInformadas && geocodificacaoAtual ? {
        sucesso: true,
        estado: geocodificacaoAtual.estado || '',
        municipio: geocodificacaoAtual.municipio || '',
        fonte: geocodificacaoAtual.fonte || '',
        precisao: geocodificacaoAtual.precisao || '',
        status: geocodificacaoAtual.status || 'OK',
        timestamp: geocodificacaoAtual.timestamp || new Date().toISOString(),
        latitude: latitudeValor,
        longitude: longitudeValor
      } : null;

      const contatos = [];
      if (campos.contatoNome.value || telefoneNormalizado || campos.contatoEmail.value) {
        contatos.push({
          nome: campos.contatoNome.value,
          telefone: telefoneFormatado,
          telefoneNormalizado,
          email: campos.contatoEmail.value,
          papel: 'Contato principal'
        });
      }

      const payload = {
        estado: campos.estado.value,
        municipio: campos.municipio.value,
        comunidade: campos.comunidade.value,
        regiao: campos.regiao.value,
        latitude: coordenadasInformadas ? latitudeValor : '',
        longitude: coordenadasInformadas ? longitudeValor : '',
        beneficiarios: beneficiariosNormalizado === '' ? '' : beneficiariosNormalizado,
        investimento: investimentoNormalizado === '' ? '' : investimentoNormalizado,
        distanciaEnergia: distanciaEnergiaNormalizada === '' ? '' : distanciaEnergiaNormalizada,
        solicitante: campos.solicitante.value,
        contatoSolicitante: campos.contatoSolicitante.value,
        doadores: campos.doadores.value,
        resumoStatus: campos.resumoStatus.value,
        dataSolicitacao: campos.dataSolicitacao.value,
        dataOrcamentoPrevisto: campos.dataOrcamentoPrevisto.value,
        dataInstalacao: campos.dataInstalacao.value,
        dataConclusao: campos.dataConclusao.value,
        dataPagamento: campos.dataPagamento.value,
        orcamentoPrevisto: orcPrevistoNormalizado === '' ? '' : orcPrevistoNormalizado,
        orcamentoAprovado: orcAprovadoNormalizado === '' ? '' : orcAprovadoNormalizado,
        orcamentoExecutado: orcExecutadoNormalizado === '' ? '' : orcExecutadoNormalizado,
        empresaResponsavel: campos.empresa.value,
        contatos,
        evidencias: evidenciasExistentes.concat(novasEvidencias),
        timeline: timelineExtras,
        termoAutorizacaoURL: termoURL,
        notaFiscalURL: notaURL,
        situacaoHidrica: campos.situacaoHidrica.value,
        usoAguaComunitario: campos.usoAgua.value,
        acoesPosInstalacao: campos.acoesPosInstalacao.value,
        observacoes: campos.observacoes.value,
        responsavelContato: campos.contatoNome.value,
        contatoInstalacao: campos.contatoNome.value,
        telefoneContato: telefoneFormatado,
        telefoneContatoNormalizado: telefoneNormalizado,
        geocodificacao: geocodificacaoPayload
      };

      const idExistente = hiddenId.value;
      const onSuccess = () => {
        mensagemFormulario.textContent = '‚úÖ Po√ßo salvo com sucesso!';
        mensagemFormulario.className = 'text-sm font-medium text-green-600';
        arquivos.termo.value = '';
        arquivos.nota.value = '';
        arquivos.evidencias.value = '';
        carregarPocos();
        if (!idExistente) {
          limparFormulario();
        } else {
          selecionarPoco(idExistente);
        }
      };

      if (idExistente) {
        payload.id = idExistente;
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(err => {
          mensagemFormulario.textContent = `‚ùå ${err.message || 'Erro ao atualizar o po√ßo.'}`;
          mensagemFormulario.className = 'text-sm font-medium text-red-600';
        }).atualizarPoco(payload);
      } else {
        google.script.run.withSuccessHandler(res => {
          hiddenId.value = res.id;
          onSuccess();
        }).withFailureHandler(err => {
          mensagemFormulario.textContent = `‚ùå ${err.message || 'Erro ao salvar o po√ßo.'}`;
          mensagemFormulario.className = 'text-sm font-medium text-red-600';
        }).salvarPoco(payload);
      }
    } catch (error) {
      mensagemFormulario.textContent = `‚ùå ${error.message || 'Erro inesperado ao salvar o po√ßo.'}`;
      mensagemFormulario.className = 'text-sm font-medium text-red-600';
    }
  });

  atualizarResumoFluxo();
  carregarPocos();

  window.addEventListener('EmpSocial:abrirFormulario', (evento) => {
    const detalhe = evento.detail || {};
    const tipo = (detalhe.tipo || '').toLowerCase();
    if (tipo !== 'poco') return;
    const dados = detalhe.dados || {};
    const acao = detalhe.acao || (dados && dados.id ? 'editar' : 'novo');
    if (acao === 'novo') {
      hiddenId.value = '';
      limparFormulario();
      window.scrollTo({ top: 0, behavior: 'smooth' });
      return;
    }
    if (dados.id) {
      selecionarPoco(dados.id);
      setTimeout(() => {
        if (btnEditar) {
          btnEditar.click();
        }
      }, 250);
    }
  });
})();
</script>
