<div class="space-y-6">
  <header class="bg-white rounded-lg shadow p-5 flex flex-col gap-2">
    <h2 class="text-xl font-semibold text-blue-700">üíß Jornada completa dos po√ßos</h2>
    <p class="text-sm text-gray-600">Centralize as informa√ß√µes desde a solicita√ß√£o regional at√© o pagamento final. Anexe evid√™ncias, acompanhe a linha do tempo e mantenha os dados financeiros alinhados com doadores e fornecedores.</p>
  </header>

  <form id="formPoco" class="bg-white rounded-lg shadow p-5 space-y-4">
    <input type="hidden" id="pocoId">
    <input type="hidden" id="dadosEvidencias">
    <input type="hidden" id="dadosTimeline">
    <input type="hidden" id="dadosTermo">
    <input type="hidden" id="dadosNota">

    <div class="flex items-center justify-between flex-wrap gap-3">
      <h3 class="font-semibold text-lg text-gray-800">üìã Cadastro e atualiza√ß√£o</h3>
      <div class="flex gap-3">
        <button type="button" id="btnLimparFormulario" class="px-4 py-2 rounded border border-gray-300 text-gray-600 hover:bg-gray-100">Limpar</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700">Salvar informa√ß√µes</button>
      </div>
    </div>

    <div class="grid md:grid-cols-4 gap-4">
      <div>
        <label class="text-sm font-medium text-gray-700">Estado</label>
        <input id="estado" class="campo" required>
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Munic√≠pio</label>
        <input id="municipio" class="campo" required>
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Comunidade / Nome do po√ßo</label>
        <input id="comunidade" class="campo" placeholder="Ex.: Comunidade Vida">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Regi√£o</label>
        <input id="regiao" class="campo" placeholder="Ex.: Sert√£o dos Inhamuns">
      </div>
    </div>

    <div class="grid md:grid-cols-4 gap-4">
      <div>
        <label class="text-sm font-medium text-gray-700">Latitude</label>
        <input id="latitude" class="campo" placeholder="-5.167">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Longitude</label>
        <input id="longitude" class="campo" placeholder="-40.656">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Benefici√°rios estimados</label>
        <input id="beneficiarios" type="number" min="0" class="campo" placeholder="0">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Empresa respons√°vel</label>
        <input id="empresa" class="campo" placeholder="Fornecedor respons√°vel">
      </div>
    </div>

    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="text-sm font-medium text-gray-700">Solicitante / l√≠der local</label>
        <input id="solicitante" class="campo" placeholder="Nome da pessoa refer√™ncia">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Contato do solicitante</label>
        <input id="contatoSolicitante" class="campo" placeholder="E-mail, telefone ou WhatsApp">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Doadores vinculados</label>
        <input id="doadores" class="campo" placeholder="IDs ou nomes separados por v√≠rgula">
      </div>
    </div>

    <div>
      <label class="text-sm font-medium text-gray-700">Resumo da situa√ß√£o</label>
      <textarea id="resumoStatus" rows="2" class="campo" placeholder="Explique em poucas linhas em que etapa o po√ßo est√°"></textarea>
    </div>

    <fieldset class="border border-blue-100 rounded-lg p-4">
      <legend class="px-2 text-blue-700 font-semibold">Datas do processo</legend>
      <div class="grid md:grid-cols-5 gap-4">
        <div>
          <label class="texto-legenda">Solicita√ß√£o</label>
          <input type="date" id="dataSolicitacao" class="campo">
        </div>
        <div>
          <label class="texto-legenda">Or√ßamento previsto</label>
          <input type="date" id="dataOrcamentoPrevisto" class="campo">
        </div>
        <div>
          <label class="texto-legenda">Instala√ß√£o</label>
          <input type="date" id="dataInstalacao" class="campo">
        </div>
        <div>
          <label class="texto-legenda">Conclus√£o</label>
          <input type="date" id="dataConclusao" class="campo">
        </div>
        <div>
          <label class="texto-legenda">Pagamento</label>
          <input type="date" id="dataPagamento" class="campo">
        </div>
      </div>
    </fieldset>

    <fieldset class="border border-blue-100 rounded-lg p-4">
      <legend class="px-2 text-blue-700 font-semibold">Or√ßamento</legend>
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="texto-legenda">Previsto (R$)</label>
          <input type="number" id="orcamentoPrevisto" class="campo" step="0.01">
        </div>
        <div>
          <label class="texto-legenda">Aprovado (R$)</label>
          <input type="number" id="orcamentoAprovado" class="campo" step="0.01">
        </div>
        <div>
          <label class="texto-legenda">Executado (R$)</label>
          <input type="number" id="orcamentoExecutado" class="campo" step="0.01">
        </div>
        <div>
          <label class="texto-legenda">Investimento previsto em planilha (R$)</label>
          <input type="number" id="investimento" class="campo" step="0.01">
        </div>
      </div>
    </fieldset>

    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="text-sm font-medium text-gray-700">Contato principal</label>
        <input id="contatoNome" class="campo" placeholder="Nome do respons√°vel">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Telefone / WhatsApp</label>
        <input id="contatoTelefone" class="campo" placeholder="(00) 90000-0000">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">E-mail</label>
        <input id="contatoEmail" class="campo" placeholder="contato@email.com">
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="text-sm font-medium text-gray-700">Termo de autoriza√ß√£o (PDF ou imagem)</label>
        <input type="file" id="arquivoTermo" accept=".pdf,image/*" class="campo">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Nota fiscal (PDF ou imagem)</label>
        <input type="file" id="arquivoNota" accept=".pdf,image/*" class="campo">
      </div>
    </div>

    <div>
      <label class="text-sm font-medium text-gray-700">Evid√™ncias (imagens, v√≠deos ou documentos)</label>
      <input type="file" id="arquivoEvidencias" class="campo" multiple>
      <p class="text-xs text-gray-500 mt-1">Os arquivos ser√£o enviados para o Google Drive configurado e vinculados ao po√ßo.</p>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="text-sm font-medium text-gray-700">Situa√ß√£o h√≠drica</label>
        <input id="situacaoHidrica" class="campo" placeholder="Produzindo normalmente, em an√°lise t√©cnica...">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Uso priorit√°rio da √°gua</label>
        <input id="usoAgua" class="campo" placeholder="Consumo humano, irriga√ß√£o, apoio √† escola...">
      </div>
    </div>

    <div>
      <label class="text-sm font-medium text-gray-700">A√ß√µes p√≥s-instala√ß√£o</label>
      <textarea id="acoesPosInstalacao" rows="2" class="campo" placeholder="Capacita√ß√µes, hortas comunit√°rias, monitoramento..."></textarea>
    </div>

    <div>
      <label class="text-sm font-medium text-gray-700">Observa√ß√µes gerais</label>
      <textarea id="observacoes" rows="3" class="campo"></textarea>
    </div>

    <p id="mensagemFormulario" class="text-sm font-medium"></p>
  </form>

  <section class="grid lg:grid-cols-12 gap-6">
    <aside class="lg:col-span-5 space-y-3">
      <div class="bg-white rounded-lg shadow p-4 flex flex-col gap-3">
        <div class="flex items-center justify-between gap-3">
          <h3 class="font-semibold text-gray-800">Po√ßos cadastrados</h3>
          <span id="contadorPocos" class="text-sm text-gray-500"></span>
        </div>
        <input id="buscaPocos" class="campo" placeholder="Buscar por estado, munic√≠pio ou status">
      </div>
      <ul id="listaPocos" class="space-y-3"></ul>
    </aside>

    <div class="lg:col-span-7">
      <div id="painelDetalhes" class="bg-white rounded-lg shadow p-6 hidden flex-col gap-5">
        <div class="flex flex-col gap-2">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 id="detalheTitulo" class="text-xl font-semibold text-gray-900"></h3>
              <p id="detalheLocal" class="text-sm text-gray-500"></p>
            </div>
            <span id="detalheStatus" class="px-3 py-1 rounded-full text-sm font-medium"></span>
          </div>
          <p id="detalheResumo" class="text-sm text-gray-600"></p>
        </div>

        <div class="grid md:grid-cols-3 gap-3">
          <article class="resumo-card">
            <p class="titulo">Benefici√°rios</p>
            <strong id="detalheBeneficiarios" class="valor">-</strong>
          </article>
          <article class="resumo-card">
            <p class="titulo">Previsto</p>
            <strong id="detalhePrevisto" class="valor">-</strong>
          </article>
          <article class="resumo-card">
            <p class="titulo">Executado</p>
            <strong id="detalheExecutado" class="valor">-</strong>
          </article>
        </div>

        <section>
          <h4 class="subtitulo">Linha do tempo do po√ßo</h4>
          <ol id="timelineEtapas" class="timeline"></ol>
        </section>

        <section class="space-y-3">
          <div class="flex items-center justify-between">
            <h4 class="subtitulo">Evid√™ncias</h4>
            <div class="flex gap-3 text-sm">
              <a id="linkTermo" class="link-doc" target="_blank" rel="noopener">Termo de autoriza√ß√£o</a>
              <a id="linkNota" class="link-doc" target="_blank" rel="noopener">Nota fiscal</a>
            </div>
          </div>
          <div id="galeriaEvidencias" class="grid sm:grid-cols-2 gap-3"></div>
        </section>

        <section class="space-y-2">
          <h4 class="subtitulo">Contatos e respons√°veis</h4>
          <ul id="listaContatos" class="space-y-2"></ul>
        </section>

        <div class="flex justify-end">
          <button id="btnEditarPoco" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700">Editar informa√ß√µes</button>
        </div>
      </div>
      <div id="mensagemDetalhes" class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
        Selecione um po√ßo para visualizar a linha do tempo e as evid√™ncias.
      </div>
    </div>
  </section>
</div>

<style>
  .campo {
    width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.55rem 0.75rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }
  .campo:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
  }
  .texto-legenda {
    font-size: 0.85rem;
    font-weight: 600;
    color: #1f2937;
    display: block;
    margin-bottom: 0.35rem;
  }
  .resumo-card {
    border: 1px solid #e0e7ff;
    border-radius: 0.75rem;
    padding: 1rem;
    background: linear-gradient(135deg, rgba(219, 234, 254, 0.6), rgba(191, 219, 254, 0.3));
  }
  .resumo-card .titulo {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #1d4ed8;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  .resumo-card .valor {
    font-size: 1.2rem;
    color: #1e3a8a;
  }
  .subtitulo {
    font-size: 0.95rem;
    font-weight: 600;
    color: #1f2937;
  }
  .timeline {
    position: relative;
    padding-left: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 0.6rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #bfdbfe;
  }
  .timeline-item {
    position: relative;
    padding-left: 0.75rem;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -1.05rem;
    top: 0.4rem;
    width: 10px;
    height: 10px;
    border-radius: 9999px;
    background: #93c5fd;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px rgba(147, 197, 253, 0.4);
  }
  .timeline-item[data-status="concluido"]::before {
    background: #22c55e;
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.35);
  }
  .timeline-item[data-status="andamento"]::before {
    background: #facc15;
    box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.35);
  }
  .timeline-item[data-status="pendente"]::before {
    background: #9ca3af;
    box-shadow: 0 0 0 2px rgba(156, 163, 175, 0.35);
  }
  .timeline-titulo {
    font-weight: 600;
    font-size: 0.95rem;
    color: #1f2937;
  }
  .timeline-data {
    font-size: 0.75rem;
    color: #6b7280;
  }
  .timeline-descricao {
    font-size: 0.75rem;
    color: #4b5563;
    margin-top: 0.25rem;
  }
  .link-doc {
    color: #2563eb;
    text-decoration: none;
  }
  .link-doc:hover {
    text-decoration: underline;
  }
</style>

<script>
(() => {
  const listaPocosEl = document.getElementById('listaPocos');
  const contadorPocosEl = document.getElementById('contadorPocos');
  const buscaEl = document.getElementById('buscaPocos');
  const painelDetalhes = document.getElementById('painelDetalhes');
  const mensagemDetalhes = document.getElementById('mensagemDetalhes');
  const timelineEl = document.getElementById('timelineEtapas');
  const evidenciasEl = document.getElementById('galeriaEvidencias');
  const contatosEl = document.getElementById('listaContatos');
  const detalheTitulo = document.getElementById('detalheTitulo');
  const detalheLocal = document.getElementById('detalheLocal');
  const detalheResumo = document.getElementById('detalheResumo');
  const detalheStatus = document.getElementById('detalheStatus');
  const detalheBeneficiarios = document.getElementById('detalheBeneficiarios');
  const detalhePrevisto = document.getElementById('detalhePrevisto');
  const detalheExecutado = document.getElementById('detalheExecutado');
  const linkTermo = document.getElementById('linkTermo');
  const linkNota = document.getElementById('linkNota');
  const btnEditar = document.getElementById('btnEditarPoco');
  const btnLimpar = document.getElementById('btnLimparFormulario');
  const mensagemFormulario = document.getElementById('mensagemFormulario');
  const form = document.getElementById('formPoco');

  const hiddenId = document.getElementById('pocoId');
  const hiddenEvidencias = document.getElementById('dadosEvidencias');
  const hiddenTimeline = document.getElementById('dadosTimeline');
  const hiddenTermo = document.getElementById('dadosTermo');
  const hiddenNota = document.getElementById('dadosNota');

  const campos = {
    estado: document.getElementById('estado'),
    municipio: document.getElementById('municipio'),
    comunidade: document.getElementById('comunidade'),
    regiao: document.getElementById('regiao'),
    latitude: document.getElementById('latitude'),
    longitude: document.getElementById('longitude'),
    beneficiarios: document.getElementById('beneficiarios'),
    investimento: document.getElementById('investimento'),
    solicitante: document.getElementById('solicitante'),
    contatoSolicitante: document.getElementById('contatoSolicitante'),
    doadores: document.getElementById('doadores'),
    resumoStatus: document.getElementById('resumoStatus'),
    dataSolicitacao: document.getElementById('dataSolicitacao'),
    dataOrcamentoPrevisto: document.getElementById('dataOrcamentoPrevisto'),
    dataInstalacao: document.getElementById('dataInstalacao'),
    dataConclusao: document.getElementById('dataConclusao'),
    dataPagamento: document.getElementById('dataPagamento'),
    orcamentoPrevisto: document.getElementById('orcamentoPrevisto'),
    orcamentoAprovado: document.getElementById('orcamentoAprovado'),
    orcamentoExecutado: document.getElementById('orcamentoExecutado'),
    empresa: document.getElementById('empresa'),
    contatoNome: document.getElementById('contatoNome'),
    contatoTelefone: document.getElementById('contatoTelefone'),
    contatoEmail: document.getElementById('contatoEmail'),
    situacaoHidrica: document.getElementById('situacaoHidrica'),
    usoAgua: document.getElementById('usoAgua'),
    acoesPosInstalacao: document.getElementById('acoesPosInstalacao'),
    observacoes: document.getElementById('observacoes')
  };

  const arquivos = {
    termo: document.getElementById('arquivoTermo'),
    nota: document.getElementById('arquivoNota'),
    evidencias: document.getElementById('arquivoEvidencias')
  };

  const STATUS_CORES = {
    'solicitado': 'bg-orange-100 text-orange-700',
    'or√ßamento previsto': 'bg-yellow-100 text-yellow-700',
    'instala√ß√£o': 'bg-blue-100 text-blue-700',
    'conclu√≠do': 'bg-green-100 text-green-700',
    'pago': 'bg-emerald-100 text-emerald-700'
  };

  let listaPocos = [];
  let detalheAtual = null;

  const formataData = (valor) => {
    if (!valor) return '';
    const data = new Date(valor);
    if (Number.isNaN(data.getTime())) return '';
    return data.toLocaleDateString('pt-BR');
  };

  const dataParaInput = (valor) => {
    if (!valor) return '';
    const data = new Date(valor);
    if (Number.isNaN(data.getTime())) return '';
    return data.toISOString().split('T')[0];
  };

  const formataMoeda = (valor) => {
    const numero = Number(valor || 0);
    return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  };

  const limparFormulario = () => {
    form.reset();
    hiddenId.value = '';
    hiddenEvidencias.value = '[]';
    hiddenTimeline.value = '[]';
    hiddenTermo.value = '';
    hiddenNota.value = '';
    mensagemFormulario.textContent = '';
    mensagemFormulario.className = 'text-sm font-medium';
  };

  const statusClasses = (status) => {
    if (!status) return 'bg-gray-100 text-gray-600';
    const chave = status.toLowerCase();
    return STATUS_CORES[chave] || 'bg-gray-100 text-gray-600';
  };

  const renderizarLista = (pocos) => {
    contadorPocosEl.textContent = `${pocos.length} registro${pocos.length === 1 ? '' : 's'}`;
    if (!pocos.length) {
      listaPocosEl.innerHTML = '<li class="bg-white rounded-lg shadow p-4 text-center text-gray-500">Nenhum po√ßo cadastrado.</li>';
      return;
    }
    const html = pocos.map(p => {
      const status = (p.Status || '').toLowerCase();
      const local = [p['Comunidade'], p['Munic√≠pio'], p['Estado']].filter(Boolean).join(' ‚Ä¢ ');
      const previsto = Number(p.OrcamentoPrevisto || p['Valor Previsto Perfura√ß√£o'] || 0);
      const executado = Number(p.OrcamentoExecutado || p['Valor Realizado'] || 0);
      return `
        <li class="bg-white rounded-lg shadow hover:shadow-md transition cursor-pointer border border-transparent hover:border-blue-200" data-id="${p.ID}">
          <div class="p-4 space-y-2">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h4 class="font-semibold text-gray-900">${escapeHtml(p['Comunidade'] || p['Munic√≠pio'] || 'Po√ßo sem identifica√ß√£o')}</h4>
                <p class="text-xs text-gray-500">${escapeHtml(local)}</p>
              </div>
              <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClasses(status)}">${escapeHtml(p.Status || 'Sem status')}</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
              <div>Benefici√°rios: <strong>${Number(p['Benefici√°rios'] || 0)}</strong></div>
              <div>Executado: <strong>${formataMoeda(executado)}</strong></div>
            </div>
          </div>
        </li>`;
    }).join('');
    listaPocosEl.innerHTML = html;
    listaPocosEl.querySelectorAll('li').forEach(item => {
      item.addEventListener('click', () => selecionarPoco(item.dataset.id));
    });
  };

  const selecionarPoco = (id) => {
    google.script.run.withSuccessHandler(detalhe => {
      detalheAtual = detalhe;
      preencherDetalhes();
    }).obterRelatorioPoco(id);
  };

  const preencherDetalhes = () => {
    if (!detalheAtual || !detalheAtual.poco) {
      painelDetalhes.classList.add('hidden');
      mensagemDetalhes.classList.remove('hidden');
      return;
    }
    const { poco, timeline, evidencias, contatos } = detalheAtual;
    painelDetalhes.classList.remove('hidden');
    mensagemDetalhes.classList.add('hidden');

    const nome = poco['Comunidade'] || poco['Munic√≠pio'] || poco['Estado'] || 'Po√ßo sem identifica√ß√£o';
    const local = [poco['Munic√≠pio'], poco['Estado']].filter(Boolean).join(' ‚Ä¢ ');
    detalheTitulo.textContent = nome;
    detalheLocal.textContent = local || 'Local n√£o informado';
    detalheResumo.textContent = poco.ResumoStatus || 'Sem descri√ß√£o';
    detalheStatus.textContent = poco.Status || 'Sem status';
    detalheStatus.className = `px-3 py-1 rounded-full text-sm font-medium ${statusClasses((poco.Status || '').toLowerCase())}`;

    detalheBeneficiarios.textContent = Number(poco['Benefici√°rios'] || 0);
    detalhePrevisto.textContent = formataMoeda(poco.OrcamentoPrevisto || poco['Valor Previsto Perfura√ß√£o']);
    detalheExecutado.textContent = formataMoeda(poco.OrcamentoExecutado || poco['Valor Realizado']);

    const idsBase = new Set(['solicitado','orcamento','instalacao','conclusao','pagamento']);
    const timelineExtras = (timeline || []).filter(item => item && !idsBase.has(String(item.id || '').toLowerCase()));
    hiddenTimeline.value = JSON.stringify(timelineExtras);

    timelineEl.innerHTML = (timeline || []).map(item => {
      const status = item.status || 'pendente';
      const data = formataData(item.data);
      return `
        <li class="timeline-item" data-status="${status}">
          <div class="timeline-titulo">${escapeHtml(item.titulo || 'Etapa')}</div>
          <div class="timeline-data">${data || 'Sem data registrada'}</div>
          ${item.descricao ? `<p class="timeline-descricao">${escapeHtml(item.descricao)}</p>` : ''}
        </li>`;
    }).join('');

    if (!timelineEl.innerHTML) {
      timelineEl.innerHTML = '<li class="text-sm text-gray-500">Nenhuma etapa registrada.</li>';
    }

    const evidenciasAtuais = Array.isArray(evidencias) ? evidencias : [];
    hiddenEvidencias.value = JSON.stringify(evidenciasAtuais);
    evidenciasEl.innerHTML = evidenciasAtuais.length
      ? evidenciasAtuais.map(ev => {
          const tipo = (ev.tipo || '').toLowerCase();
          const isImagem = tipo.includes('imagem');
          if (isImagem) {
            return `
              <figure class="rounded-lg overflow-hidden border">
                <img src="${escapeHtml(ev.url)}" alt="${escapeHtml(ev.titulo || 'Evid√™ncia do po√ßo')}" class="w-full h-40 object-cover">
                <figcaption class="p-2 text-xs text-gray-600">${escapeHtml(ev.titulo || 'Imagem')}</figcaption>
              </figure>`;
          }
          return `
            <a href="${escapeHtml(ev.url)}" target="_blank" rel="noopener" class="flex items-center gap-2 border rounded-lg p-3 hover:bg-gray-50">
              <span class="material-icons text-blue-600">description</span>
              <div>
                <p class="text-sm font-semibold text-gray-800">${escapeHtml(ev.titulo || 'Documento')}</p>
                <p class="text-xs text-gray-500">${tipo || 'arquivo'}</p>
              </div>
            </a>`;
        }).join('')
      : '<p class="text-sm text-gray-500">Nenhuma evid√™ncia enviada.</p>';

    linkTermo.href = poco.TermoAutorizacaoURL || '#';
    linkTermo.classList.toggle('opacity-60', !poco.TermoAutorizacaoURL);
    linkNota.href = poco.NotaFiscalURL || '#';
    linkNota.classList.toggle('opacity-60', !poco.NotaFiscalURL);
    hiddenTermo.value = poco.TermoAutorizacaoURL || '';
    hiddenNota.value = poco.NotaFiscalURL || '';

    contatosEl.innerHTML = (contatos && contatos.length)
      ? contatos.map(contato => `
          <li class="border border-gray-200 rounded-lg p-3">
            <p class="text-sm font-semibold text-gray-800">${escapeHtml(contato.nome || contato.ResponsavelContato || 'Contato')}</p>
            <p class="text-xs text-gray-500">${escapeHtml(contato.papel || contato.OrganizacaoContato || '')}</p>
            <p class="text-xs text-gray-500">${escapeHtml(contato.telefone || contato.ContatoExterno || '')}</p>
            <p class="text-xs text-gray-500">${escapeHtml(contato.email || '')}</p>
          </li>`).join('')
      : '<li class="text-sm text-gray-500">Nenhum contato estruturado.</li>';
  };

  const carregarPocos = () => {
    google.script.run.withSuccessHandler(pocos => {
      listaPocos = pocos;
      const filtro = (buscaEl.value || '').toLowerCase();
      const filtrados = filtro
        ? pocos.filter(p => {
            const texto = [p['Comunidade'], p['Munic√≠pio'], p['Estado'], p.Status, p['Regi√£o']]
              .filter(Boolean)
              .join(' ')
              .toLowerCase();
            return texto.includes(filtro);
          })
        : pocos;
      renderizarLista(filtrados);
      if (detalheAtual && detalheAtual.poco) {
        const existe = pocos.find(p => p.ID === detalheAtual.poco.ID);
        if (!existe) {
          detalheAtual = null;
          preencherDetalhes();
        }
      }
    }).listarPocos();
  };

  buscaEl.addEventListener('input', () => {
    const filtro = buscaEl.value.toLowerCase();
    const filtrados = listaPocos.filter(p => {
      const texto = [p['Comunidade'], p['Munic√≠pio'], p['Estado'], p.Status, p['Regi√£o']]
        .filter(Boolean)
        .join(' ')
        .toLowerCase();
      return texto.includes(filtro);
    });
    renderizarLista(filtrados);
  });

  btnLimpar.addEventListener('click', limparFormulario);

  btnEditar.addEventListener('click', () => {
    if (!detalheAtual || !detalheAtual.poco) return;
    const { poco, contatos } = detalheAtual;
    hiddenId.value = poco.ID;
    campos.estado.value = poco.Estado || '';
    campos.municipio.value = poco['Munic√≠pio'] || '';
    campos.comunidade.value = poco.Comunidade || '';
    campos.regiao.value = poco['Regi√£o'] || '';
    campos.latitude.value = poco.Latitude || '';
    campos.longitude.value = poco.Longitude || '';
    campos.beneficiarios.value = poco['Benefici√°rios'] || '';
    campos.investimento.value = poco.Investimento || '';
    campos.solicitante.value = poco.Solicitante || '';
    campos.contatoSolicitante.value = poco.ContatoSolicitante || '';
    campos.doadores.value = poco.Doadores || '';
    campos.resumoStatus.value = poco.ResumoStatus || '';
    campos.dataSolicitacao.value = dataParaInput(poco.DataSolicitacao);
    campos.dataOrcamentoPrevisto.value = dataParaInput(poco.DataOrcamentoPrevisto);
    campos.dataInstalacao.value = dataParaInput(poco.DataInstalacao);
    campos.dataConclusao.value = dataParaInput(poco.DataConclusao);
    campos.dataPagamento.value = dataParaInput(poco.DataPagamento);
    campos.orcamentoPrevisto.value = poco.OrcamentoPrevisto || poco['Valor Previsto Perfura√ß√£o'] || '';
    campos.orcamentoAprovado.value = poco.OrcamentoAprovado || '';
    campos.orcamentoExecutado.value = poco.OrcamentoExecutado || poco['Valor Realizado'] || '';
    campos.empresa.value = poco['Empresa Respons√°vel'] || '';
    campos.situacaoHidrica.value = poco.SituacaoHidrica || '';
    campos.usoAgua.value = poco.UsoAguaComunitario || '';
    campos.acoesPosInstalacao.value = poco.AcoesPosInstalacao || '';
    campos.observacoes.value = poco.Observa√ß√µes || '';

    const contatoPrincipal = Array.isArray(contatos) && contatos.length ? contatos[0] : {};
    campos.contatoNome.value = contatoPrincipal.nome || contatoPrincipal.ResponsavelContato || '';
    campos.contatoTelefone.value = contatoPrincipal.telefone || contatoPrincipal.ContatoExterno || '';
    campos.contatoEmail.value = contatoPrincipal.email || '';

    hiddenEvidencias.value = JSON.stringify(detalheAtual.evidencias || []);
    hiddenTimeline.value = hiddenTimeline.value || '[]';
    hiddenTermo.value = poco.TermoAutorizacaoURL || '';
    hiddenNota.value = poco.NotaFiscalURL || '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  const enviarArquivo = async (file) => {
    const reader = new FileReader();
    const base64 = await new Promise((resolve, reject) => {
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
    return new Promise(resolve => {
      google.script.run.withSuccessHandler(url => resolve(url)).uploadFile(base64, file.name, file.type);
    });
  };

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    mensagemFormulario.textContent = 'Salvando informa√ß√µes...';
    mensagemFormulario.className = 'text-sm font-medium text-blue-600';

    try {
      const evidenciasExistentes = JSON.parse(hiddenEvidencias.value || '[]');
      const timelineExtras = JSON.parse(hiddenTimeline.value || '[]');
      const novasEvidencias = [];

      for (const file of arquivos.evidencias.files) {
        const url = await enviarArquivo(file);
        novasEvidencias.push({
          id: `novo-${Date.now()}-${Math.random().toString(36).slice(2)}`,
          tipo: file.type,
          titulo: file.name,
          url,
          data: new Date().toISOString()
        });
      }

      let termoURL = hiddenTermo.value;
      if (arquivos.termo.files.length) {
        termoURL = await enviarArquivo(arquivos.termo.files[0]);
      }
      let notaURL = hiddenNota.value;
      if (arquivos.nota.files.length) {
        notaURL = await enviarArquivo(arquivos.nota.files[0]);
      }

      const contatos = [];
      if (campos.contatoNome.value || campos.contatoTelefone.value || campos.contatoEmail.value) {
        contatos.push({
          nome: campos.contatoNome.value,
          telefone: campos.contatoTelefone.value,
          email: campos.contatoEmail.value,
          papel: 'Contato principal'
        });
      }

      const payload = {
        estado: campos.estado.value,
        municipio: campos.municipio.value,
        comunidade: campos.comunidade.value,
        regiao: campos.regiao.value,
        latitude: campos.latitude.value,
        longitude: campos.longitude.value,
        beneficiarios: campos.beneficiarios.value,
        investimento: campos.investimento.value,
        solicitante: campos.solicitante.value,
        contatoSolicitante: campos.contatoSolicitante.value,
        doadores: campos.doadores.value,
        resumoStatus: campos.resumoStatus.value,
        dataSolicitacao: campos.dataSolicitacao.value,
        dataOrcamentoPrevisto: campos.dataOrcamentoPrevisto.value,
        dataInstalacao: campos.dataInstalacao.value,
        dataConclusao: campos.dataConclusao.value,
        dataPagamento: campos.dataPagamento.value,
        orcamentoPrevisto: campos.orcamentoPrevisto.value,
        orcamentoAprovado: campos.orcamentoAprovado.value,
        orcamentoExecutado: campos.orcamentoExecutado.value,
        empresaResponsavel: campos.empresa.value,
        contatos,
        evidencias: evidenciasExistentes.concat(novasEvidencias),
        timeline: timelineExtras,
        termoAutorizacaoURL: termoURL,
        notaFiscalURL: notaURL,
        situacaoHidrica: campos.situacaoHidrica.value,
        usoAguaComunitario: campos.usoAgua.value,
        acoesPosInstalacao: campos.acoesPosInstalacao.value,
        observacoes: campos.observacoes.value,
        responsavelContato: campos.contatoNome.value,
        contatoInstalacao: campos.contatoNome.value,
        telefoneContato: campos.contatoTelefone.value
      };

      const idExistente = hiddenId.value;
      const onSuccess = () => {
        mensagemFormulario.textContent = '‚úÖ Po√ßo salvo com sucesso!';
        mensagemFormulario.className = 'text-sm font-medium text-green-600';
        arquivos.termo.value = '';
        arquivos.nota.value = '';
        arquivos.evidencias.value = '';
        carregarPocos();
        if (!idExistente) {
          limparFormulario();
        } else {
          selecionarPoco(idExistente);
        }
      };

      if (idExistente) {
        payload.id = idExistente;
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(err => {
          mensagemFormulario.textContent = `‚ùå ${err.message || 'Erro ao atualizar o po√ßo.'}`;
          mensagemFormulario.className = 'text-sm font-medium text-red-600';
        }).atualizarPoco(payload);
      } else {
        google.script.run.withSuccessHandler(res => {
          hiddenId.value = res.id;
          onSuccess();
        }).withFailureHandler(err => {
          mensagemFormulario.textContent = `‚ùå ${err.message || 'Erro ao salvar o po√ßo.'}`;
          mensagemFormulario.className = 'text-sm font-medium text-red-600';
        }).salvarPoco(payload);
      }
    } catch (error) {
      mensagemFormulario.textContent = `‚ùå ${error.message || 'Erro inesperado ao salvar o po√ßo.'}`;
      mensagemFormulario.className = 'text-sm font-medium text-red-600';
    }
  });

  carregarPocos();
})();
</script>
