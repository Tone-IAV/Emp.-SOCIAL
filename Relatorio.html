<div class="p-4">
  <h2 class="text-xl font-bold mb-4">📈 Relatório Financeiro de Poço</h2>

  <div class="bg-white p-4 rounded shadow mb-6">
    <label class="block mb-2 font-semibold">Selecione o Poço</label>
    <select id="pocoSelect" class="border p-2 w-full rounded"></select>
  </div>

  <!-- RESUMO -->
  <div id="resumo" class="hidden bg-white rounded-lg shadow p-4 mb-6">
    <h3 class="text-lg font-semibold mb-2" id="nomePoco"></h3>
    <p><b>Status:</b> <span id="statusPoco"></span></p>
    <p><b>Base:</b> <span id="basePoco"></span></p>
    <p><b>Valor Previsto:</b> R$ <span id="valorPrevisto"></span></p>
    <p><b>Valor Realizado:</b> R$ <span id="valorRealizado"></span></p>
    <p><b>Saldo:</b> R$ <span id="saldo"></span></p>
  </div>

  <!-- GRÁFICO -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <canvas id="graficoPoco" height="120"></canvas>
  </div>

  <!-- TABELA -->
  <div class="bg-white rounded shadow p-4">
    <h3 class="font-semibold mb-2">Despesas Registradas</h3>
    <table id="tabelaDespesas" class="w-full">
      <thead class="bg-gray-200">
        <tr><th class="p-2 text-left">Data</th><th class="p-2 text-left">Descrição</th><th class="p-2 text-left">Valor</th><th class="p-2 text-left">Comprovante</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="mt-6 text-right">
    <button onclick="gerarPDF()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">📄 Gerar PDF</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let dadosPoco = null;
let grafico = null;

// Carregar poços no select
function carregarSelectPocos() {
  google.script.run.withSuccessHandler(pocos => {
    const select = document.getElementById('pocoSelect');
    select.innerHTML = '<option value="">Selecione...</option>' + pocos.map(p => `<option value="${p.ID}">${p.Nome} - ${p.Base}</option>`).join('');
  }).listarPocos();
}

document.getElementById('pocoSelect').addEventListener('change', e => {
  const id = e.target.value;
  if (id) carregarRelatorio(id);
});

function carregarRelatorio(id) {
  google.script.run.withSuccessHandler(res => {
    dadosPoco = res;
    const p = res.poco;
    const despesas = res.despesas;

    document.getElementById('resumo').classList.remove('hidden');
    document.getElementById('nomePoco').textContent = p.Nome;
    document.getElementById('statusPoco').textContent = p.Status;
    document.getElementById('basePoco').textContent = p.Base;
    document.getElementById('valorPrevisto').textContent = Number(p.ValorPrevisto || 0).toFixed(2);
    document.getElementById('valorRealizado').textContent = Number(p.ValorRealizado || 0).toFixed(2);
    const saldo = Number(p.ValorPrevisto || 0) - Number(p.ValorRealizado || 0);
    document.getElementById('saldo').textContent = saldo.toFixed(2);

    // Atualiza tabela
    const tbody = document.querySelector('#tabelaDespesas tbody');
    tbody.innerHTML = despesas.length
      ? despesas.map(d => `
          <tr class="border-b">
            <td class="p-2">${new Date(d.Data).toLocaleDateString('pt-BR')}</td>
            <td class="p-2">${d.Descrição}</td>
            <td class="p-2">R$ ${Number(d.Valor).toFixed(2)}</td>
            <td class="p-2">${d.ComprovanteURL ? `<a href="${d.ComprovanteURL}" target="_blank">📎 Ver</a>` : '-'}</td>
          </tr>
        `).join('')
      : '<tr><td colspan="4" class="text-center p-3 text-gray-500">Nenhuma despesa registrada</td></tr>';

    // Atualiza gráfico
    const ctx = document.getElementById('graficoPoco');
    if (grafico) grafico.destroy();
    grafico = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Valor Realizado', 'Saldo Restante'],
        datasets: [{
          data: [p.ValorRealizado || 0, saldo],
          backgroundColor: ['#3b82f6', '#93c5fd']
        }]
      },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  }).obterRelatorioPoco(id);
}

async function gerarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const p = dadosPoco.poco;
  const despesas = dadosPoco.despesas;

  doc.setFontSize(14);
  doc.text('Relatório de Prestação de Contas', 15, 15);
  doc.setFontSize(11);
  doc.text(`Poço: ${p.Nome} - ${p.Base}`, 15, 25);
  doc.text(`Status: ${p.Status}`, 15, 32);
  doc.text(`Valor Previsto: R$ ${Number(p.ValorPrevisto).toFixed(2)}`, 15, 39);
  doc.text(`Valor Realizado: R$ ${Number(p.ValorRealizado).toFixed(2)}`, 15, 46);
  const saldo = Number(p.ValorPrevisto) - Number(p.ValorRealizado);
  doc.text(`Saldo Restante: R$ ${saldo.toFixed(2)}`, 15, 53);

  // Tabela simples
  let y = 65;
  doc.text('Despesas:', 15, y);
  y += 8;
  despesas.forEach(d => {
    doc.text(`${new Date(d.Data).toLocaleDateString('pt-BR')} - ${d.Descrição} - R$ ${Number(d.Valor).toFixed(2)}`, 15, y);
    y += 6;
    if (y > 270) { doc.addPage(); y = 20; }
  });

  doc.save(`Relatorio_${p.Nome}.pdf`);
}

carregarSelectPocos();
</script>
