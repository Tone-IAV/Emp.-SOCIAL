<div class="p-4">
  <h2 class="text-xl font-bold mb-4">ðŸ“ˆ RelatÃ³rio Financeiro de PoÃ§o</h2>

  <div class="bg-white p-4 rounded shadow mb-6">
    <label class="block mb-2 font-semibold">Selecione o PoÃ§o</label>
    <select id="pocoSelect" class="border p-2 w-full rounded"></select>
  </div>

  <!-- RESUMO -->
  <div id="resumo" class="hidden bg-white rounded-lg shadow p-4 mb-6">
    <h3 class="text-lg font-semibold mb-2" id="nomePoco"></h3>
    <p><b>Status:</b> <span id="statusPoco"></span></p>
    <p><b>Base:</b> <span id="basePoco"></span></p>
    <p><b>Valor Previsto:</b> <span id="valorPrevisto"></span></p>
    <p><b>Valor Aprovado:</b> <span id="valorAprovado"></span></p>
    <p><b>Valor Executado:</b> <span id="valorRealizado"></span></p>
    <p><b>Saldo:</b> <span id="saldo"></span></p>
  </div>

  <!-- GRÃFICO -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <div id="graficoPoco" style="min-height:220px;"></div>
  </div>

  <!-- TABELA -->
  <div class="bg-white rounded shadow p-4">
    <h3 class="font-semibold mb-2">Despesas Registradas</h3>
    <table id="tabelaDespesas" class="w-full">
      <thead class="bg-gray-200">
        <tr><th class="p-2 text-left">Data</th><th class="p-2 text-left">DescriÃ§Ã£o</th><th class="p-2 text-left">Valor</th><th class="p-2 text-left">Comprovante</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="mt-6 text-right">
    <button onclick="gerarPDF()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ðŸ“„ Gerar PDF</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let dadosPoco = null;
let grafico = null;

// Carregar poÃ§os no select
function carregarSelectPocos() {
  google.script.run.withSuccessHandler(pocos => {
    const select = document.getElementById('pocoSelect');
    const options = pocos.map(p => {
      const nome = p['Comunidade'] || p['MunicÃ­pio'] || p['Estado'] || 'PoÃ§o sem nome';
      const status = p.Status || 'Sem status';
      return `<option value="${p.ID}">${nome} â€” ${status}</option>`;
    });
    select.innerHTML = '<option value="">Selecione...</option>' + options.join('');
  }).listarPocos();
}

document.getElementById('pocoSelect').addEventListener('change', e => {
  const id = e.target.value;
  if (id) carregarRelatorio(id);
});

function carregarRelatorio(id) {
  google.script.run.withSuccessHandler(res => {
    dadosPoco = res;
    const p = res.poco;
    const despesas = res.despesas;

    if (!p) {
      document.getElementById('resumo').classList.add('hidden');
      document.querySelector('#tabelaDespesas tbody').innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-3">PoÃ§o nÃ£o encontrado.</td></tr>';
      return;
    }

    const nome = p['Comunidade'] || p['MunicÃ­pio'] || p['Estado'] || 'PoÃ§o sem nome';
    const local = [p['MunicÃ­pio'], p['Estado']].filter(Boolean).join(' - ');
    const valorPrevisto = Number(p.OrcamentoPrevisto || p['Valor Previsto PerfuraÃ§Ã£o'] || 0);
    const valorAprovado = Number(p.OrcamentoAprovado || 0);
    const valorExecutado = Number(p.OrcamentoExecutado || p['Valor Realizado'] || 0);
    const saldo = valorPrevisto - valorExecutado;

    document.getElementById('resumo').classList.remove('hidden');
    document.getElementById('nomePoco').textContent = nome;
    document.getElementById('statusPoco').textContent = p['Status'] || '-';
    document.getElementById('basePoco').textContent = local || '-';
    document.getElementById('valorPrevisto').textContent = valorPrevisto.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('valorAprovado').textContent = valorAprovado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('valorRealizado').textContent = valorExecutado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('saldo').textContent = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    // Atualiza tabela
    const tbody = document.querySelector('#tabelaDespesas tbody');
    tbody.innerHTML = despesas.length
      ? despesas.map(d => {
          const data = d.Data ? new Date(d.Data) : null;
          const dataTexto = data && !isNaN(data.getTime()) ? data.toLocaleDateString('pt-BR') : '-';
          const valor = Number(d.Valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          return `
            <tr class="border-b">
              <td class="p-2">${dataTexto}</td>
              <td class="p-2">${d.DescriÃ§Ã£o}</td>
              <td class="p-2">${valor}</td>
              <td class="p-2">${d.ComprovanteURL ? `<a href="${d.ComprovanteURL}" target="_blank">ðŸ“Ž Ver</a>` : '-'}</td>
            </tr>
          `;
        }).join('')
      : '<tr><td colspan="4" class="text-center p-3 text-gray-500">Nenhuma despesa registrada</td></tr>';

    // Atualiza grÃ¡fico
    if (!window.Highcharts) return;
    if (grafico) grafico.destroy();
    const saldoPositivo = saldo > 0 ? saldo : 0;
    const excedente = saldo < 0 ? Math.abs(saldo) : 0;
    const serie = [
      { name: 'Executado', y: valorExecutado }
    ];
    if (saldoPositivo > 0) serie.push({ name: 'Saldo restante', y: saldoPositivo });
    if (excedente > 0) serie.push({ name: 'Excedente executado', y: excedente });

    grafico = Highcharts.chart('graficoPoco', {
      chart: { type: 'pie' },
      title: { text: null },
      credits: { enabled: false },
      plotOptions: {
        pie: {
          innerSize: '60%',
          dataLabels: { format: '{point.name}: <b>{point.percentage:.1f}%</b>' }
        }
      },
      series: [{
        name: 'Investimento',
        data: serie
      }]
    });
  }).obterRelatorioPoco(id);
}

async function gerarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const p = dadosPoco.poco;
  const despesas = dadosPoco.despesas;

  const nome = p['Comunidade'] || p['MunicÃ­pio'] || p['Estado'] || 'PoÃ§o sem nome';
  const local = [p['MunicÃ­pio'], p['Estado']].filter(Boolean).join(' - ');
  const valorPrevisto = Number(p.OrcamentoPrevisto || p['Valor Previsto PerfuraÃ§Ã£o'] || 0);
  const valorExecutado = Number(p.OrcamentoExecutado || p['Valor Realizado'] || 0);
  const saldo = valorPrevisto - valorExecutado;

  doc.setFontSize(14);
  doc.text('RelatÃ³rio de PrestaÃ§Ã£o de Contas', 15, 15);
  doc.setFontSize(11);
  doc.text(`PoÃ§o: ${nome}`, 15, 25);
  doc.text(`Local: ${local || '-'}`, 15, 32);
  doc.text(`Status: ${p['Status'] || '-'}`, 15, 39);
  doc.text(`Valor Previsto: R$ ${valorPrevisto.toFixed(2)}`, 15, 46);
  doc.text(`Valor Executado: R$ ${valorExecutado.toFixed(2)}`, 15, 53);
  doc.text(`Saldo Restante: R$ ${saldo.toFixed(2)}`, 15, 60);

  // Tabela simples
  let y = 70;
  doc.text('Despesas:', 15, y);
  y += 8;
  despesas.forEach(d => {
    const data = d.Data ? new Date(d.Data).toLocaleDateString('pt-BR') : '-';
    doc.text(`${data} - ${d.DescriÃ§Ã£o} - R$ ${Number(d.Valor || 0).toFixed(2)}`, 15, y);
    y += 6;
    if (y > 270) { doc.addPage(); y = 20; }
  });

  doc.save(`Relatorio_${nome}.pdf`);
}

carregarSelectPocos();
</script>
