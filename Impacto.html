<div class="p-4 space-y-6">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <h2 id="impactoTitulo" class="text-xl font-bold">üå± An√°lise de impacto das perfura√ß√µes</h2>
      <p id="impactoDescricao" class="text-gray-600">Resumo consolidado dos resultados entregues aos doadores e √†s comunidades atendidas.</p>
    </div>
    <div class="impact-controls">
      <label for="impactoFiltro" class="impact-controls__label">Analisar:</label>
      <select id="impactoFiltro" class="impact-controls__select">
        <option value="pocos" selected>Perfura√ß√£o de po√ßos</option>
        <option value="projetos">Projetos sociais</option>
        <option value="doadores">Rede de doadores</option>
      </select>
    </div>
  </div>

  <style>
    .impact-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.08);
    }
    .impact-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #1d4ed8;
      margin-bottom: 1rem;
    }
    .impact-chart { min-height: 240px; }
    .impact-metric {
      background: linear-gradient(120deg, rgba(59,130,246,0.12), rgba(14,165,233,0.15));
      border-radius: 16px;
      padding: 1rem 1.25rem;
    }
    .impact-metric span {
      display: block;
    }
    .impact-metric .label {
      color: #1e3a8a;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .impact-metric .value {
      font-size: 1.6rem;
      font-weight: 700;
      color: #0f172a;
    }
    .impact-metric .detail {
      color: #475569;
      font-size: 0.85rem;
    }
    .impact-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .impact-table thead {
      background: #e0f2fe;
      color: #1d4ed8;
    }
    .impact-table th,
    .impact-table td {
      padding: 0.65rem 0.8rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }
    .timeline-impacto {
      position: relative;
      padding-left: 1.5rem;
    }
    .timeline-impacto::before {
      content: '';
      position: absolute;
      left: 0.45rem;
      top: 0.3rem;
      bottom: 0.3rem;
      width: 2px;
      background: #bfdbfe;
    }
    .timeline-item {
      position: relative;
      margin-bottom: 1.2rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.05rem;
      top: 0.2rem;
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 999px;
      background: #2563eb;
    }
    .timeline-item strong {
      color: #1d4ed8;
    }
    .timeline-item small {
      display: block;
      color: #6b7280;
      margin-top: 0.25rem;
    }
  </style>
  <style>
    .impact-controls { display:flex; align-items:center; gap:0.75rem; background:#eff6ff; padding:0.6rem 1rem; border-radius:999px; box-shadow:0 6px 18px rgba(37,99,235,0.12); }
    .impact-controls__label { font-size:0.85rem; font-weight:600; color:#1d4ed8; text-transform:uppercase; letter-spacing:0.08em; }
    .impact-controls__select { border:none; background:transparent; font-size:0.95rem; font-weight:600; color:#1e40af; padding:0.25rem 0.5rem; outline:none; cursor:pointer; }
    .impact-controls__select option { color:#1e293b; }
  </style>

  <div class="grid gap-4 md:grid-cols-5" id="metricasImpacto"></div>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="impact-card">
      <h3 id="impactoGraficoPrimarioTitulo">Contribui√ß√£o por doador</h3>
      <div id="graficoDoadoresImpacto" class="impact-chart"></div>
    </div>
    <div class="impact-card">
      <h3 id="impactoGraficoSecundarioTitulo">Status de entrega dos po√ßos</h3>
      <div id="graficoStatusImpacto" class="impact-chart"></div>
    </div>
  </div>

  <div class="impact-card">
    <h3 id="impactoGraficoTerciarioTitulo">Distribui√ß√£o dos benefici√°rios por estado</h3>
    <div id="graficoRegioesImpacto" class="impact-chart"></div>
  </div>

  <div class="impact-card">
    <h3 id="impactoTabelaTitulo">Presta√ß√£o de contas por po√ßo</h3>
    <div class="overflow-x-auto">
      <table class="impact-table">
        <thead>
          <tr id="impactoTabelaCabecalho"></tr>
        </thead>
        <tbody id="impactoTabelaCorpo"></tbody>
      </table>
    </div>
  </div>

  <div class="impact-card">
    <h3>Linha do tempo recente</h3>
    <div class="timeline-impacto" id="timelineImpacto"></div>
  </div>
</div>

<script>

  (() => {
    const chartsImpacto = {};
    const utilFormatarNumero = typeof window.formatarNumero === 'function' ? window.formatarNumero : (valor) => Number(valor || 0).toLocaleString('pt-BR');
    const utilFormatarMoeda = typeof window.formatarMoeda === 'function' ? window.formatarMoeda : (valor) => Number(valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const escapeHtmlBase = typeof window.escapeHtml === 'function' ? window.escapeHtml : (texto = '') => String(texto)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
    const criarDetalhes = typeof window.criarAtributoDetalhes === 'function' ? window.criarAtributoDetalhes : (() => '');
    const filtroSelect = document.getElementById('impactoFiltro');
    const tituloEl = document.getElementById('impactoTitulo');
    const descricaoEl = document.getElementById('impactoDescricao');
    const metricasContainer = document.getElementById('metricasImpacto');
    const tabelaCabecalho = document.getElementById('impactoTabelaCabecalho');
    const tabelaCorpo = document.getElementById('impactoTabelaCorpo');
    const tabelaTitulo = document.getElementById('impactoTabelaTitulo');
    const graficoPrimarioTitulo = document.getElementById('impactoGraficoPrimarioTitulo');
    const graficoSecundarioTitulo = document.getElementById('impactoGraficoSecundarioTitulo');
    const graficoTerciarioTitulo = document.getElementById('impactoGraficoTerciarioTitulo');
    const timelineContainer = document.getElementById('timelineImpacto');
    let dadosBase = {};
    let categoriaAtual = 'pocos';

    const escapeHtml = (valor) => escapeHtmlBase(valor ?? '');

    const atualizarTituloGrafico = (elemento, texto) => {
      if (elemento) elemento.textContent = texto;
    };

    const renderMetricas = (metricas = []) => {
      if (!metricasContainer) return;
      if (!metricas.length) {
        metricasContainer.innerHTML = '<div class="impact-metric"><span class="label">Sem dados</span><span class="value">-</span><span class="detail">Cadastre informa√ß√µes para visualizar m√©tricas.</span></div>';
        return;
      }
      metricasContainer.innerHTML = metricas.map(item => `
        <div class="impact-metric">
          <span class="label">${escapeHtml(item.label)}</span>
          <span class="value">${escapeHtml(item.valor)}</span>
          <span class="detail">${escapeHtml(item.detalhe || '')}</span>
        </div>
      `).join('');
    };

    const renderTabela = (config = {}) => {
      if (!tabelaCabecalho || !tabelaCorpo) return;
      const colunas = Array.isArray(config.colunas) ? config.colunas : [];
      const linhas = Array.isArray(config.linhas) ? config.linhas : [];
      tabelaCabecalho.innerHTML = colunas.map(col => `<th>${escapeHtml(col)}</th>`).join('');
      if (tabelaTitulo) tabelaTitulo.textContent = config.titulo || 'Presta√ß√£o de contas';
      if (!linhas.length) {
        tabelaCorpo.innerHTML = `<tr><td colspan="${Math.max(colunas.length, 1)}" class="text-center text-gray-500 py-4">${escapeHtml(config.vazia || 'Nenhum registro dispon√≠vel.')}</td></tr>`;
        return;
      }
      tabelaCorpo.innerHTML = linhas.map(linha => {
        const detalhe = linha.detalhe ? ` ${linha.detalhe}` : '';
        return `<tr${detalhe}>${linha.celulas.map(cel => `<td>${cel}</td>`).join('')}</tr>`;
      }).join('');
    };

    const renderTimeline = (eventos = []) => {
      if (!timelineContainer) return;
      if (!eventos.length) {
        timelineContainer.innerHTML = '<p class="text-gray-500">Sem registros recentes.</p>';
        return;
      }
      timelineContainer.innerHTML = eventos.map(evento => {
        const detalheAttr = evento.detalhe ? ` ${evento.detalhe}` : '';
        return `
          <div class="timeline-item"${detalheAttr}>
            <strong>${escapeHtml(evento.titulo)}</strong>
            <div>${escapeHtml(evento.descricao || '')}</div>
            <small>${escapeHtml(evento.meta || '')}</small>
          </div>
        `;
      }).join('');
    };

    const renderGrafico = (id, configuracao) => {
      const container = document.getElementById(id);
      if (!container) return;
      if (chartsImpacto[id]) {
        chartsImpacto[id].destroy();
        chartsImpacto[id] = null;
      }
      if (!window.Highcharts) {
        container.innerHTML = '<div class="empty-state">Gr√°fico indispon√≠vel no momento.</div>';
        return;
      }
      if (!configuracao || !configuracao.series || !configuracao.series.length) {
        const mensagem = configuracao && configuracao.emptyMessage ? configuracao.emptyMessage : 'Dados insuficientes para este gr√°fico.';
        container.innerHTML = `<div class="empty-state">${escapeHtml(mensagem)}</div>`;
        return;
      }
      chartsImpacto[id] = Highcharts.chart(id, Highcharts.merge({
        title: { text: null },
        credits: { enabled: false },
        legend: { align: 'center', verticalAlign: 'bottom' }
      }, configuracao));
    };

    const normalizarLista = (valor) => Array.isArray(valor) ? valor : [];

    const obterProjetos = (base) => {
      if (Array.isArray(base.projetos)) return base.projetos;
      if (Array.isArray(base.projetosImpacto)) return base.projetosImpacto;
      if (window.__dadosMissoesAtuais && Array.isArray(window.__dadosMissoesAtuais.projetos)) return window.__dadosMissoesAtuais.projetos;
      return [];
    };

    const obterDoadores = (base) => {
      if (Array.isArray(base.doadores)) return base.doadores;
      if (Array.isArray(base.rankingDoadores)) return base.rankingDoadores;
      if (Array.isArray(base.ranking)) return base.ranking;
      if (window.__dadosMissoesAtuais && Array.isArray(window.__dadosMissoesAtuais.doadores)) return window.__dadosMissoesAtuais.doadores;
      return [];
    };

    const obterPocos = (base) => {
      if (Array.isArray(base.pocos)) return base.pocos;
      if (Array.isArray(base.pocosMonitorados)) return base.pocosMonitorados;
      return [];
    };

    const agruparPor = (lista, chave) => {
      return lista.reduce((acc, item) => {
        const valor = (item[chave] || 'Indefinido').toString();
        acc[valor] = (acc[valor] || 0) + 1;
        return acc;
      }, {});
    };

    const prepararDados = {
      pocos: (base) => {
        const metricas = base.metricas || {};
        const listaPocos = obterPocos(base);
        const doadores = obterDoadores(base);
        const status = normalizarLista(base.distribuicaoStatus);
        const regioes = normalizarLista(base.regioes);
        const timelineBruto = normalizarLista(base.timeline);

        const metricasCards = [
          { label: 'Benefici√°rios alcan√ßados', valor: utilFormatarNumero(metricas.beneficiariosTotais || 0), detalhe: 'Pessoas com acesso √† √°gua' },
          { label: 'Fam√≠lias estimadas', valor: utilFormatarNumero(metricas.familiasEstimadas || 0), detalhe: 'Baseado em 4 pessoas por fam√≠lia' },
          { label: 'Volume di√°rio estimado', valor: `${utilFormatarNumero(metricas.volumeAguaDiario || 0)} L`, detalhe: 'Capacidade de oferta de √°gua' },
          { label: 'Investimento realizado', valor: utilFormatarMoeda(metricas.investimentoRealizado || 0), detalhe: `Previsto ${utilFormatarMoeda(metricas.investimentoPrevisto || 0)}` },
          { label: 'Custo por benefici√°rio', valor: utilFormatarMoeda(metricas.custoPorPessoa || 0), detalhe: 'Efici√™ncia financeira atual' }
        ];

        const linhasTabela = listaPocos.map(p => {
          const detalhe = criarDetalhes({
            titulo: p.nome || p.poco || 'Po√ßo',
            subtitulo: `${utilFormatarNumero(p.beneficiarios || 0)} benefici√°rios ‚Ä¢ ${p.status || 'Status n√£o informado'}`,
            campos: [
              { label: 'Localidade', valor: p.local || p.municipio || 'Local n√£o informado' },
              { label: 'Doadores vinculados', valor: p.doadores || 'Nenhum doador vinculado' },
              { label: 'Investimento realizado', valor: utilFormatarMoeda(p.valorExecutado || 0) },
              { label: 'Gap financeiro', valor: utilFormatarMoeda(p.gapFinanceiro || 0) },
              { label: 'Vaz√£o estimada', valor: p.vazao ? `${utilFormatarNumero(p.vazao)} L/h` : 'N√£o informada' }
            ]
          });
          const celulas = [
            `<div class="font-semibold text-gray-900">${escapeHtml(p.nome || p.poco || 'Po√ßo')}</div><small class="text-gray-500">${escapeHtml(p.local || p.municipio || 'Local n√£o informado')}</small>`,
            escapeHtml(p.status || 'Sem status'),
            escapeHtml(utilFormatarNumero(p.beneficiarios || 0)),
            escapeHtml(p.doadores || '‚Äî'),
            escapeHtml(utilFormatarMoeda(p.valorExecutado || 0)),
            escapeHtml(utilFormatarMoeda(p.gapFinanceiro || 0)),
            escapeHtml(p.vazao ? `${utilFormatarNumero(p.vazao)} L/h` : '‚Äî')
          ];
          return { celulas, detalhe };
        });

        const timelineEventos = timelineBruto.map(ev => {
          const data = ev.data ? new Date(ev.data) : null;
          const dataFormatada = data && !isNaN(data.getTime()) ? data.toLocaleDateString('pt-BR') : 'Data n√£o informada';
          const detalhe = criarDetalhes({
            titulo: ev.poco || 'Atualiza√ß√£o do po√ßo',
            subtitulo: `${dataFormatada} ‚Ä¢ ${ev.statusContato || 'Sem status de contato'}`,
            campos: [
              { label: 'Respons√°vel', valor: ev.responsavel || 'N√£o informado' },
              { label: 'Resumo', valor: ev.resumo || 'Sem resumo registrado.' },
              { label: 'Pr√≥xima a√ß√£o', valor: ev.proximaAcao || 'N√£o definida' }
            ]
          });
          return {
            titulo: ev.poco || 'Po√ßo',
            descricao: ev.resumo || 'Sem descri√ß√£o registrada.',
            meta: `${dataFormatada} ‚Ä¢ ${ev.responsavel || 'Equipe'}`,
            detalhe
          };
        });

        const chartDoadores = doadores.length ? {
          chart: { type: 'column' },
          xAxis: { categories: doadores.map(d => d.nome || 'Doador'), title: { text: null } },
          yAxis: {
            min: 0,
            title: { text: 'Valor doado (R$)' },
            labels: {
              formatter() {
                return utilFormatarMoeda(this.value);
              }
            }
          },
          legend: { enabled: false },
          tooltip: {
            pointFormatter() {
              return `<span style="color:${this.color}">‚óè</span> ${escapeHtml(this.category)}: <b>${utilFormatarMoeda(this.y)}</b>`;
            }
          },
          plotOptions: { column: { borderRadius: 8, pointPadding: 0.1 } },
          series: [{ name: 'Doa√ß√µes', data: doadores.map(d => Number(d.valor || d.total || 0)) }]
        } : { series: [], emptyMessage: 'Nenhum doador vinculado.' };

        const chartStatus = status.length ? {
          chart: { type: 'pie' },
          plotOptions: {
            pie: {
              innerSize: '55%',
              dataLabels: { format: '{point.name}: <b>{point.y}</b>' }
            }
          },
          tooltip: { pointFormat: '<b>{point.y}</b> po√ßos ({point.percentage:.1f}%)' },
          series: [{
            name: 'Po√ßos',
            data: status.map(s => ({
              name: s.status,
              y: Number(s.total || 0)
            }))
          }]
        } : { series: [], emptyMessage: 'Sem dados de status.' };

        const chartRegioes = regioes.length ? {
          chart: { type: 'column' },
          xAxis: { categories: regioes.map(r => r.estado || 'UF') },
          yAxis: { min: 0, title: { text: 'Benefici√°rios' } },
          legend: { enabled: false },
          tooltip: { pointFormat: '<b>{point.y}</b> benefici√°rios' },
          plotOptions: { column: { borderRadius: 6, pointPadding: 0.12 } },
          series: [{ name: 'Benefici√°rios', data: regioes.map(r => Number(r.beneficiarios || 0)) }]
        } : { series: [], emptyMessage: 'Sem distribui√ß√£o regional registrada.' };

        return {
          titulo: 'üå± An√°lise de impacto das perfura√ß√µes',
          descricao: 'Resumo consolidado dos resultados entregues aos doadores e √†s comunidades atendidas.',
          metricas: metricasCards,
          tabela: {
            titulo: 'Presta√ß√£o de contas por po√ßo',
            colunas: ['Po√ßo', 'Status', 'Benefici√°rios', 'Doadores vinculados', 'Investimento realizado', 'Gap financeiro', 'Vaz√£o estimada'],
            linhas: linhasTabela,
            vazia: 'Nenhum po√ßo registrado.'
          },
          graficosTitulos: {
            primario: 'Contribui√ß√£o por doador',
            secundario: 'Status de entrega dos po√ßos',
            terciario: 'Distribui√ß√£o dos benefici√°rios por estado'
          },
          charts: [
            { id: 'graficoDoadoresImpacto', options: chartDoadores },
            { id: 'graficoStatusImpacto', options: chartStatus },
            { id: 'graficoRegioesImpacto', options: chartRegioes }
          ],
          timeline: timelineEventos
        };
      },
      projetos: (base) => {
        const projetos = obterProjetos(base);
        const total = projetos.length;
        const emExecucao = projetos.filter(p => String(p.status || '').toLowerCase().includes('exec')).length;
        const concluido = projetos.filter(p => String(p.status || '').toLowerCase().includes('concl')).length;
        const investimentoPrevisto = projetos.reduce((total, item) => total + (Number(item.investimentoPrevisto || item.custoPrevisto || 0) || 0), 0);
        const investimentoRealizado = projetos.reduce((total, item) => total + (Number(item.valorExecutado || item.investimentoRealizado || 0) || 0), 0);
        const beneficiarios = projetos.reduce((total, item) => total + (Number(item.beneficiarios || item.familias || 0) || 0), 0);
        const metricasCards = [
          { label: 'Projetos cadastrados', valor: utilFormatarNumero(total), detalhe: 'Iniciativas monitoradas pela miss√£o.' },
          { label: 'Em execu√ß√£o', valor: utilFormatarNumero(emExecucao), detalhe: `${utilFormatarNumero(concluido)} conclu√≠dos` },
          { label: 'Investimento previsto', valor: utilFormatarMoeda(investimentoPrevisto), detalhe: `Realizado ${utilFormatarMoeda(investimentoRealizado)}` },
          { label: 'Benefici√°rios atendidos', valor: utilFormatarNumero(beneficiarios), detalhe: 'Somat√≥rio informado nos projetos.' },
          { label: 'Ticket m√©dio por projeto', valor: total ? utilFormatarMoeda(investimentoPrevisto / total) : utilFormatarMoeda(0), detalhe: 'Com base nos valores previstos.' }
        ];

        const linhasTabela = projetos.map(projeto => {
          const detalhe = criarDetalhes({
            titulo: projeto.titulo || projeto.nome || 'Projeto',
            subtitulo: `${projeto.status || 'Sem status'} ‚Ä¢ ${projeto.municipio || projeto.local || 'Local n√£o informado'}`,
            descricao: projeto.descricao || '',
            campos: [
              { label: 'Respons√°vel', valor: projeto.responsavel || 'N√£o informado' },
              { label: 'Investimento previsto', valor: utilFormatarMoeda(projeto.investimentoPrevisto || projeto.custoPrevisto || 0) },
              { label: 'Investimento realizado', valor: utilFormatarMoeda(projeto.valorExecutado || projeto.investimentoRealizado || 0) },
              { label: 'Benefici√°rios', valor: utilFormatarNumero(projeto.beneficiarios || projeto.familias || 0) },
              { label: 'Pr√≥xima a√ß√£o', valor: projeto.proximaAcao || 'N√£o definida' }
            ]
          });
          const celulas = [
            `<div class="font-semibold text-gray-900">${escapeHtml(projeto.titulo || projeto.nome || 'Projeto')}</div><small class="text-gray-500">${escapeHtml(projeto.municipio || projeto.local || 'Local n√£o informado')}</small>`,
            escapeHtml(projeto.etapa || projeto.status || 'Sem etapa'),
            escapeHtml(projeto.responsavel || '‚Äî'),
            escapeHtml(utilFormatarMoeda(projeto.investimentoPrevisto || projeto.custoPrevisto || 0)),
            escapeHtml(utilFormatarNumero(projeto.beneficiarios || projeto.familias || 0)),
            escapeHtml(projeto.proximaAcao || '‚Äî')
          ];
          return { celulas, detalhe };
        });

        const investimentosPorProjeto = projetos.map(item => ({
          nome: item.titulo || item.nome || 'Projeto',
          valor: Number(item.investimentoPrevisto || item.custoPrevisto || 0)
        })).sort((a, b) => b.valor - a.valor).slice(0, 8);

        const graficoInvestimento = investimentosPorProjeto.length ? {
          chart: { type: 'column' },
          xAxis: { categories: investimentosPorProjeto.map(i => i.nome) },
          yAxis: { min: 0, title: { text: 'Investimento (R$)' } },
          legend: { enabled: false },
          tooltip: { pointFormat: '<b>{point.y:,.0f}</b>' },
          series: [{ name: 'Investimento previsto', data: investimentosPorProjeto.map(i => i.valor) }]
        } : { series: [], emptyMessage: 'Nenhum investimento registrado.' };

        const statusAgrupado = Object.entries(agruparPor(projetos, 'status')).map(([nome, total]) => ({ nome, y: total }));
        const graficoStatus = statusAgrupado.length ? {
          chart: { type: 'pie' },
          tooltip: { pointFormat: '<b>{point.y}</b> projetos ({point.percentage:.1f}%)' },
          plotOptions: { pie: { innerSize: '55%', dataLabels: { format: '{point.name}: <b>{point.y}</b>' } } },
          series: [{ name: 'Projetos', data: statusAgrupado }]
        } : { series: [], emptyMessage: 'Sem status informados.' };

        const projetosPorEstado = Object.entries(agruparPor(projetos, 'estado')).map(([estado, total]) => ({ estado, total }));
        const graficoRegioes = projetosPorEstado.length ? {
          chart: { type: 'column' },
          xAxis: { categories: projetosPorEstado.map(r => r.estado || 'UF') },
          yAxis: { min: 0, title: { text: 'Projetos' } },
          legend: { enabled: false },
          series: [{ name: 'Projetos', data: projetosPorEstado.map(r => r.total) }]
        } : { series: [], emptyMessage: 'Sem distribui√ß√£o regional registrada.' };

        const timelineEventos = projetos.map(projeto => {
          const data = projeto.data || projeto.inicio || projeto.previsaoInicio;
          const dataObj = data ? new Date(data) : null;
          const dataFormatada = dataObj && !isNaN(dataObj.getTime()) ? dataObj.toLocaleDateString('pt-BR') : 'Data n√£o informada';
          const detalhe = criarDetalhes({
            titulo: projeto.titulo || projeto.nome || 'Projeto',
            subtitulo: `${dataFormatada} ‚Ä¢ ${projeto.status || 'Sem status'}`,
            campos: [
              { label: 'Respons√°vel', valor: projeto.responsavel || 'N√£o informado' },
              { label: 'Descri√ß√£o', valor: projeto.descricao || 'Sem descri√ß√£o registrada.' },
              { label: 'Pr√≥xima a√ß√£o', valor: projeto.proximaAcao || 'N√£o definida' }
            ]
          });
          return {
            titulo: projeto.titulo || projeto.nome || 'Projeto',
            descricao: projeto.descricao || 'Sem descri√ß√£o registrada.',
            meta: `${dataFormatada} ‚Ä¢ ${projeto.responsavel || 'Equipe'}`,
            detalhe
          };
        }).slice(0, 8);

        return {
          titulo: 'üöÄ Impacto dos projetos sociais',
          descricao: 'Acompanhe a evolu√ß√£o das iniciativas sociais, seus investimentos e benefici√°rios.',
          metricas: metricasCards,
          tabela: {
            titulo: 'Portf√≥lio de projetos',
            colunas: ['Projeto', 'Etapa', 'Respons√°vel', 'Investimento previsto', 'Benefici√°rios', 'Pr√≥xima a√ß√£o'],
            linhas: linhasTabela,
            vazia: 'Nenhum projeto cadastrado.'
          },
          graficosTitulos: {
            primario: 'Investimento por projeto',
            secundario: 'Distribui√ß√£o por status',
            terciario: 'Projetos por estado'
          },
          charts: [
            { id: 'graficoDoadoresImpacto', options: graficoInvestimento },
            { id: 'graficoStatusImpacto', options: graficoStatus },
            { id: 'graficoRegioesImpacto', options: graficoRegioes }
          ],
          timeline: timelineEventos
        };
      },
      doadores: (base) => {
        const doadores = obterDoadores(base);
        const total = doadores.length;
        const volumeDoado = doadores.reduce((total, item) => total + (Number(item.valor || item.total || 0) || 0), 0);
        const projetosApoiados = doadores.reduce((total, item) => total + (Number(item.projetos || item.pocos || 0) || 0), 0);
        const abrangencia = new Set(doadores.map(d => (d.estado || d.regiao || d.abrangencia || '').toString().trim()).filter(Boolean)).size;

        const metricasCards = [
          { label: 'Doadores ativos', valor: utilFormatarNumero(total), detalhe: 'Parceiros cadastrados e monitorados.' },
          { label: 'Volume doado', valor: utilFormatarMoeda(volumeDoado), detalhe: 'Somat√≥rio registrado nas parcerias.' },
          { label: 'Projetos apoiados', valor: utilFormatarNumero(projetosApoiados), detalhe: 'Quantidade total vinculada aos doadores.' },
          { label: 'Ticket m√©dio', valor: total ? utilFormatarMoeda(volumeDoado / total) : utilFormatarMoeda(0), detalhe: 'Investimento m√©dio por aliado.' },
          { label: 'Estados de atua√ß√£o', valor: utilFormatarNumero(abrangencia), detalhe: 'Cobertura territorial declarada.' }
        ];

        const linhasTabela = doadores.map(doador => {
          const detalhe = criarDetalhes({
            titulo: doador.nome || 'Doador',
            subtitulo: doador.categoria || doador.tipo || 'Tipo n√£o informado',
            campos: [
              { label: 'Valor acumulado', valor: utilFormatarMoeda(doador.valor || doador.total || 0) },
              { label: 'Projetos apoiados', valor: utilFormatarNumero(doador.projetos || doador.pocos || 0) },
              { label: 'Contato principal', valor: doador.contato || 'N√£o informado' },
              { label: '√öltimo aporte', valor: doador.ultimoAporte ? new Date(doador.ultimoAporte).toLocaleDateString('pt-BR') : 'Sem registro' }
            ]
          });
          const celulas = [
            `<div class="font-semibold text-gray-900">${escapeHtml(doador.nome || 'Doador')}</div><small class="text-gray-500">${escapeHtml(doador.estado || doador.regiao || 'Sem regi√£o')}</small>`,
            escapeHtml(doador.categoria || doador.tipo || '‚Äî'),
            escapeHtml(utilFormatarMoeda(doador.valor || doador.total || 0)),
            escapeHtml(utilFormatarNumero(doador.projetos || doador.pocos || 0)),
            escapeHtml(doador.ultimoAporte ? new Date(doador.ultimoAporte).toLocaleDateString('pt-BR') : '‚Äî')
          ];
          return { celulas, detalhe };
        });

        const graficoContribuicao = doadores.length ? {
          chart: { type: 'column' },
          xAxis: { categories: doadores.map(d => d.nome || 'Doador'), title: { text: null } },
          yAxis: { min: 0, title: { text: 'Valor doado (R$)' } },
          legend: { enabled: false },
          series: [{ name: 'Valor doado', data: doadores.map(d => Number(d.valor || d.total || 0)) }]
        } : { series: [], emptyMessage: 'Nenhum doador registrado.' };

        const categorias = Object.entries(agruparPor(doadores, 'categoria')).map(([nome, total]) => ({ name: nome, y: total }));
        const graficoCategorias = categorias.length ? {
          chart: { type: 'pie' },
          series: [{ name: 'Doadores', data: categorias }],
          tooltip: { pointFormat: '<b>{point.y}</b> doadores ({point.percentage:.1f}%)' }
        } : { series: [], emptyMessage: 'Classifique os doadores para visualizar a distribui√ß√£o.' };

        const regioes = Object.entries(agruparPor(doadores, 'estado')).map(([estado, total]) => ({ estado, total }));
        const graficoRegioes = regioes.length ? {
          chart: { type: 'column' },
          xAxis: { categories: regioes.map(r => r.estado || 'UF') },
          yAxis: { min: 0, title: { text: 'Doadores' } },
          legend: { enabled: false },
          series: [{ name: 'Doadores', data: regioes.map(r => r.total) }]
        } : { series: [], emptyMessage: 'Informe a regi√£o de atua√ß√£o dos doadores.' };

        const timelineEventos = doadores.map(doador => {
          const data = doador.ultimoAporte || doador.ultimaAcao;
          const dataObj = data ? new Date(data) : null;
          const dataFormatada = dataObj && !isNaN(dataObj.getTime()) ? dataObj.toLocaleDateString('pt-BR') : 'Sem data';
          const detalhe = criarDetalhes({
            titulo: doador.nome || 'Doador',
            subtitulo: `${dataFormatada} ‚Ä¢ ${doador.categoria || 'Sem categoria'}`,
            campos: [
              { label: 'Investimento acumulado', valor: utilFormatarMoeda(doador.valor || doador.total || 0) },
              { label: 'Projetos apoiados', valor: utilFormatarNumero(doador.projetos || doador.pocos || 0) },
              { label: 'Contato', valor: doador.contato || 'N√£o informado' }
            ]
          });
          return {
            titulo: doador.nome || 'Doador',
            descricao: `√öltimo aporte em ${dataFormatada}.`,
            meta: `${doador.categoria || 'Tipo n√£o informado'} ‚Ä¢ ${utilFormatarMoeda(doador.valor || doador.total || 0)}`,
            detalhe
          };
        }).slice(0, 8);

        return {
          titulo: 'ü§ù Impacto da rede de doadores',
          descricao: 'Monitore a contribui√ß√£o dos aliados e identifique oportunidades de relacionamento.',
          metricas: metricasCards,
          tabela: {
            titulo: 'Doadores e compromissos registrados',
            colunas: ['Doador', 'Tipo de apoio', 'Valor acumulado', 'Projetos apoiados', '√öltimo aporte'],
            linhas: linhasTabela,
            vazia: 'Nenhum doador cadastrado.'
          },
          graficosTitulos: {
            primario: 'Volume por doador',
            secundario: 'Distribui√ß√£o por tipo de apoio',
            terciario: 'Doadores por estado'
          },
          charts: [
            { id: 'graficoDoadoresImpacto', options: graficoContribuicao },
            { id: 'graficoStatusImpacto', options: graficoCategorias },
            { id: 'graficoRegioesImpacto', options: graficoRegioes }
          ],
          timeline: timelineEventos
        };
      }
    };

    const renderCategoria = (categoria) => {
      const preparador = prepararDados[categoria] || prepararDados.pocos;
      const pacote = preparador(dadosBase);
      if (tituloEl) tituloEl.textContent = pacote.titulo;
      if (descricaoEl) descricaoEl.textContent = pacote.descricao;
      renderMetricas(pacote.metricas);
      renderTabela(pacote.tabela);
      atualizarTituloGrafico(graficoPrimarioTitulo, pacote.graficosTitulos?.primario || 'Gr√°fico principal');
      atualizarTituloGrafico(graficoSecundarioTitulo, pacote.graficosTitulos?.secundario || 'Gr√°fico secund√°rio');
      atualizarTituloGrafico(graficoTerciarioTitulo, pacote.graficosTitulos?.terciario || 'Gr√°fico terci√°rio');
      pacote.charts.forEach(item => renderGrafico(item.id, item.options));
      renderTimeline(pacote.timeline);
      categoriaAtual = categoria;
      if (filtroSelect && filtroSelect.value !== categoria) filtroSelect.value = categoria;
    };

    const carregar = (dados) => {
      dadosBase = dados || {};
      renderCategoria(categoriaAtual);
    };

    if (filtroSelect) {
      filtroSelect.addEventListener('change', () => renderCategoria(filtroSelect.value));
    }

    if (window.google && google.script && google.script.run && google.script.run.withSuccessHandler) {
      google.script.run.withSuccessHandler(carregar).obterAnaliseImpacto();
    } else {
      carregar({});
    }
  })();
</script>

