<div class="p-4 space-y-4">
  <div class="flex flex-col gap-2">
    <h2 class="text-xl font-bold text-blue-700">üóÇÔ∏è Fluxo operacional dos po√ßos</h2>
    <p class="text-sm text-gray-600">Arraste os cart√µes entre as colunas para atualizar a etapa do processo. Os marcos alimentam automaticamente o cronograma, o kanban e o relat√≥rio financeiro.</p>
  </div>

  <div class="bg-white rounded-lg shadow p-4 flex items-center gap-4 flex-wrap">
    <div class="flex items-center gap-2 text-sm text-gray-600">
      <span class="w-3 h-3 rounded-full bg-orange-300"></span> Solicita√ß√£o
    </div>
    <div class="flex items-center gap-2 text-sm text-gray-600">
      <span class="w-3 h-3 rounded-full bg-yellow-300"></span> Or√ßamento previsto
    </div>
    <div class="flex items-center gap-2 text-sm text-gray-600">
      <span class="w-3 h-3 rounded-full bg-blue-400"></span> Instala√ß√£o
    </div>
    <div class="flex items-center gap-2 text-sm text-gray-600">
      <span class="w-3 h-3 rounded-full bg-green-400"></span> Conclu√≠do
    </div>
    <div class="flex items-center gap-2 text-sm text-gray-600">
      <span class="w-3 h-3 rounded-full bg-emerald-500"></span> Pago
    </div>
  </div>

  <div id="kanbanBoard" class="grid lg:grid-cols-5 gap-4"></div>
</div>

<style>
  .kanban-col {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    min-height: 320px;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 0.75rem;
    border: 1px dashed transparent;
    transition: border-color 0.2s ease, background 0.2s ease;
  }
  .kanban-col.drag-over {
    border-color: #2563eb;
    background: rgba(191, 219, 254, 0.3);
  }
  .kanban-card {
    background: #ffffff;
    border-radius: 0.75rem;
    border: 1px solid #e5e7eb;
    padding: 1rem;
    box-shadow: 0 6px 12px rgba(15, 23, 42, 0.06);
    cursor: grab;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 18px rgba(15, 23, 42, 0.12);
  }
  .kanban-card strong {
    display: block;
    font-size: 0.95rem;
    color: #0f172a;
    margin-bottom: 0.25rem;
  }
  .kanban-card small {
    display: block;
    font-size: 0.75rem;
    color: #475569;
  }
</style>

<script>
(() => {
  const COLUNAS = [
    { id: 'solicitado', titulo: 'Solicitado', status: 'Solicitado', descricao: 'Dados iniciais aguardando an√°lise.' },
    { id: 'orcamento', titulo: 'Or√ßamento previsto', status: 'Or√ßamento previsto', descricao: 'Aguardando valida√ß√£o financeira e v√≠nculo com doadores.' },
    { id: 'instalacao', titulo: 'Instala√ß√£o', status: 'Instala√ß√£o', descricao: 'Execu√ß√£o em campo e mobiliza√ß√£o t√©cnica.' },
    { id: 'concluido', titulo: 'Conclu√≠do', status: 'Conclu√≠do', descricao: 'Po√ßo em opera√ß√£o, pendente pagamento.' },
    { id: 'pago', titulo: 'Pago', status: 'Pago', descricao: 'Presta√ß√£o de contas finalizada.' }
  ];

  const board = document.getElementById('kanbanBoard');
  const coresColuna = {
    'Solicitado': '#fed7aa',
    'Or√ßamento previsto': '#fef3c7',
    'Instala√ß√£o': '#dbeafe',
    'Conclu√≠do': '#dcfce7',
    'Pago': '#d1fae5'
  };

  const criarColunas = () => {
    board.innerHTML = COLUNAS.map(col => `
      <div class="flex flex-col gap-3">
        <div>
          <h3 class="text-sm font-semibold text-slate-700">${col.titulo}</h3>
          <p class="text-xs text-slate-500">${col.descricao}</p>
        </div>
        <div class="kanban-col" data-status="${col.status}"></div>
      </div>`).join('');
  };

  const formatarMoeda = (valor) => {
    return Number(valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  };

  const montarCartoes = (pocos) => {
    const colunas = board.querySelectorAll('.kanban-col');
    colunas.forEach(col => col.innerHTML = '');

    pocos.forEach(poco => {
      const coluna = board.querySelector(`.kanban-col[data-status="${poco.status || 'Solicitado'}"]`);
      if (!coluna) return;
      const card = document.createElement('div');
      card.className = 'kanban-card';
      card.draggable = true;
      card.dataset.id = poco.id;
      card.dataset.status = poco.status;
      card.innerHTML = `
        <strong>${escapeHtml(poco.titulo)}</strong>
        <small>${escapeHtml(poco.local || 'Local n√£o informado')}</small>
        <div class="mt-2 grid grid-cols-2 gap-2 text-xs text-slate-500">
          <span>Previsto:<br><b>${formatarMoeda(poco.previsto)}</b></span>
          <span>Executado:<br><b>${formatarMoeda(poco.executado)}</b></span>
        </div>
        <div class="mt-2 text-xs text-slate-500">Benefici√°rios: <b>${poco.beneficiarios || 0}</b></div>
        <div class="mt-1 text-xs text-slate-500">Respons√°vel: <b>${escapeHtml(poco.responsavel || '‚Äî')}</b></div>`;
      if (typeof window.definirDetalhesElemento === 'function') {
        window.definirDetalhesElemento(card, {
          titulo: poco.titulo || 'Po√ßo',
          subtitulo: `${poco.status || 'Sem status'} ‚Ä¢ ${poco.local || 'Local n√£o informado'}`,
          campos: [
            { label: 'Etapa atual', valor: poco.status || 'N√£o informado' },
            { label: 'Valor previsto', valor: formatarMoeda(poco.previsto || 0) },
            { label: 'Valor executado', valor: formatarMoeda(poco.executado || 0) },
            { label: 'Benefici√°rios', valor: poco.beneficiarios || 0 },
            { label: 'Respons√°vel', valor: poco.responsavel || 'N√£o informado' }
          ],
          acao: { label: 'Abrir cadastro do po√ßo', destino: 'pocos' }
        });
      }
      card.style.borderTop = `4px solid ${coresColuna[poco.status] || '#e5e7eb'}`;
      coluna.appendChild(card);
    });

    configurarDrag();
  };

  const configurarDrag = () => {
    const cards = board.querySelectorAll('.kanban-card');
    cards.forEach(card => {
      card.addEventListener('dragstart', (event) => {
        event.dataTransfer.setData('id', card.dataset.id);
        setTimeout(() => card.classList.add('opacity-40'));
      });
      card.addEventListener('dragend', () => {
        card.classList.remove('opacity-40');
      });
    });

    board.querySelectorAll('.kanban-col').forEach(coluna => {
      coluna.addEventListener('dragover', (event) => {
        event.preventDefault();
        coluna.classList.add('drag-over');
      });
      coluna.addEventListener('dragleave', () => coluna.classList.remove('drag-over'));
      coluna.addEventListener('drop', (event) => {
        event.preventDefault();
        coluna.classList.remove('drag-over');
        const id = event.dataTransfer.getData('id');
        const card = board.querySelector(`.kanban-card[data-id="${id}"]`);
        if (!card) return;
        coluna.appendChild(card);
        const novoStatus = coluna.dataset.status;
        card.dataset.status = novoStatus;
        google.script.run.atualizarStatusPoco(id, novoStatus);
      });
    });
  };

  const carregarKanban = () => {
    google.script.run.withSuccessHandler(montarCartoes).obterKanbanProcesso();
  };

  criarColunas();
  carregarKanban();
})();
</script>
