<div class="p-4 space-y-6">
  <h2 class="text-xl font-bold">üìä Gest√£o √† vista da perfura√ß√£o</h2>
  <p class="text-gray-600">Acompanhe o andamento dos po√ßos, riscos e fornecedores envolvidos na opera√ß√£o.</p>

  <style>
    .gestao-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(15, 118, 110, 0.08);
    }
    .gestao-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #134e4a;
      margin-bottom: 1rem;
    }
    .gestao-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      background: #ecfdf5;
      color: #047857;
      font-weight: 600;
      font-size: 0.75rem;
    }
    .gestao-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .gestao-table thead {
      background: #d1fae5;
      color: #065f46;
    }
    .gestao-table th,
    .gestao-table td {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }
    .timeline-item {
      position: relative;
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 0.4rem;
      top: 0.2rem;
      width: 0.6rem;
      height: 0.6rem;
      border-radius: 999px;
      background: #0f766e;
    }
    .timeline-item small {
      color: #6b7280;
      display: block;
      margin-top: 0.25rem;
    }
  </style>

  <div class="grid gap-4 md:grid-cols-4" id="cardsGestao"></div>

  <div class="grid gap-4 lg:grid-cols-2">
    <div class="gestao-card">
      <h3>Andamento dos po√ßos e pr√≥ximos passos</h3>
      <div class="overflow-x-auto">
        <table class="gestao-table" id="tabelaAndamento">
          <thead>
            <tr>
              <th>Po√ßo</th>
              <th>Status</th>
              <th>Respons√°vel</th>
              <th>Pr√≥xima a√ß√£o</th>
              <th>√öltimo contato</th>
              <th>Gap financeiro</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="gestao-card">
      <h3>Alertas operacionais</h3>
      <div class="overflow-x-auto">
        <table class="gestao-table" id="tabelaAlertasGestao">
          <thead>
            <tr>
              <th>Po√ßo</th>
              <th>Motivo</th>
              <th>Respons√°vel</th>
              <th>Pr√≥xima a√ß√£o</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="grid gap-4 lg:grid-cols-2">
    <div class="gestao-card">
      <h3>Fornecedores engajados</h3>
      <div class="overflow-x-auto">
        <table class="gestao-table" id="tabelaFornecedores">
          <thead>
            <tr>
              <th>Fornecedor</th>
              <th>Po√ßos</th>
              <th>Valor previsto</th>
              <th>Valor executado</th>
              <th>Status</th>
              <th>Contato</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="gestao-card">
      <h3>Pr√≥ximos marcos do cronograma</h3>
      <div id="listaCronograma"></div>
    </div>
  </div>
</div>

<script>
  (() => {
    const { formatarNumero, formatarMoeda, escapeHtml, criarAtributoDetalhes } = window;

    function renderTabelaGenerica(id, linhas, template, colunas = 4) {
      const tbody = document.querySelector(`#${id} tbody`);
      if (!tbody) return;
      if (!linhas || !linhas.length) {
        tbody.innerHTML = `<tr><td colspan="${colunas}" class="text-gray-500 text-center py-3">Sem registros no momento.</td></tr>`;
        return;
      }
      tbody.innerHTML = linhas.map(template).join('');
    }

    function renderCronograma(lista) {
      const container = document.getElementById('listaCronograma');
      if (!lista || !lista.length) {
        container.innerHTML = '<p class="text-gray-500">Nenhum marco previsto ainda.</p>';
        return;
      }
      container.innerHTML = lista.map(item => {
        const data = item.data ? new Date(item.data).toLocaleDateString('pt-BR') : 'Data a definir';
        const detalheAttr = criarAtributoDetalhes({
          titulo: item.poco || 'Marco do cronograma',
          subtitulo: `${data} ‚Ä¢ ${item.status || 'Status n√£o informado'}`,
          campos: [
            { label: 'Etapa', valor: item.etapa || 'N√£o informada' },
            { label: 'Descri√ß√£o', valor: item.descricao || 'Sem descri√ß√£o registrada.' },
            { label: 'Respons√°vel', valor: item.responsavel || 'N√£o informado' }
          ],
          acao: { label: 'Abrir gest√£o', destino: 'gestao' }
        });
        return `
          <div class="timeline-item" ${detalheAttr} role="button" tabindex="0">
            <strong>${escapeHtml(item.poco)}</strong> ‚Äî <span class="gestao-tag">${escapeHtml(item.etapa)}</span>
            <div>${escapeHtml(item.descricao)}</div>
            <small>${data} ‚Ä¢ ${escapeHtml(item.status)}</small>
          </div>
        `;
      }).join('');
    }

    function renderGestao(dados) {
      const resumo = dados.resumo || {};
      const cards = [
        { titulo: 'Po√ßos ativos', valor: formatarNumero(resumo.totalPocos || 0), detalhe: `${formatarNumero(resumo.emExecucao || 0)} em execu√ß√£o` },
        { titulo: 'Planejados', valor: formatarNumero(resumo.planejados || 0), detalhe: 'Em fase de prepara√ß√£o' },
        { titulo: 'Conclu√≠dos', valor: formatarNumero(resumo.concluidos || 0), detalhe: 'Entregues e monitorados' },
        { titulo: 'Gap financeiro', valor: formatarMoeda(resumo.gapFinanceiro || 0), detalhe: 'Previsto - executado' }
      ];
      document.getElementById('cardsGestao').innerHTML = cards.map(c => `
        <div class="gestao-card">
          <span class="text-sm font-semibold text-emerald-700 uppercase">${c.titulo}</span>
          <p class="text-2xl font-bold mt-1">${c.valor}</p>
          <span class="text-sm text-gray-500">${c.detalhe}</span>
        </div>
      `).join('');

      renderTabelaGenerica('tabelaAndamento', dados.andamento, item => {
        const ultimoContato = item.ultimoContato ? new Date(item.ultimoContato).toLocaleDateString('pt-BR') : '-';
        const gap = item.gapFinanceiro > 0
          ? `<span class="text-red-600 font-semibold">${formatarMoeda(item.gapFinanceiro)}</span>`
          : `<span class="text-emerald-600">${formatarMoeda(item.gapFinanceiro)}</span>`;
        const detalheAttr = criarAtributoDetalhes({
          titulo: item.nome || 'Po√ßo',
          subtitulo: `${item.status || 'Sem status'} ‚Äî ${item.local || 'Local n√£o informado'}`,
          campos: [
            { label: 'Respons√°vel', valor: item.responsavel || 'N√£o informado' },
            { label: 'Pr√≥xima a√ß√£o', valor: item.proximaAcao || 'Sem a√ß√£o definida' },
            { label: 'Status do contato', valor: item.statusContato || 'Sem status' },
            { label: '√öltimo contato', valor: ultimoContato },
            { label: 'Gap financeiro', valor: formatarMoeda(item.gapFinanceiro || 0) }
          ],
          acao: { label: 'Abrir cadastro do po√ßo', destino: 'pocos' }
        });
        return `
          <tr ${detalheAttr} class="linha-detalhe" role="button" tabindex="0">
            <td>
              <div class="font-semibold text-gray-900">${escapeHtml(item.nome)}</div>
              <small class="text-gray-500">${escapeHtml(item.local)}</small>
            </td>
            <td><span class="gestao-tag">${escapeHtml(item.status)}</span></td>
            <td>${escapeHtml(item.responsavel)}</td>
            <td>
              <div>${escapeHtml(item.proximaAcao || '-')}</div>
              <small class="text-gray-500">Contato: ${escapeHtml(item.statusContato)}</small>
            </td>
            <td>${ultimoContato}</td>
            <td>${gap}</td>
          </tr>
        `;
      }, 6);

      renderTabelaGenerica('tabelaAlertasGestao', dados.alertas, item => {
        const detalheAttr = criarAtributoDetalhes({
          titulo: item.poco || 'Po√ßo em alerta',
          subtitulo: item.motivo ? `Motivo: ${item.motivo}` : 'Alerta aberto',
          campos: [
            { label: 'Respons√°vel', valor: item.responsavel || 'N√£o informado' },
            { label: 'Pr√≥xima a√ß√£o', valor: item.proximaAcao || 'Sem pr√≥xima a√ß√£o' },
            { label: 'Status', valor: item.status || 'Sem status' },
            { label: 'Contato', valor: item.contato || 'Sem contato associado' }
          ],
          acao: { label: 'Abrir gest√£o', destino: 'gestao' }
        });
        return `
          <tr ${detalheAttr} class="linha-detalhe" role="button" tabindex="0">
            <td>${escapeHtml(item.poco)}</td>
            <td>${escapeHtml(item.motivo)}</td>
            <td>${escapeHtml(item.responsavel)}</td>
            <td>${escapeHtml(item.proximaAcao)}</td>
          </tr>
        `;
      });

      renderTabelaGenerica('tabelaFornecedores', dados.fornecedores, item => {
        const detalheAttr = criarAtributoDetalhes({
          titulo: item.fornecedor || 'Fornecedor',
          subtitulo: `${formatarNumero(item.pocosAtendidos || 0)} po√ßos atendidos`,
          campos: [
            { label: 'Valor previsto', valor: formatarMoeda(item.valorPrevisto || 0) },
            { label: 'Valor executado', valor: formatarMoeda(item.valorExecutado || 0) },
            { label: 'Status', valor: item.status || 'Sem status' },
            { label: 'Contato', valor: item.contato || 'Sem contato' },
            { label: 'Observa√ß√µes', valor: item.observacoes || 'Sem observa√ß√µes registradas.' }
          ],
          acao: { label: 'Abrir gest√£o', destino: 'gestao' }
        });
        return `
          <tr ${detalheAttr} class="linha-detalhe" role="button" tabindex="0">
            <td>${escapeHtml(item.fornecedor)}</td>
            <td>${formatarNumero(item.pocosAtendidos)}</td>
            <td>${formatarMoeda(item.valorPrevisto)}</td>
            <td>${formatarMoeda(item.valorExecutado)}</td>
            <td>${escapeHtml(item.status)}</td>
            <td>
              <div>${escapeHtml(item.contato || '-')}</div>
              <small class="text-gray-500">${escapeHtml(item.observacoes || '')}</small>
            </td>
          </tr>
        `;
      }, 6);

      renderCronograma(dados.cronograma);
    }

    google.script.run.withSuccessHandler(renderGestao).obterResumoGestao();
  })();
</script>
