<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <title>Emp. Social</title>
    <style>
      :root {
        color-scheme: light;
        --primary: #005a9c;
        --primary-dark: #004270;
        --background: #f4f6f8;
        --surface: #ffffff;
        --text: #2c3e50;
        --muted: #7f8c8d;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--background);
        color: var(--text);
      }

      header.site-header {
        background: var(--primary);
        color: #fff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .nav-container {
        width: 100%;
        margin: 0;
        padding: 0 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .brand {
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: 0.03em;
        padding: 18px 0;
      }

      nav ul {
        list-style: none;
        display: flex;
        gap: 16px;
        margin: 0;
        padding: 0;
      }

      nav a {
        color: #fff;
        text-decoration: none;
        font-weight: 500;
        padding: 12px 16px;
        border-radius: 6px;
        transition: background 0.2s ease-in-out;
      }

      nav a:hover,
      nav a.active {
        background: var(--primary-dark);
      }

      main {
        width: 100%;
        margin: 32px 0;
        padding: 0 24px 48px;
      }

      .card {
        background: var(--surface);
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 32px;
      }

      .card-title {
        font-size: 1.4rem;
        font-weight: 600;
        padding: 24px 24px 0;
      }

      .card-subtitle {
        color: var(--muted);
        padding: 0 24px 16px;
        margin-top: 4px;
      }

      .toolbar {
        display: flex;
        justify-content: flex-end;
        padding: 0 24px 16px;
        gap: 8px;
      }

      button {
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 10px 18px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: background 0.2s ease-in-out;
      }

      button.secondary {
        background: transparent;
        color: var(--primary);
        border: 1px solid rgba(0, 90, 156, 0.3);
      }

      button:hover {
        background: var(--primary-dark);
      }

      button.secondary:hover {
        background: rgba(0, 90, 156, 0.08);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: rgba(0, 90, 156, 0.08);
      }

      th,
      td {
        text-align: left;
        padding: 12px 18px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      tbody tr:hover {
        background: rgba(0, 90, 156, 0.05);
      }

      .table-container {
        padding: 0 24px 24px;
        overflow-x: auto;
      }

      .hidden {
        display: none !important;
      }

      .loading {
        padding: 24px;
        text-align: center;
        color: var(--muted);
      }

      body.modal-open {
        overflow: hidden;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(44, 62, 80, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 1000;
        opacity: 1;
        transition: opacity 0.2s ease-in-out;
      }

      .modal-overlay:not(.visible) {
        opacity: 0;
      }

      .modal {
        background: var(--surface);
        border-radius: 12px;
        width: min(640px, 100%);
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.16);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 24px 24px 0;
      }

      .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
      }

      .icon-button {
        background: transparent;
        border: none;
        color: inherit;
        font-size: 1.6rem;
        line-height: 1;
        border-radius: 6px;
        padding: 6px;
        cursor: pointer;
      }

      .icon-button:hover {
        background: rgba(0, 0, 0, 0.06);
      }

      .modal-body {
        padding: 20px 24px 0;
        overflow-y: auto;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 24px;
        padding-top: 20px;
      }

      .modal-footer.hidden {
        display: none !important;
      }

      .modal-footer button {
        min-width: 120px;
      }

      .modal-form .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .form-field {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-field label {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .form-field input,
      .form-field textarea,
      .form-field select {
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 6px;
        padding: 10px 12px;
        font-size: 0.95rem;
        color: var(--text);
        background: #fff;
      }

      .form-field textarea {
        min-height: 96px;
        resize: vertical;
      }

      .readonly-input {
        background: rgba(0, 0, 0, 0.05);
        cursor: not-allowed;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .detail-field {
        background: rgba(0, 90, 156, 0.04);
        border-radius: 8px;
        padding: 12px 14px;
      }

      .detail-field dt {
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .detail-field dd {
        margin: 0;
        font-size: 1rem;
        color: var(--text);
        word-break: break-word;
      }

      .project-detail {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .project-summary {
        background: linear-gradient(135deg, rgba(0, 90, 156, 0.12), rgba(0, 90, 156, 0.04));
        border-radius: 12px;
        padding: 20px;
        display: grid;
        gap: 16px;
      }

      .project-summary h3 {
        margin: 0;
        font-size: 1.15rem;
        font-weight: 600;
      }

      .project-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .project-chip {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(0, 90, 156, 0.15);
        border-radius: 8px;
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .project-chip span {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--muted);
        letter-spacing: 0.04em;
      }

      .project-chip strong {
        font-size: 1rem;
        font-weight: 600;
      }

      .project-section {
        background: rgba(0, 0, 0, 0.02);
        border-radius: 12px;
        padding: 16px 18px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .project-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .project-section-title {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-dark);
      }

      .project-section-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
      }

      .project-section-content .detail-field {
        background: #fff;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .project-visualizations {
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        background: #fff;
        overflow: hidden;
      }

      .visualization-selector {
        display: flex;
        gap: 8px;
        padding: 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        background: rgba(0, 90, 156, 0.05);
        flex-wrap: wrap;
      }

      .visualization-selector button {
        background: transparent;
        color: var(--primary);
        border: 1px solid rgba(0, 90, 156, 0.3);
        padding: 8px 14px;
        font-size: 0.9rem;
      }

      .visualization-selector button.active {
        background: var(--primary);
        color: #fff;
      }

      .visualization-panel {
        display: none;
        padding: 20px;
      }

      .visualization-panel.active {
        display: block;
      }

      .visualization-panels {
        display: block;
      }

      .visualization-panel h4 {
        margin: 0 0 12px;
        font-size: 1.05rem;
      }

      .visualization-panel p {
        margin: 0 0 16px;
        color: var(--muted);
      }

      .visualization-placeholder {
        display: grid;
        gap: 12px;
      }

      .kanban-board {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .kanban-column {
        background: rgba(0, 90, 156, 0.05);
        border-radius: 10px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .kanban-column h5 {
        margin: 0;
        font-size: 0.95rem;
        color: var(--primary-dark);
      }

      .kanban-card {
        background: #fff;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        padding: 10px 12px;
        font-size: 0.9rem;
        line-height: 1.4;
        color: var(--text);
      }

      .timeline {
        position: relative;
        padding-left: 20px;
        display: grid;
        gap: 14px;
      }

      .timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: rgba(0, 90, 156, 0.25);
      }

      .timeline-item {
        position: relative;
        padding-left: 16px;
      }

      .timeline-item::before {
        content: '';
        position: absolute;
        left: -12px;
        top: 4px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--primary);
      }

      .timeline-item strong {
        display: block;
        margin-bottom: 4px;
        font-size: 0.95rem;
      }

      .timeline-item span {
        color: var(--muted);
        font-size: 0.85rem;
      }

      @media (max-width: 768px) {
        nav ul {
          flex-wrap: wrap;
          gap: 8px;
        }

        nav a {
          padding: 10px 12px;
        }

        th,
        td {
          padding: 10px 12px;
        }

        .modal {
          max-height: 95vh;
        }

        .modal-header {
          padding: 24px 20px 0;
        }

        .modal-body {
          padding: 20px 20px 0;
        }

        .modal-footer {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <? var initialView = currentView; ?>
    <header class="site-header">
      <div class="nav-container">
        <div class="brand">Emp. Social</div>
        <nav>
          <ul>
            <? views.forEach(function(view) { ?>
              <li>
                <a
                  href="?view=<?= view.id ?>"
                  data-view="<?= view.id ?>"
                  class="<?= view.id === initialView ? 'active' : '' ?>"
                ><?= view.label ?></a>
              </li>
            <? }); ?>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <? views.forEach(function(view) { ?>
        <section
          id="view-<?= view.id ?>"
          class="card view-section <?= view.id === initialView ? '' : 'hidden' ?>"
          data-view-section="<?= view.id ?>"
        >
          <?!= include(view.partial) ?>
        </section>
      <? }); ?>
    </main>

    <div
      id="modal-overlay"
      class="modal-overlay hidden"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
    >
      <div class="modal" role="document">
        <div class="modal-header">
          <h2 id="modal-title" class="modal-title"></h2>
          <button class="icon-button" type="button" aria-label="Fechar" data-close-modal>
            &times;
          </button>
        </div>
        <div id="modal-body" class="modal-body"></div>
        <div id="modal-footer" class="modal-footer hidden"></div>
      </div>
    </div>

    <template id="table-template">
      <thead></thead>
      <tbody></tbody>
    </template>

    <script>
      const views = <?!= JSON.stringify(views) ?>;
      const defaultView = '<?= initialView ?>';
      const viewLookup = views.reduce((acc, view) => {
        acc[view.id] = view;
        return acc;
      }, {});
      const metadataCache = {};

      document.addEventListener('DOMContentLoaded', () => {
        setupNavigation();
        setupModal();
        navigateTo(defaultView, false);
      });

      function setupNavigation() {
        document.querySelectorAll('nav a[data-view]').forEach((link) => {
          link.addEventListener('click', (event) => {
            event.preventDefault();
            const view = link.dataset.view;
            navigateTo(view, true);
          });
        });

        window.addEventListener('popstate', () => {
          const view = new URL(window.location.href).searchParams.get('view') || defaultView;
          navigateTo(view, false);
        });
      }

      function setupModal() {
        const overlay = document.getElementById('modal-overlay');
        if (!overlay) return;

        overlay.querySelectorAll('[data-close-modal]').forEach((button) => {
          button.addEventListener('click', () => closeModal());
        });

        overlay.addEventListener('click', (event) => {
          if (event.target === overlay) {
            closeModal();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            closeModal();
          }
        });
      }

      function navigateTo(view, pushState = true) {
        if (!viewLookup[view]) {
          view = defaultView;
        }

        document.querySelectorAll('[data-view-section]').forEach((section) => {
          section.classList.toggle('hidden', section.dataset.viewSection !== view);
        });

        document.querySelectorAll('nav a[data-view]').forEach((link) => {
          link.classList.toggle('active', link.dataset.view === view);
        });

        if (pushState) {
          const url = new URL(window.location.href);
          url.searchParams.set('view', view);
          history.pushState({}, '', url);
        }

        loadTable(view);
      }

      function loadTable(view) {
        const loading = document.querySelector(`[data-loading="${view}"]`);
        const table = document.querySelector(`[data-table="${view}"]`);
        if (!loading || !table) return;

        loading.classList.remove('hidden');
        table.classList.add('hidden');
        table.innerHTML = '';

        const viewConfig = viewLookup[view];
        if (!viewConfig) {
          loading.textContent = 'Visualização não configurada.';
          return;
        }

        const method = viewConfig.fetch;
        if (!method || typeof google.script.run[method] !== 'function') {
          console.warn(`Nenhum método de busca configurado para "${view}".`);
          loading.textContent = 'Não foi possível carregar os dados desta visualização.';
          return;
        }

        google.script.run
          .withSuccessHandler((data) => renderTable(view, data))
          .withFailureHandler((error) => {
            loading.textContent = 'Não foi possível carregar os dados desta visualização.';
            handleError(error);
          })[method]();
      }

      function renderTable(view, data) {
        const loading = document.querySelector(`[data-loading="${view}"]`);
        const table = document.querySelector(`[data-table="${view}"]`);
        if (!loading || !table) return;

        fetchMetadata(view)
          .then((metadata) => {
            loading.classList.add('hidden');
            table.classList.remove('hidden');
            table.innerHTML = '';

            const template = document.getElementById('table-template');
            const clone = template.content.cloneNode(true);
            const thead = clone.querySelector('thead');
            const tbody = clone.querySelector('tbody');
            const columns = metadata.columns || [];

            if (columns.length) {
              const headerRow = document.createElement('tr');
              columns.forEach((column) => {
                const th = document.createElement('th');
                th.textContent = column.label;
                headerRow.appendChild(th);
              });
              thead.appendChild(headerRow);
            }

            if (!Array.isArray(data) || data.length === 0) {
              const emptyRow = document.createElement('tr');
              const cell = document.createElement('td');
              cell.colSpan = Math.max(columns.length, 1);
              cell.style.padding = '24px';
              cell.style.textAlign = 'center';
              cell.style.color = 'var(--muted)';
              cell.textContent = 'Nenhum registro encontrado.';
              emptyRow.appendChild(cell);
              tbody.appendChild(emptyRow);
            } else {
              data.forEach((row) => {
                const tr = document.createElement('tr');
                tr.tabIndex = 0;
                tr.addEventListener('click', () => openDetails(view, row));
                tr.addEventListener('keydown', (event) => {
                  if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openDetails(view, row);
                  }
                });

                columns.forEach((column) => {
                  const td = document.createElement('td');
                  const value = row[column.name];
                  td.textContent = value != null && value !== '' ? value : '—';
                  tr.appendChild(td);
                });

                tbody.appendChild(tr);
              });
            }

            table.appendChild(thead);
            table.appendChild(tbody);
          })
          .catch((error) => {
            loading.classList.remove('hidden');
            loading.textContent = 'Não foi possível carregar os dados desta visualização.';
            table.classList.add('hidden');
            handleError(error);
          });
      }

      function fetchMetadata(view) {
        if (metadataCache[view]) {
          return Promise.resolve(metadataCache[view]);
        }

        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler((data) => {
              metadataCache[view] = data;
              resolve(data);
            })
            .withFailureHandler(reject)
            .getViewConfig(view);
        });
      }

      function openForm(view, record = null) {
        const viewConfig = viewLookup[view];
        if (!viewConfig) {
          alert('Visualização não configurada.');
          return;
        }

        fetchMetadata(view)
          .then((metadata) => {
            const definition = viewLookup[view];
            if (!definition || !definition.save) {
              alert('Nenhuma ação de salvamento disponível para esta visualização.');
              return;
            }

            const form = buildForm(view, definition, metadata, record);
            const titleBase = metadata.label || definition.label || 'Registro';
            const title = record ? `Editar registro - ${titleBase}` : `Novo registro - ${titleBase}`;

            showModal({
              title,
              body: form,
              actions: [
                {
                  label: 'Cancelar',
                  variant: 'secondary',
                  onClick: () => closeModal()
                },
                {
                  label: 'Salvar',
                  type: 'submit',
                  form: form.id
                }
              ]
            });
          })
          .catch(handleError);
      }

      function buildForm(view, definition, metadata, record) {
        const form = document.createElement('form');
        form.className = 'modal-form';
        form.id = `form-${view}-${Date.now()}`;

        const grid = document.createElement('div');
        grid.className = 'form-grid';

        (metadata.columns || []).forEach((column) => {
          if (column.isKey) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.dataset.field = column.name;
            hiddenInput.value = record && record[column.name] ? record[column.name] : '';
            form.appendChild(hiddenInput);

            if (record && record[column.name]) {
              const fieldWrapper = document.createElement('div');
              fieldWrapper.className = 'form-field';

              const label = document.createElement('label');
              label.textContent = column.label;

              const displayInput = document.createElement('input');
              displayInput.type = 'text';
              displayInput.value = record[column.name];
              displayInput.readOnly = true;
              displayInput.classList.add('readonly-input');

              fieldWrapper.appendChild(label);
              fieldWrapper.appendChild(displayInput);
              grid.appendChild(fieldWrapper);
            }

            return;
          }

          const fieldWrapper = document.createElement('div');
          fieldWrapper.className = 'form-field';

          const label = document.createElement('label');
          const inputId = `${form.id}-${column.name}`;
          label.setAttribute('for', inputId);
          label.textContent = column.label;

          const input = createInputFieldElement(column, record ? record[column.name] : '');
          input.id = inputId;
          input.dataset.field = column.name;

          fieldWrapper.appendChild(label);
          fieldWrapper.appendChild(input);
          grid.appendChild(fieldWrapper);
        });

        form.appendChild(grid);

        form.addEventListener('submit', (event) => {
          event.preventDefault();
          submitForm(view, definition, metadata, form);
        });

        return form;
      }

      function createInputFieldElement(column, value) {
        const lower = column.name ? column.name.toLowerCase() : '';
        const multilineKeywords = ['descricao', 'descrição', 'observacao', 'observação', 'comentario', 'comentário', 'justificativa', 'anotacao', 'anotação', 'notas'];
        const shouldUseTextarea = multilineKeywords.some((keyword) => lower.includes(keyword));

        if (shouldUseTextarea) {
          const textarea = document.createElement('textarea');
          textarea.value = value || '';
          return textarea;
        }

        const input = document.createElement('input');
        input.type = 'text';
        input.value = value || '';
        return input;
      }

      function submitForm(view, definition, metadata, form) {
        const payload = {};
        (metadata.columns || []).forEach((column) => {
          const field = form.querySelector(`[data-field="${column.name}"]`);
          if (!field) return;
          payload[column.name] = field.value != null ? field.value : '';
        });

        const method = definition && definition.save;
        if (!method || typeof google.script.run[method] !== 'function') {
          alert('Não foi possível salvar os dados desta visualização.');
          return;
        }

        google.script.run
          .withSuccessHandler(() => {
            closeModal();
            loadTable(view);
            alert('Registro salvo com sucesso.');
          })
          .withFailureHandler(handleError)[method](payload);
      }

      function openDetails(view, record) {
        const definition = viewLookup[view];
        if (!definition) {
          return;
        }

        fetchMetadata(view)
          .then((metadata) => {
            const titleBase = metadata.label || definition.label || 'Registro';
            const detailContent = buildDetail(metadata, record, view);

            const actions = [];
            if (definition.save) {
              actions.push({
                label: 'Editar',
                onClick: () => {
                  closeModal();
                  openForm(view, record);
                }
              });
            }

            actions.push({
              label: 'Fechar',
              variant: 'secondary',
              onClick: () => closeModal()
            });

            showModal({
              title: `Detalhes - ${titleBase}`,
              body: detailContent,
              actions
            });
          })
          .catch(handleError);
      }

      function buildDetail(metadata, record, view) {
        if (view === 'projetos') {
          return buildProjectDetail(metadata, record);
        }

        return buildDefaultDetail(metadata, record);
      }

      function buildDefaultDetail(metadata, record) {
        const container = document.createElement('div');
        container.className = 'detail-grid';

        (metadata.columns || []).forEach((column) => {
          const field = document.createElement('dl');
          field.className = 'detail-field';

          const title = document.createElement('dt');
          title.textContent = column.label;

          const value = document.createElement('dd');
          const content = record && record[column.name] != null && record[column.name] !== '' ? record[column.name] : '—';
          value.textContent = content;

          field.appendChild(title);
          field.appendChild(value);
          container.appendChild(field);
        });

        return container;
      }

      function buildProjectDetail(metadata, record) {
        const columns = metadata.columns || [];
        const used = new Set();
        const container = document.createElement('div');
        container.className = 'project-detail';

        const normalize = (value) =>
          (value || '')
            .toString()
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '');

        const columnKey = (column) => column.name || column.label || '';

        const matchColumn = (column, keywords) => {
          const search = normalize(column.label || column.name || '');
          return keywords.some((keyword) => search.includes(keyword));
        };

        const createChip = (column) => {
          used.add(columnKey(column));
          const chip = document.createElement('div');
          chip.className = 'project-chip';

          const label = document.createElement('span');
          label.textContent = column.label || column.name;

          const strong = document.createElement('strong');
          strong.textContent = getValue(record, column.name, column.label);

          chip.appendChild(label);
          chip.appendChild(strong);
          return chip;
        };

        const summaryKeywords = [
          'nome',
          'projeto',
          'status',
          'fase',
          'situacao',
          'responsavel',
          'inicio',
          'inici',
          'previsao',
          'prazo',
          'fim',
          'conclusao',
          'doador',
          'doacao',
          'orcamento',
          'budget',
          'valor'
        ];

        const summarySection = document.createElement('section');
        summarySection.className = 'project-summary';

        const summaryTitle = document.createElement('h3');
        summaryTitle.textContent = metadata.label ? `Resumo do ${metadata.label}` : 'Resumo do Projeto';

        const summaryGrid = document.createElement('div');
        summaryGrid.className = 'project-summary-grid';

        columns
          .filter((column) => matchColumn(column, summaryKeywords))
          .slice(0, 8)
          .forEach((column) => {
            summaryGrid.appendChild(createChip(column));
          });

        if (!summaryGrid.childElementCount && columns.length) {
          summaryGrid.appendChild(createChip(columns[0]));
        }

        summarySection.appendChild(summaryTitle);
        summarySection.appendChild(summaryGrid);
        container.appendChild(summarySection);

        const createSection = (title, filteredColumns) => {
          if (!filteredColumns.length) {
            return null;
          }

          const section = document.createElement('section');
          section.className = 'project-section';

          const header = document.createElement('div');
          header.className = 'project-section-header';

          const heading = document.createElement('h4');
          heading.className = 'project-section-title';
          heading.textContent = title;

          header.appendChild(heading);
          section.appendChild(header);

          const content = document.createElement('div');
          content.className = 'project-section-content detail-grid';

          filteredColumns.forEach((column) => {
            used.add(columnKey(column));
            content.appendChild(createDetailField(column, record));
          });

          section.appendChild(content);
          return section;
        };

        const contactKeywords = ['contato', 'telefone', 'email', 'responsavel', 'parceiro'];
        const fundingKeywords = ['doacao', 'aporte', 'orcamento', 'finance', 'patrocin', 'recurso'];
        const actionKeywords = ['acao', 'entrega', 'atividade', 'etapa', 'meta'];

        const contactColumns = columns.filter(
          (column) => !used.has(columnKey(column)) && matchColumn(column, contactKeywords)
        );
        const fundingColumns = columns.filter(
          (column) => !used.has(columnKey(column)) && matchColumn(column, fundingKeywords)
        );
        const actionColumns = columns.filter(
          (column) => !used.has(columnKey(column)) && matchColumn(column, actionKeywords)
        );

        const otherColumns = columns.filter((column) => !used.has(columnKey(column)));

        const contactSection = createSection('Relacionamentos e Contatos', contactColumns);
        if (contactSection) {
          container.appendChild(contactSection);
        }

        const fundingSection = createSection('Financiamento e Doações', fundingColumns);
        if (fundingSection) {
          container.appendChild(fundingSection);
        }

        const actionsSection = createSection('Ações Diretas e Indiretas', actionColumns);
        if (actionsSection) {
          container.appendChild(actionsSection);
        }

        if (otherColumns.length) {
          const othersSection = createSection('Outras Informações', otherColumns);
          if (othersSection) {
            container.appendChild(othersSection);
          }
        }

        container.appendChild(buildProjectVisualizations(columns, record));

        return container;
      }

      function createDetailField(column, record) {
        const field = document.createElement('dl');
        field.className = 'detail-field';

        const title = document.createElement('dt');
        title.textContent = column.label || column.name;

        const value = document.createElement('dd');
        value.textContent = getValue(record, column.name, column.label);

        field.appendChild(title);
        field.appendChild(value);
        return field;
      }

      function getValue(record, fieldName, fallback) {
        if (!record) {
          return '—';
        }
        let value = fieldName ? record[fieldName] : undefined;
        if ((value == null || value === '') && fallback) {
          value = record[fallback];
        }
        if (value == null || value === '') {
          return '—';
        }
        return value;
      }

      function buildProjectVisualizations(columns, record) {
        const visualization = document.createElement('section');
        visualization.className = 'project-visualizations';

        const selector = document.createElement('div');
        selector.className = 'visualization-selector';

        const panelsWrapper = document.createElement('div');
        panelsWrapper.className = 'visualization-panels';

        const views = [
          { id: 'gantt', label: 'Gantt' },
          { id: 'kanban', label: 'Kanban' },
          { id: 'timeline', label: 'Linha do Tempo' }
        ];

        const panels = {};

        views.forEach((view) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.textContent = view.label;
          button.dataset.panel = view.id;
          button.addEventListener('click', () => setActivePanel(view.id));
          selector.appendChild(button);

          const panel = document.createElement('div');
          panel.className = 'visualization-panel';
          panel.dataset.panel = view.id;
          panelsWrapper.appendChild(panel);
          panels[view.id] = panel;
        });

        visualization.appendChild(selector);
        visualization.appendChild(panelsWrapper);

        populateGanttPanel(panels.gantt, columns, record);
        populateKanbanPanel(panels.kanban, columns, record);
        populateTimelinePanel(panels.timeline, columns, record);

        function setActivePanel(id) {
          panelsWrapper.querySelectorAll('.visualization-panel').forEach((panel) => {
            panel.classList.toggle('active', panel.dataset.panel === id);
          });
          selector.querySelectorAll('button').forEach((button) => {
            button.classList.toggle('active', button.dataset.panel === id);
          });
        }

        setActivePanel('gantt');

        return visualization;
      }

      function populateGanttPanel(panel, columns, record) {
        panel.innerHTML = '';

        const header = document.createElement('h4');
        header.textContent = 'Cronograma do Projeto';

        const description = document.createElement('p');
        description.textContent =
          'Visualização simplificada do andamento do projeto com base nas datas registradas.';

        const scheduleList = document.createElement('div');
        scheduleList.className = 'visualization-placeholder';

        const importantDates = extractDateFields(columns, record);

        if (!importantDates.length) {
          const empty = document.createElement('div');
          empty.textContent = 'Nenhuma data relevante cadastrada para este projeto.';
          scheduleList.appendChild(empty);
        } else {
          importantDates.forEach((item) => {
            const field = document.createElement('div');
            field.className = 'detail-field';

            const title = document.createElement('strong');
            title.textContent = item.label;

            const span = document.createElement('span');
            span.textContent = item.value;

            field.appendChild(title);
            field.appendChild(span);
            scheduleList.appendChild(field);
          });
        }

        panel.appendChild(header);
        panel.appendChild(description);
        panel.appendChild(scheduleList);
      }

      function populateKanbanPanel(panel, columns, record) {
        panel.innerHTML = '';

        const header = document.createElement('h4');
        header.textContent = 'Fluxo de Trabalho';

        const description = document.createElement('p');
        description.textContent =
          'Organize as ações diretas e indiretas do projeto nos estágios principais para acompanhamento rápido.';

        const board = document.createElement('div');
        board.className = 'kanban-board';

        const lanes = {
          planejado: { title: 'Planejado', items: [] },
          andamento: { title: 'Em andamento', items: [] },
          concluido: { title: 'Concluído', items: [] }
        };

        const actionFields = columns.filter((column) =>
          /acao|ação|etapa|atividade|entrega|tarefa/i.test(column.label || column.name || '')
        );

        actionFields.forEach((column) => {
          const value = record ? record[column.name] : '';
          if (!value) {
            return;
          }

          const entries = Array.isArray(value)
            ? value
            : value
                .toString()
                .split(/\n|;/)
                .map((item) => item.trim())
                .filter(Boolean);

          entries.forEach((entry) => {
            const normalized = entry.toLowerCase();
            if (/conclu|finaliz|feito/.test(normalized)) {
              lanes.concluido.items.push(entry);
            } else if (/em andamento|andamento|execut|progress/.test(normalized)) {
              lanes.andamento.items.push(entry);
            } else {
              lanes.planejado.items.push(entry);
            }
          });
        });

        Object.values(lanes).forEach((lane) => {
          const column = document.createElement('div');
          column.className = 'kanban-column';

          const title = document.createElement('h5');
          title.textContent = lane.title;
          column.appendChild(title);

          if (!lane.items.length) {
            const empty = document.createElement('div');
            empty.className = 'kanban-card';
            empty.textContent = 'Nenhuma ação categorizada.';
            column.appendChild(empty);
          } else {
            lane.items.forEach((item) => {
              const card = document.createElement('div');
              card.className = 'kanban-card';
              card.textContent = item;
              column.appendChild(card);
            });
          }

          board.appendChild(column);
        });

        panel.appendChild(header);
        panel.appendChild(description);
        panel.appendChild(board);
      }

      function populateTimelinePanel(panel, columns, record) {
        panel.innerHTML = '';

        const header = document.createElement('h4');
        header.textContent = 'Linha do Tempo do Projeto';

        const description = document.createElement('p');
        description.textContent =
          'Acompanhe os principais marcos, entregas e interações registradas ao longo do projeto.';

        const timeline = document.createElement('div');
        timeline.className = 'timeline';

        const events = [];

        const relevantColumns = columns.filter((column) =>
          /(data|marco|março|marco|evento|registro|contato)/i.test(column.label || column.name || '')
        );

        relevantColumns.forEach((column) => {
          const value = record ? record[column.name] : '';
          if (!value) {
            return;
          }

          const entries = Array.isArray(value)
            ? value
            : value
                .toString()
                .split(/\n|;/)
                .map((item) => item.trim())
                .filter(Boolean);

          entries.forEach((entry) => {
            events.push({
              title: column.label || column.name,
              description: entry
            });
          });
        });

        if (!events.length) {
          const empty = document.createElement('div');
          empty.textContent = 'Nenhum evento registrado para este projeto.';
          timeline.appendChild(empty);
        } else {
          events.forEach((event) => {
            const item = document.createElement('div');
            item.className = 'timeline-item';

            const title = document.createElement('strong');
            title.textContent = event.title;

            const span = document.createElement('span');
            span.textContent = event.description;

            item.appendChild(title);
            item.appendChild(span);
            timeline.appendChild(item);
          });
        }

        panel.appendChild(header);
        panel.appendChild(description);
        panel.appendChild(timeline);
      }

      function extractDateFields(columns, record) {
        const results = [];
        const dateRegex = /(data|inicio|início|fim|prazo|previs|entrega|marco)/i;

        columns.forEach((column) => {
          if (!dateRegex.test(column.label || column.name || '')) {
            return;
          }

          const value = record ? record[column.name] : '';
          if (!value) {
            return;
          }

          results.push({
            label: column.label || column.name,
            value: value.toString()
          });
        });

        return results;
      }

      function showModal({ title, body, actions = [] }) {
        const overlay = document.getElementById('modal-overlay');
        if (!overlay) return;

        const titleElement = document.getElementById('modal-title');
        const bodyContainer = document.getElementById('modal-body');
        const footer = document.getElementById('modal-footer');

        titleElement.textContent = title || '';
        bodyContainer.innerHTML = '';
        if (body instanceof Node) {
          bodyContainer.appendChild(body);
        }

        footer.innerHTML = '';
        actions.forEach((action) => {
          const button = document.createElement('button');
          button.type = action.type || 'button';
          button.textContent = action.label;
          if (action.variant === 'secondary') {
            button.classList.add('secondary');
          }
          if (action.form) {
            button.setAttribute('form', action.form);
          }
          if (typeof action.onClick === 'function') {
            button.addEventListener('click', action.onClick);
          }
          footer.appendChild(button);
        });

        footer.classList.toggle('hidden', footer.children.length === 0);

        overlay.classList.remove('hidden');
        overlay.classList.add('visible');
        overlay.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');

        setTimeout(() => {
          const focusable = overlay.querySelectorAll(
            'input:not([type="hidden"]), textarea, select, button:not([data-close-modal]), [data-close-modal]'
          );
          if (focusable.length > 0) {
            const firstElement = focusable[0];
            if (typeof firstElement.focus === 'function') {
              firstElement.focus();
            }
          }
        }, 50);
      }

      function closeModal() {
        const overlay = document.getElementById('modal-overlay');
        if (!overlay || overlay.classList.contains('hidden')) {
          return;
        }

        overlay.classList.remove('visible');
        overlay.classList.add('hidden');
        overlay.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');

        const bodyContainer = document.getElementById('modal-body');
        const footer = document.getElementById('modal-footer');
        bodyContainer.innerHTML = '';
        footer.innerHTML = '';
        footer.classList.add('hidden');
      }

      function handleError(error) {
        alert(`Erro ao carregar dados: ${error.message || error}`);
        console.error(error);
      }
    </script>
  </body>
</html>
