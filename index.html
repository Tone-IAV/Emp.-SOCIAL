<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <title>Emp. Social</title>
    <style>
      :root {
        color-scheme: light;
        --primary: #005a9c;
        --primary-dark: #004270;
        --background: #f4f6f8;
        --surface: #ffffff;
        --text: #2c3e50;
        --muted: #7f8c8d;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--background);
        color: var(--text);
      }

      header.site-header {
        background: var(--primary);
        color: #fff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .nav-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .brand {
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: 0.03em;
        padding: 18px 0;
      }

      nav ul {
        list-style: none;
        display: flex;
        gap: 16px;
        margin: 0;
        padding: 0;
      }

      nav a {
        color: #fff;
        text-decoration: none;
        font-weight: 500;
        padding: 12px 16px;
        border-radius: 6px;
        transition: background 0.2s ease-in-out;
      }

      nav a:hover,
      nav a.active {
        background: var(--primary-dark);
      }

      main {
        max-width: 1200px;
        margin: 32px auto;
        padding: 0 24px 48px;
      }

      .card {
        background: var(--surface);
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 32px;
      }

      .card-title {
        font-size: 1.4rem;
        font-weight: 600;
        padding: 24px 24px 0;
      }

      .card-subtitle {
        color: var(--muted);
        padding: 0 24px 16px;
        margin-top: 4px;
      }

      .toolbar {
        display: flex;
        justify-content: flex-end;
        padding: 0 24px 16px;
        gap: 8px;
      }

      button {
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 10px 18px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: background 0.2s ease-in-out;
      }

      button.secondary {
        background: transparent;
        color: var(--primary);
        border: 1px solid rgba(0, 90, 156, 0.3);
      }

      button:hover {
        background: var(--primary-dark);
      }

      button.secondary:hover {
        background: rgba(0, 90, 156, 0.08);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: rgba(0, 90, 156, 0.08);
      }

      th,
      td {
        text-align: left;
        padding: 12px 18px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      tbody tr:hover {
        background: rgba(0, 90, 156, 0.05);
      }

      .table-container {
        padding: 0 24px 24px;
        overflow-x: auto;
      }

      .hidden {
        display: none !important;
      }

      .loading {
        padding: 24px;
        text-align: center;
        color: var(--muted);
      }

      @media (max-width: 768px) {
        nav ul {
          flex-wrap: wrap;
          gap: 8px;
        }

        nav a {
          padding: 10px 12px;
        }

        th,
        td {
          padding: 10px 12px;
        }
      }
    </style>
  </head>
  <body>
    <? var initialView = currentView; ?>
    <header class="site-header">
      <div class="nav-container">
        <div class="brand">Emp. Social</div>
        <nav>
          <ul>
            <? views.forEach(function(view) { ?>
              <li>
                <a
                  href="?view=<?= view.id ?>"
                  data-view="<?= view.id ?>"
                  class="<?= view.id === initialView ? 'active' : '' ?>"
                ><?= view.label ?></a>
              </li>
            <? }); ?>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <? views.forEach(function(view) { ?>
        <section
          id="view-<?= view.id ?>"
          class="card view-section <?= view.id === initialView ? '' : 'hidden' ?>"
          data-view-section="<?= view.id ?>"
        >
          <?!= include(view.partial) ?>
        </section>
      <? }); ?>
    </main>

    <template id="table-template">
      <thead></thead>
      <tbody></tbody>
    </template>

    <script>
      const views = <?!= JSON.stringify(views) ?>;
      const defaultView = '<?= initialView ?>';

      document.addEventListener('DOMContentLoaded', () => {
        setupNavigation();
        navigateTo(defaultView, false);
      });

      function setupNavigation() {
        document.querySelectorAll('nav a[data-view]').forEach((link) => {
          link.addEventListener('click', (event) => {
            event.preventDefault();
            const view = link.dataset.view;
            navigateTo(view, true);
          });
        });

        window.addEventListener('popstate', () => {
          const view = new URL(window.location.href).searchParams.get('view') || defaultView;
          navigateTo(view, false);
        });
      }

      function navigateTo(view, pushState = true) {
        if (!views.some((item) => item.id === view)) {
          view = defaultView;
        }

        document.querySelectorAll('[data-view-section]').forEach((section) => {
          section.classList.toggle('hidden', section.dataset.viewSection !== view);
        });

        document.querySelectorAll('nav a[data-view]').forEach((link) => {
          link.classList.toggle('active', link.dataset.view === view);
        });

        if (pushState) {
          const url = new URL(window.location.href);
          url.searchParams.set('view', view);
          history.pushState({}, '', url);
        }

        loadTable(view);
      }

      function loadTable(view) {
        const loading = document.querySelector(`[data-loading="${view}"]`);
        const table = document.querySelector(`[data-table="${view}"]`);
        if (!loading || !table) return;

        loading.classList.remove('hidden');
        table.classList.add('hidden');
        table.innerHTML = '';

        const viewConfig = views.find((item) => item.id === view);
        if (!viewConfig) {
          loading.textContent = 'Visualização não configurada.';
          return;
        }

        const method = viewConfig.fetch;
        if (!method || typeof google.script.run[method] !== 'function') {
          console.warn(`Nenhum método de busca configurado para "${view}".`);
          loading.textContent = 'Não foi possível carregar os dados desta visualização.';
          return;
        }

        google.script.run
          .withSuccessHandler((data) => renderTable(view, data))
          .withFailureHandler(handleError)[method]();
      }

      function renderTable(view, data) {
        const loading = document.querySelector(`[data-loading="${view}"]`);
        const table = document.querySelector(`[data-table="${view}"]`);
        if (!loading || !table) return;

        loading.classList.add('hidden');
        table.classList.remove('hidden');

        const template = document.getElementById('table-template');
        const clone = template.content.cloneNode(true);
        const thead = clone.querySelector('thead');
        const tbody = clone.querySelector('tbody');

        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" style="padding: 24px; text-align: center; color: var(--muted);">Nenhum registro encontrado.</td></tr>`;
        } else {
          const columns = Object.keys(data[0]);
          const headerRow = document.createElement('tr');
          columns.forEach((column) => {
            const th = document.createElement('th');
            th.textContent = column;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          data.forEach((row) => {
            const tr = document.createElement('tr');
            columns.forEach((column) => {
              const td = document.createElement('td');
              td.textContent = row[column] || '';
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        }

        table.appendChild(thead);
        table.appendChild(tbody);
      }

      function openForm(view) {
        alert(`Funcionalidade de formulário para "${view}" ainda será implementada.`);
      }

      function handleError(error) {
        alert(`Erro ao carregar dados: ${error.message || error}`);
        console.error(error);
      }
    </script>
  </body>
</html>
