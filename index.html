<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Po√ßos Mission√°rios</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <script src="https://code.highcharts.com/maps/highmaps.js"></script>
  <script src="https://code.highcharts.com/maps/modules/map.js"></script>
  <script src="https://code.highcharts.com/gantt/highcharts-gantt.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; margin:0; background:linear-gradient(180deg,#cfe9ff 0%,#f9fbff 40%,#ffffff 100%); color:#1f2937; }
    nav { background:linear-gradient(90deg,#60a5fa 0%,#38bdf8 50%,#22d3ee 100%); color:#0f172a; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; padding:10px 20px; gap:12px; box-shadow:0 6px 16px rgba(14,116,144,0.25); }
    nav .title-wrapper { display:flex; align-items:center; gap:0.5rem; }
    nav .title { font-weight:700; font-size:1.2rem; color:#0f172a; text-shadow:0 1px 0 rgba(255,255,255,0.6); }
    nav button { background:rgba(255,255,255,0.6); border:none; color:#0f172a; font-weight:600; margin:0 8px; cursor:pointer; padding:6px 12px; border-radius:999px; transition:all .2s ease; box-shadow:0 4px 10px rgba(59,130,246,0.25); }
    nav button:hover { transform:translateY(-1px); background:rgba(255,255,255,0.85); }
    nav button.active { background:#0ea5e9; color:white; box-shadow:0 6px 14px rgba(14,165,233,0.35); }
    .info-button { width:28px; height:28px; border-radius:50%; border:1px solid rgba(14,165,233,0.6); color:#0f172a; background:#e0f2fe; font-weight:700; line-height:1; display:flex; align-items:center; justify-content:center; transition:all .2s ease; box-shadow:0 4px 10px rgba(14,165,233,0.25); }
    .info-button:hover { background:#bae6fd; transform:translateY(-1px); }
    main { padding:20px; }
    .section { display:none; animation:fadeIn .3s ease; }
    .section.active { display:block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
    .map-overlay { position:fixed; inset:0; background:rgba(191,219,254,0.6); display:flex; align-items:center; justify-content:center; padding:20px; z-index:50; opacity:0; pointer-events:none; transition:opacity .25s ease; }
    .map-overlay.visible { opacity:1; pointer-events:auto; }
    .map-modal { background:linear-gradient(180deg,#ffffff 0%,#e0f2fe 100%); border-radius:24px; max-width:900px; width:100%; padding:28px; box-shadow:0 24px 50px rgba(59,130,246,0.25); position:relative; display:flex; flex-direction:column; gap:16px; }
    .map-modal h3 { font-size:1.25rem; font-weight:700; color:#0369a1; margin:0; }
    .map-modal p { color:#0f172a; font-size:0.95rem; margin:0; }
    .map-close { position:absolute; top:16px; right:16px; border:none; background:#bae6fd; font-size:1.3rem; line-height:1; cursor:pointer; color:#0f172a; border-radius:999px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(14,165,233,0.25); transition:background .2s ease, transform .2s ease; }
    .map-close:hover { background:#7dd3fc; transform:translateY(-1px); }
    #mapaEstados { width:100%; height:420px; }
    .map-legend { font-size:0.85rem; color:#0f172a; background:rgba(191,219,254,0.8); border-radius:16px; padding:14px; box-shadow:0 8px 18px rgba(30,64,175,0.15); }
    .gamified-hub { margin:24px 20px 0; padding:28px; border-radius:28px; background:linear-gradient(180deg, rgba(191,219,254,0.65) 0%, rgba(255,255,255,0.96) 100%); box-shadow:0 28px 60px rgba(14,165,233,0.18); border:1px solid rgba(125,211,252,0.35); }
    .gamified-grid { display:grid; grid-template-columns:minmax(0,2fr) minmax(0,1fr); gap:28px; align-items:start; }
    @media (max-width: 1024px) { .gamified-grid { grid-template-columns:1fr; } }
    .gamified-hub__header { display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:16px; margin-bottom:24px; }
    .gamified-hub__title { font-size:1.4rem; font-weight:700; color:#0f172a; }
    .gamified-hub__subtitle { font-size:0.9rem; color:#475569; max-width:520px; }
    .hub-score-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:18px; margin-bottom:28px; }
    .score-card { display:block; background:rgba(255,255,255,0.96); border-radius:20px; padding:18px; box-shadow:0 20px 42px rgba(59,130,246,0.18); position:relative; overflow:hidden; cursor:pointer; border:1px solid rgba(14,165,233,0.16); transition:transform .2s ease, box-shadow .2s ease; }
    .score-card:hover { transform:translateY(-6px); box-shadow:0 26px 56px rgba(14,165,233,0.28); }
    .score-card__icon { width:42px; height:42px; border-radius:14px; background:linear-gradient(135deg, #38bdf8, #2563eb); display:flex; align-items:center; justify-content:center; color:white; font-size:1.35rem; margin-bottom:12px; box-shadow:0 12px 24px rgba(59,130,246,0.3); }
    .score-card__label { font-size:0.75rem; letter-spacing:0.08em; font-weight:600; color:#0369a1; text-transform:uppercase; }
    .score-card__value { font-size:1.9rem; font-weight:700; color:#0f172a; margin:6px 0; }
    .score-card__detail { font-size:0.82rem; color:#475569; }
    .journey-board { background:rgba(255,255,255,0.92); border-radius:26px; padding:24px; box-shadow:0 24px 48px rgba(15,23,42,0.12); border:1px solid rgba(226,232,240,0.8); }
    .journey-board__header { display:flex; flex-wrap:wrap; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:18px; }
    .journey-board__title { font-size:1.05rem; font-weight:700; color:#0f172a; }
    .journey-board__subtitle { font-size:0.82rem; color:#475569; max-width:480px; }
    .journey-track { position:relative; display:grid; grid-template-columns:repeat(auto-fit, minmax(190px, 1fr)); gap:22px; }
    .journey-track::before { content:""; position:absolute; top:50%; left:6%; right:6%; height:4px; background:linear-gradient(90deg, rgba(14,165,233,0.55), rgba(37,99,235,0.25)); z-index:0; }
    .stage-node { background:#ffffff; border-radius:24px; padding:18px; box-shadow:0 24px 40px rgba(59,130,246,0.18); border:1px solid rgba(191,219,254,0.8); position:relative; z-index:1; display:flex; flex-direction:column; gap:12px; min-height:210px; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease; }
    .stage-node:hover { transform:translateY(-6px); box-shadow:0 30px 56px rgba(14,165,233,0.3); }
    .stage-node::before { content:attr(data-order); position:absolute; top:16px; right:18px; font-size:0.85rem; font-weight:700; color:rgba(14,165,233,0.35); }
    .stage-node__status { font-size:0.75rem; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; color:#0ea5e9; }
    .stage-node__titulo { font-size:1.05rem; font-weight:700; color:#0f172a; }
    .stage-node__contagem { display:flex; align-items:baseline; gap:6px; font-size:1.6rem; font-weight:700; color:#1d4ed8; }
    .stage-node__contagem span { font-size:0.75rem; text-transform:uppercase; color:#475569; font-weight:600; letter-spacing:0.05em; }
    .stage-node__progress { background:rgba(191,219,254,0.6); height:8px; border-radius:999px; position:relative; overflow:hidden; }
    .stage-node__progress-bar { position:absolute; inset:0; width:var(--progress,0%); background:linear-gradient(90deg, #38bdf8, #2563eb); border-radius:999px; }
    .stage-node__percentual { font-size:0.78rem; color:#0f172a; font-weight:600; }
    .stage-node__lista { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }
    .stage-node__item { background:rgba(59,130,246,0.08); border-radius:16px; padding:10px 12px; display:flex; flex-direction:column; gap:4px; font-size:0.8rem; color:#334155; }
    .stage-node__item strong { font-size:0.86rem; color:#0f172a; }
    .stage-node__item span { font-size:0.76rem; color:#475569; }
    .stage-node__empty { font-size:0.78rem; color:#64748b; background:rgba(226,232,240,0.7); padding:12px; border-radius:14px; text-align:center; }
    .stage-node--alerta { border-color:rgba(248,113,113,0.45); box-shadow:0 30px 60px rgba(248,113,113,0.25); }
    .stage-node--alerta .stage-node__progress-bar { background:linear-gradient(90deg, #f97316, #ef4444); }
    .project-flow { margin-top:28px; background:rgba(255,255,255,0.94); border-radius:24px; padding:22px; box-shadow:0 24px 42px rgba(15,23,42,0.1); border:1px solid rgba(226,232,240,0.85); }
    .project-flow__title { font-size:1rem; font-weight:700; color:#0f172a; margin-bottom:12px; }
    .project-timeline { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:14px; }
    .project-timeline__item { position:relative; border-left:3px solid #38bdf8; padding-left:14px; background:rgba(59,130,246,0.06); border-radius:0 16px 16px 0; padding-top:8px; padding-bottom:8px; }
    .project-timeline__item::before { content:""; position:absolute; left:-7px; top:10px; width:12px; height:12px; border-radius:999px; background:#0ea5e9; box-shadow:0 0 0 4px rgba(14,165,233,0.2); }
    .project-timeline__item strong { font-size:0.86rem; color:#0f172a; }
    .project-timeline__meta { font-size:0.74rem; color:#475569; display:flex; flex-wrap:wrap; gap:10px; margin-top:4px; }
    .project-timeline__descricao { font-size:0.78rem; color:#334155; margin-top:6px; }
    .mission-sidebar { display:flex; flex-direction:column; gap:22px; }
    .mission-card { background:rgba(255,255,255,0.95); border-radius:24px; padding:20px; box-shadow:0 24px 44px rgba(15,23,42,0.12); border:1px solid rgba(226,232,240,0.9); }
    .mission-card__title { font-size:0.98rem; font-weight:700; color:#0f172a; display:flex; align-items:center; gap:8px; margin-bottom:14px; }
    .mission-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:14px; }
    .mission-list__item { background:rgba(14,165,233,0.12); border-radius:18px; padding:12px 14px; display:flex; flex-direction:column; gap:6px; font-size:0.82rem; color:#334155; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease; }
    .mission-list__item:hover { transform:translateY(-3px); box-shadow:0 18px 32px rgba(14,165,233,0.25); }
    .mission-list__item strong { font-size:0.9rem; color:#0f172a; }
    .mission-list__tag { font-size:0.72rem; text-transform:uppercase; font-weight:700; color:#0ea5e9; letter-spacing:0.08em; }
    .mission-list__acao { font-size:0.78rem; color:#334155; }
    .mission-card__empty { font-size:0.8rem; color:#64748b; text-align:center; padding:14px; background:rgba(226,232,240,0.65); border-radius:16px; }
    .impact-glance { display:grid; gap:12px; }
    .impact-pill { background:linear-gradient(135deg, rgba(14,165,233,0.16), rgba(59,130,246,0.2)); border-radius:18px; padding:14px; display:flex; flex-direction:column; gap:6px; font-size:0.84rem; color:#0f172a; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease; }
    .impact-pill:hover { transform:translateY(-3px); box-shadow:0 18px 32px rgba(37,99,235,0.25); }
    .impact-pill strong { font-size:1rem; font-weight:700; }
    .impact-pill span { font-size:0.78rem; color:#334155; }
    .donor-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:12px; }
    .donor-list__item { display:flex; justify-content:space-between; align-items:flex-start; gap:14px; background:rgba(15,23,42,0.04); border-radius:18px; padding:12px 14px; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease; }
    .donor-list__item:hover { transform:translateY(-3px); box-shadow:0 18px 32px rgba(15,23,42,0.18); }
    .donor-list__item strong { font-size:0.86rem; color:#0f172a; }
    .donor-list__item span { font-size:0.74rem; color:#475569; display:block; }
    .donor-list__value { text-align:right; display:flex; flex-direction:column; gap:4px; }
    .hub-empty { font-size:0.8rem; color:#64748b; text-align:center; padding:16px; background:rgba(226,232,240,0.6); border-radius:16px; }
    .score-card:focus-visible, .stage-node:focus-visible, .mission-list__item:focus-visible, .project-timeline__item:focus-visible, .impact-pill:focus-visible, .donor-list__item:focus-visible { outline:3px solid rgba(14,165,233,0.55); outline-offset:3px; }
    [data-detalhes] { cursor:pointer; }
    tr[data-detalhes]:hover, tr[data-detalhes]:focus-visible,
    li[data-detalhes]:hover, li[data-detalhes]:focus-visible,
    .timeline-item[data-detalhes]:hover, .timeline-item[data-detalhes]:focus-visible { background:rgba(14,165,233,0.12); }
    body.detail-open { overflow:hidden; }
    .detail-overlay { position:fixed; inset:0; background:rgba(15,23,42,0.55); display:flex; align-items:center; justify-content:center; padding:24px; z-index:120; opacity:0; pointer-events:none; transition:opacity .2s ease; }
    .detail-overlay.visible { opacity:1; pointer-events:auto; }
    .detail-modal { background:#ffffff; border-radius:24px; box-shadow:0 28px 60px rgba(15,23,42,0.25); width:min(720px, 100%); max-height:90vh; overflow:auto; padding:28px; display:flex; flex-direction:column; gap:18px; position:relative; }
    .detail-close { position:absolute; top:18px; right:18px; width:36px; height:36px; border:none; border-radius:999px; background:#e0f2fe; color:#0f172a; font-size:1.4rem; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 20px rgba(14,165,233,0.25); transition:transform .2s ease, background .2s ease; }
    .detail-close:hover { background:#bae6fd; transform:translateY(-2px); }
    .detail-title { font-size:1.3rem; font-weight:700; color:#0f172a; margin:0; }
    .detail-subtitle { font-size:0.95rem; color:#0369a1; margin:0; }
    .detail-description { font-size:0.9rem; color:#475569; margin:0; }
    .detail-list { margin:0; display:flex; flex-direction:column; gap:12px; }
    .detail-row { display:grid; grid-template-columns:160px 1fr; gap:12px; padding:12px 14px; border-radius:16px; background:rgba(226,232,240,0.55); }
    .detail-term { font-size:0.8rem; font-weight:600; color:#1d4ed8; text-transform:uppercase; letter-spacing:0.06em; }
    .detail-value { font-size:0.92rem; color:#0f172a; line-height:1.4; }
    .detail-actions { display:flex; justify-content:flex-end; gap:12px; margin-top:4px; }
    .detail-action-button {
      background:linear-gradient(90deg,#38bdf8,#2563eb);
      color:#ffffff;
      border:none;
      border-radius:999px;
      padding:10px 18px;
      font-weight:600;
      font-size:0.9rem;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(37,99,235,0.25);
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .detail-action-button:hover { transform:translateY(-2px); box-shadow:0 14px 32px rgba(37,99,235,0.3); }
    @media (max-width: 640px) {
      .detail-row { grid-template-columns:1fr; }
      .detail-term { font-size:0.75rem; }
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.Highcharts) {
        Highcharts.setOptions({
          lang: {
            decimalPoint: ',',
            thousandsSep: '.',
            downloadPNG: 'Baixar PNG',
            downloadJPEG: 'Baixar JPEG',
            downloadPDF: 'Baixar PDF',
            downloadSVG: 'Baixar SVG'
          },
          chart: {
            style: { fontFamily: 'Inter, sans-serif' },
            backgroundColor: 'transparent'
          },
          title: { style: { fontWeight: '600' } },
          colors: ['#1d4ed8', '#38bdf8', '#2563eb', '#0ea5e9', '#3b82f6', '#0284c7']
        });
      }
    });
  </script>
  <script>
    window.formatarNumero = function(valor, casasDecimais = 0) {
      const numero = Number(valor || 0);
      return numero.toLocaleString('pt-BR', {
        minimumFractionDigits: casasDecimais,
        maximumFractionDigits: casasDecimais
      });
    };

    window.formatarMoeda = function(valor) {
      return Number(valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };

    window.escapeHtml = function(texto = '') {
      return String(texto)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };
  </script>
  <script>
    window.criarAtributoDetalhes = function(config = {}) {
      const normalizar = (valor) => {
        if (valor === null || valor === undefined) return '';
        if (Array.isArray(valor)) return valor.join(', ');
        return String(valor);
      };

      try {
        const payload = {
          titulo: normalizar(config.titulo || 'Detalhes'),
          subtitulo: normalizar(config.subtitulo || ''),
          descricao: normalizar(config.descricao || ''),
          campos: Array.isArray(config.campos)
            ? config.campos.map(campo => ({
                label: normalizar(campo && campo.label),
                valor: normalizar(campo && campo.valor)
              }))
            : []
        };
        if (config.acao && typeof config.acao === 'object') {
          payload.acao = {
            label: normalizar(config.acao.label || ''),
            destino: normalizar(config.acao.destino || ''),
            descricao: normalizar(config.acao.descricao || '')
          };
        }
        const encoded = encodeURIComponent(JSON.stringify(payload));
        return `data-detalhes="${encoded}"`;
      } catch (erro) {
        console.error('N√£o foi poss√≠vel preparar os detalhes do item.', erro);
        return '';
      }
    };

    window.definirDetalhesElemento = function(elemento, config = {}) {
      if (!elemento) return;
      const atributo = window.criarAtributoDetalhes(config);
      if (!atributo) return;
      const match = atributo.match(/data-detalhes="([^"]*)"/);
      if (!match || match.length < 2) return;
      elemento.setAttribute('data-detalhes', match[1]);
      if (!elemento.hasAttribute('tabindex')) {
        elemento.setAttribute('tabindex', '0');
      }
      if (!elemento.hasAttribute('role')) {
        elemento.setAttribute('role', 'button');
      }
    };
  </script>
</head>

<body>
  <!-- NAVBAR -->
  <nav>
    <div class="title-wrapper">
      <span class="title">üíß Po√ßos Mission√°rios</span>
      <button id="btnInfoMapa" class="info-button" title="Ver orienta√ß√£o anal√≠tica">i</button>
    </div>
    <div class="flex flex-wrap gap-2">
      <button class="nav-item active" data-target="dashboard">Dashboard</button>
      <button class="nav-item" data-target="gestao">Gest√£o √† vista</button>
      <button class="nav-item" data-target="impacto">Impacto</button>
      <button class="nav-item" data-target="pocos">Po√ßos</button>
      <button class="nav-item" data-target="kanban">Kanban</button>
    </div>
  </nav>

  <div id="painelMapa" class="map-overlay">
    <div class="map-modal">
      <button class="map-close" type="button" aria-label="Fechar mapa">√ó</button>
      <div>
        <h3>Vis√£o geogr√°fica para decis√£o r√°pida</h3>
        <p>Observe onde est√£o os po√ßos monitorados, os benefici√°rios alcan√ßados e quais estados demandam refor√ßo de investimento. Utilize esta leitura antes das reuni√µes executivas ou com doadores.</p>
      </div>
      <div id="mapaEstados"></div>
      <div class="map-legend">
        <strong>Como interpretar:</strong> selecione um estado no mapa para visualizar o total de po√ßos ativos e a quantidade de benefici√°rios atendidos. Foque nos estados com menor intensidade para direcionar recursos e mobiliza√ß√£o.
      </div>
    </div>
  </div>

  <section class="gamified-hub" aria-labelledby="tituloHubGamificado">
    <div class="gamified-grid">
      <div>
        <header class="gamified-hub__header">
          <div>
            <h1 id="tituloHubGamificado" class="gamified-hub__title">Mapa vivo da miss√£o üí†</h1>
            <p class="gamified-hub__subtitle">Navegue como um jogo: acompanhe a jornada dos po√ßos, organize projetos colaborativos e mantenha as miss√µes registradas com precis√£o na base de dados.</p>
          </div>
          <button type="button" class="px-4 py-2 rounded-full bg-sky-500 text-white font-semibold shadow" data-navegacao="dashboard">Abrir painel anal√≠tico</button>
        </header>

        <div id="hubScoreCards" class="hub-score-grid">
          <div class="hub-empty">Carregando m√©tricas da miss√£o...</div>
        </div>

        <div class="journey-board">
          <div class="journey-board__header">
            <div>
              <h2 class="journey-board__title">Trilha dos po√ßos</h2>
              <p class="journey-board__subtitle">Cada etapa representa um checkpoint cr√≠tico. Clique para mergulhar na gest√£o detalhada e atualizar dados diretamente na base.</p>
            </div>
            <button type="button" class="px-3 py-2 rounded-full bg-white border border-sky-200 text-sky-700 text-sm font-semibold shadow-sm" data-navegacao="pocos">Cadastrar ou atualizar po√ßo</button>
          </div>
          <div id="journeyTrack" class="journey-track">
            <div class="hub-empty">Mapeando est√°gios dos po√ßos...</div>
          </div>
        </div>

        <div class="project-flow">
          <div class="project-flow__title">Cronograma vivo dos projetos</div>
          <ul id="projectTimeline" class="project-timeline">
            <li class="mission-card__empty">Carregando etapas do cronograma...</li>
          </ul>
        </div>
      </div>

      <aside class="mission-sidebar">
        <div class="mission-card">
          <div class="mission-card__title">‚ö° Miss√µes priorit√°rias</div>
          <ul id="missionList" class="mission-list">
            <li class="mission-card__empty">Buscando alertas cr√≠ticos...</li>
          </ul>
        </div>

        <div class="mission-card">
          <div class="mission-card__title">üéØ Impacto imediato</div>
          <div id="impactGlance" class="impact-glance">
            <div class="hub-empty">Calculando impacto gerado...</div>
          </div>
        </div>

        <div class="mission-card">
          <div class="mission-card__title">ü§ù Aliados em campo</div>
          <ul id="donorRanking" class="donor-list">
            <li class="mission-card__empty">Conectando com os doadores em destaque...</li>
          </ul>
        </div>
      </aside>
    </div>
  </section>

  <!-- √ÅREA PRINCIPAL -->
  <main>
    <div id="dashboard" class="section active"><?!= include('Dashboard'); ?></div>
    <div id="gestao" class="section"><?!= include('Gestao'); ?></div>
    <div id="impacto" class="section"><?!= include('Impacto'); ?></div>
    <div id="pocos" class="section"><?!= include('Pocos'); ?></div>
    <div id="kanban" class="section"><?!= include('Kanban'); ?></div>
  </main>

  <div id="detalhesOverlay" class="detail-overlay" aria-hidden="true" role="dialog">
    <div class="detail-modal" role="document">
      <button type="button" class="detail-close" id="btnFecharDetalhes" aria-label="Fechar detalhes">&times;</button>
      <div class="space-y-2">
        <h3 class="detail-title" id="detalheTitulo"></h3>
        <p class="detail-subtitle" id="detalheSubtitulo"></p>
      </div>
      <p class="detail-description" id="detalheDescricao"></p>
      <dl class="detail-list" id="detalheConteudo"></dl>
      <div class="detail-actions" id="detalheAcoes" style="display:none;"></div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="text-center text-gray-500 py-4 mt-6 text-sm">
    ¬© 2025 Projeto Po√ßos Mission√°rios ‚Äî Sistema desenvolvido em Google Apps Script
  </footer>

  <script>
    (function() {
      const scoreContainer = document.getElementById('hubScoreCards');
      const trackContainer = document.getElementById('journeyTrack');
      const missionContainer = document.getElementById('missionList');
      const projectContainer = document.getElementById('projectTimeline');
      const impactContainer = document.getElementById('impactGlance');
      const donorContainer = document.getElementById('donorRanking');
      const { escapeHtml, formatarNumero, formatarMoeda, criarAtributoDetalhes } = window;

      const placeholder = (element, mensagem) => {
        if (!element) return;
        element.innerHTML = `<div class="hub-empty">${escapeHtml(mensagem)}</div>`;
      };

      const formatarPercentual = valor => `${Math.round(Number(valor) || 0)}%`;
      const formatarDataCurta = valor => {
        if (!valor) return 'Sem data';
        const data = new Date(valor);
        if (isNaN(data.getTime())) return 'Sem data';
        return data.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
      };

      const createScoreCard = (icon, titulo, valor, detalhe, destino) => {
        const detalheAttr = criarAtributoDetalhes({
          titulo,
          subtitulo: detalhe || '',
          campos: [
            { label: 'Valor atual', valor: valor },
            { label: 'Contexto', valor: detalhe || 'Sem detalhes adicionais.' }
          ],
          acao: destino ? { label: 'Abrir guia relacionada', destino } : undefined
        });
        return `
          <article class="score-card" ${detalheAttr} role="button" tabindex="0">
            <div class="score-card__icon">${icon}</div>
            <span class="score-card__label">${escapeHtml(titulo)}</span>
            <div class="score-card__value">${escapeHtml(String(valor))}</div>
            <p class="score-card__detail">${escapeHtml(String(detalhe))}</p>
          </article>
        `;
      };

      const render = (dados) => {
        if (!dados) {
          placeholder(scoreContainer, 'N√£o foi poss√≠vel carregar as m√©tricas.');
          placeholder(trackContainer, 'N√£o foi poss√≠vel carregar o pipeline.');
          placeholder(missionContainer, 'N√£o foi poss√≠vel carregar as miss√µes priorit√°rias.');
          placeholder(projectContainer, 'N√£o foi poss√≠vel carregar o cronograma.');
          placeholder(impactContainer, 'Sem dados de impacto dispon√≠veis.');
          placeholder(donorContainer, 'Sem doadores destacados no momento.');
          return;
        }

        const resumo = dados.resumo || {};
        const etapas = Array.isArray(dados.etapas) ? dados.etapas : [];
        const missoes = Array.isArray(dados.missoes) ? dados.missoes : [];
        const projetos = Array.isArray(dados.projetos) ? dados.projetos : [];
        const impacto = dados.impacto || {};
        const doadores = Array.isArray(dados.rankingDoadores) ? dados.rankingDoadores : [];

        if (scoreContainer) {
          scoreContainer.innerHTML = [
            createScoreCard('üéØ', 'Po√ßos monitorados', formatarNumero(resumo.totalPocos || 0), `${formatarNumero(resumo.concluidos || 0)} conclu√≠dos`, 'dashboard'),
            createScoreCard('üöÄ', 'Miss√µes em campo', formatarNumero(resumo.emExecucao || 0), `${formatarNumero(resumo.planejados || 0)} em prepara√ß√£o`, 'gestao'),
            createScoreCard('üë•', 'Benefici√°rios alcan√ßados', formatarNumero(resumo.beneficiarios || 0), `Custo m√©dio ${formatarMoeda(resumo.custoPorPessoa || 0)}/pessoa`, 'impacto'),
            createScoreCard('üí∞', 'Investimento realizado', formatarMoeda(resumo.investimentoRealizado || 0), `Gap ${formatarMoeda(resumo.gapFinanceiro || 0)}`, 'gestao'),
            createScoreCard('ü§ù', 'Doadores ativos', formatarNumero(resumo.doadoresAtivos || 0), 'Rede colaborativa atualizada', 'impacto')
          ].join('');
        }

        if (trackContainer) {
          if (!etapas.length) {
            placeholder(trackContainer, 'Cadastre um po√ßo para ativar a trilha do jogo.');
          } else {
            trackContainer.innerHTML = etapas.map(etapa => {
              const totalFormatado = formatarNumero(etapa.total || 0);
              const safePercent = Math.min(Math.max(Number(etapa.percentual) || 0, 0), 100);
              const destaques = Array.isArray(etapa.destaques) && etapa.destaques.length
                ? etapa.destaques.map(item => `
                    <li class="stage-node__item">
                      <strong>${escapeHtml(item.nome || 'Sem identifica√ß√£o')}</strong>
                      <span>${escapeHtml(item.local || 'Sem local informado')}</span>
                      ${item.responsavel ? `<span>Respons√°vel: ${escapeHtml(item.responsavel)}</span>` : ''}
                      ${item.gapFinanceiro > 0 ? `<span>Gap: <b>${formatarMoeda(item.gapFinanceiro)}</b></span>` : ''}
                      ${item.diasSemContato > 0 ? `<span>${escapeHtml(`${item.diasSemContato} dias sem contato`)}</span>` : ''}
                      ${item.proximaAcao ? `<span>Pr√≥ximo passo: ${escapeHtml(item.proximaAcao)}</span>` : ''}
                    </li>
                  `).join('')
                : '<li class="stage-node__empty">Nenhuma pend√™ncia cr√≠tica nesta etapa.</li>';
              const ariaLabel = `${totalFormatado} po√ßos em ${etapa.titulo}`;
              return `
                <article class="stage-node ${etapa.alerta ? 'stage-node--alerta' : ''}" data-order="${escapeHtml(String(etapa.ordem || ''))}" data-navegacao="pocos" role="button" tabindex="0" aria-label="${escapeHtml(ariaLabel)}">
                  <div>
                    <div class="stage-node__status">${escapeHtml(etapa.status)}</div>
                    <div class="stage-node__titulo">${escapeHtml(etapa.titulo)}</div>
                  </div>
                  <div class="stage-node__contagem">${escapeHtml(totalFormatado)} <span>po√ßos</span></div>
                  <div class="stage-node__progress" aria-hidden="true"><span class="stage-node__progress-bar" style="--progress:${safePercent}%;"></span></div>
                  <div class="stage-node__percentual">${escapeHtml(formatarPercentual(etapa.percentual || 0))} do pipeline</div>
                  <ul class="stage-node__lista">${destaques}</ul>
                </article>
              `;
            }).join('');
          }
        }

        if (missionContainer) {
          if (!missoes.length) {
            missionContainer.innerHTML = '<li class="mission-card__empty">Sem alertas cr√≠ticos. Continue monitorando o campo!</li>';
          } else {
            missionContainer.innerHTML = missoes.map(item => {
              const detalheAttr = criarAtributoDetalhes({
                titulo: item.titulo || 'Miss√£o priorit√°ria',
                subtitulo: item.motivo || 'A√ß√£o necess√°ria',
                campos: [
                  { label: 'Respons√°vel', valor: item.responsavel || 'N√£o informado' },
                  { label: 'Pr√≥xima a√ß√£o', valor: item.proximaAcao || 'N√£o definida' },
                  { label: 'Status', valor: item.status || 'Sem status' }
                ],
                acao: { label: 'Abrir gest√£o', destino: 'gestao' }
              });
              return `
              <li class="mission-list__item" ${detalheAttr} role="button" tabindex="0">
                <span class="mission-list__tag">Prioridade</span>
                <strong>${escapeHtml(item.titulo || 'Miss√£o')}</strong>
                <span class="mission-list__acao">${escapeHtml(item.motivo || 'A√ß√£o necess√°ria')}</span>
                ${item.responsavel ? `<span class="mission-list__acao">Respons√°vel: ${escapeHtml(item.responsavel)}</span>` : ''}
                ${item.proximaAcao ? `<span class="mission-list__acao">Pr√≥ximo passo: ${escapeHtml(item.proximaAcao)}</span>` : ''}
              </li>`;
            }).join('');
          }
        }

        if (projectContainer) {
          if (!projetos.length) {
            projectContainer.innerHTML = '<li class="mission-card__empty">Nenhuma etapa de projeto registrada ainda.</li>';
          } else {
            projectContainer.innerHTML = projetos.map(item => {
              const detalheAttr = criarAtributoDetalhes({
                titulo: item.poco || 'Projeto',
                subtitulo: `${item.etapa || 'Etapa n√£o informada'} ‚Ä¢ ${formatarDataCurta(item.data)}`,
                descricao: item.descricao || '',
                campos: [
                  { label: 'Status', valor: item.status || 'Sem status' },
                  { label: 'Respons√°vel', valor: item.responsavel || 'N√£o informado' },
                  { label: 'Pr√≥xima a√ß√£o', valor: item.proximaAcao || 'N√£o definida' }
                ],
                acao: { label: 'Abrir gest√£o', destino: 'gestao' }
              });
              return `
              <li class="project-timeline__item" ${detalheAttr} role="button" tabindex="0">
                <strong>${escapeHtml(item.poco || 'Projeto')}</strong>
                <div class="project-timeline__meta">
                  <span>${escapeHtml(item.etapa || '-')}</span>
                  <span>${escapeHtml(formatarDataCurta(item.data))}</span>
                  ${item.status ? `<span>${escapeHtml(item.status)}</span>` : ''}
                </div>
                ${item.descricao ? `<div class="project-timeline__descricao">${escapeHtml(item.descricao)}</div>` : ''}
              </li>`;
            }).join('');
          }
        }

        if (impactContainer) {
          const cards = [
            { label: 'Fam√≠lias estimadas atendidas', valor: formatarNumero(impacto.familiasEstimadas || 0), descricao: 'Estimativa com base em 4 pessoas por fam√≠lia.' },
            { label: 'Volume di√°rio de √°gua', valor: `${formatarNumero(impacto.volumeAguaDiario || 0)} L/dia`, descricao: 'Capacidade total somada dos po√ßos ativos.' },
            { label: 'Investimento previsto', valor: formatarMoeda(impacto.investimentoPrevisto || 0), descricao: 'Planejamento financeiro aprovado para o ciclo atual.' },
            { label: 'Investimento realizado', valor: formatarMoeda(impacto.investimentoRealizado || 0), descricao: 'Recursos j√° aplicados em campo.' }
          ];
          impactContainer.innerHTML = cards.map(card => {
            const detalheAttr = criarAtributoDetalhes({
              titulo: card.label,
              subtitulo: card.valor,
              descricao: card.descricao,
              campos: [
                { label: 'Indicador', valor: card.label },
                { label: 'Valor atual', valor: card.valor },
                { label: 'Descri√ß√£o', valor: card.descricao }
              ],
              acao: { label: 'Abrir guia Impacto', destino: 'impacto' }
            });
            return `
            <div class="impact-pill" ${detalheAttr} role="button" tabindex="0">
              <strong>${escapeHtml(String(card.valor))}</strong>
              <span>${escapeHtml(card.label)}</span>
            </div>`;
          }).join('');
        }

        if (donorContainer) {
          if (!doadores.length) {
            donorContainer.innerHTML = '<li class="mission-card__empty">Traga novos aliados para acelerar as miss√µes.</li>';
          } else {
            donorContainer.innerHTML = doadores.map(item => {
              const detalheAttr = criarAtributoDetalhes({
                titulo: item.nome || 'Aliado',
                subtitulo: `Contribui√ß√£o ${formatarMoeda(item.valor || 0)}`,
                campos: [
                  { label: 'Po√ßos apoiados', valor: formatarNumero(item.pocos || 0) },
                  { label: 'Benefici√°rios impactados', valor: formatarNumero(item.beneficiarios || 0) },
                  { label: 'Contato', valor: item.contato || 'N√£o informado' }
                ],
                acao: { label: 'Abrir guia Impacto', destino: 'impacto' }
              });
              return `
              <li class="donor-list__item" ${detalheAttr} role="button" tabindex="0">
                <div>
                  <strong>${escapeHtml(item.nome || 'Aliado')}</strong>
                  <span>${escapeHtml(`${formatarNumero(item.pocos || 0)} po√ßos apoiados`)}</span>
                </div>
                <div class="donor-list__value">
                  <span>${escapeHtml(formatarMoeda(item.valor || 0))}</span>
                  <span>${escapeHtml(`${formatarNumero(item.beneficiarios || 0)} benefici√°rios`)}</span>
                </div>
              </li>`;
            }).join('');
          }
        }
      };

      const inicializar = () => {
        if (window.google && google.script && google.script.run && google.script.run.withSuccessHandler) {
          google.script.run.withSuccessHandler(render).obterVisaoGamificada();
        } else {
          render(null);
        }
      };

      inicializar();
    })();
  </script>

  <!-- SCRIPT DE NAVEGA√á√ÉO -->
  <script>
    const setActiveSection = (target) => {
      const secaoDestino = document.getElementById(target);
      if (!secaoDestino) {
        console.error(`Se√ß√£o "${target}" n√£o encontrada. Verifique se o include correspondente est√° dispon√≠vel.`);
        return false;
      }

      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      secaoDestino.classList.add('active');

      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      const botaoDestino = document.querySelector(`.nav-item[data-target="${target}"]`);
      if (botaoDestino) {
        botaoDestino.classList.add('active');
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
      return true;
    };

    document.querySelectorAll('.nav-item').forEach(btn => {
      btn.addEventListener('click', () => {
        setActiveSection(btn.dataset.target);
      });
    });

    window.navegarPara = (target) => {
      if (!setActiveSection(target)) {
        setActiveSection('dashboard');
      }
    };

    document.addEventListener('click', (evento) => {
      const alvo = evento.target.closest('[data-navegacao]');
      if (!alvo) return;
      if (evento.target.closest('[data-detalhes]')) {
        return;
      }
      const destino = alvo.getAttribute('data-navegacao');
      if (!destino) return;
      evento.preventDefault();
      window.navegarPara(destino);
    });

    document.addEventListener('keydown', (evento) => {
      const alvo = evento.target.closest('[data-navegacao]');
      if (!alvo) return;
      if (evento.target.closest('[data-detalhes]')) {
        return;
      }
      if (evento.key === 'Enter' || evento.key === ' ') {
        evento.preventDefault();
        const destino = alvo.getAttribute('data-navegacao');
        if (destino) {
          window.navegarPara(destino);
        }
      }
    });

    const overlay = document.getElementById('painelMapa');
    const btnInfo = document.getElementById('btnInfoMapa');
    const fechar = overlay ? overlay.querySelector('.map-close') : null;

    const fecharOverlay = () => {
      if (overlay) {
        overlay.classList.remove('visible');
      }
    };

    if (!overlay || !btnInfo || !fechar) {
      console.warn('Painel do mapa n√£o foi inicializado corretamente. Verifique se os elementos necess√°rios est√£o presentes.');
    } else {
      btnInfo.addEventListener('click', () => {
        overlay.classList.add('visible');
        if (typeof window.renderMapaDistribuicao === 'function') {
          window.renderMapaDistribuicao('mapaEstados');
        } else {
          console.warn('Fun√ß√£o "renderMapaDistribuicao" n√£o encontrada. Certifique-se de carreg√°-la antes de abrir o painel.');
        }
      });

      fechar.addEventListener('click', fecharOverlay);

      overlay.addEventListener('click', evt => {
        if (evt.target === overlay) fecharOverlay();
      });

      document.addEventListener('keydown', evt => {
        if (evt.key === 'Escape' && overlay.classList.contains('visible')) {
          fecharOverlay();
        }
      });
    }
  </script>
  <script>
    (function() {
      const overlay = document.getElementById('detalhesOverlay');
      if (!overlay) return;

      const tituloEl = document.getElementById('detalheTitulo');
      const subtituloEl = document.getElementById('detalheSubtitulo');
      const descricaoEl = document.getElementById('detalheDescricao');
      const conteudoEl = document.getElementById('detalheConteudo');
      const acoesEl = document.getElementById('detalheAcoes');
      const fecharBtn = document.getElementById('btnFecharDetalhes');
      const { escapeHtml } = window;
      let ultimoFoco = null;

      const setTexto = (elemento, valor) => {
        if (!elemento) return;
        if (valor) {
          elemento.innerHTML = escapeHtml(valor);
          elemento.style.display = '';
        } else {
          elemento.innerHTML = '';
          elemento.style.display = 'none';
        }
      };

      const formatarValor = (valor) => {
        const texto = escapeHtml(valor || '');
        return texto.replace(/\n/g, '<br>');
      };

      const fecharDetalhes = () => {
        overlay.classList.remove('visible');
        overlay.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('detail-open');
        if (ultimoFoco && typeof ultimoFoco.focus === 'function') {
          ultimoFoco.focus();
        }
      };

      const abrirDetalhes = (dados) => {
        if (!dados) return;
        ultimoFoco = document.activeElement instanceof HTMLElement ? document.activeElement : null;
        setTexto(tituloEl, dados.titulo || 'Detalhes do item');
        setTexto(subtituloEl, dados.subtitulo || '');
        setTexto(descricaoEl, dados.descricao || '');

        const campos = Array.isArray(dados.campos) ? dados.campos : [];
        if (!campos.length) {
          conteudoEl.innerHTML = `
            <div class="detail-row">
              <dt class="detail-term">Informa√ß√µes</dt>
              <dd class="detail-value">Sem dados adicionais dispon√≠veis.</dd>
            </div>`;
        } else {
          conteudoEl.innerHTML = campos.map(campo => `
            <div class="detail-row">
              <dt class="detail-term">${escapeHtml(campo.label || '')}</dt>
              <dd class="detail-value">${formatarValor(campo.valor || '')}</dd>
            </div>
          `).join('');
        }

        if (acoesEl) {
          acoesEl.innerHTML = '';
          acoesEl.style.display = 'none';
          const acao = dados.acao;
          if (acao && acao.destino) {
            const botao = document.createElement('button');
            botao.type = 'button';
            botao.className = 'detail-action-button';
            botao.textContent = acao.label || 'Abrir guia relacionada';
            botao.addEventListener('click', () => {
              fecharDetalhes();
              if (typeof window.navegarPara === 'function') {
                window.navegarPara(acao.destino);
              }
            });
            acoesEl.appendChild(botao);
            acoesEl.style.display = 'flex';
          }
        }

        overlay.classList.add('visible');
        overlay.setAttribute('aria-hidden', 'false');
        document.body.classList.add('detail-open');
        if (fecharBtn && typeof fecharBtn.focus === 'function') {
          fecharBtn.focus();
        }
      };

      const obterDetalhes = (elemento) => {
        if (!elemento) return null;
        const bruto = elemento.getAttribute('data-detalhes');
        if (!bruto) return null;
        try {
          return JSON.parse(decodeURIComponent(bruto));
        } catch (erro) {
          console.error('N√£o foi poss√≠vel abrir os detalhes do item selecionado.', erro);
          return null;
        }
      };

      document.addEventListener('click', (evento) => {
        const alvo = evento.target.closest('[data-detalhes]');
        if (!alvo) return;
        const dados = obterDetalhes(alvo);
        if (!dados) return;
        evento.preventDefault();
        abrirDetalhes(dados);
      });

      document.addEventListener('keydown', (evento) => {
        const alvo = evento.target.closest('[data-detalhes]');
        if (!alvo) return;
        if (evento.key === 'Enter' || evento.key === ' ') {
          const dados = obterDetalhes(alvo);
          if (!dados) return;
          evento.preventDefault();
          abrirDetalhes(dados);
        }
      });

      if (fecharBtn) {
        fecharBtn.addEventListener('click', (evt) => {
          evt.preventDefault();
          fecharDetalhes();
        });
      }

      overlay.addEventListener('click', (evento) => {
        if (evento.target === overlay) {
          fecharDetalhes();
        }
      });

      document.addEventListener('keydown', (evento) => {
        if (evento.key === 'Escape' && overlay.classList.contains('visible')) {
          fecharDetalhes();
        }
      });

      window.fecharDetalhesItem = fecharDetalhes;
    })();
  </script>
</body>
</html>
