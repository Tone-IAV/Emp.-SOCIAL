<div class="detalhes-wrapper">
  <header class="detalhes-header">
    <div>
      <h2 class="detalhes-title">üîç Painel vivo de detalhes</h2>
      <p class="detalhes-subtitle">Investigue miss√µes, projetos sociais e aliados financeiros com tudo que foi cadastrado.</p>
    </div>
    <div class="detalhes-controls">
      <div class="detalhes-filtros" role="tablist" aria-label="Tipos de cadastro">
        <button type="button" class="detalhes-filtro ativo" data-categoria="pocos" role="tab" aria-selected="true">Perfura√ß√£o de po√ßos</button>
        <button type="button" class="detalhes-filtro" data-categoria="projetos" role="tab" aria-selected="false">Projetos sociais</button>
        <button type="button" class="detalhes-filtro" data-categoria="doadores" role="tab" aria-selected="false">Rede de doadores</button>
      </div>
      <div class="detalhes-search">
        <span class="material-icons" aria-hidden="true">search</span>
        <input type="search" id="detalhesBusca" placeholder="Buscar por nome, local ou status" aria-label="Buscar item" />
      </div>
    </div>
  </header>

  <section class="detalhes-resumo" id="detalhesResumo" aria-live="polite"></section>

  <div class="detalhes-grid">
    <aside class="detalhes-lista" aria-label="Itens cadastrados">
      <div id="detalhesLista" class="detalhes-lista__conteudo"></div>
      <div id="detalhesListaVazia" class="detalhes-lista__vazio">Nenhum registro encontrado para o filtro atual.</div>
    </aside>

    <section class="detalhes-painel" aria-live="polite" aria-busy="false">
      <div id="detalhesPlaceholder" class="detalhes-placeholder">
        <span class="material-icons" aria-hidden="true">dashboard_customize</span>
        <p>Selecione um item para ver imagens, documentos, cronograma e contatos vinculados.</p>
      </div>
      <article id="detalhesPainel" class="detalhes-card" hidden>
        <header class="detalhes-card__header">
          <div>
            <div class="detalhes-status" id="detalhesStatus"></div>
            <h3 id="detalhesTitulo"></h3>
            <p id="detalhesSubtitulo"></p>
          </div>
          <div class="detalhes-ctas">
            <button type="button" id="detalhesEditar" class="detalhes-cta" hidden>Editar</button>
            <button type="button" id="detalhesAbrirGuia" class="detalhes-cta secundario" hidden>Abrir guia relacionada</button>
          </div>
        </header>
        <p id="detalhesResumoTexto" class="detalhes-card__resumo"></p>
        <div id="detalhesChips" class="detalhes-chips"></div>

        <div id="detalhesMetricas" class="detalhes-metricas"></div>
        <dl id="detalhesCampos" class="detalhes-campos"></dl>

        <section class="detalhes-secao" aria-labelledby="detalhesDoadoresTitulo" hidden>
          <div class="detalhes-secao__header">
            <h4 id="detalhesDoadoresTitulo">Rede de apoio</h4>
            <span class="detalhes-secao__meta" id="detalhesDoadoresMeta"></span>
          </div>
          <ul id="detalhesDoadores" class="detalhes-lista-detalhe"></ul>
        </section>

        <section class="detalhes-secao" aria-labelledby="detalhesEvidenciasTitulo" hidden>
          <div class="detalhes-secao__header">
            <h4 id="detalhesEvidenciasTitulo">Galeria e anexos</h4>
            <span class="detalhes-secao__meta" id="detalhesEvidenciasMeta"></span>
          </div>
          <div id="detalhesEvidencias" class="detalhes-galeria"></div>
        </section>

        <section class="detalhes-secao" aria-labelledby="detalhesDocumentosTitulo" hidden>
          <div class="detalhes-secao__header">
            <h4 id="detalhesDocumentosTitulo">Documentos oficiais</h4>
          </div>
          <ul id="detalhesDocumentos" class="detalhes-lista-detalhe"></ul>
        </section>

        <section class="detalhes-secao" aria-labelledby="detalhesContatosTitulo" hidden>
          <div class="detalhes-secao__header">
            <h4 id="detalhesContatosTitulo">Pessoas respons√°veis</h4>
          </div>
          <ul id="detalhesContatos" class="detalhes-lista-detalhe"></ul>
        </section>

        <section class="detalhes-secao" aria-labelledby="detalhesTimelineTitulo" hidden>
          <div class="detalhes-secao__header">
            <h4 id="detalhesTimelineTitulo">Linha do tempo</h4>
          </div>
          <ol id="detalhesTimeline" class="detalhes-timeline"></ol>
        </section>
      </article>
    </section>
  </div>
</div>

<style>
  .detalhes-wrapper { display:flex; flex-direction:column; gap:24px; }
  .detalhes-header { display:flex; flex-direction:column; gap:18px; background:linear-gradient(180deg, rgba(191,219,254,0.5), rgba(255,255,255,0.9)); padding:24px; border-radius:24px; box-shadow:0 18px 36px rgba(59,130,246,0.15); }
  .detalhes-title { font-size:1.4rem; font-weight:700; color:#0f172a; margin:0; }
  .detalhes-subtitle { margin:0; font-size:0.95rem; color:#475569; max-width:620px; }
  .detalhes-controls { display:flex; flex-direction:column; gap:16px; }
  .detalhes-filtros { display:flex; flex-wrap:wrap; gap:8px; }
  .detalhes-filtro { border:none; border-radius:999px; padding:10px 18px; font-weight:600; color:#1d4ed8; background:rgba(191,219,254,0.4); cursor:pointer; transition:transform .2s ease, box-shadow .2s ease, background .2s ease; }
  .detalhes-filtro:hover { transform:translateY(-2px); box-shadow:0 12px 24px rgba(59,130,246,0.18); }
  .detalhes-filtro.ativo { background:linear-gradient(120deg,#38bdf8,#2563eb); color:white; box-shadow:0 16px 34px rgba(37,99,235,0.26); }
  .detalhes-search { display:flex; align-items:center; gap:8px; background:white; border-radius:18px; padding:0 16px; border:1px solid rgba(148,163,184,0.25); box-shadow:0 12px 28px rgba(148,163,184,0.12); }
  .detalhes-search input { border:none; padding:10px 0; width:220px; font-size:0.95rem; outline:none; color:#0f172a; }
  .detalhes-resumo { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
  .detalhes-resumo__card { background:white; padding:16px; border-radius:18px; box-shadow:0 12px 28px rgba(37,99,235,0.12); display:flex; flex-direction:column; gap:6px; border:1px solid rgba(191,219,254,0.6); }
  .detalhes-resumo__card span { font-size:0.75rem; text-transform:uppercase; letter-spacing:0.08em; color:#1d4ed8; font-weight:600; }
  .detalhes-resumo__card strong { font-size:1.4rem; color:#0f172a; }
  .detalhes-grid { display:grid; grid-template-columns:minmax(0,0.9fr) minmax(0,1.6fr); gap:24px; align-items:start; }
  @media (max-width: 1024px) { .detalhes-grid { grid-template-columns:1fr; } }
  .detalhes-lista { background:white; border-radius:22px; padding:16px; box-shadow:0 16px 36px rgba(15,23,42,0.12); border:1px solid rgba(148,163,184,0.2); display:flex; flex-direction:column; gap:12px; max-height:calc(100vh - 280px); overflow:auto; }
  .detalhes-lista__conteudo { display:flex; flex-direction:column; gap:12px; }
  .detalhes-lista__vazio { font-size:0.85rem; color:#64748b; text-align:center; padding:16px; border-radius:16px; background:rgba(226,232,240,0.45); display:none; }
  .detalhes-item { border:1px solid rgba(148,163,184,0.2); border-radius:18px; padding:14px; background:linear-gradient(180deg, rgba(248,250,252,0.9), rgba(255,255,255,0.95)); display:flex; flex-direction:column; gap:6px; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease; }
  .detalhes-item:hover, .detalhes-item:focus-visible { transform:translateY(-3px); box-shadow:0 16px 32px rgba(37,99,235,0.24); border-color:rgba(37,99,235,0.45); outline:none; }
  .detalhes-item__titulo { font-size:1rem; font-weight:600; color:#0f172a; }
  .detalhes-item__subtitulo { font-size:0.8rem; color:#475569; }
  .detalhes-item__status { font-size:0.72rem; padding:4px 10px; border-radius:999px; width:max-content; background:rgba(191,219,254,0.65); color:#1d4ed8; font-weight:600; }
  .detalhes-item__meta { font-size:0.75rem; color:#0f766e; }
  .detalhes-item.selecionado { border-color:rgba(14,165,233,0.9); box-shadow:0 18px 34px rgba(14,165,233,0.28); }
  .detalhes-painel { background:transparent; display:flex; align-items:stretch; }
  .detalhes-placeholder { border:1px dashed rgba(148,163,184,0.35); border-radius:22px; padding:48px 24px; text-align:center; color:#64748b; font-size:0.95rem; display:flex; flex-direction:column; gap:12px; justify-content:center; align-items:center; }
  .detalhes-placeholder .material-icons { font-size:2.6rem; color:#38bdf8; }
  .detalhes-card { background:white; border-radius:26px; padding:24px; box-shadow:0 20px 44px rgba(15,23,42,0.18); border:1px solid rgba(226,232,240,0.9); display:flex; flex-direction:column; gap:20px; width:100%; }
  .detalhes-card__header { display:flex; flex-wrap:wrap; justify-content:space-between; gap:12px; }
  .detalhes-card__header h3 { margin:0; font-size:1.3rem; font-weight:700; color:#0f172a; }
  .detalhes-card__header p { margin:0; color:#475569; font-size:0.85rem; }
  .detalhes-status { font-size:0.7rem; text-transform:uppercase; font-weight:700; letter-spacing:0.08em; color:#1e3a8a; }
  .detalhes-ctas { display:flex; flex-wrap:wrap; gap:10px; }
  .detalhes-cta { border:none; border-radius:999px; padding:10px 18px; background:linear-gradient(135deg,#0ea5e9,#2563eb); color:white; font-weight:600; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease; }
  .detalhes-cta:hover { transform:translateY(-2px); box-shadow:0 16px 32px rgba(37,99,235,0.25); }
  .detalhes-cta.secundario { background:#e0f2fe; color:#1d4ed8; }
  .detalhes-card__resumo { margin:0; font-size:0.95rem; color:#334155; line-height:1.5; }
  .detalhes-chips { display:flex; flex-wrap:wrap; gap:8px; }
  .detalhes-chip { border-radius:999px; background:rgba(14,165,233,0.14); color:#0369a1; padding:6px 14px; font-size:0.75rem; font-weight:600; }
  .detalhes-metricas { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; }
  .detalhes-metrica { background:rgba(224,242,254,0.75); border-radius:18px; padding:14px; display:flex; flex-direction:column; gap:4px; }
  .detalhes-metrica span { font-size:0.72rem; text-transform:uppercase; letter-spacing:0.08em; color:#0369a1; font-weight:600; }
  .detalhes-metrica strong { font-size:1.2rem; color:#0f172a; }
  .detalhes-metrica small { font-size:0.75rem; color:#475569; }
  .detalhes-campos { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin:0; }
  .detalhes-campo { background:rgba(248,250,252,0.9); border-radius:16px; padding:12px 14px; display:flex; flex-direction:column; gap:4px; border:1px solid rgba(226,232,240,0.9); }
  .detalhes-campo dt { font-size:0.72rem; text-transform:uppercase; color:#475569; font-weight:600; margin:0; }
  .detalhes-campo dd { margin:0; font-size:0.92rem; color:#0f172a; }
  .detalhes-secao { display:flex; flex-direction:column; gap:12px; }
  .detalhes-secao__header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .detalhes-secao__header h4 { margin:0; font-size:1rem; font-weight:700; color:#0f172a; }
  .detalhes-secao__meta { font-size:0.75rem; color:#0369a1; font-weight:600; }
  .detalhes-lista-detalhe { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; }
  .detalhes-lista-detalhe li { background:rgba(248,250,252,0.95); border:1px solid rgba(226,232,240,0.9); border-radius:16px; padding:12px 14px; display:flex; flex-direction:column; gap:4px; }
  .detalhes-lista-detalhe strong { color:#0f172a; font-size:0.92rem; }
  .detalhes-lista-detalhe span { color:#475569; font-size:0.78rem; }
  .detalhes-documento__link { display:flex; align-items:center; gap:10px; color:#1d4ed8; text-decoration:none; font-weight:600; }
  .detalhes-documento__link:hover { text-decoration:underline; }
  .detalhes-galeria { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
  .detalhes-galeria figure, .detalhes-galeria a { border-radius:18px; overflow:hidden; border:1px solid rgba(226,232,240,0.9); background:white; box-shadow:0 12px 24px rgba(15,23,42,0.12); }
  .detalhes-galeria img { width:100%; height:160px; object-fit:cover; display:block; }
  .detalhes-galeria figcaption { padding:10px; font-size:0.75rem; color:#475569; }
  .detalhes-galeria a { padding:14px; display:flex; flex-direction:column; gap:6px; color:#1d4ed8; text-decoration:none; }
  .detalhes-galeria a span { font-size:0.8rem; color:#475569; }
  .detalhes-timeline { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:14px; position:relative; }
  .detalhes-timeline::before { content:''; position:absolute; left:12px; top:4px; bottom:4px; width:2px; background:rgba(148,163,184,0.35); }
  .detalhes-timeline__item { position:relative; padding-left:36px; }
  .detalhes-timeline__item::before { content:''; position:absolute; left:7px; top:4px; width:10px; height:10px; border-radius:999px; background:#38bdf8; box-shadow:0 0 0 4px rgba(56,189,248,0.25); }
  .detalhes-timeline__item strong { display:block; font-size:0.92rem; color:#0f172a; }
  .detalhes-timeline__meta { font-size:0.75rem; color:#0369a1; display:flex; gap:8px; flex-wrap:wrap; }
  .detalhes-timeline__descricao { font-size:0.78rem; color:#475569; margin-top:4px; }
  .detalhes-vazio { font-size:0.82rem; color:#94a3b8; background:rgba(226,232,240,0.6); border-radius:14px; padding:12px; text-align:center; }
</style>

<script>
  (() => {
    const formatarNumero = (valor) => Number(valor || 0).toLocaleString('pt-BR');
    const formatarMoeda = (valor) => Number(valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const formatarData = (valor) => {
      if (!valor) return '';
      const data = new Date(valor);
      if (Number.isNaN(data.getTime())) return valor;
      return data.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
    };
    const escapeHtml = (texto = '') => String(texto)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

    const filtros = Array.from(document.querySelectorAll('.detalhes-filtro'));
    const buscaInput = document.getElementById('detalhesBusca');
    const resumoEl = document.getElementById('detalhesResumo');
    const listaEl = document.getElementById('detalhesLista');
    const listaVaziaEl = document.getElementById('detalhesListaVazia');
    const painelPlaceholder = document.getElementById('detalhesPlaceholder');
    const painelEl = document.getElementById('detalhesPainel');
    const painelStatus = document.getElementById('detalhesStatus');
    const painelTitulo = document.getElementById('detalhesTitulo');
    const painelSubtitulo = document.getElementById('detalhesSubtitulo');
    const painelResumo = document.getElementById('detalhesResumoTexto');
    const painelChips = document.getElementById('detalhesChips');
    const painelMetricas = document.getElementById('detalhesMetricas');
    const painelCampos = document.getElementById('detalhesCampos');
    const painelDoadoresTitulo = document.getElementById('detalhesDoadoresTitulo');
    const painelDoadoresSecao = document.querySelector('[aria-labelledby="detalhesDoadoresTitulo"]');
    const painelDoadoresMeta = document.getElementById('detalhesDoadoresMeta');
    const painelDoadores = document.getElementById('detalhesDoadores');
    const painelEvidenciasSecao = document.querySelector('[aria-labelledby="detalhesEvidenciasTitulo"]');
    const painelEvidenciasMeta = document.getElementById('detalhesEvidenciasMeta');
    const painelEvidencias = document.getElementById('detalhesEvidencias');
    const painelDocsSecao = document.querySelector('[aria-labelledby="detalhesDocumentosTitulo"]');
    const painelDocs = document.getElementById('detalhesDocumentos');
    const painelContatosSecao = document.querySelector('[aria-labelledby="detalhesContatosTitulo"]');
    const painelContatos = document.getElementById('detalhesContatos');
    const painelTimelineSecao = document.querySelector('[aria-labelledby="detalhesTimelineTitulo"]');
    const painelTimeline = document.getElementById('detalhesTimeline');
    const btnEditar = document.getElementById('detalhesEditar');
    const btnAbrirGuia = document.getElementById('detalhesAbrirGuia');

    const estado = {
      categoria: 'pocos',
      dados: { pocos: [], projetos: [], doadores: [] },
      filtrados: [],
      selecionado: null,
      linksGuia: { pocos: 'pocos', projetos: 'gestao', doadores: 'impacto' }
    };

    const normalizarColecao = (valor) => Array.isArray(valor) ? valor : [];

    const atualizarResumoCategoria = () => {
      const colecao = estado.dados[estado.categoria] || [];
      const total = colecao.length;
      const ativos = colecao.filter(item => (item.status || '').toLowerCase().includes('exec')).length;
      const destaque = colecao.reduce((acc, item) => acc + (Number(item.metricas?.[0]?.valorNumerico || 0)), 0);
      const cards = [
        { label: 'Registros', valor: total, detalhe: 'Itens cadastrados para monitorar' },
        { label: 'Em andamento', valor: ativos, detalhe: 'Status com a√ß√µes em execu√ß√£o' }
      ];
      if (destaque > 0) {
        cards.push({ label: estado.categoria === 'doadores' ? 'Investimento somado' : 'Benef√≠cios somados', valor: destaque, detalhe: estado.categoria === 'doadores' ? 'Volume total informado' : 'Somat√≥rio do indicador principal' });
      }
      resumoEl.innerHTML = cards.map(card => `
        <div class="detalhes-resumo__card">
          <span>${escapeHtml(card.label)}</span>
          <strong>${escapeHtml(formatarNumero(card.valor))}</strong>
          <small>${escapeHtml(card.detalhe)}</small>
        </div>
      `).join('');
    };

    const renderizarLista = () => {
      const busca = (buscaInput.value || '').toLowerCase();
      const colecao = normalizarColecao(estado.dados[estado.categoria]);
      const filtrados = colecao.filter(item => {
        const termos = [item.titulo, item.subtitulo, item.status, item.resumo, ...(item.tags || [])]
          .filter(Boolean)
          .join(' ')
          .toLowerCase();
        return termos.includes(busca);
      });
      estado.filtrados = filtrados;
      listaEl.innerHTML = filtrados.map(item => `
        <article class="detalhes-item${estado.selecionado && estado.selecionado.id === item.id ? ' selecionado' : ''}" data-id="${escapeHtml(item.id)}" tabindex="0" role="button" aria-pressed="${estado.selecionado && estado.selecionado.id === item.id}">
          <span class="detalhes-item__status">${escapeHtml(item.status || 'Sem status')}</span>
          <div class="detalhes-item__titulo">${escapeHtml(item.titulo || 'Sem identifica√ß√£o')}</div>
          <div class="detalhes-item__subtitulo">${escapeHtml(item.subtitulo || '')}</div>
          ${item.meta ? `<div class="detalhes-item__meta">${escapeHtml(item.meta)}</div>` : ''}
        </article>
      `).join('');
      listaVaziaEl.style.display = filtrados.length ? 'none' : 'block';
      if (!filtrados.length) {
        painelPlaceholder.hidden = false;
        painelEl.hidden = true;
        estado.selecionado = null;
      }
    };

    const renderizarMetricas = (metricas = []) => {
      if (!metricas.length) {
        painelMetricas.innerHTML = '';
        return;
      }
      painelMetricas.innerHTML = metricas.map(item => `
        <div class="detalhes-metrica">
          <span>${escapeHtml(item.label || '')}</span>
          <strong>${escapeHtml(item.valor || '-')}</strong>
          ${item.detalhe ? `<small>${escapeHtml(item.detalhe)}</small>` : ''}
        </div>
      `).join('');
    };

    const renderizarCampos = (campos = []) => {
      if (!campos.length) {
        painelCampos.innerHTML = '';
        return;
      }
      painelCampos.innerHTML = campos.map(campo => `
        <div class="detalhes-campo">
          <dt>${escapeHtml(campo.label || '')}</dt>
          <dd>${escapeHtml(campo.valor || '-')}</dd>
        </div>
      `).join('');
    };

    const renderizarListaDetalhe = (lista = [], destino, metaEl) => {
      if (!destino) return;
      if (!Array.isArray(lista) || !lista.length) {
        destino.innerHTML = '<li class="detalhes-vazio">Nenhum registro dispon√≠vel.</li>';
        if (metaEl) metaEl.textContent = '';
        return;
      }
      destino.innerHTML = lista.map(item => `
        <li>
          ${item.titulo ? `<strong>${escapeHtml(item.titulo)}</strong>` : ''}
          ${item.descricao ? `<span>${escapeHtml(item.descricao)}</span>` : ''}
          ${item.valor ? `<span>${escapeHtml(item.valor)}</span>` : ''}
          ${item.meta ? `<span>${escapeHtml(item.meta)}</span>` : ''}
        </li>
      `).join('');
      if (metaEl) metaEl.textContent = `${lista.length} registros`;
    };

    const renderizarEvidencias = (evidencias = []) => {
      if (!painelEvidencias) return;
      if (!evidencias.length) {
        painelEvidencias.innerHTML = '<div class="detalhes-vazio">Nenhuma evid√™ncia enviada.</div>';
        painelEvidenciasMeta.textContent = '';
        return;
      }
      painelEvidencias.innerHTML = evidencias.map(ev => {
        const tipo = (ev.tipo || '').toLowerCase();
        if (tipo.includes('imagem')) {
          return `
            <figure>
              <img src="${escapeHtml(ev.url)}" alt="${escapeHtml(ev.titulo || 'Evid√™ncia')}" loading="lazy">
              <figcaption>${escapeHtml(ev.titulo || 'Imagem')}</figcaption>
            </figure>`;
        }
        return `
          <a href="${escapeHtml(ev.url)}" target="_blank" rel="noopener">
            <strong>${escapeHtml(ev.titulo || 'Documento')}</strong>
            <span>${escapeHtml(ev.tipo || 'arquivo')}</span>
          </a>`;
      }).join('');
      painelEvidenciasMeta.textContent = `${evidencias.length} anexos`;
    };

    const renderizarDocumentos = (documentos = []) => {
      if (!painelDocs) return;
      if (!documentos.length) {
        painelDocs.innerHTML = '<li class="detalhes-vazio">Nenhum documento oficial cadastrado.</li>';
        return;
      }
      painelDocs.innerHTML = documentos.map(doc => `
        <li>
          <a class="detalhes-documento__link" href="${escapeHtml(doc.url)}" target="_blank" rel="noopener">
            <span class="material-icons" aria-hidden="true">description</span>
            ${escapeHtml(doc.titulo || 'Documento')}
          </a>
          ${doc.meta ? `<span>${escapeHtml(doc.meta)}</span>` : ''}
        </li>
      `).join('');
    };

    const renderizarContatos = (contatos = []) => {
      if (!painelContatos) return;
      if (!contatos.length) {
        painelContatos.innerHTML = '<li class="detalhes-vazio">Nenhum contato registrado.</li>';
        return;
      }
      painelContatos.innerHTML = contatos.map(contato => `
        <li>
          <strong>${escapeHtml(contato.nome || 'Contato')}</strong>
          ${contato.papel ? `<span>${escapeHtml(contato.papel)}</span>` : ''}
          ${contato.telefone ? `<span>${escapeHtml(contato.telefone)}</span>` : ''}
          ${contato.email ? `<span>${escapeHtml(contato.email)}</span>` : ''}
        </li>
      `).join('');
    };

    const renderizarTimeline = (eventos = []) => {
      if (!painelTimeline) return;
      if (!eventos.length) {
        painelTimeline.innerHTML = '<li class="detalhes-vazio">Nenhuma movimenta√ß√£o registrada.</li>';
        return;
      }
      painelTimeline.innerHTML = eventos.map(ev => `
        <li class="detalhes-timeline__item">
          <strong>${escapeHtml(ev.titulo || 'Evento')}</strong>
          <div class="detalhes-timeline__meta">
            ${ev.data ? `<span>${escapeHtml(formatarData(ev.data))}</span>` : ''}
            ${ev.status ? `<span>${escapeHtml(ev.status)}</span>` : ''}
          </div>
          ${ev.descricao ? `<div class="detalhes-timeline__descricao">${escapeHtml(ev.descricao)}</div>` : ''}
        </li>
      `).join('');
    };

    const aplicarVisibilidadeSecao = (secao, possuiDados) => {
      if (!secao) return;
      if (possuiDados) {
        secao.hidden = false;
      } else {
        secao.hidden = true;
      }
    };

    const renderizarPainel = (item) => {
      if (!item) {
        painelPlaceholder.hidden = false;
        painelEl.hidden = true;
        return;
      }
      painelPlaceholder.hidden = true;
      painelEl.hidden = false;
      painelStatus.textContent = item.status || '';
      painelTitulo.textContent = item.titulo || 'Item sem identifica√ß√£o';
      painelSubtitulo.textContent = item.subtitulo || '';
      painelResumo.textContent = item.resumo || 'Sem descri√ß√£o detalhada.';
      painelChips.innerHTML = (item.tags || []).map(tag => `<span class="detalhes-chip">${escapeHtml(tag)}</span>`).join('');
      renderizarMetricas(item.metricas || []);
      renderizarCampos(item.campos || []);
      if (painelDoadoresTitulo) {
        painelDoadoresTitulo.textContent = item.rotuloRede || (estado.categoria === 'doadores' ? 'Po√ßos apoiados' : 'Rede de apoio');
      }
      renderizarListaDetalhe(item.doadores || [], painelDoadores, painelDoadoresMeta);
      renderizarEvidencias(item.evidencias || []);
      renderizarDocumentos(item.documentos || []);
      renderizarContatos(item.contatos || []);
      renderizarTimeline(item.timeline || []);
      aplicarVisibilidadeSecao(painelDoadoresSecao, Array.isArray(item.doadores) && item.doadores.length > 0);
      aplicarVisibilidadeSecao(painelEvidenciasSecao, Array.isArray(item.evidencias) && item.evidencias.length > 0);
      aplicarVisibilidadeSecao(painelDocsSecao, Array.isArray(item.documentos) && item.documentos.length > 0);
      aplicarVisibilidadeSecao(painelContatosSecao, Array.isArray(item.contatos) && item.contatos.length > 0);
      aplicarVisibilidadeSecao(painelTimelineSecao, Array.isArray(item.timeline) && item.timeline.length > 0);

      if (item.acaoEditar) {
        btnEditar.hidden = false;
        btnEditar.onclick = () => {
          if (typeof window.abrirFormularioCadastro === 'function') {
            window.abrirFormularioCadastro({ tipo: item.acaoEditar.tipo, dados: item.acaoEditar.dados });
          }
        };
      } else {
        btnEditar.hidden = true;
        btnEditar.onclick = null;
      }

      const destinoGuia = item.acaoGuia || estado.linksGuia[estado.categoria];
      if (destinoGuia) {
        btnAbrirGuia.hidden = false;
        btnAbrirGuia.onclick = () => {
          if (typeof window.navegarPara === 'function') {
            window.navegarPara(destinoGuia);
          }
        };
      } else {
        btnAbrirGuia.hidden = true;
        btnAbrirGuia.onclick = null;
      }
    };

    listaEl.addEventListener('click', (evento) => {
      const card = evento.target.closest('.detalhes-item');
      if (!card) return;
      const id = card.getAttribute('data-id');
      const item = estado.filtrados.find(registro => registro.id === id);
      if (!item) return;
      estado.selecionado = item;
      renderizarLista();
      renderizarPainel(item);
    });

    listaEl.addEventListener('keydown', (evento) => {
      if (evento.key !== 'Enter' && evento.key !== ' ') return;
      const card = evento.target.closest('.detalhes-item');
      if (!card) return;
      evento.preventDefault();
      card.click();
    });

    filtros.forEach(botao => {
      botao.addEventListener('click', () => {
        const categoria = botao.getAttribute('data-categoria');
        if (!categoria || categoria === estado.categoria) return;
        filtros.forEach(btn => {
          btn.classList.toggle('ativo', btn === botao);
          btn.setAttribute('aria-selected', btn === botao ? 'true' : 'false');
        });
        estado.categoria = categoria;
        estado.selecionado = null;
        buscaInput.value = '';
        atualizarResumoCategoria();
        renderizarLista();
        renderizarPainel(null);
      });
    });

    buscaInput.addEventListener('input', () => {
      renderizarLista();
      if (estado.filtrados.length && !estado.selecionado) {
        estado.selecionado = estado.filtrados[0];
        renderizarPainel(estado.selecionado);
      }
    });

    const transformarDados = (dados = {}) => {
      const pocos = normalizarColecao(dados.pocos).map(item => Object.assign({}, item, {
        metricas: normalizarColecao(item.metricas).map(m => Object.assign({}, m, {
          valor: m.formato === 'moeda' ? formatarMoeda(m.valorNumerico) : (m.formato === 'numero' ? formatarNumero(m.valorNumerico) : (m.valor || '-')),
          detalhe: m.detalhe || ''
        }))
      }));
      const projetos = normalizarColecao(dados.projetos).map(item => Object.assign({}, item, {
        metricas: normalizarColecao(item.metricas).map(m => Object.assign({}, m, {
          valor: m.formato === 'moeda' ? formatarMoeda(m.valorNumerico) : (m.formato === 'numero' ? formatarNumero(m.valorNumerico) : (m.valor || '-')),
          detalhe: m.detalhe || ''
        }))
      }));
      const doadores = normalizarColecao(dados.doadores).map(item => Object.assign({}, item, {
        metricas: normalizarColecao(item.metricas).map(m => Object.assign({}, m, {
          valor: m.formato === 'moeda' ? formatarMoeda(m.valorNumerico) : (m.formato === 'numero' ? formatarNumero(m.valorNumerico) : (m.valor || '-')),
          detalhe: m.detalhe || ''
        }))
      }));
      return { pocos, projetos, doadores };
    };

    const carregarDados = () => {
      const sucesso = (resposta) => {
        estado.dados = transformarDados(resposta || {});
        atualizarResumoCategoria();
        renderizarLista();
        if (estado.filtrados.length) {
          estado.selecionado = estado.filtrados[0];
          renderizarPainel(estado.selecionado);
        }
      };
      const fallback = () => {
        const dadosBase = window.__dadosMissoesAtuais || {};
        const placeholder = {
          pocos: normalizarColecao(dadosBase.missoes).map((item, indice) => ({
            id: `missao-${indice}`,
            titulo: item.titulo,
            subtitulo: item.responsavel || '',
            status: item.status || 'Planejamento',
            resumo: item.motivo || item.proximaAcao || '',
            metricas: [],
            campos: [],
            tags: ['Dados parciais'],
            acaoGuia: 'dashboard'
          })),
          projetos: normalizarColecao(dadosBase.projetos).map((item, indice) => ({
            id: `projeto-${indice}`,
            titulo: item.poco,
            subtitulo: item.etapa || '',
            status: item.status || 'Execu√ß√£o',
            resumo: item.descricao || '',
            metricas: [],
            campos: [],
            tags: ['Dados parciais'],
            acaoGuia: 'gestao'
          })),
          doadores: normalizarColecao(dadosBase.doadores).map((item, indice) => ({
            id: `doador-${indice}`,
            titulo: item.nome,
            subtitulo: formatarMoeda(item.valor || 0),
            status: 'Ativo',
            resumo: `${formatarNumero(item.pocos || 0)} po√ßos apoiados`,
            metricas: [],
            campos: [],
            tags: ['Dados parciais'],
            acaoGuia: 'impacto'
          }))
        };
        sucesso(placeholder);
      };

      if (window.google && google.script && google.script.run && google.script.run.withSuccessHandler) {
        google.script.run.withSuccessHandler(sucesso).withFailureHandler(fallback).obterPainelDetalhes();
      } else {
        fallback();
      }
    };

    carregarDados();
  })();
</script>
